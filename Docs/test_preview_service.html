<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_preview_service</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_preview_service</h1>
        <p>Defines a test case for preview functionality that verifies term highlighting in document passages. Creates a temporary database and file, stores parsed document content, and checks that search terms are properly marked within the document text. Includes assertions for highlighted text, page retrieval, and search result formatting. Uses fixtures for database management and temporary file handling.</p>
<h2>Functions</h2>
<h3 id="db_manager">db_manager(tmp_path: Path) -&gt; DatabaseManager</h3>
<p>The function `db_manager` is a generator that creates and manages a `DatabaseManager` instance for a specified temporary path. It constructs the database file path by appending &quot;preview.db&quot; to the provided `tmp_path`, initializes the database manager, and yields it for use. After the generator&#x27;s execution completes, it ensures the database manager is properly closed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">db_manager</span>(tmp_path: Path) <span style="color: #666666">-&gt;</span> DatabaseManager:
    db_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;preview.db&quot;</span>
    manager <span style="color: #666666">=</span> DatabaseManager(db_path)
    manager<span style="color: #666666">.</span>initialize()
    <span style="color: #008000; font-weight: bold">yield</span> manager
    manager<span style="color: #666666">.</span>close()
</code></pre>
<h3 id="test_preview_highlights_terms">test_preview_highlights_terms(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>The function `test_preview_highlights_terms` tests the preview and highlighting functionality of a document ingestion and retrieval system. It creates a sample text file, parses it, and stores the document version in a database using `IngestDocumentRepository`. It then uses `PreviewService` to retrieve highlighted passages containing the term &quot;gamma&quot; and verifies that the term is wrapped in `&lt;mark&gt;` tags within the snippet. The test also checks that the retrieved passage corresponds to page 1 or has no page specified, and confirms that the full text of the first page contains &quot;Alpha&quot;. Finally, it performs a search for &quot;gamma&quot; using the repository and asserts that the search results include a highlighted version of the term wrapped in `&lt;mark&gt;` tags.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_preview_highlights_terms</span>(tmp_path: Path, db_manager: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    file_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;sample.txt&quot;</span>
    file_path<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;Alpha beta gamma delta epsilon&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
    parsed <span style="color: #666666">=</span> parse_file(file_path)
    checksum <span style="color: #666666">=</span> hashlib<span style="color: #666666">.</span>sha256(file_path<span style="color: #666666">.</span>read_bytes())<span style="color: #666666">.</span>hexdigest()
    repo <span style="color: #666666">=</span> IngestDocumentRepository(db_manager)
    stored <span style="color: #666666">=</span> repo<span style="color: #666666">.</span>store_version(
        path<span style="color: #666666">=</span><span style="color: #008000">str</span>(file_path),
        checksum<span style="color: #666666">=</span>checksum,
        size<span style="color: #666666">=</span>file_path<span style="color: #666666">.</span>stat()<span style="color: #666666">.</span>st_size,
        mtime<span style="color: #666666">=</span>file_path<span style="color: #666666">.</span>stat()<span style="color: #666666">.</span>st_mtime,
        ctime<span style="color: #666666">=</span>file_path<span style="color: #666666">.</span>stat()<span style="color: #666666">.</span>st_ctime,
        parsed<span style="color: #666666">=</span>parsed,
        base_metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;file&quot;</span>: {<span style="color: #BA2121">&quot;size&quot;</span>: file_path<span style="color: #666666">.</span>stat()<span style="color: #666666">.</span>st_size}},
    )

    preview <span style="color: #666666">=</span> PreviewService(db_manager)
    result <span style="color: #666666">=</span> preview<span style="color: #666666">.</span>get_highlighted_passages(stored[<span style="color: #BA2121">&quot;id&quot;</span>], [<span style="color: #BA2121">&quot;gamma&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;&lt;mark&gt;gamma&lt;/mark&gt;&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> result[<span style="color: #BA2121">&quot;snippet&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> result[<span style="color: #BA2121">&quot;page&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">1</span> <span style="color: #AA22FF; font-weight: bold">or</span> result[<span style="color: #BA2121">&quot;page&quot;</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
    page <span style="color: #666666">=</span> preview<span style="color: #666666">.</span>get_page(stored[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #666666">1</span>)
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Alpha&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> page[<span style="color: #BA2121">&quot;text&quot;</span>]

    results <span style="color: #666666">=</span> repo<span style="color: #666666">.</span>search(<span style="color: #BA2121">&quot;gamma&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> results
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;&lt;mark&gt;gamma&lt;/mark&gt;&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> results[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;highlight&quot;</span>]
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
