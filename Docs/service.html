<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>service</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>service</h1>
        <p>This background service manages ingest jobs with resumable processing capabilities, supporting queuing, pausing, cancellation, and status tracking for multiple job types including folder crawling, file ingestion, rescanning, and removal operations. Jobs are persisted in a database and can be restored after system restarts, utilizing threading for concurrent execution while providing progress monitoring and completion tracking. The module implements comprehensive file ingestion handling through methods for processing individual files, discovering files based on job type and filters, managing job states including cancellation and pausing, and synchronizing project documents. It supports operations such as file removal, rescanning, and batch ingestion of single files or entire directories with integrated error handling, metadata tracking, checksum calculation, and progress/result persistence. The implementation includes file filtering using include/exclude patterns, job data serialization for storage, subscriber update emission, rollback logic for cancelled jobs, and integration with a document repository for managing file metadata and versions.</p>
<h2 id="TaskStatus">Class: TaskStatus</h2>
<p>The `TaskStatus` class defines a set of canonical status values used for tracking task execution state in a task log. It enumerates standard task states including QUEUED, RUNNING, PAUSED, CANCELLED, FAILED, and COMPLETED. The class also defines a FINAL set containing the terminal states CANCELLED, FAILED, and COMPLETED that signify the end of a task&#x27;s lifecycle.</p>
<h2 id="_JobPaused">Class: _JobPaused</h2>
<p>The code defines a custom exception class `_JobPaused` that inherits from `RuntimeError`. This exception is intended to be raised internally to terminate or unwind a worker loop when a pause request is received. The exception serves as a control flow mechanism to break out of worker loop iterations in response to pause commands.</p>
<h2 id="_JobCancelled">Class: _JobCancelled</h2>
<p>This code defines a custom exception class `_JobCancelled` that inherits from `RuntimeError`. The exception is intended to be raised internally when a job cancellation request is detected. It serves as a specific error type for handling cancellation scenarios within the system.</p>
<h2 id="IngestJob">Class: IngestJob</h2>
<p>The `IngestJob` class represents a single ingest job with attributes for tracking job metadata, status, progress, errors, summary, and state. It includes fields for managing job execution such as cancel and pause events, and provides a method to initialize default values for progress tracking and file handling. The `ensure_defaults` method populates default bookkeeping keys and ensures proper handling of known files during job restoration.</p>
<h3 id="ensure_defaults">Method: ensure_defaults(self) -&gt; None</h3>
<p>The `ensure_defaults` method initializes default values for progress tracking and state management in an `IngestJob` instance. It ensures that specific keys are present in the `progress` and `state` dictionaries, setting them to default values if they do not already exist. The method also handles the initialization and copying of `known_files` from either the job&#x27;s state or parameters, ensuring that modifications to the state do not affect the original parameters. Additionally, it creates a snapshot of the known files if one does not already exist in the state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">ensure_defaults</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Populate default bookkeeping keys for newly restored jobs.&quot;&quot;&quot;</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;total&quot;</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;succeeded&quot;</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;failed&quot;</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;skipped&quot;</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>state<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;pending_files&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>state<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;position&quot;</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>state<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;processed_files&quot;</span>, [])
        known_files <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> known_files <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            known_files <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {})
            <span style="color: #3D7B7B; font-style: italic"># Ensure we store a copy so mutation does not leak back to params.</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;known_files&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(known_files)
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #3D7B7B; font-style: italic"># Work with a copy to keep the serialized representation stable.</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;known_files&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(known_files)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;known_files_snapshot&quot;</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>state:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;known_files&quot;</span>])
</code></pre>
<h2 id="IngestService">Class: IngestService</h2>
<p>This code defines a comprehensive ingest service that coordinates background jobs for file ingestion and processing through a worker thread. The system handles multiple job types including folder crawling and single file ingestion, managing file discovery, parsing, storage, and synchronization with a project&#x27;s document database. It supports batch and streaming data processing modes with configurable parameters, and includes functionality for handling missing values, applying custom transformations, and generating summary statistics. Key components encompass job queuing, execution, pausing, resuming, cancellation, and completion tracking, along with rollback capabilities, progress tracking, and metadata management including file checksums, versioning, and document synchronization. The implementation uses thread-safe methods for job updates and notifications, serializes job data, converts database records into ingest jobs, loads known files from previous jobs, normalizes file paths, hashes files, and generates UTC timestamps, while managing job lifecycle states including pause and resume operations based on job status.</p>
<h3 id="__init__">Method: __init__(self, db: DatabaseManager, *, worker_idle_sleep: float=0.1) -&gt; None</h3>
<p>Initializes the `IngestService` with a database manager and optional worker idle sleep time. Sets up repositories for background task logs, documents, and project documents. Creates a thread-safe queue for job management, initializes an empty dictionary for tracking jobs, and sets up a reentrant lock for thread safety. Registers a stop event for controlling the worker thread, configures the worker thread with a specified sleep interval, restores any incomplete ingestion jobs, and starts the worker thread.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, db: DatabaseManager, <span style="color: #666666">*</span>, worker_idle_sleep: <span style="color: #008000">float</span> <span style="color: #666666">=</span> <span style="color: #666666">0.1</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>db <span style="color: #666666">=</span> db
        <span style="color: #008000">self</span><span style="color: #666666">.</span>repo <span style="color: #666666">=</span> BackgroundTaskLogRepository(db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>documents <span style="color: #666666">=</span> IngestDocumentRepository(db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_documents <span style="color: #666666">=</span> DocumentRepository(db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue: <span style="color: #BA2121">&quot;queue.Queue[Optional[int]]&quot;</span> <span style="color: #666666">=</span> queue<span style="color: #666666">.</span>Queue()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs: <span style="color: #008000">dict</span>[<span style="color: #008000">int</span>, IngestJob] <span style="color: #666666">=</span> {}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs_lock <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>RLock()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_subscribers: <span style="color: #008000">list</span>[TaskCallback] <span style="color: #666666">=</span> []
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_stop_event <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Event()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_worker_idle_sleep <span style="color: #666666">=</span> worker_idle_sleep
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_worker <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Thread(target<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_worker_loop, name<span style="color: #666666">=</span><span style="color: #BA2121">&quot;IngestWorker&quot;</span>, daemon<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_restore_incomplete_jobs()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_worker<span style="color: #666666">.</span>start()
</code></pre>
<h3 id="subscribe">Method: subscribe(self, callback: TaskCallback) -&gt; Callable[[], None]</h3>
<p>The `subscribe` method registers a callback function to receive task update notifications and returns an unsubscribe handle. The method appends the provided callback to an internal list of subscribers, protected by a lock. The returned unsubscribe function removes the callback from the subscribers list when called, also under lock protection. This implements a thread-safe observer pattern for task progress updates.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">subscribe</span>(<span style="color: #008000">self</span>, callback: TaskCallback) <span style="color: #666666">-&gt;</span> Callable[[], <span style="color: #008000; font-weight: bold">None</span>]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Register ``callback`` for task updates and return an unsubscribe handle.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs_lock:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_subscribers<span style="color: #666666">.</span>append(callback)

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">unsubscribe</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs_lock:
                <span style="color: #008000; font-weight: bold">if</span> callback <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_subscribers:
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_subscribers<span style="color: #666666">.</span>remove(callback)

        <span style="color: #008000; font-weight: bold">return</span> unsubscribe
</code></pre>
<details>
<summary>Subfunction: unsubscribe() -&gt; None</summary>
<h4 id="unsubscribe">unsubscribe() -&gt; None</h4>
<p>The `unsubscribe` function removes a specified callback from the list of subscribers stored in `self._subscribers`. It operates under the protection of `self._jobs_lock` to ensure thread-safe modification of the subscribers list. If the callback is present in the list, it is removed; otherwise, the function performs no action.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">unsubscribe</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs_lock:
                <span style="color: #008000; font-weight: bold">if</span> callback <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_subscribers:
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_subscribers<span style="color: #666666">.</span>remove(callback)
</code></pre>
</details>
<h3 id="queue_folder_crawl">Method: queue_folder_crawl(self, project_id: int | None, root: str | Path, *, include: Iterable[str] | None=None, exclude: Iterable[str] | None=None) -&gt; int</h3>
<p>The function `queue_folder_crawl` initiates a background job to discover and ingest all files within a specified directory tree. It accepts a project identifier, a root path, and optional inclusion/exclusion patterns for file filtering. The function resolves the root path, prepares job parameters including project ID, root directory, and filter lists, then creates and returns a job identifier for the folder crawling task. The job is labeled with a descriptive name indicating the root path being processed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">queue_folder_crawl</span>(
        <span style="color: #008000">self</span>,
        project_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        root: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path,
        <span style="color: #666666">*</span>,
        include: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        exclude: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Discover and ingest all files underneath ``root``.&quot;&quot;&quot;</span>

        root_path <span style="color: #666666">=</span> Path(root)<span style="color: #666666">.</span>resolve()
        params <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;project_id&quot;</span>: project_id,
            <span style="color: #BA2121">&quot;root&quot;</span>: <span style="color: #008000">str</span>(root_path),
            <span style="color: #BA2121">&quot;include&quot;</span>: <span style="color: #008000">list</span>(include <span style="color: #AA22FF; font-weight: bold">or</span> []),
            <span style="color: #BA2121">&quot;exclude&quot;</span>: <span style="color: #008000">list</span>(exclude <span style="color: #AA22FF; font-weight: bold">or</span> []),
        }
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_job(<span style="color: #BA2121">&quot;folder_crawl&quot;</span>, params, <span style="color: #BA2121">f&quot;Folder crawl for </span><span style="color: #A45A77; font-weight: bold">{</span>root_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
</code></pre>
<h3 id="queue_file_add">Method: queue_file_add(self, project_id: int | None, files: str | Path | Iterable[str | Path], *, include: Iterable[str] | None=None, exclude: Iterable[str] | None=None) -&gt; int</h3>
<p>The function `queue_file_add` queues a job to ingest one or more specified files into a project. It accepts a project ID, a file or iterable of files, and optional include/exclude filters for file types. The function normalizes the file paths, determines a base directory from the first file, and creates a job with parameters specifying the ingestion task. The job is labeled &quot;Single file ingest&quot; and its identifier is returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">queue_file_add</span>(
        <span style="color: #008000">self</span>,
        project_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        files: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> Iterable[<span style="color: #008000">str</span> <span style="color: #666666">|</span> Path],
        <span style="color: #666666">*</span>,
        include: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        exclude: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Queue a job that ingests one or multiple explicit files.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(files, (<span style="color: #008000">str</span>, Path)):
            file_list <span style="color: #666666">=</span> [files]
        <span style="color: #008000; font-weight: bold">else</span>:
            file_list <span style="color: #666666">=</span> <span style="color: #008000">list</span>(files)
        normalized <span style="color: #666666">=</span> [<span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve()) <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> file_list]
        base_dir <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(normalized[<span style="color: #666666">0</span>])<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>parent) <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        params <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;project_id&quot;</span>: project_id,
            <span style="color: #BA2121">&quot;files&quot;</span>: normalized,
            <span style="color: #BA2121">&quot;include&quot;</span>: <span style="color: #008000">list</span>(include <span style="color: #AA22FF; font-weight: bold">or</span> []),
            <span style="color: #BA2121">&quot;exclude&quot;</span>: <span style="color: #008000">list</span>(exclude <span style="color: #AA22FF; font-weight: bold">or</span> []),
            <span style="color: #BA2121">&quot;root&quot;</span>: base_dir,
        }
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_job(<span style="color: #BA2121">&quot;single_file&quot;</span>, params, <span style="color: #BA2121">&quot;Single file ingest&quot;</span>)
</code></pre>
<h3 id="queue_rescan">Method: queue_rescan(self, project_id: int | None, root: str | Path, *, include: Iterable[str] | None=None, exclude: Iterable[str] | None=None, known_files: dict[str, Any] | None=None) -&gt; int</h3>
<p>The function `queue_rescan` initiates a background job to re-ingest files within a specified root directory that have changed since the last crawl. It accepts parameters including the project ID, root path, include/exclude filters, and a dictionary of known files. The function resolves the root path, loads known files if not provided, and creates a job with the specified parameters and a descriptive label. It returns the identifier of the created job.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">queue_rescan</span>(
        <span style="color: #008000">self</span>,
        project_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        root: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path,
        <span style="color: #666666">*</span>,
        include: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        exclude: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        known_files: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Re-ingest files that have changed since the previous crawl.&quot;&quot;&quot;</span>

        root_path <span style="color: #666666">=</span> Path(root)<span style="color: #666666">.</span>resolve()
        <span style="color: #008000; font-weight: bold">if</span> known_files <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            known_files <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_known_files(<span style="color: #008000">str</span>(root_path))
        params <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;project_id&quot;</span>: project_id,
            <span style="color: #BA2121">&quot;root&quot;</span>: <span style="color: #008000">str</span>(root_path),
            <span style="color: #BA2121">&quot;include&quot;</span>: <span style="color: #008000">list</span>(include <span style="color: #AA22FF; font-weight: bold">or</span> []),
            <span style="color: #BA2121">&quot;exclude&quot;</span>: <span style="color: #008000">list</span>(exclude <span style="color: #AA22FF; font-weight: bold">or</span> []),
            <span style="color: #BA2121">&quot;known_files&quot;</span>: known_files <span style="color: #AA22FF; font-weight: bold">or</span> {},
        }
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_job(<span style="color: #BA2121">&quot;rescan&quot;</span>, params, <span style="color: #BA2121">f&quot;Rescan for </span><span style="color: #A45A77; font-weight: bold">{</span>root_path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
</code></pre>
<h3 id="queue_remove">Method: queue_remove(self, project_id: int | None, root: str | Path, files: Iterable[str | Path]) -&gt; int</h3>
<p>The function `queue_remove` is designed to remove specified files from the ingest index within a given project and root directory. It takes a project ID, a root path, and an iterable of file paths as input. The function resolves the root path and normalizes the file paths to their absolute forms. It then loads the known files associated with the root path and constructs a parameter dictionary including the project ID, root path, normalized file paths, and the known files. Finally, it creates and returns a job to remove the specified files from the ingest index, using the provided parameters and a descriptive job title.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">queue_remove</span>(
        <span style="color: #008000">self</span>,
        project_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        root: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path,
        files: Iterable[<span style="color: #008000">str</span> <span style="color: #666666">|</span> Path],
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Remove tracked files from the ingest index.&quot;&quot;&quot;</span>

        root_path <span style="color: #666666">=</span> Path(root)<span style="color: #666666">.</span>resolve()
        normalized <span style="color: #666666">=</span> [<span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve()) <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> files]
        known_files <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_known_files(<span style="color: #008000">str</span>(root_path))
        params <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;project_id&quot;</span>: project_id,
            <span style="color: #BA2121">&quot;root&quot;</span>: <span style="color: #008000">str</span>(root_path),
            <span style="color: #BA2121">&quot;files&quot;</span>: normalized,
            <span style="color: #BA2121">&quot;known_files&quot;</span>: known_files <span style="color: #AA22FF; font-weight: bold">or</span> {},
        }
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_job(<span style="color: #BA2121">&quot;remove&quot;</span>, params, <span style="color: #BA2121">&quot;Remove files from ingest index&quot;</span>)
</code></pre>
<h3 id="pause_job">Method: pause_job(self, job_id: int) -&gt; None</h3>
<p>The `pause_job` function pauses a running job by setting its pause event. It retrieves the job using the provided `job_id` from the internal `_jobs` dictionary and, if found, triggers the job&#x27;s pause mechanism by setting its `pause_event`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">pause_job</span>(<span style="color: #008000">self</span>, job_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs<span style="color: #666666">.</span>get(job_id)
        <span style="color: #008000; font-weight: bold">if</span> job <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            job<span style="color: #666666">.</span>pause_event<span style="color: #666666">.</span>set()
</code></pre>
<h3 id="resume_job">Method: resume_job(self, job_id: int) -&gt; None</h3>
<p>The `resume_job` function resumes a paused background task by clearing its pause event, updating its status from `PAUSED` to `QUEUED`, persisting the status change, and adding the job to an execution queue. If the job does not exist, the function returns without performing any actions.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">resume_job</span>(<span style="color: #008000">self</span>, job_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs<span style="color: #666666">.</span>get(job_id)
        <span style="color: #008000; font-weight: bold">if</span> job <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        job<span style="color: #666666">.</span>pause_event<span style="color: #666666">.</span>clear()
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs_lock:
            <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>PAUSED:
                job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> TaskStatus<span style="color: #666666">.</span>QUEUED
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>QUEUED)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>put(job<span style="color: #666666">.</span>job_id)
</code></pre>
<h3 id="cancel_job">Method: cancel_job(self, job_id: int) -&gt; None</h3>
<p>The `cancel_job` function cancels a running job by setting a cancellation event. It retrieves the job using the provided `job_id` from the internal `_jobs` dictionary and, if the job exists, triggers its cancellation by setting the `cancel_event`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">cancel_job</span>(<span style="color: #008000">self</span>, job_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs<span style="color: #666666">.</span>get(job_id)
        <span style="color: #008000; font-weight: bold">if</span> job <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            job<span style="color: #666666">.</span>cancel_event<span style="color: #666666">.</span>set()
</code></pre>
<h3 id="wait_for_completion">Method: wait_for_completion(self, job_id: int, timeout: float | None=None) -&gt; bool</h3>
<p>The function `wait_for_completion` blocks execution until a job identified by `job_id` reaches a terminal state or a specified timeout expires. It checks the status of the job in two locations: first in `self._jobs` and then in `self.repo`. If the job is found and its status is final, it returns `True`. If the job is not found in the repository, it returns `False`. If a timeout is specified and exceeded, it also returns `False`. The function sleeps for 50 milliseconds between checks to avoid excessive polling.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">wait_for_completion</span>(<span style="color: #008000">self</span>, job_id: <span style="color: #008000">int</span>, timeout: <span style="color: #008000">float</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Block until ``job_id`` reaches a terminal state or ``timeout`` expires.&quot;&quot;&quot;</span>

        deadline <span style="color: #666666">=</span> time<span style="color: #666666">.</span>monotonic() <span style="color: #666666">+</span> timeout <span style="color: #008000; font-weight: bold">if</span> timeout <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000; font-weight: bold">True</span>:
            job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs<span style="color: #666666">.</span>get(job_id)
            <span style="color: #008000; font-weight: bold">if</span> job <span style="color: #AA22FF; font-weight: bold">and</span> job<span style="color: #666666">.</span>status <span style="color: #AA22FF; font-weight: bold">in</span> TaskStatus<span style="color: #666666">.</span>FINAL:
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
            <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
            <span style="color: #008000; font-weight: bold">if</span> record[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #AA22FF; font-weight: bold">in</span> TaskStatus<span style="color: #666666">.</span>FINAL:
                <span style="color: #008000; font-weight: bold">if</span> job <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                    job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> record[<span style="color: #BA2121">&quot;status&quot;</span>]
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">if</span> deadline <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">and</span> time<span style="color: #666666">.</span>monotonic() <span style="color: #666666">&gt;=</span> deadline:
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
            time<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.05</span>)
</code></pre>
<h3 id="shutdown">Method: shutdown(self, *, wait: bool=True) -&gt; None</h3>
<p>The `shutdown` method requests the worker thread to stop by setting a stop event and placing a termination signal in the queue. If the `wait` parameter is True, it blocks until the worker thread completes execution.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">shutdown</span>(<span style="color: #008000">self</span>, <span style="color: #666666">*</span>, wait: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Request the worker to stop and optionally wait for completion.&quot;&quot;&quot;</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_stop_event<span style="color: #666666">.</span>set()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>put(<span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> wait:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_worker<span style="color: #666666">.</span>join()
</code></pre>
<h3 id="_create_job">Method: _create_job(self, job_type: str, params: dict[str, Any], message: str) -&gt; int</h3>
<p>The function `_create_job` creates and initializes a new ingestion job with the specified type, parameters, and message. It constructs a job payload containing job details, progress tracking, error logs, summary data, and state information. The job is persisted in the repository with a &quot;QUEUED&quot; status, converted into a job object, and added to an internal jobs dictionary and processing queue. Finally, it emits an event to signal the job&#x27;s creation and returns the job identifier.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_job</span>(<span style="color: #008000">self</span>, job_type: <span style="color: #008000">str</span>, params: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any], message: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
        payload <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;job&quot;</span>: {<span style="color: #BA2121">&quot;type&quot;</span>: job_type, <span style="color: #BA2121">&quot;params&quot;</span>: params},
            <span style="color: #BA2121">&quot;progress&quot;</span>: {
                <span style="color: #BA2121">&quot;total&quot;</span>: <span style="color: #666666">0</span>,
                <span style="color: #BA2121">&quot;processed&quot;</span>: <span style="color: #666666">0</span>,
                <span style="color: #BA2121">&quot;succeeded&quot;</span>: <span style="color: #666666">0</span>,
                <span style="color: #BA2121">&quot;failed&quot;</span>: <span style="color: #666666">0</span>,
                <span style="color: #BA2121">&quot;skipped&quot;</span>: <span style="color: #666666">0</span>,
            },
            <span style="color: #BA2121">&quot;errors&quot;</span>: [],
            <span style="color: #BA2121">&quot;summary&quot;</span>: {},
            <span style="color: #BA2121">&quot;state&quot;</span>: {
                <span style="color: #BA2121">&quot;pending_files&quot;</span>: <span style="color: #008000; font-weight: bold">None</span>,
                <span style="color: #BA2121">&quot;position&quot;</span>: <span style="color: #666666">0</span>,
                <span style="color: #BA2121">&quot;processed_files&quot;</span>: [],
                <span style="color: #BA2121">&quot;known_files&quot;</span>: <span style="color: #008000">dict</span>(params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {})),
                <span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>: <span style="color: #008000">dict</span>(params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {})),
            },
        }
        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>repo<span style="color: #666666">.</span>create(
            <span style="color: #BA2121">f&quot;ingest.</span><span style="color: #A45A77; font-weight: bold">{</span>job_type<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>QUEUED,
            message<span style="color: #666666">=</span>message,
            extra_data<span style="color: #666666">=</span>payload,
        )
        job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_record_to_job(record)
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs_lock:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs[job<span style="color: #666666">.</span>job_id] <span style="color: #666666">=</span> job
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>put(job<span style="color: #666666">.</span>job_id)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit(job<span style="color: #666666">.</span>job_id)
        <span style="color: #008000; font-weight: bold">return</span> job<span style="color: #666666">.</span>job_id
</code></pre>
<h3 id="_restore_incomplete_jobs">Method: _restore_incomplete_jobs(self) -&gt; None</h3>
<p>The function `_restore_incomplete_jobs` restores incomplete background jobs from persistent storage into the service&#x27;s active job management structure. It iterates through all incomplete job records retrieved from the repository, converts each record into a job object, and adds it to the internal job dictionary. If a job is paused, it sets the pause event and persists the paused status. For other incomplete jobs, it resets their status to queued, persists the change, and adds the job ID to the processing queue.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_restore_incomplete_jobs</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>repo<span style="color: #666666">.</span>list_incomplete():
            job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_record_to_job(record)
            <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs_lock:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs[job<span style="color: #666666">.</span>job_id] <span style="color: #666666">=</span> job
            <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>PAUSED:
                job<span style="color: #666666">.</span>pause_event<span style="color: #666666">.</span>set()
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>PAUSED)
            <span style="color: #008000; font-weight: bold">else</span>:
                <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>status <span style="color: #666666">!=</span> TaskStatus<span style="color: #666666">.</span>QUEUED:
                    job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> TaskStatus<span style="color: #666666">.</span>QUEUED
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>QUEUED)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>put(job<span style="color: #666666">.</span>job_id)
</code></pre>
<h3 id="_worker_loop">Method: _worker_loop(self) -&gt; None</h3>
<p>The `_worker_loop` method implements the main execution loop for a worker thread in the `IngestService`. It continuously processes jobs from a queue, handling job start, processing, completion, cancellation, and failure states. The loop respects pause and cancel events for individual jobs, and ensures proper cleanup of queued items during shutdown. The method uses a timeout to periodically check for termination signals and manages job lifecycle through dedicated handler methods.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_worker_loop</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_stop_event<span style="color: #666666">.</span>is_set():
            <span style="color: #008000; font-weight: bold">try</span>:
                job_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>get(timeout<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_worker_idle_sleep)
            <span style="color: #008000; font-weight: bold">except</span> queue<span style="color: #666666">.</span>Empty:
                <span style="color: #008000; font-weight: bold">continue</span>

            <span style="color: #008000; font-weight: bold">if</span> job_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>task_done()
                <span style="color: #008000; font-weight: bold">continue</span>

            job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs<span style="color: #666666">.</span>get(job_id)
            <span style="color: #008000; font-weight: bold">if</span> job <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>task_done()
                <span style="color: #008000; font-weight: bold">continue</span>

            <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>pause_event<span style="color: #666666">.</span>is_set():
                <span style="color: #3D7B7B; font-style: italic"># Remain paused until resume clears the flag.</span>
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>task_done()
                <span style="color: #008000; font-weight: bold">continue</span>

            <span style="color: #008000; font-weight: bold">try</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_start_job(job)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_process_job(job)
                <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>cancel_event<span style="color: #666666">.</span>is_set():
                    <span style="color: #008000; font-weight: bold">raise</span> _JobCancelled
                <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>pause_event<span style="color: #666666">.</span>is_set():
                    <span style="color: #008000; font-weight: bold">raise</span> _JobPaused
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_complete_job(job)
            <span style="color: #008000; font-weight: bold">except</span> _JobPaused:
                <span style="color: #3D7B7B; font-style: italic"># Already persisted by _check_pause_cancel.</span>
                <span style="color: #008000; font-weight: bold">pass</span>
            <span style="color: #008000; font-weight: bold">except</span> _JobCancelled:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_handle_cancel(job)
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_fail_job(job, exc)
            <span style="color: #008000; font-weight: bold">finally</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>task_done()

        <span style="color: #3D7B7B; font-style: italic"># Drain remaining queue items so join() on Queue won&#39;t block when shutting down.</span>
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000; font-weight: bold">True</span>:
            <span style="color: #008000; font-weight: bold">try</span>:
                job_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>get_nowait()
            <span style="color: #008000; font-weight: bold">except</span> queue<span style="color: #666666">.</span>Empty:
                <span style="color: #008000; font-weight: bold">break</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_queue<span style="color: #666666">.</span>task_done()
</code></pre>
<h3 id="_start_job">Method: _start_job(self, job: IngestJob) -&gt; None</h3>
<p>The function `_start_job` initializes and starts an ingestion job by ensuring default values are set, updating the job&#x27;s status to `RUNNING`, and preserving a snapshot of known files in the job&#x27;s state. It then persists the updated job state with the running status.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_start_job</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job<span style="color: #666666">.</span>ensure_defaults()
        job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> TaskStatus<span style="color: #666666">.</span>RUNNING
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>):
            job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {}))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>RUNNING)
</code></pre>
<h3 id="_process_job">Method: _process_job(self, job: IngestJob) -&gt; None</h3>
<p>The `_process_job` method handles the execution of an ingestion job by processing a list of files. It retrieves pending files from the job&#x27;s state, discovers new files if needed, and iterates through them to process each one using `_handle_path`. The method tracks progress, updates job statistics such as succeeded, skipped, and failed counts, and persists the job state after each file is processed. It also manages file metadata, handles errors, and performs cleanup for removed files during a rescan operation. The method updates the job&#x27;s summary with information about OCR needs and removed files, and ensures that document records are updated or deleted accordingly.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_process_job</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        files <span style="color: #666666">=</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;pending_files&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> files <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            files <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_discover_files(job)
            job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;pending_files&quot;</span>] <span style="color: #666666">=</span> files
            job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;position&quot;</span>] <span style="color: #666666">=</span> <span style="color: #666666">0</span>
            job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;total&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">len</span>(files)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job)

        position <span style="color: #666666">=</span> <span style="color: #008000">int</span>(job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;position&quot;</span>, <span style="color: #666666">0</span>))
        known_files: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {})
        processed_files: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed_files&quot;</span>, [])

        <span style="color: #008000; font-weight: bold">while</span> position <span style="color: #666666">&lt;</span> <span style="color: #008000">len</span>(files):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_check_pause_cancel(job)
            file_path <span style="color: #666666">=</span> Path(files[position])
            result <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_handle_path(job, file_path)
            position <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
            job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;position&quot;</span>] <span style="color: #666666">=</span> position
            job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;processed&quot;</span>] <span style="color: #666666">+=</span> <span style="color: #666666">1</span>

            <span style="color: #008000; font-weight: bold">if</span> result[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;success&quot;</span>:
                job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;succeeded&quot;</span>] <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
                metadata <span style="color: #666666">=</span> result[<span style="color: #BA2121">&quot;metadata&quot;</span>]
                processed_files<span style="color: #666666">.</span>append(metadata)
                known_files[metadata[<span style="color: #BA2121">&quot;path&quot;</span>]] <span style="color: #666666">=</span> {
                    <span style="color: #BA2121">&quot;checksum&quot;</span>: metadata[<span style="color: #BA2121">&quot;checksum&quot;</span>],
                    <span style="color: #BA2121">&quot;mtime&quot;</span>: metadata[<span style="color: #BA2121">&quot;mtime&quot;</span>],
                    <span style="color: #BA2121">&quot;size&quot;</span>: metadata[<span style="color: #BA2121">&quot;size&quot;</span>],
                }
                <span style="color: #008000; font-weight: bold">if</span> metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;needs_ocr&quot;</span>):
                    job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;needs_ocr&quot;</span>, [])<span style="color: #666666">.</span>append(
                        {
                            <span style="color: #BA2121">&quot;path&quot;</span>: metadata[<span style="color: #BA2121">&quot;path&quot;</span>],
                            <span style="color: #BA2121">&quot;message&quot;</span>: metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;ocr_message&quot;</span>),
                        }
                    )
            <span style="color: #008000; font-weight: bold">elif</span> result[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;skipped&quot;</span>:
                job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;skipped&quot;</span>] <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
            <span style="color: #008000; font-weight: bold">elif</span> result[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;removed&quot;</span>:
                job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;succeeded&quot;</span>] <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
                removed_path <span style="color: #666666">=</span> result[<span style="color: #BA2121">&quot;metadata&quot;</span>][<span style="color: #BA2121">&quot;path&quot;</span>]
                <span style="color: #008000; font-weight: bold">if</span> removed_path <span style="color: #AA22FF; font-weight: bold">in</span> known_files:
                    known_files<span style="color: #666666">.</span>pop(removed_path, <span style="color: #008000; font-weight: bold">None</span>)
                job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;removed&quot;</span>, [])<span style="color: #666666">.</span>append(removed_path)
            <span style="color: #008000; font-weight: bold">if</span> result<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;error&quot;</span>):
                job<span style="color: #666666">.</span>errors<span style="color: #666666">.</span>append(result[<span style="color: #BA2121">&quot;error&quot;</span>])
                job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;failed&quot;</span>] <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job)

        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>job_type <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;rescan&quot;</span>:
            snapshot <span style="color: #666666">=</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>, {})
            current_paths <span style="color: #666666">=</span> {<span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(Path(path)) <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> files}
            removed <span style="color: #666666">=</span> [path <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> snapshot<span style="color: #666666">.</span>keys() <span style="color: #008000; font-weight: bold">if</span> path <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> current_paths]
            <span style="color: #008000; font-weight: bold">if</span> removed:
                job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;removed&quot;</span>, [])<span style="color: #666666">.</span>extend(removed)
                <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> removed:
                    known_files<span style="color: #666666">.</span>pop(path, <span style="color: #008000; font-weight: bold">None</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>delete_by_paths(removed)
        job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;processed_files&quot;</span>] <span style="color: #666666">=</span> processed_files
        job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;pending_files&quot;</span>] <span style="color: #666666">=</span> files
</code></pre>
<h3 id="_handle_path">Method: _handle_path(self, job: IngestJob, path: Path) -&gt; dict[str, Any]</h3>
<p>The function `_handle_path` processes a file path based on the type of ingestion job specified in `job`. It handles three main cases: removing a file, rescanning a file, or ingesting a new file. For removal jobs, it deletes document versions from the database and returns metadata about the removed files. For missing files, it skips processing and returns an error. For valid files, it computes file metadata including checksum, size, and modification time. During rescan jobs, it compares current file metadata with previously known metadata to determine if reprocessing is needed. If parsing fails, it records the error and returns a failure status. On successful parsing, it stores the parsed content in the database and returns detailed metadata about the processed document, including version information, preview, OCR status, and parser metadata.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_handle_path</span>(<span style="color: #008000">self</span>, job: IngestJob, path: Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>job_type <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;remove&quot;</span>:
            normalized <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(path)
            removed <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>delete_by_paths([normalized])
            metadata <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;path&quot;</span>: normalized, <span style="color: #BA2121">&quot;removed_versions&quot;</span>: removed}
            <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;removed&quot;</span>, <span style="color: #BA2121">&quot;metadata&quot;</span>: metadata}

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path<span style="color: #666666">.</span>exists():
            <span style="color: #008000; font-weight: bold">return</span> {
                <span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;skipped&quot;</span>,
                <span style="color: #BA2121">&quot;metadata&quot;</span>: {<span style="color: #BA2121">&quot;path&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(path)},
                <span style="color: #BA2121">&quot;error&quot;</span>: <span style="color: #BA2121">f&quot;Missing file: </span><span style="color: #A45A77; font-weight: bold">{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            }

        stat <span style="color: #666666">=</span> path<span style="color: #666666">.</span>stat()
        metadata <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;path&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(path),
            <span style="color: #BA2121">&quot;mtime&quot;</span>: stat<span style="color: #666666">.</span>st_mtime,
            <span style="color: #BA2121">&quot;size&quot;</span>: stat<span style="color: #666666">.</span>st_size,
            <span style="color: #BA2121">&quot;checksum&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>_hash_file(path),
        }

        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>job_type <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;rescan&quot;</span>:
            previous <span style="color: #666666">=</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>, {})<span style="color: #666666">.</span>get(metadata[<span style="color: #BA2121">&quot;path&quot;</span>])
            <span style="color: #008000; font-weight: bold">if</span> previous <span style="color: #AA22FF; font-weight: bold">and</span> previous<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;mtime&quot;</span>) <span style="color: #666666">==</span> metadata[<span style="color: #BA2121">&quot;mtime&quot;</span>] <span style="color: #AA22FF; font-weight: bold">and</span> previous<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;checksum&quot;</span>) <span style="color: #666666">==</span> metadata[<span style="color: #BA2121">&quot;checksum&quot;</span>]:
                <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;skipped&quot;</span>, <span style="color: #BA2121">&quot;metadata&quot;</span>: metadata}

        <span style="color: #008000; font-weight: bold">try</span>:
            parsed <span style="color: #666666">=</span> parse_file(path)
        <span style="color: #008000; font-weight: bold">except</span> ParserError <span style="color: #008000; font-weight: bold">as</span> exc:
            metadata[<span style="color: #BA2121">&quot;parser_error&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">str</span>(exc)
            <span style="color: #008000; font-weight: bold">return</span> {
                <span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;failed&quot;</span>,
                <span style="color: #BA2121">&quot;metadata&quot;</span>: metadata,
                <span style="color: #BA2121">&quot;error&quot;</span>: <span style="color: #008000">str</span>(exc),
            }
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
            metadata[<span style="color: #BA2121">&quot;parser_error&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">str</span>(exc)
            <span style="color: #008000; font-weight: bold">return</span> {
                <span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;failed&quot;</span>,
                <span style="color: #BA2121">&quot;metadata&quot;</span>: metadata,
                <span style="color: #BA2121">&quot;error&quot;</span>: <span style="color: #008000">str</span>(exc),
            }

        base_metadata <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;file&quot;</span>: {
                <span style="color: #BA2121">&quot;size&quot;</span>: stat<span style="color: #666666">.</span>st_size,
                <span style="color: #BA2121">&quot;mtime&quot;</span>: stat<span style="color: #666666">.</span>st_mtime,
                <span style="color: #BA2121">&quot;ctime&quot;</span>: stat<span style="color: #666666">.</span>st_ctime,
                <span style="color: #BA2121">&quot;checksum&quot;</span>: metadata[<span style="color: #BA2121">&quot;checksum&quot;</span>],
            }
        }
        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>store_version(
            path<span style="color: #666666">=</span>metadata[<span style="color: #BA2121">&quot;path&quot;</span>],
            checksum<span style="color: #666666">=</span>metadata[<span style="color: #BA2121">&quot;checksum&quot;</span>],
            size<span style="color: #666666">=</span>stat<span style="color: #666666">.</span>st_size,
            mtime<span style="color: #666666">=</span>stat<span style="color: #666666">.</span>st_mtime,
            ctime<span style="color: #666666">=</span>stat<span style="color: #666666">.</span>st_ctime,
            parsed<span style="color: #666666">=</span>parsed,
            base_metadata<span style="color: #666666">=</span>base_metadata,
        )
        metadata[<span style="color: #BA2121">&quot;document_id&quot;</span>] <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>)
        metadata[<span style="color: #BA2121">&quot;version&quot;</span>] <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;version&quot;</span>)
        metadata[<span style="color: #BA2121">&quot;preview&quot;</span>] <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;preview&quot;</span>)
        metadata[<span style="color: #BA2121">&quot;needs_ocr&quot;</span>] <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;needs_ocr&quot;</span>, <span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;ocr_message&quot;</span>):
            metadata[<span style="color: #BA2121">&quot;ocr_message&quot;</span>] <span style="color: #666666">=</span> record[<span style="color: #BA2121">&quot;ocr_message&quot;</span>]
        metadata[<span style="color: #BA2121">&quot;parser_metadata&quot;</span>] <span style="color: #666666">=</span> parsed<span style="color: #666666">.</span>metadata

        <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;success&quot;</span>, <span style="color: #BA2121">&quot;metadata&quot;</span>: metadata}
</code></pre>
<h3 id="_discover_files">Method: _discover_files(self, job: IngestJob) -&gt; list[str]</h3>
<p>The function `_discover_files` identifies and returns a list of file paths based on the type of ingestion job specified in the `IngestJob` object. For a &quot;single_file&quot; job, it processes individual files listed in the job parameters, applying include and exclude filters relative to a base directory. For a &quot;remove&quot; job, it normalizes and returns the paths of files specified for removal. For other job types, it recursively discovers all files under a specified root directory, applying include and exclude filters to determine which files to include in the result. The returned list is deduplicated and sorted.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_discover_files</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>job_type <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;single_file&quot;</span>:
            files <span style="color: #666666">=</span> [Path(path) <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;files&quot;</span>, [])]
            include <span style="color: #666666">=</span> job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
            exclude <span style="color: #666666">=</span> job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;exclude&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
            base <span style="color: #666666">=</span> Path(job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;root&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> Path(files[<span style="color: #666666">0</span>])<span style="color: #666666">.</span>parent) <span style="color: #008000; font-weight: bold">if</span> files <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            result: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">for</span> file_path <span style="color: #AA22FF; font-weight: bold">in</span> files:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> file_path<span style="color: #666666">.</span>exists():
                    <span style="color: #008000; font-weight: bold">continue</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_matches_filters(file_path, include, exclude, base):
                    result<span style="color: #666666">.</span>append(<span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(file_path))
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">sorted</span>(<span style="color: #008000">dict</span><span style="color: #666666">.</span>fromkeys(result))

        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>job_type <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;remove&quot;</span>:
            files <span style="color: #666666">=</span> [<span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(Path(path)) <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;files&quot;</span>, [])]
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">sorted</span>(<span style="color: #008000">dict</span><span style="color: #666666">.</span>fromkeys(files))

        root <span style="color: #666666">=</span> Path(job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;root&quot;</span>, <span style="color: #BA2121">&quot;.&quot;</span>))<span style="color: #666666">.</span>resolve()
        include <span style="color: #666666">=</span> job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
        exclude <span style="color: #666666">=</span> job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;exclude&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> root<span style="color: #666666">.</span>exists():
            <span style="color: #008000; font-weight: bold">return</span> []
        result: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> file_path <span style="color: #AA22FF; font-weight: bold">in</span> root<span style="color: #666666">.</span>rglob(<span style="color: #BA2121">&quot;*&quot;</span>):
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> file_path<span style="color: #666666">.</span>is_file():
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_matches_filters(file_path, include, exclude, root):
                result<span style="color: #666666">.</span>append(<span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(file_path))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">sorted</span>(<span style="color: #008000">dict</span><span style="color: #666666">.</span>fromkeys(result))
</code></pre>
<h3 id="_matches_filters">Method: _matches_filters(self, path: Path, include: Iterable[str], exclude: Iterable[str], base: Path | None) -&gt; bool</h3>
<p>The function `_matches_filters` determines whether a given file path matches specified inclusion and exclusion patterns. It accepts a file path, lists of include and exclude patterns, and an optional base path for relative normalization. The function normalizes the path for pattern matching, considering both the file&#x27;s name and its relative path from the base. It evaluates each pattern against multiple variations of the path (case-sensitive and case-insensitive, with normalized forward slashes) to check for matches. The function returns `True` if the path matches all inclusion patterns (if any are specified) and does not match any exclusion patterns.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_matches_filters</span>(
        <span style="color: #008000">self</span>,
        path: Path,
        include: Iterable[<span style="color: #008000">str</span>],
        exclude: Iterable[<span style="color: #008000">str</span>],
        base: Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">fnmatch</span> <span style="color: #008000; font-weight: bold">import</span> fnmatch

        relative <span style="color: #666666">=</span> path<span style="color: #666666">.</span>name
        <span style="color: #008000; font-weight: bold">if</span> base <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">try</span>:
                relative <span style="color: #666666">=</span> <span style="color: #008000">str</span>(path<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>relative_to(base<span style="color: #666666">.</span>resolve()))
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
                relative <span style="color: #666666">=</span> path<span style="color: #666666">.</span>name

        include_patterns <span style="color: #666666">=</span> <span style="color: #008000">list</span>(include)
        exclude_patterns <span style="color: #666666">=</span> <span style="color: #008000">list</span>(exclude)

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_matches</span>(pattern: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
            normalized_relative <span style="color: #666666">=</span> relative<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\\</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;/&quot;</span>)
            normalized_pattern <span style="color: #666666">=</span> pattern<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\\</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;/&quot;</span>)
            candidates <span style="color: #666666">=</span> [
                relative,
                relative<span style="color: #666666">.</span>lower(),
                normalized_relative,
                normalized_relative<span style="color: #666666">.</span>lower(),
                path<span style="color: #666666">.</span>name,
                path<span style="color: #666666">.</span>name<span style="color: #666666">.</span>lower(),
            ]
            patterns <span style="color: #666666">=</span> [pattern, pattern<span style="color: #666666">.</span>lower(), normalized_pattern, normalized_pattern<span style="color: #666666">.</span>lower()]
            <span style="color: #008000; font-weight: bold">for</span> candidate <span style="color: #AA22FF; font-weight: bold">in</span> candidates:
                <span style="color: #008000; font-weight: bold">for</span> current <span style="color: #AA22FF; font-weight: bold">in</span> patterns:
                    <span style="color: #008000; font-weight: bold">if</span> fnmatch(candidate, current):
                        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>

        <span style="color: #008000; font-weight: bold">if</span> include_patterns <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">any</span>(_matches(pattern) <span style="color: #008000; font-weight: bold">for</span> pattern <span style="color: #AA22FF; font-weight: bold">in</span> include_patterns):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">if</span> exclude_patterns <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">any</span>(_matches(pattern) <span style="color: #008000; font-weight: bold">for</span> pattern <span style="color: #AA22FF; font-weight: bold">in</span> exclude_patterns):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
</code></pre>
<details>
<summary>Subfunction: _matches(pattern: str) -&gt; bool</summary>
<h4 id="_matches">_matches(pattern: str) -&gt; bool</h4>
<p>The function `_matches` determines whether a given file path matches a specified pattern using multiple normalization and case variations. It converts backslashes to forward slashes in both the file path and the pattern for consistent comparison. The function tests the file path and its name against the pattern in various combinations of original and lowercase forms, utilizing `fnmatch` for pattern matching. It returns `True` if any combination results in a match, otherwise `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_matches</span>(pattern: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
            normalized_relative <span style="color: #666666">=</span> relative<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\\</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;/&quot;</span>)
            normalized_pattern <span style="color: #666666">=</span> pattern<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\\</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;/&quot;</span>)
            candidates <span style="color: #666666">=</span> [
                relative,
                relative<span style="color: #666666">.</span>lower(),
                normalized_relative,
                normalized_relative<span style="color: #666666">.</span>lower(),
                path<span style="color: #666666">.</span>name,
                path<span style="color: #666666">.</span>name<span style="color: #666666">.</span>lower(),
            ]
            patterns <span style="color: #666666">=</span> [pattern, pattern<span style="color: #666666">.</span>lower(), normalized_pattern, normalized_pattern<span style="color: #666666">.</span>lower()]
            <span style="color: #008000; font-weight: bold">for</span> candidate <span style="color: #AA22FF; font-weight: bold">in</span> candidates:
                <span style="color: #008000; font-weight: bold">for</span> current <span style="color: #AA22FF; font-weight: bold">in</span> patterns:
                    <span style="color: #008000; font-weight: bold">if</span> fnmatch(candidate, current):
                        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
</details>
<h3 id="_handle_cancel">Method: _handle_cancel(self, job: IngestJob) -&gt; None</h3>
<p>The function `_handle_cancel` processes the cancellation of an `IngestJob` by rolling back the job, updating its status to `CANCELLED`, and persisting the updated status.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_handle_cancel</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_rollback_job(job)
        job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> TaskStatus<span style="color: #666666">.</span>CANCELLED
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>CANCELLED, completed<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
</code></pre>
<h3 id="_rollback_job">Method: _rollback_job(self, job: IngestJob) -&gt; None</h3>
<p>The `_rollback_job` function performs a rollback operation for an `IngestJob` by restoring the known files snapshot, updating job progress and summary counters to reflect the rollback, and resetting counters that represent committed work. It ensures the UI accurately reflects the rollback state by adjusting progress tracking and summary statistics.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_rollback_job</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        snapshot <span style="color: #666666">=</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>, {})
        job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;known_files&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(snapshot)
        job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;rolled_back&quot;</span>, <span style="color: #666666">0</span>)
        job<span style="color: #666666">.</span>summary[<span style="color: #BA2121">&quot;rolled_back&quot;</span>] <span style="color: #666666">+=</span> job<span style="color: #666666">.</span>progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;succeeded&quot;</span>, <span style="color: #666666">0</span>)
        <span style="color: #3D7B7B; font-style: italic"># Reset counters that represent committed work so the UI reflects rollback.</span>
        job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;succeeded&quot;</span>] <span style="color: #666666">=</span> <span style="color: #666666">0</span>
        job<span style="color: #666666">.</span>progress[<span style="color: #BA2121">&quot;processed&quot;</span>] <span style="color: #666666">=</span> job<span style="color: #666666">.</span>progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;skipped&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #666666">+</span> job<span style="color: #666666">.</span>progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;failed&quot;</span>, <span style="color: #666666">0</span>)
        job<span style="color: #666666">.</span>summary[<span style="color: #BA2121">&quot;known_files&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(snapshot)
        job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;processed_files&quot;</span>] <span style="color: #666666">=</span> []
</code></pre>
<h3 id="_fail_job">Method: _fail_job(self, job: IngestJob, exc: Exception) -&gt; None</h3>
<p>The function `_fail_job` updates an `IngestJob` object to reflect a failed status when an exception occurs during ingestion. It sets the job&#x27;s status to `FAILED`, appends the string representation of the exception to the job&#x27;s errors list, and persists the updated job state with a failure message and completed flag.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_fail_job</span>(<span style="color: #008000">self</span>, job: IngestJob, exc: <span style="color: #CB3F38; font-weight: bold">Exception</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> TaskStatus<span style="color: #666666">.</span>FAILED
        job<span style="color: #666666">.</span>errors<span style="color: #666666">.</span>append(<span style="color: #008000">str</span>(exc))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>FAILED, message<span style="color: #666666">=</span><span style="color: #008000">str</span>(exc), completed<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
</code></pre>
<h3 id="_complete_job">Method: _complete_job(self, job: IngestJob) -&gt; None</h3>
<p>The function `_complete_job` updates the status of an `IngestJob` to `COMPLETED` and populates its summary with progress and error information. It ensures that counts for successful, failed, skipped, and removed files are set in the job&#x27;s summary, and it cleans up the job&#x27;s state by removing temporary data and syncing project documents. Finally, it persists the completed job&#x27;s state and status.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_complete_job</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> TaskStatus<span style="color: #666666">.</span>COMPLETED
        job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;success_count&quot;</span>, job<span style="color: #666666">.</span>progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;succeeded&quot;</span>, <span style="color: #666666">0</span>))
        job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;failure_count&quot;</span>, job<span style="color: #666666">.</span>progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;failed&quot;</span>, <span style="color: #666666">0</span>))
        job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;skipped_count&quot;</span>, job<span style="color: #666666">.</span>progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;skipped&quot;</span>, <span style="color: #666666">0</span>))
        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;removed&quot;</span>):
            job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;removed_count&quot;</span>, <span style="color: #008000">len</span>(job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;removed&quot;</span>, [])))
        job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;rolled_back&quot;</span>, <span style="color: #666666">0</span>)
        job<span style="color: #666666">.</span>summary[<span style="color: #BA2121">&quot;known_files&quot;</span>] <span style="color: #666666">=</span> job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {})
        job<span style="color: #666666">.</span>summary[<span style="color: #BA2121">&quot;total_files&quot;</span>] <span style="color: #666666">=</span> job<span style="color: #666666">.</span>progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;total&quot;</span>, <span style="color: #666666">0</span>)
        job<span style="color: #666666">.</span>summary[<span style="color: #BA2121">&quot;errors&quot;</span>] <span style="color: #666666">=</span> job<span style="color: #666666">.</span>errors
        job<span style="color: #666666">.</span>state<span style="color: #666666">.</span>pop(<span style="color: #BA2121">&quot;known_files_snapshot&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>)
        job<span style="color: #666666">.</span>state[<span style="color: #BA2121">&quot;processed_files&quot;</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_project_documents(job)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>COMPLETED, completed<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
</code></pre>
<h3 id="_check_pause_cancel">Method: _check_pause_cancel(self, job: IngestJob) -&gt; None</h3>
<p>The function `_check_pause_cancel` checks whether an ingestion job has been cancelled or paused. If the job is cancelled, it persists the job state and raises a `_JobCancelled` exception. If the job is paused, it updates the job&#x27;s status to `PAUSED`, persists the status, and raises a `_JobPaused` exception.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_check_pause_cancel</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>cancel_event<span style="color: #666666">.</span>is_set():
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job)
            <span style="color: #008000; font-weight: bold">raise</span> _JobCancelled
        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>pause_event<span style="color: #666666">.</span>is_set():
            job<span style="color: #666666">.</span>status <span style="color: #666666">=</span> TaskStatus<span style="color: #666666">.</span>PAUSED
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist(job, status<span style="color: #666666">=</span>TaskStatus<span style="color: #666666">.</span>PAUSED)
            <span style="color: #008000; font-weight: bold">raise</span> _JobPaused
</code></pre>
<h3 id="_persist">Method: _persist(self, job: IngestJob, *, status: str | None=None, message: str | None=None, completed: bool=False) -&gt; None</h3>
<p>The function `_persist` updates the persistence state of an `IngestJob` by serializing its data and storing it in the repository. It allows updating the job&#x27;s status, message, and completion timestamp. The function emits an event after the update is complete.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_persist</span>(
        <span style="color: #008000">self</span>,
        job: IngestJob,
        <span style="color: #666666">*</span>,
        status: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        message: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        completed: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        payload <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_serialize(job)
        completed_at <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_utcnow() <span style="color: #008000; font-weight: bold">if</span> completed <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>repo<span style="color: #666666">.</span>update(
            job<span style="color: #666666">.</span>job_id,
            status<span style="color: #666666">=</span>status,
            message<span style="color: #666666">=</span>message,
            extra_data<span style="color: #666666">=</span>payload,
            completed_at<span style="color: #666666">=</span>completed_at,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit(job<span style="color: #666666">.</span>job_id)
</code></pre>
<h3 id="_serialize">Method: _serialize(self, job: IngestJob) -&gt; dict[str, Any]</h3>
<p>The function `_serialize` converts an `IngestJob` object into a dictionary representation. It extracts and serializes the job&#x27;s type, parameters, progress, errors, summary, and state into a structured format for storage or transmission. The job&#x27;s state is further serialized using a helper method `_serialize_state`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_serialize</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        <span style="color: #008000; font-weight: bold">return</span> {
            <span style="color: #BA2121">&quot;job&quot;</span>: {<span style="color: #BA2121">&quot;type&quot;</span>: job<span style="color: #666666">.</span>job_type, <span style="color: #BA2121">&quot;params&quot;</span>: job<span style="color: #666666">.</span>params},
            <span style="color: #BA2121">&quot;progress&quot;</span>: <span style="color: #008000">dict</span>(job<span style="color: #666666">.</span>progress),
            <span style="color: #BA2121">&quot;errors&quot;</span>: <span style="color: #008000">list</span>(job<span style="color: #666666">.</span>errors),
            <span style="color: #BA2121">&quot;summary&quot;</span>: <span style="color: #008000">dict</span>(job<span style="color: #666666">.</span>summary),
            <span style="color: #BA2121">&quot;state&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>_serialize_state(job<span style="color: #666666">.</span>state),
        }
</code></pre>
<h3 id="_sync_project_documents">Method: _sync_project_documents(self, job: IngestJob) -&gt; None</h3>
<p>The function `_sync_project_documents` synchronizes the list of documents in a project with the files reported by an ingestion job. It retrieves the project ID from the job parameters and verifies the project&#x27;s existence in the database. It then fetches existing documents for the project, normalizing their paths for comparison.

For each file reported as known in the job summary, it checks if the file already exists in the project. If not, it creates a new document entry; otherwise, it updates the metadata of the existing document if changes are detected.

It also processes a list of removed files from the job summary and deletes corresponding document entries from the project if they match the removed paths.

The function handles exceptions gracefully during database operations and path normalization, ensuring that errors do not halt the synchronization process. It uses a defensive programming approach to avoid crashes due to unexpected data types or database issues.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sync_project_documents</span>(<span style="color: #008000">self</span>, job: IngestJob) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project_id <span style="color: #666666">=</span> job<span style="color: #666666">.</span>params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;project_id&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(project_id, <span style="color: #008000">int</span>):
            <span style="color: #008000; font-weight: bold">return</span>

        repo <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_documents
        <span style="color: #008000; font-weight: bold">try</span>:
            connection <span style="color: #666666">=</span> repo<span style="color: #666666">.</span>db<span style="color: #666666">.</span>connect()
            project_exists <span style="color: #666666">=</span> connection<span style="color: #666666">.</span>execute(
                <span style="color: #BA2121">&quot;SELECT 1 FROM projects WHERE id = ?&quot;</span>,
                (project_id,),
            )<span style="color: #666666">.</span>fetchone()
            <span style="color: #008000; font-weight: bold">if</span> project_exists <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">return</span>
            existing_docs <span style="color: #666666">=</span> {
                <span style="color: #008000">str</span>(Path(doc[<span style="color: #BA2121">&quot;source_path&quot;</span>])<span style="color: #666666">.</span>resolve()): doc
                <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> repo<span style="color: #666666">.</span>list_for_project(project_id)
                <span style="color: #008000; font-weight: bold">if</span> doc<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
            }
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
            <span style="color: #008000; font-weight: bold">return</span>

        known_files_param <span style="color: #666666">=</span> job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {})
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(known_files_param, <span style="color: #008000">dict</span>):
            known_files_param <span style="color: #666666">=</span> {}

        normalized_known: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> path, metadata <span style="color: #AA22FF; font-weight: bold">in</span> known_files_param<span style="color: #666666">.</span>items():
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(path, <span style="color: #008000">str</span>):
                <span style="color: #008000; font-weight: bold">continue</span>
            normalized_path <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve())
            data <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(metadata) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(metadata, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
            normalized_known[normalized_path] <span style="color: #666666">=</span> data
            document <span style="color: #666666">=</span> existing_docs<span style="color: #666666">.</span>get(normalized_path)
            payload <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;file&quot;</span>: data}
            <span style="color: #008000; font-weight: bold">if</span> document <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                title <span style="color: #666666">=</span> Path(normalized_path)<span style="color: #666666">.</span>stem <span style="color: #AA22FF; font-weight: bold">or</span> Path(normalized_path)<span style="color: #666666">.</span>name
                <span style="color: #008000; font-weight: bold">try</span>:
                    repo<span style="color: #666666">.</span>create(
                        project_id,
                        title,
                        source_type<span style="color: #666666">=</span><span style="color: #BA2121">&quot;file&quot;</span>,
                        source_path<span style="color: #666666">=</span>normalized_path,
                        metadata<span style="color: #666666">=</span>payload,
                    )
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
                    <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                updates: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
                <span style="color: #008000; font-weight: bold">if</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>) <span style="color: #666666">!=</span> normalized_path:
                    updates[<span style="color: #BA2121">&quot;source_path&quot;</span>] <span style="color: #666666">=</span> normalized_path
                current_meta <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;metadata&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
                <span style="color: #008000; font-weight: bold">if</span> current_meta<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;file&quot;</span>) <span style="color: #666666">!=</span> data:
                    updates[<span style="color: #BA2121">&quot;metadata&quot;</span>] <span style="color: #666666">=</span> payload
                <span style="color: #008000; font-weight: bold">if</span> updates:
                    <span style="color: #008000; font-weight: bold">try</span>:
                        repo<span style="color: #666666">.</span>update(document[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #666666">**</span>updates)
                    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
                        <span style="color: #008000; font-weight: bold">continue</span>

        removed_paths: <span style="color: #008000">set</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        removed <span style="color: #666666">=</span> job<span style="color: #666666">.</span>summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;removed&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(removed, (<span style="color: #008000">list</span>, <span style="color: #008000">tuple</span>, <span style="color: #008000">set</span>)):
            <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> removed:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(entry, <span style="color: #008000">str</span>):
                    <span style="color: #008000; font-weight: bold">continue</span>
                removed_paths<span style="color: #666666">.</span>add(<span style="color: #008000">str</span>(Path(entry)<span style="color: #666666">.</span>resolve()))

        <span style="color: #008000; font-weight: bold">if</span> removed_paths:
            <span style="color: #008000; font-weight: bold">for</span> document <span style="color: #AA22FF; font-weight: bold">in</span> repo<span style="color: #666666">.</span>list_for_project(project_id):
                source_path <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> source_path:
                    <span style="color: #008000; font-weight: bold">continue</span>
                normalized <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(source_path)<span style="color: #666666">.</span>resolve())
                <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #AA22FF; font-weight: bold">in</span> removed_paths:
                    <span style="color: #008000; font-weight: bold">try</span>:
                        repo<span style="color: #666666">.</span>delete(document[<span style="color: #BA2121">&quot;id&quot;</span>])
                    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
                        <span style="color: #008000; font-weight: bold">continue</span>
</code></pre>
<h3 id="_serialize_state">Method: _serialize_state(state: dict[str, Any]) -&gt; dict[str, Any]</h3>
<p>The function `_serialize_state` takes a dictionary `state` as input and returns a new dictionary where all values that are instances of `Path` have been converted to their string representation. For all other values, the original value is preserved in the returned dictionary. This ensures that the state can be serialized properly, particularly for storage or transmission purposes where path objects need to be represented as strings.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_serialize_state</span>(state: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        serialized: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> state<span style="color: #666666">.</span>items():
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(value, Path):
                serialized[key] <span style="color: #666666">=</span> <span style="color: #008000">str</span>(value)
            <span style="color: #008000; font-weight: bold">else</span>:
                serialized[key] <span style="color: #666666">=</span> value
        <span style="color: #008000; font-weight: bold">return</span> serialized
</code></pre>
<h3 id="_record_to_job">Method: _record_to_job(self, record: dict[str, Any]) -&gt; IngestJob</h3>
<p>The function `_record_to_job` converts a dictionary representation of a task record into an `IngestJob` object. It extracts various fields from the input dictionary, such as job type, parameters, status, progress, errors, summary, and state, and uses them to initialize the `IngestJob`. The function ensures default values are set for the job and handles the case where the job&#x27;s status is paused by setting an internal pause event. Finally, it returns the constructed `IngestJob` instance.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_record_to_job</span>(<span style="color: #008000">self</span>, record: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> IngestJob:
        extra <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;extra_data&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
        job_data <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;job&quot;</span>, {})
        progress <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {})
        errors <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;errors&quot;</span>, [])
        summary <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, {})
        state <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;state&quot;</span>, {})
        job <span style="color: #666666">=</span> IngestJob(
            job_id<span style="color: #666666">=</span>record[<span style="color: #BA2121">&quot;id&quot;</span>],
            job_type<span style="color: #666666">=</span>job_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;type&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;task_name&quot;</span>, <span style="color: #BA2121">&quot;ingest.unknown&quot;</span>)<span style="color: #666666">.</span>split(<span style="color: #BA2121">&quot;.&quot;</span>)[<span style="color: #666666">-1</span>],
            params<span style="color: #666666">=</span>job_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;params&quot;</span>, {}),
            status<span style="color: #666666">=</span>record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>, TaskStatus<span style="color: #666666">.</span>QUEUED),
            progress<span style="color: #666666">=</span><span style="color: #008000">dict</span>(progress),
            errors<span style="color: #666666">=</span><span style="color: #008000">list</span>(errors),
            summary<span style="color: #666666">=</span><span style="color: #008000">dict</span>(summary),
            state<span style="color: #666666">=</span><span style="color: #008000">dict</span>(state),
        )
        job<span style="color: #666666">.</span>ensure_defaults()
        <span style="color: #008000; font-weight: bold">if</span> job<span style="color: #666666">.</span>status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>PAUSED:
            job<span style="color: #666666">.</span>pause_event<span style="color: #666666">.</span>set()
        <span style="color: #008000; font-weight: bold">return</span> job
</code></pre>
<h3 id="_emit">Method: _emit(self, job_id: int) -&gt; None</h3>
<p>The function `_emit` processes a job identified by `job_id` by retrieving it from `self._jobs`, serializing its data, and appending the job&#x27;s status to the serialized payload. It then iterates through all registered subscribers in `self._subscribers`, invoking each callback with the `job_id` and the constructed payload. Any exceptions raised during callback execution are caught and ignored, ensuring that one failing subscriber does not prevent others from being notified.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_emit</span>(<span style="color: #008000">self</span>, job_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_jobs<span style="color: #666666">.</span>get(job_id)
        <span style="color: #008000; font-weight: bold">if</span> job <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        payload <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_serialize(job)
        payload[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">=</span> job<span style="color: #666666">.</span>status
        <span style="color: #008000; font-weight: bold">for</span> callback <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_subscribers):
            <span style="color: #008000; font-weight: bold">try</span>:
                callback(job_id, payload)
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
                <span style="color: #008000; font-weight: bold">continue</span>
</code></pre>
<h3 id="_load_known_files">Method: _load_known_files(self, root: str) -&gt; dict[str, Any]</h3>
<p>The function `_load_known_files` retrieves a dictionary of known files associated with a specified root directory from completed tasks stored in the repository. It iterates through specific task names related to ingestion processes, checks for records matching the given root path, and extracts file information from the task&#x27;s summary data. If matching files are found, they are returned as a dictionary; otherwise, an empty dictionary is returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_load_known_files</span>(<span style="color: #008000">self</span>, root: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        root_path <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(root)<span style="color: #666666">.</span>resolve())
        known_files: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> task_name <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;ingest.rescan&quot;</span>, <span style="color: #BA2121">&quot;ingest.folder_crawl&quot;</span>):
            <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>repo<span style="color: #666666">.</span>list_completed(task_name):
                extra <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;extra_data&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
                job_data <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;job&quot;</span>, {})
                params <span style="color: #666666">=</span> job_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;params&quot;</span>, {})
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(params<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;root&quot;</span>)) <span style="color: #666666">!=</span> root_path:
                    <span style="color: #008000; font-weight: bold">continue</span>
                summary <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, {})
                files <span style="color: #666666">=</span> summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> files:
                    known_files <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(files)
                    <span style="color: #008000; font-weight: bold">return</span> known_files
        <span style="color: #008000; font-weight: bold">return</span> known_files
</code></pre>
<h3 id="_normalize_path">Method: _normalize_path(path: Path) -&gt; str</h3>
<p>The function `_normalize_path` takes a `Path` object as input and returns its normalized string representation. It achieves this by resolving the path to eliminate any relative components and then converting it to a string. This ensures that the returned path is absolute and free of symbolic links or redundant directory separators.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalize_path</span>(path: Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(path<span style="color: #666666">.</span>resolve())
</code></pre>
<h3 id="_hash_file">Method: _hash_file(path: Path) -&gt; str</h3>
<p>The function `_hash_file` computes a SHA-256 hash of the contents of a file located at the specified path. It reads the file in chunks of 65,536 bytes to efficiently handle large files and updates the hash digest with each chunk. The resulting hash is returned as a hexadecimal string.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_hash_file</span>(path: Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        digest <span style="color: #666666">=</span> hashlib<span style="color: #666666">.</span>sha256()
        <span style="color: #008000; font-weight: bold">with</span> path<span style="color: #666666">.</span>open(<span style="color: #BA2121">&quot;rb&quot;</span>) <span style="color: #008000; font-weight: bold">as</span> handle:
            <span style="color: #008000; font-weight: bold">for</span> chunk <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">iter</span>(<span style="color: #008000; font-weight: bold">lambda</span>: handle<span style="color: #666666">.</span>read(<span style="color: #666666">65536</span>), <span style="color: #BA2121">b&quot;&quot;</span>):
                digest<span style="color: #666666">.</span>update(chunk)
        <span style="color: #008000; font-weight: bold">return</span> digest<span style="color: #666666">.</span>hexdigest()
</code></pre>
<h3 id="_utcnow">Method: _utcnow() -&gt; str</h3>
<p>The function `_utcnow()` returns the current UTC date and time in ISO 8601 format as a string. It imports `datetime` and `timezone` from the `datetime` module, gets the current date and time with UTC timezone information, and formats it as an ISO string.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_utcnow</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">datetime</span> <span style="color: #008000; font-weight: bold">import</span> datetime, timezone

        <span style="color: #008000; font-weight: bold">return</span> datetime<span style="color: #666666">.</span>now(timezone<span style="color: #666666">.</span>utc)<span style="color: #666666">.</span>isoformat()
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
