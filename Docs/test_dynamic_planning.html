<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_dynamic_planning</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_dynamic_planning</h1>
        <p>Module defines a stub client for testing chat interactions and includes tests for conversation management with dynamic plans. The stub client simulates chat responses with deterministic outputs and captures request data. Tests verify plan execution, citation handling, and reasoning artifacts when citations are absent. A context provider supplies evidence for steps in the conversation.</p>
<h2 id="StubLMStudioClient">Class: StubLMStudioClient</h2>
<p>The `StubLMStudioClient` class is a deterministic test client that records chat invocations in a list of requests. It implements a `chat` method that returns a fixed `ChatMessage` response with incremental content and citations based on the invocation order. The class also includes a `health_check` method that always returns `True`.</p>
<h3 id="__init__">Method: __init__(self) -&gt; None</h3>
<p>Initializes an instance of `StubLMStudioClient` with an empty list to store requests.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>requests: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]] <span style="color: #666666">=</span> []
</code></pre>
<h3 id="health_check">Method: health_check(self) -&gt; bool</h3>
<p>The `health_check` method of the `StubLMStudioClient` class always returns `True`, indicating a successful health status. This implementation is a stub that does not perform any actual health verification.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">health_check</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
</code></pre>
<h3 id="chat">Method: chat(self, messages, *, preset, extra_options=None) -&gt; ChatMessage</h3>
<p>The `chat` method in the `StubLMStudioClient` class simulates a chat interaction by generating a placeholder response. It takes a list of messages, a preset, and optional extra options, then appends the messages and options to an internal requests list. The method returns a `ChatMessage` object containing placeholder content, a single citation entry with an ID, source, and snippet, and no reasoning or raw response data. The content string includes a step number based on the request index, and the citation reflects the same step number for identification.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">chat</span>(<span style="color: #008000">self</span>, messages, <span style="color: #666666">*</span>, preset, extra_options<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> ChatMessage:  <span style="color: #3D7B7B; font-style: italic"># type: ignore[override]</span>
        index <span style="color: #666666">=</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>requests) <span style="color: #666666">+</span> <span style="color: #666666">1</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>requests<span style="color: #666666">.</span>append({<span style="color: #BA2121">&quot;messages&quot;</span>: <span style="color: #008000">list</span>(messages), <span style="color: #BA2121">&quot;options&quot;</span>: extra_options})
        content <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Step </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> finding&quot;</span>
        citations <span style="color: #666666">=</span> [
            {
                <span style="color: #BA2121">&quot;id&quot;</span>: <span style="color: #BA2121">f&quot;doc-</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
                <span style="color: #BA2121">&quot;source&quot;</span>: <span style="color: #BA2121">f&quot;Doc </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
                <span style="color: #BA2121">&quot;snippet&quot;</span>: <span style="color: #BA2121">f&quot;Detail </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            }
        ]
        <span style="color: #008000; font-weight: bold">return</span> ChatMessage(
            content<span style="color: #666666">=</span>content,
            citations<span style="color: #666666">=</span>citations,
            reasoning<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
            raw_response<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;choices&quot;</span>: []},
        )
</code></pre>
<h2>Functions</h2>
<h3 id="_provider_for_steps">_provider_for_steps(texts: list[str]) -&gt; Iterable[StepContextBatch]</h3>
<p>The function `_provider_for_steps` takes a list of strings as input and returns an iterable of `StepContextBatch` objects. For each string in the input list, it creates a `StepContextBatch` instance containing the string as both a snippet and a document entry. Each document entry is structured with an ID (derived from the lowercase version of the string with spaces replaced by hyphens), a source field set to the original string, and a text field also set to the original string. The function collects all these `StepContextBatch` instances into a list and returns it.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_provider_for_steps</span>(
    texts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>],
) <span style="color: #666666">-&gt;</span> Iterable[StepContextBatch]:
    batches: <span style="color: #008000">list</span>[StepContextBatch] <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> text <span style="color: #AA22FF; font-weight: bold">in</span> texts:
        batches<span style="color: #666666">.</span>append(
            StepContextBatch(
                snippets<span style="color: #666666">=</span>[text],
                documents<span style="color: #666666">=</span>[{<span style="color: #BA2121">&quot;id&quot;</span>: text<span style="color: #666666">.</span>lower()<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot; &quot;</span>, <span style="color: #BA2121">&quot;-&quot;</span>), <span style="color: #BA2121">&quot;source&quot;</span>: text, <span style="color: #BA2121">&quot;text&quot;</span>: text}],
            )
        )
    <span style="color: #008000; font-weight: bold">return</span> batches
</code></pre>
<h3 id="test_conversation_manager_executes_dynamic_plan">test_conversation_manager_executes_dynamic_plan() -&gt; None</h3>
<p>The function `test_conversation_manager_executes_dynamic_plan` tests the execution of a dynamic plan within a `ConversationManager`. It initializes a `StubLMStudioClient` and a `ConversationManager` instance, then defines a context provider that generates step contexts. The test calls the `ask` method on the manager with a query and the defined provider, expecting two requests to be made to the client and two step results to be generated. It verifies that all steps in the plan are marked as &quot;done&quot;, that the answer contains specific content (&quot;Step 1 finding&quot; and &quot;[1]&quot;), and that there are two citations in the response, with the first citation referencing step 1. Additionally, it checks that the first step result has the correct citation index.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_conversation_manager_executes_dynamic_plan</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    client <span style="color: #666666">=</span> StubLMStudioClient()
    manager <span style="color: #666666">=</span> ConversationManager(client)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">provider</span>(_item, step_index: <span style="color: #008000">int</span>, _total: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Iterable[StepContextBatch]:
        <span style="color: #008000; font-weight: bold">return</span> _provider_for_steps([<span style="color: #BA2121">f&quot;Evidence </span><span style="color: #A45A77; font-weight: bold">{</span>step_index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>])

    turn <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>ask(
        <span style="color: #BA2121">&quot;Compare dataset A. Summarize insights.&quot;</span>,
        context_provider<span style="color: #666666">=</span>provider,
    )

    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(client<span style="color: #666666">.</span>requests) <span style="color: #666666">==</span> <span style="color: #666666">2</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(turn<span style="color: #666666">.</span>step_results) <span style="color: #666666">==</span> <span style="color: #666666">2</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">all</span>(item<span style="color: #666666">.</span>status <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;done&quot;</span> <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>plan)
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Step 1 finding&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>answer
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;[1]&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>answer
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(turn<span style="color: #666666">.</span>citations) <span style="color: #666666">==</span> <span style="color: #666666">2</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>citations[<span style="color: #666666">0</span>]<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;steps&quot;</span>) <span style="color: #666666">==</span> [<span style="color: #666666">1</span>]
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>step_results[<span style="color: #666666">0</span>]<span style="color: #666666">.</span>citation_indexes <span style="color: #666666">==</span> [<span style="color: #666666">1</span>]
</code></pre>
<details>
<summary>Subfunction: provider(_item, step_index: int, _total: int) -&gt; Iterable[StepContextBatch]</summary>
<h4 id="provider">provider(_item, step_index: int, _total: int) -&gt; Iterable[StepContextBatch]</h4>
<p>The function `provider` takes three parameters: `_item`, `step_index`, and `_total`, and returns an iterable of `StepContextBatch`. It calls `_provider_for_steps` with a list containing a single string element `&quot;Evidence {step_index}&quot;`, where `step_index` is formatted into the string. The purpose of this function appears to be generating a batch of step contexts for a specific evidence step in a multi-step process.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">provider</span>(_item, step_index: <span style="color: #008000">int</span>, _total: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Iterable[StepContextBatch]:
        <span style="color: #008000; font-weight: bold">return</span> _provider_for_steps([<span style="color: #BA2121">f&quot;Evidence </span><span style="color: #A45A77; font-weight: bold">{</span>step_index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>])
</code></pre>
</details>
<h3 id="test_dynamic_plan_notes_missing_citations">test_dynamic_plan_notes_missing_citations() -&gt; None</h3>
<p>The function `test_dynamic_plan_notes_missing_citations` defines a unit test that verifies the behavior of a conversation manager when processing a query with a context provider that returns no citations. It creates a stub client, `EmptyCitationClient`, which simulates an LMStudio client response with empty citations. A `ConversationManager` is initialized with this client, and a context provider function supplies step contexts. The test then executes a query through the manager and asserts that:

1. Two step results are generated.
2. Reasoning artifacts are present.
3. The assumptions in the reasoning artifacts contain the text &quot;No citations&quot;.
4. All step results have empty citation indexes.

This validates how the system handles cases where no citations are provided during dynamic plan execution.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_dynamic_plan_notes_missing_citations</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EmptyCitationClient</span>(StubLMStudioClient):
        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">chat</span>(<span style="color: #008000">self</span>, messages, <span style="color: #666666">*</span>, preset, extra_options<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> ChatMessage:  <span style="color: #3D7B7B; font-style: italic"># type: ignore[override]</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>requests<span style="color: #666666">.</span>append({<span style="color: #BA2121">&quot;messages&quot;</span>: <span style="color: #008000">list</span>(messages), <span style="color: #BA2121">&quot;options&quot;</span>: extra_options})
            <span style="color: #008000; font-weight: bold">return</span> ChatMessage(
                content<span style="color: #666666">=</span><span style="color: #BA2121">&quot;&quot;</span>,
                citations<span style="color: #666666">=</span>[],
                reasoning<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
                raw_response<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;choices&quot;</span>: []},
            )

    client <span style="color: #666666">=</span> EmptyCitationClient()
    manager <span style="color: #666666">=</span> ConversationManager(client)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">provider</span>(_item, step_index: <span style="color: #008000">int</span>, _total: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Iterable[StepContextBatch]:
        <span style="color: #008000; font-weight: bold">return</span> _provider_for_steps([<span style="color: #BA2121">f&quot;Context </span><span style="color: #A45A77; font-weight: bold">{</span>step_index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>])

    turn <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>ask(
        <span style="color: #BA2121">&quot;Outline requirements. Provide recommendation.&quot;</span>,
        context_provider<span style="color: #666666">=</span>provider,
    )

    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(turn<span style="color: #666666">.</span>step_results) <span style="color: #666666">==</span> <span style="color: #666666">2</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>reasoning_artifacts <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">any</span>(<span style="color: #BA2121">&quot;No citations&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> text <span style="color: #008000; font-weight: bold">for</span> text <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>reasoning_artifacts<span style="color: #666666">.</span>assumptions)
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">all</span>(result<span style="color: #666666">.</span>citation_indexes <span style="color: #666666">==</span> [] <span style="color: #008000; font-weight: bold">for</span> result <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>step_results)
</code></pre>
<details>
<summary>Subfunction: provider(_item, step_index: int, _total: int) -&gt; Iterable[StepContextBatch]</summary>
<h4 id="provider">provider(_item, step_index: int, _total: int) -&gt; Iterable[StepContextBatch]</h4>
<p>The function `provider` takes three parameters: `_item`, `step_index`, and `_total`, and returns an iterable of `StepContextBatch`. It invokes `_provider_for_steps` with a list containing a single string element formatted as `&quot;Context {step_index}&quot;`, where `step_index` is inserted into the string. The function serves as a wrapper that prepares a context batch for a specific step based on the provided index.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">provider</span>(_item, step_index: <span style="color: #008000">int</span>, _total: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Iterable[StepContextBatch]:
        <span style="color: #008000; font-weight: bold">return</span> _provider_for_steps([<span style="color: #BA2121">f&quot;Context </span><span style="color: #A45A77; font-weight: bold">{</span>step_index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>])
</code></pre>
</details>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
