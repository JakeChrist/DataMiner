<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>backup_service</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>backup_service</h1>
        <p>The module defines a `BackupService` class for creating and restoring archive snapshots of application data. It includes methods to generate backups in ZIP format containing database exports, project storage files, and manifest metadata. The restore process imports database snapshots and reconstructs project storage directories based on the manifest. The service uses temporary directories during backup and restore operations and handles schema version compatibility checks. The module also exports a `MANIFEST_NAME` constant for identifying manifest files within backups.</p>
<h2 id="BackupService">Class: BackupService</h2>
<p>The `BackupService` class provides functionality to create and restore compressed archive snapshots of application data, including database exports and project storage files. The `create_backup` method generates a ZIP archive containing a database dump, a manifest file, and derived project data, organizing the backup with a timestamped filename if the destination is a directory. The `restore_backup` method extracts a provided backup archive, validates its manifest, imports the database, and restores project storage locations while updating the active project configuration.</p>
<h3 id="__init__">Method: __init__(self, project_service: ProjectService) -&gt; None</h3>
<p>The `__init__` method initializes the `BackupService` class by accepting a `ProjectService` instance and assigning it to the private attribute `_projects`. This establishes a dependency on the project service for backup operations.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, project_service: ProjectService) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects <span style="color: #666666">=</span> project_service
</code></pre>
<h3 id="create_backup">Method: create_backup(self, destination: str | Path) -&gt; Path</h3>
<p>The `create_backup` function generates a backup of the application&#x27;s data and configuration to a specified destination. It creates a ZIP archive containing the database, project files, and a manifest file. The function ensures the destination directory exists, constructs a timestamped filename if the destination is a directory, and exports the database using the project&#x27;s database manager. It includes project storage locations in the manifest and archives all relevant files from each project&#x27;s storage directory. The resulting ZIP file is returned as a `Path` object.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">create_backup</span>(<span style="color: #008000">self</span>, destination: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path) <span style="color: #666666">-&gt;</span> Path:
        destination_path <span style="color: #666666">=</span> Path(destination)
        <span style="color: #008000; font-weight: bold">if</span> destination_path<span style="color: #666666">.</span>is_dir():
            timestamp <span style="color: #666666">=</span> _dt<span style="color: #666666">.</span>datetime<span style="color: #666666">.</span>now(_dt<span style="color: #666666">.</span>UTC)<span style="color: #666666">.</span>strftime(<span style="color: #BA2121">&quot;%Y%m</span><span style="color: #A45A77; font-weight: bold">%d</span><span style="color: #BA2121">-%H%M%S&quot;</span>)
            destination_path <span style="color: #666666">=</span> destination_path <span style="color: #666666">/</span> <span style="color: #BA2121">f&quot;dataminer-backup-</span><span style="color: #A45A77; font-weight: bold">{</span>timestamp<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.zip&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> destination_path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>exists():
            destination_path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)

        storage_locations: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">str</span>] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>list_projects():
            location <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>get_project_storage_location(record<span style="color: #666666">.</span>id)
            <span style="color: #008000; font-weight: bold">if</span> location <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">continue</span>
            storage_locations[<span style="color: #008000">str</span>(record<span style="color: #666666">.</span>id)] <span style="color: #666666">=</span> <span style="color: #008000">str</span>(location)

        manifest <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;created&quot;</span>: _dt<span style="color: #666666">.</span>datetime<span style="color: #666666">.</span>now(_dt<span style="color: #666666">.</span>UTC)<span style="color: #666666">.</span>isoformat()<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;+00:00&quot;</span>, <span style="color: #BA2121">&quot;Z&quot;</span>),
            <span style="color: #BA2121">&quot;schema_version&quot;</span>: SCHEMA_VERSION,
            <span style="color: #BA2121">&quot;active_project&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>active_project_id,
            <span style="color: #BA2121">&quot;storage_locations&quot;</span>: storage_locations,
        }

        <span style="color: #008000; font-weight: bold">with</span> tempfile<span style="color: #666666">.</span>TemporaryDirectory() <span style="color: #008000; font-weight: bold">as</span> tmpdir:
            tmp_path <span style="color: #666666">=</span> Path(tmpdir)
            db_export <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;database.db&quot;</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>database_manager<span style="color: #666666">.</span>export_database(db_export)
            manifest_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> MANIFEST_NAME
            manifest_path<span style="color: #666666">.</span>write_text(json<span style="color: #666666">.</span>dumps(manifest, indent<span style="color: #666666">=2</span>), encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

            <span style="color: #008000; font-weight: bold">with</span> zipfile<span style="color: #666666">.</span>ZipFile(destination_path, <span style="color: #BA2121">&quot;w&quot;</span>, compression<span style="color: #666666">=</span>zipfile<span style="color: #666666">.</span>ZIP_DEFLATED) <span style="color: #008000; font-weight: bold">as</span> archive:
                archive<span style="color: #666666">.</span>write(db_export, <span style="color: #BA2121">&quot;database/dataminer.db&quot;</span>)
                <span style="color: #008000; font-weight: bold">for</span> project_id, path_str <span style="color: #AA22FF; font-weight: bold">in</span> storage_locations<span style="color: #666666">.</span>items():
                    project_path <span style="color: #666666">=</span> Path(path_str)
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> project_path<span style="color: #666666">.</span>exists():
                        <span style="color: #008000; font-weight: bold">continue</span>
                    <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> project_path<span style="color: #666666">.</span>rglob(<span style="color: #BA2121">&quot;*&quot;</span>):
                        <span style="color: #008000; font-weight: bold">if</span> path<span style="color: #666666">.</span>is_file():
                            arcname <span style="color: #666666">=</span> Path(<span style="color: #BA2121">&quot;derived&quot;</span>) <span style="color: #666666">/</span> project_id <span style="color: #666666">/</span> path<span style="color: #666666">.</span>relative_to(project_path)
                            archive<span style="color: #666666">.</span>write(path, arcname)
                archive<span style="color: #666666">.</span>write(manifest_path, MANIFEST_NAME)
        <span style="color: #008000; font-weight: bold">return</span> destination_path
</code></pre>
<h3 id="restore_backup">Method: restore_backup(self, archive_path: str | Path) -&gt; None</h3>
<p>The `restore_backup` function restores a backup from a specified archive file. It extracts the archive contents into a temporary directory, validates the manifest file for schema compatibility, and imports the database snapshot into the project&#x27;s database manager. It then processes storage locations defined in the manifest, copying derived project data to their respective target directories. If no specific storage locations are defined, it copies all project data from the archive to the default storage root. Finally, it reloads the projects to reflect the restored data.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">restore_backup</span>(<span style="color: #008000">self</span>, archive_path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        archive <span style="color: #666666">=</span> Path(archive_path)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> archive<span style="color: #666666">.</span>exists():
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">FileNotFoundError</span>(archive)

        <span style="color: #008000; font-weight: bold">with</span> tempfile<span style="color: #666666">.</span>TemporaryDirectory() <span style="color: #008000; font-weight: bold">as</span> tmpdir:
            tmp_path <span style="color: #666666">=</span> Path(tmpdir)
            <span style="color: #008000; font-weight: bold">with</span> zipfile<span style="color: #666666">.</span>ZipFile(archive, <span style="color: #BA2121">&quot;r&quot;</span>) <span style="color: #008000; font-weight: bold">as</span> zip_file:
                zip_file<span style="color: #666666">.</span>extractall(tmp_path)
            manifest_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> MANIFEST_NAME
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> manifest_path<span style="color: #666666">.</span>exists():
                <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>(<span style="color: #BA2121">&quot;Backup archive missing manifest.json&quot;</span>)
            manifest <span style="color: #666666">=</span> json<span style="color: #666666">.</span>loads(manifest_path<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>))
            schema_version <span style="color: #666666">=</span> <span style="color: #008000">int</span>(manifest<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;schema_version&quot;</span>, <span style="color: #666666">0</span>))
            <span style="color: #008000; font-weight: bold">if</span> schema_version <span style="color: #666666">&gt;</span> SCHEMA_VERSION:
                <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>(<span style="color: #BA2121">&quot;Backup schema version is newer than supported&quot;</span>)

            database_source <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;database&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;dataminer.db&quot;</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> database_source<span style="color: #666666">.</span>exists():
                <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>(<span style="color: #BA2121">&quot;Backup archive missing database snapshot&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>database_manager<span style="color: #666666">.</span>import_database(database_source)

            storage_locations <span style="color: #666666">=</span> manifest<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;storage_locations&quot;</span>)
            derived_root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;derived&quot;</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(storage_locations, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> storage_locations:
                <span style="color: #008000; font-weight: bold">for</span> project_id, path_str <span style="color: #AA22FF; font-weight: bold">in</span> storage_locations<span style="color: #666666">.</span>items():
                    target <span style="color: #666666">=</span> Path(path_str)
                    source <span style="color: #666666">=</span> derived_root <span style="color: #666666">/</span> <span style="color: #008000">str</span>(project_id)
                    <span style="color: #008000; font-weight: bold">if</span> target<span style="color: #666666">.</span>exists():
                        shutil<span style="color: #666666">.</span>rmtree(target, ignore_errors<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
                    <span style="color: #008000; font-weight: bold">if</span> source<span style="color: #666666">.</span>exists():
                        shutil<span style="color: #666666">.</span>copytree(source, target)
                    <span style="color: #008000; font-weight: bold">else</span>:
                        target<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
                    <span style="color: #008000; font-weight: bold">try</span>:
                        numeric_id <span style="color: #666666">=</span> <span style="color: #008000">int</span>(project_id)
                    <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">TypeError</span>, <span style="color: #CB3F38; font-weight: bold">ValueError</span>):
                        <span style="color: #008000; font-weight: bold">continue</span>
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>set_project_storage_location(numeric_id, target)
            <span style="color: #008000; font-weight: bold">else</span>:
                derived_source <span style="color: #666666">=</span> derived_root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;projects&quot;</span>
                target_root <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>storage_root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;projects&quot;</span>
                <span style="color: #008000; font-weight: bold">if</span> target_root<span style="color: #666666">.</span>exists():
                    shutil<span style="color: #666666">.</span>rmtree(target_root)
                <span style="color: #008000; font-weight: bold">if</span> derived_source<span style="color: #666666">.</span>exists():
                    shutil<span style="color: #666666">.</span>copytree(derived_source, target_root)
                <span style="color: #008000; font-weight: bold">else</span>:
                    target_root<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_projects<span style="color: #666666">.</span>reload()
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
