<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>preview</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>preview</h1>
        <p>The module defines a `PreviewService` class for generating highlighted text previews of ingested documents. It retrieves document data from a database, constructs snippets with emphasized terms using HTML `&lt;mark&gt;` tags, and provides functionality to fetch specific pages from documents. The service supports case-insensitive term matching, context-based snippet generation around search terms, and page number detection based on term presence in page content. Helper methods handle text highlighting, snippet building, page identification, and preview assembly. The class is initialized with a database manager and uses an `IngestDocumentRepository` for document access.</p>
<h2 id="PreviewService">Class: PreviewService</h2>
<p>The `PreviewService` class provides functionality to retrieve highlighted text snippets and specific pages from stored documents. It supports generating previews with emphasized terms and finding the page containing specified search terms. The class interacts with a database through a document repository to fetch and process document data, including handling text normalization, snippet generation, and page retrieval.</p>
<h3 id="__init__">Method: __init__(self, db: DatabaseManager) -&gt; None</h3>
<p>Initializes the `PreviewService` instance with a database manager and sets up the `IngestDocumentRepository` for document management.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, db: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>db <span style="color: #666666">=</span> db
        <span style="color: #008000">self</span><span style="color: #666666">.</span>documents <span style="color: #666666">=</span> IngestDocumentRepository(db)
</code></pre>
<h3 id="get_highlighted_passages">Method: get_highlighted_passages(self, document_id: int, terms: Sequence[str] | None=None, *, context_chars: int=240) -&gt; dict[str, Any]</h3>
<p>The function `get_highlighted_passages` retrieves a text snippet from a document identified by `document_id`, optionally highlighting specified terms within the snippet. It accepts an optional list of terms to emphasize and a context length parameter. If no terms are provided, it returns a preview of the document or a truncated version of its normalized text. If terms are provided, it builds a highlighted snippet around those terms and determines the page number where the terms occur. The result is assembled into a structured preview including metadata about the document and the highlighted context. It raises a `LookupError` if the document ID is invalid.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_highlighted_passages</span>(
        <span style="color: #008000">self</span>,
        document_id: <span style="color: #008000">int</span>,
        terms: Sequence[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        <span style="color: #666666">*</span>,
        context_chars: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">240</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a snippet with highlights for ``document_id``.</span>

<span style="color: #BA2121; font-style: italic">        ``terms`` is treated as a case-insensitive set of tokens to emphasise in the</span>
<span style="color: #BA2121; font-style: italic">        returned snippet. If no terms are supplied, the stored preview is returned.</span>
<span style="color: #BA2121; font-style: italic">        &quot;&quot;&quot;</span>

        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>get(document_id)
        <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">LookupError</span>(<span style="color: #BA2121">f&quot;Unknown document id: </span><span style="color: #A45A77; font-weight: bold">{</span>document_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

        normalized <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;normalized_text&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
        snippet_source <span style="color: #666666">=</span> normalized
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> snippet_source:
            snippet_source <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;preview&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> terms:
            snippet <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;preview&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> snippet_source[:context_chars]
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_assemble_preview(record, snippet, page<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>, offset<span style="color: #666666">=0</span>)

        snippet, offset <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_highlight(snippet_source, terms, context_chars)
        page_number <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_find_page(record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;pages&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> [], terms)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_assemble_preview(record, snippet, page<span style="color: #666666">=</span>page_number, offset<span style="color: #666666">=</span>offset)
</code></pre>
<h3 id="get_page">Method: get_page(self, document_id: int, page_number: int) -&gt; dict[str, Any]</h3>
<p>Returns the full text of a specified page from a document identified by `document_id` and `page_number`. Raises `LookupError` if the document or page is not found. The returned dictionary includes the document ID, page number, and page text.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_page</span>(<span style="color: #008000">self</span>, document_id: <span style="color: #008000">int</span>, page_number: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return the full text of ``page_number`` for ``document_id``.&quot;&quot;&quot;</span>

        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>get(document_id)
        <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">LookupError</span>(<span style="color: #BA2121">f&quot;Unknown document id: </span><span style="color: #A45A77; font-weight: bold">{</span>document_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> page <span style="color: #AA22FF; font-weight: bold">in</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;pages&quot;</span>, []):
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">int</span>(page<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;number&quot;</span>, <span style="color: #666666">-1</span>)) <span style="color: #666666">==</span> <span style="color: #008000">int</span>(page_number):
                <span style="color: #008000; font-weight: bold">return</span> {
                    <span style="color: #BA2121">&quot;document_id&quot;</span>: record[<span style="color: #BA2121">&quot;id&quot;</span>],
                    <span style="color: #BA2121">&quot;page_number&quot;</span>: page_number,
                    <span style="color: #BA2121">&quot;text&quot;</span>: page<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>),
                }
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">LookupError</span>(<span style="color: #BA2121">f&quot;Page </span><span style="color: #A45A77; font-weight: bold">{</span>page_number<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> not found for document </span><span style="color: #A45A77; font-weight: bold">{</span>document_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
</code></pre>
<h3 id="_apply_highlight">Method: _apply_highlight(text: str, terms: Iterable[str]) -&gt; str</h3>
<p>The function `_apply_highlight` takes a string `text` and an iterable of search terms `terms`, and returns the text with each term wrapped in `&lt;mark&gt;` HTML tags for highlighting. It processes the terms by sorting them in descending order of length to avoid partial matches, compiles a regular expression pattern for each term (case-insensitive), and substitutes occurrences of the term in the text with the marked version. Empty or invalid terms are filtered out before processing.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_highlight</span>(text: <span style="color: #008000">str</span>, terms: Iterable[<span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        highlighted <span style="color: #666666">=</span> text
        <span style="color: #008000; font-weight: bold">for</span> term <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">sorted</span>({term <span style="color: #008000; font-weight: bold">for</span> term <span style="color: #AA22FF; font-weight: bold">in</span> terms <span style="color: #008000; font-weight: bold">if</span> term}, key<span style="color: #666666">=</span><span style="color: #008000">len</span>, reverse<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>):
            pattern <span style="color: #666666">=</span> re<span style="color: #666666">.</span>compile(re<span style="color: #666666">.</span>escape(term), re<span style="color: #666666">.</span>IGNORECASE)
            highlighted <span style="color: #666666">=</span> pattern<span style="color: #666666">.</span>sub(<span style="color: #008000; font-weight: bold">lambda</span> match: <span style="color: #BA2121">f&quot;&lt;mark&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>match<span style="color: #666666">.</span>group(<span style="color: #666666">0</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/mark&gt;&quot;</span>, highlighted)
        <span style="color: #008000; font-weight: bold">return</span> highlighted
</code></pre>
<h3 id="_build_highlight">Method: _build_highlight(self, text: str, terms: Sequence[str], context_chars: int) -&gt; tuple[str, int]</h3>
<p>The function `_build_highlight` generates a highlighted text snippet from a given string based on provided search terms. It identifies the first occurrence of any term in the text and extracts a contextually centered snippet around it. If no terms are found, it returns the beginning of the text up to the specified character limit, also highlighted. The function returns a tuple containing the highlighted snippet and the starting index of the snippet within the original text.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_highlight</span>(
        <span style="color: #008000">self</span>, text: <span style="color: #008000">str</span>, terms: Sequence[<span style="color: #008000">str</span>], context_chars: <span style="color: #008000">int</span>
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">str</span>, <span style="color: #008000">int</span>]:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> text:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #666666">0</span>
        lowered <span style="color: #666666">=</span> text<span style="color: #666666">.</span>lower()
        best_index <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">for</span> term <span style="color: #AA22FF; font-weight: bold">in</span> terms:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> term:
                <span style="color: #008000; font-weight: bold">continue</span>
            index <span style="color: #666666">=</span> lowered<span style="color: #666666">.</span>find(term<span style="color: #666666">.</span>lower())
            <span style="color: #008000; font-weight: bold">if</span> index <span style="color: #666666">!=</span> <span style="color: #666666">-1</span> <span style="color: #AA22FF; font-weight: bold">and</span> (best_index <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">or</span> index <span style="color: #666666">&lt;</span> best_index):
                best_index <span style="color: #666666">=</span> index
        <span style="color: #008000; font-weight: bold">if</span> best_index <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            snippet <span style="color: #666666">=</span> text[:context_chars]
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_highlight(snippet, terms), <span style="color: #666666">0</span>
        start <span style="color: #666666">=</span> <span style="color: #008000">max</span>(best_index <span style="color: #666666">-</span> context_chars <span style="color: #666666">//</span> <span style="color: #666666">2</span>, <span style="color: #666666">0</span>)
        end <span style="color: #666666">=</span> <span style="color: #008000">min</span>(start <span style="color: #666666">+</span> context_chars, <span style="color: #008000">len</span>(text))
        snippet <span style="color: #666666">=</span> text[start:end]
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_highlight(snippet, terms), start
</code></pre>
<h3 id="_find_page">Method: _find_page(pages: list[dict[str, Any]], terms: Sequence[str]) -&gt; int | None</h3>
<p>The function `_find_page` searches through a list of page dictionaries to locate the first page containing any of the specified terms. It converts the search terms and page content to lowercase for case-insensitive matching. If a match is found, it attempts to extract and return the page number as an integer. If the page number cannot be converted to an integer or is invalid, it returns `None`. If no matching page is found, the function returns `None`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_find_page</span>(pages: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]], terms: Sequence[<span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        lowered_terms <span style="color: #666666">=</span> [term<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">for</span> term <span style="color: #AA22FF; font-weight: bold">in</span> terms <span style="color: #008000; font-weight: bold">if</span> term]
        <span style="color: #008000; font-weight: bold">for</span> page <span style="color: #AA22FF; font-weight: bold">in</span> pages:
            content <span style="color: #666666">=</span> (page<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)<span style="color: #666666">.</span>lower()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">any</span>(term <span style="color: #AA22FF; font-weight: bold">in</span> content <span style="color: #008000; font-weight: bold">for</span> term <span style="color: #AA22FF; font-weight: bold">in</span> lowered_terms):
                <span style="color: #008000; font-weight: bold">try</span>:
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">int</span>(page<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;number&quot;</span>))
                <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">TypeError</span>, <span style="color: #CB3F38; font-weight: bold">ValueError</span>):
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="_assemble_preview">Method: _assemble_preview(record: dict[str, Any], snippet: str, *, page: int | None, offset: int) -&gt; dict[str, Any]</h3>
<p>The function `_assemble_preview` constructs and returns a dictionary containing preview-related information for a document record. It extracts specific fields from the input `record` dictionary, such as document ID, path, version, preview content, OCR status, page information, and metadata. The returned dictionary also includes the provided `snippet` and `offset`, as well as the optional `page` parameter, forming a structured preview object for use in the application&#x27;s UI or processing pipeline.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_assemble_preview</span>(
        record: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any],
        snippet: <span style="color: #008000">str</span>,
        <span style="color: #666666">*</span>,
        page: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        offset: <span style="color: #008000">int</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        <span style="color: #008000; font-weight: bold">return</span> {
            <span style="color: #BA2121">&quot;document_id&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>),
            <span style="color: #BA2121">&quot;path&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>),
            <span style="color: #BA2121">&quot;version&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;version&quot;</span>),
            <span style="color: #BA2121">&quot;snippet&quot;</span>: snippet,
            <span style="color: #BA2121">&quot;offset&quot;</span>: offset,
            <span style="color: #BA2121">&quot;preview&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;preview&quot;</span>),
            <span style="color: #BA2121">&quot;needs_ocr&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;needs_ocr&quot;</span>, <span style="color: #008000; font-weight: bold">False</span>),
            <span style="color: #BA2121">&quot;ocr_message&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;ocr_message&quot;</span>),
            <span style="color: #BA2121">&quot;page&quot;</span>: page,
            <span style="color: #BA2121">&quot;pages&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;pages&quot;</span>),
            <span style="color: #BA2121">&quot;sections&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;sections&quot;</span>),
            <span style="color: #BA2121">&quot;metadata&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;metadata&quot;</span>),
        }
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
