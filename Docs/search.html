<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>search</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>search</h1>
        <p>The module defines a `SearchService` class that provides keyword search functionality across indexed documents, integrating with project metadata and chat scopes. It supports searching within specified tags, folders, or chat contexts, and returns structured results including document metadata, highlights, and context snippets. The service resolves search scope from explicit parameters or stored chat state, normalizes file paths, and handles query tokenization with fallback strategies for matching. It includes methods for retrieving documents, collecting context records, and generating text snippets from search results. The implementation uses an ingest index for searching and maintains mappings of documents by path to efficiently associate search results with project data.</p>
<h2 id="SearchService">Class: SearchService</h2>
<p>The `SearchService` class provides methods to search and retrieve document snippets based on keyword queries, supporting scoping by tags, folders, and chat context. It integrates with ingest, document, and chat repositories to fetch and structure search results, including highlights and contextual chunks. The service includes logic for resolving query scopes, normalizing paths, tokenizing queries, and handling fallback search strategies when initial attempts fail.</p>
<h3 id="__init__">Method: __init__(self, ingest_repository: IngestDocumentRepository, document_repository: DocumentRepository, chat_repository: ChatRepository) -&gt; None</h3>
<p>Initializes the SearchService class with three repository dependencies: IngestDocumentRepository for document ingestion, DocumentRepository for document management, and ChatRepository for chat-related operations. Assigns these repositories to instance attributes for use in subsequent methods.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(
        <span style="color: #008000">self</span>,
        ingest_repository: IngestDocumentRepository,
        document_repository: DocumentRepository,
        chat_repository: ChatRepository,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest <span style="color: #666666">=</span> ingest_repository
        <span style="color: #008000">self</span><span style="color: #666666">.</span>documents <span style="color: #666666">=</span> document_repository
        <span style="color: #008000">self</span><span style="color: #666666">.</span>chats <span style="color: #666666">=</span> chat_repository
</code></pre>
<h3 id="search_documents">Method: search_documents(self, query: str, *, project_id: int, limit: int=5, chat_id: int | None=None, tags: Iterable[int] | None=None, folder: str | Path | None=None, recursive: bool=True, save_scope: bool=False) -&gt; list[dict[str, Any]]</h3>
<p>The function `search_documents` performs a search query against an indexed document corpus, returning a list of relevant document records. It accepts parameters for specifying the project, query string, result limits, chat context, tags, folder scope, and whether to save the search scope. The method resolves the search scope using `_resolve_scope`, retrieves candidate documents within that scope via `documents.list_for_scope`, and builds a path-based index of those documents. It then iterates through search results from `_search_with_fallback`, matches them to documents by path, and constructs result entries containing document metadata, highlighted text, chunk information, and relevance scores. The function ensures no duplicate documents are included in the results and stops collecting once the specified limit is reached.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">search_documents</span>(
        <span style="color: #008000">self</span>,
        query: <span style="color: #008000">str</span>,
        <span style="color: #666666">*</span>,
        project_id: <span style="color: #008000">int</span>,
        limit: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">5</span>,
        chat_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        tags: Iterable[<span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        recursive: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>,
        save_scope: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Search the ingest index and join results with project documents.&quot;&quot;&quot;</span>

        scope_tags, scope_folder <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_resolve_scope(
            chat_id,
            tags,
            folder,
            save_scope<span style="color: #666666">=</span>save_scope,
        )
        candidate_documents <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>list_for_scope(
            project_id,
            tags<span style="color: #666666">=</span>scope_tags,
            folder<span style="color: #666666">=</span>scope_folder,
            recursive<span style="color: #666666">=</span>recursive,
        )
        documents_by_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_path_index(candidate_documents)
        seen_documents: <span style="color: #008000">set</span>[<span style="color: #008000">int</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        results: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_search_with_fallback(query, limit<span style="color: #666666">=</span>limit <span style="color: #666666">*</span> <span style="color: #666666">6</span>):
            doc_payload <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            path <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> doc_payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path:
                <span style="color: #008000; font-weight: bold">continue</span>
            document <span style="color: #666666">=</span> documents_by_path<span style="color: #666666">.</span>get(<span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(path))
            <span style="color: #008000; font-weight: bold">if</span> document <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">continue</span>
            doc_id <span style="color: #666666">=</span> <span style="color: #008000">int</span>(document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>))
            <span style="color: #008000; font-weight: bold">if</span> doc_id <span style="color: #AA22FF; font-weight: bold">in</span> seen_documents:
                <span style="color: #008000; font-weight: bold">continue</span>
            seen_documents<span style="color: #666666">.</span>add(doc_id)
            chunk: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;chunk&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            chunk_text <span style="color: #666666">=</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(chunk, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            highlight <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;highlight&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> chunk_text <span style="color: #AA22FF; font-weight: bold">or</span> doc_payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;preview&quot;</span>)
            results<span style="color: #666666">.</span>append(
                {
                    <span style="color: #BA2121">&quot;document&quot;</span>: document,
                    <span style="color: #BA2121">&quot;highlight&quot;</span>: highlight,
                    <span style="color: #BA2121">&quot;context&quot;</span>: chunk_text <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>,
                    <span style="color: #BA2121">&quot;chunk&quot;</span>: chunk,
                    <span style="color: #BA2121">&quot;ingest_document&quot;</span>: doc_payload,
                    <span style="color: #BA2121">&quot;score&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;score&quot;</span>),
                }
            )
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(results) <span style="color: #666666">&gt;=</span> limit:
                <span style="color: #008000; font-weight: bold">break</span>
        <span style="color: #008000; font-weight: bold">return</span> results
</code></pre>
<h3 id="collect_context_records">Method: collect_context_records(self, query: str, *, project_id: int, limit: int=5, tags: Iterable[int] | None=None, folder: str | Path | None=None, recursive: bool=True, include_identifiers: Iterable[str] | None=None, exclude_identifiers: Iterable[str] | None=None) -&gt; list[dict[str, Any]]</h3>
<p>The function `collect_context_records` retrieves structured retrieval records for a given query within a specified scope. It filters documents based on project ID, optional tags, folder path, and recursion settings. The results are limited by a specified number and further filtered using include or exclude identifiers associated with documents. Each record includes document metadata, chunked text content, highlighting information, and relevance scores. The function ensures no duplicate chunks are included in the result set and returns a list of dictionaries representing the retrieved context records.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">collect_context_records</span>(
        <span style="color: #008000">self</span>,
        query: <span style="color: #008000">str</span>,
        <span style="color: #666666">*</span>,
        project_id: <span style="color: #008000">int</span>,
        limit: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">5</span>,
        tags: Iterable[<span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        recursive: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>,
        include_identifiers: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        exclude_identifiers: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return structured retrieval records for ``query`` within scope.&quot;&quot;&quot;</span>

        scope_tags <span style="color: #666666">=</span> <span style="color: #008000">list</span>(tags) <span style="color: #008000; font-weight: bold">if</span> tags <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        scope_folder <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_folder(folder) <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        candidate_documents <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>list_for_scope(
            project_id,
            tags<span style="color: #666666">=</span>scope_tags,
            folder<span style="color: #666666">=</span>scope_folder,
            recursive<span style="color: #666666">=</span>recursive,
        )
        documents_by_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_path_index(candidate_documents)
        include_set <span style="color: #666666">=</span> {<span style="color: #008000">str</span>(item) <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> (include_identifiers <span style="color: #AA22FF; font-weight: bold">or</span> []) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(item)}
        exclude_set <span style="color: #666666">=</span> {<span style="color: #008000">str</span>(item) <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> (exclude_identifiers <span style="color: #AA22FF; font-weight: bold">or</span> []) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(item)}
        records: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> []
        seen_chunks: <span style="color: #008000">set</span>[<span style="color: #008000">int</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_search_with_fallback(query, limit<span style="color: #666666">=</span>limit <span style="color: #666666">*</span> <span style="color: #666666">6</span>):
            doc_payload <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            path <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> doc_payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path:
                <span style="color: #008000; font-weight: bold">continue</span>
            document <span style="color: #666666">=</span> documents_by_path<span style="color: #666666">.</span>get(<span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(path))
            <span style="color: #008000; font-weight: bold">if</span> document <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">continue</span>
            identifiers <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_document_identifiers(document)
            <span style="color: #008000; font-weight: bold">if</span> include_set <span style="color: #AA22FF; font-weight: bold">and</span> include_set<span style="color: #666666">.</span>isdisjoint(identifiers):
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">if</span> exclude_set <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> exclude_set<span style="color: #666666">.</span>isdisjoint(identifiers):
                <span style="color: #008000; font-weight: bold">continue</span>
            chunk: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;chunk&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            chunk_id <span style="color: #666666">=</span> <span style="color: #008000">int</span>(chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>, <span style="color: #666666">-1</span>)) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(chunk, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">-1</span>
            <span style="color: #008000; font-weight: bold">if</span> chunk_id <span style="color: #AA22FF; font-weight: bold">in</span> seen_chunks:
                <span style="color: #008000; font-weight: bold">continue</span>
            text <span style="color: #666666">=</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(chunk, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> text:
                <span style="color: #008000; font-weight: bold">continue</span>
            highlight <span style="color: #666666">=</span> (
                record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;highlight&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;highlight&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> doc_payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;preview&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> text
            )
            context_record <span style="color: #666666">=</span> {
                <span style="color: #BA2121">&quot;document&quot;</span>: document,
                <span style="color: #BA2121">&quot;chunk&quot;</span>: chunk,
                <span style="color: #BA2121">&quot;context&quot;</span>: text,
                <span style="color: #BA2121">&quot;highlight&quot;</span>: highlight,
                <span style="color: #BA2121">&quot;ingest_document&quot;</span>: doc_payload,
                <span style="color: #BA2121">&quot;score&quot;</span>: record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;score&quot;</span>),
            }
            records<span style="color: #666666">.</span>append(context_record)
            seen_chunks<span style="color: #666666">.</span>add(chunk_id)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(records) <span style="color: #666666">&gt;=</span> limit:
                <span style="color: #008000; font-weight: bold">break</span>
        <span style="color: #008000; font-weight: bold">return</span> records
</code></pre>
<h3 id="retrieve_context_snippets">Method: retrieve_context_snippets(self, query: str, *, project_id: int, limit: int=5, tags: Iterable[int] | None=None, folder: str | Path | None=None, recursive: bool=True, include_identifiers: Iterable[str] | None=None, exclude_identifiers: Iterable[str] | None=None) -&gt; list[str]</h3>
<p>The function `retrieve_context_snippets` retrieves a list of context snippets relevant to a given query from a specified project. It collects context records using the `collect_context_records` method with parameters such as project ID, query, limit, tags, folder path, recursion settings, and identifier filters. For each record, it extracts document and chunk information to construct a snippet string that includes a label (derived from the document title or file name) and the contextual text. The resulting list of formatted snippets is returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">retrieve_context_snippets</span>(
        <span style="color: #008000">self</span>,
        query: <span style="color: #008000">str</span>,
        <span style="color: #666666">*</span>,
        project_id: <span style="color: #008000">int</span>,
        limit: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">5</span>,
        tags: Iterable[<span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        recursive: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>,
        include_identifiers: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        exclude_identifiers: Iterable[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        records <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>collect_context_records(
            query,
            project_id<span style="color: #666666">=</span>project_id,
            limit<span style="color: #666666">=</span>limit,
            tags<span style="color: #666666">=</span>tags,
            folder<span style="color: #666666">=</span>folder,
            recursive<span style="color: #666666">=</span>recursive,
            include_identifiers<span style="color: #666666">=</span>include_identifiers,
            exclude_identifiers<span style="color: #666666">=</span>exclude_identifiers,
        )
        snippets: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> records:
            document <span style="color: #666666">=</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            chunk <span style="color: #666666">=</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;chunk&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            context <span style="color: #666666">=</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;context&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
            path <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
            title <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> (Path(path)<span style="color: #666666">.</span>stem <span style="color: #008000; font-weight: bold">if</span> path <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> title <span style="color: #AA22FF; font-weight: bold">and</span> path:
                title <span style="color: #666666">=</span> Path(path)<span style="color: #666666">.</span>name
            label <span style="color: #666666">=</span> title <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Document&quot;</span>
            snippets<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>label<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>context<span style="color: #666666">.</span>strip()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> snippets
</code></pre>
<h3 id="_resolve_scope">Method: _resolve_scope(self, chat_id: int | None, tags: Iterable[int] | None, folder: str | Path | None, *, save_scope: bool) -&gt; tuple[list[int] | None, str | None]</h3>
<p>The function `_resolve_scope` resolves and returns the effective tags and folder scope for a given chat ID, based on explicitly provided values or stored scope settings. It accepts optional `chat_id`, `tags`, and `folder` parameters, and a keyword-only `save_scope` flag. If `chat_id` is provided, it retrieves the stored scope from `self.chats`. The function prioritizes explicit values over stored ones, and if `save_scope` is True, it updates the stored scope with the explicitly provided values. It returns a tuple of the resolved tags and folder, which may be `None` if not specified or stored.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_resolve_scope</span>(
        <span style="color: #008000">self</span>,
        chat_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        tags: Iterable[<span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        <span style="color: #666666">*</span>,
        save_scope: <span style="color: #008000">bool</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">list</span>[<span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>]:
        explicit_tags <span style="color: #666666">=</span> <span style="color: #008000">list</span>(tags) <span style="color: #008000; font-weight: bold">if</span> tags <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        explicit_folder <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_folder(folder) <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>

        stored_scope: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">if</span> chat_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            stored_scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>chats<span style="color: #666666">.</span>get_query_scope(chat_id) <span style="color: #AA22FF; font-weight: bold">or</span> {}

        scope_tags <span style="color: #666666">=</span> explicit_tags <span style="color: #008000; font-weight: bold">if</span> explicit_tags <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> stored_scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;tags&quot;</span>)
        scope_folder <span style="color: #666666">=</span> explicit_folder <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> stored_scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;folder&quot;</span>)

        <span style="color: #008000; font-weight: bold">if</span> chat_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">and</span> save_scope:
            payload <span style="color: #666666">=</span> {
                <span style="color: #BA2121">&quot;tags&quot;</span>: explicit_tags <span style="color: #AA22FF; font-weight: bold">or</span> [],
                <span style="color: #BA2121">&quot;folder&quot;</span>: explicit_folder,
            }
            <span style="color: #008000">self</span><span style="color: #666666">.</span>chats<span style="color: #666666">.</span>set_query_scope(chat_id, payload)

        <span style="color: #008000; font-weight: bold">return</span> scope_tags, scope_folder
</code></pre>
<h3 id="_build_path_index">Method: _build_path_index(self, documents: Iterable[dict[str, Any]]) -&gt; dict[str, dict[str, Any]]</h3>
<p>The function `_build_path_index` constructs a dictionary index mapping normalized file paths to their corresponding document metadata. It takes an iterable of document dictionaries, extracts the `source_path` from each document, normalizes the path using the internal `_normalize_path` method, and stores the document data in the index under the normalized path as the key. Documents without a `source_path` are skipped. The resulting dictionary allows for efficient lookup of document metadata by file path.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_path_index</span>(<span style="color: #008000">self</span>, documents: Iterable[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]:
        index: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> document <span style="color: #AA22FF; font-weight: bold">in</span> documents:
            source_path <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> source_path:
                <span style="color: #008000; font-weight: bold">continue</span>
            normalized <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_path(source_path)
            index[normalized] <span style="color: #666666">=</span> document
        <span style="color: #008000; font-weight: bold">return</span> index
</code></pre>
<h3 id="_document_identifiers">Method: _document_identifiers(document: dict[str, Any]) -&gt; set[str]</h3>
<p>The function `_document_identifiers` extracts a set of unique string identifiers from a document dictionary. It collects the document&#x27;s ID, source path, and title, normalizing the source path for consistency. The function returns a set containing these identifiers, which may include the document ID, the raw source path, the normalized source path, and the document title if available.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_document_identifiers</span>(document: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">set</span>[<span style="color: #008000">str</span>]:
        identifiers: <span style="color: #008000">set</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        doc_id <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> doc_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            identifiers<span style="color: #666666">.</span>add(<span style="color: #008000">str</span>(doc_id))
        source_path <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> source_path:
            identifiers<span style="color: #666666">.</span>add(<span style="color: #008000">str</span>(source_path))
            identifiers<span style="color: #666666">.</span>add(SearchService<span style="color: #666666">.</span>_normalize_path(source_path))
        title <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(title, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> title:
            identifiers<span style="color: #666666">.</span>add(title)
        <span style="color: #008000; font-weight: bold">return</span> identifiers
</code></pre>
<h3 id="_normalize_path">Method: _normalize_path(path: str | Path) -&gt; str</h3>
<p>The function `_normalize_path` takes a path as input, which can be either a string or a `Path` object, and returns a normalized string representation of the path. It achieves this by converting the input to a `Path` object and then to a string, ensuring consistent path formatting.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalize_path</span>(path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(Path(path))
</code></pre>
<h3 id="_normalize_folder">Method: _normalize_folder(folder: str | Path | None) -&gt; str | None</h3>
<p>The function `_normalize_folder` takes a folder path as input, which can be a string, a `Path` object, or `None`. It returns `None` if the input is `None` or an empty string. Otherwise, it converts the input to a string representation of a `Path` object and returns that string. This ensures consistent handling of folder paths by normalizing them into a standard string format.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalize_folder</span>(folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #008000; font-weight: bold">None</span>, <span style="color: #BA2121">&quot;&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(Path(folder))
</code></pre>
<h3 id="_search_with_fallback">Method: _search_with_fallback(self, query: str, *, limit: int) -&gt; list[dict[str, Any]]</h3>
<p>The function `_search_with_fallback` performs a search query on an ingest index with fallback logic to handle overly strict MATCH syntax. It takes a query string and a limit for the number of results, normalizes the query, and generates multiple search attempts including wildcard-based variations. The function iterates through these attempts, executing searches and returning the first non-empty result set. If all attempts fail or return no results, it returns an empty list. The function handles potential `sqlite3.OperationalError` exceptions during search execution and ensures that duplicate attempts are not executed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_search_with_fallback</span>(<span style="color: #008000">self</span>, query: <span style="color: #008000">str</span>, <span style="color: #666666">*</span>, limit: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Query the ingest index while relaxing overly strict MATCH syntax.&quot;&quot;&quot;</span>

        normalized <span style="color: #666666">=</span> (query <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> normalized:
            <span style="color: #008000; font-weight: bold">return</span> []

        attempts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> [normalized]
        tokens <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_tokenize_query(normalized)
        <span style="color: #008000; font-weight: bold">if</span> tokens:
            wildcard_tokens <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>token<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">*&quot;</span> <span style="color: #008000; font-weight: bold">for</span> token <span style="color: #AA22FF; font-weight: bold">in</span> tokens]
            attempts<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot; OR &quot;</span><span style="color: #666666">.</span>join(wildcard_tokens))
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(tokens) <span style="color: #666666">&gt;</span> <span style="color: #666666">1</span>:
                attempts<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">.</span>join(wildcard_tokens))

        seen: <span style="color: #008000">set</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        <span style="color: #008000; font-weight: bold">for</span> candidate <span style="color: #AA22FF; font-weight: bold">in</span> attempts:
            candidate <span style="color: #666666">=</span> candidate<span style="color: #666666">.</span>strip()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> candidate <span style="color: #AA22FF; font-weight: bold">or</span> candidate <span style="color: #AA22FF; font-weight: bold">in</span> seen:
                <span style="color: #008000; font-weight: bold">continue</span>
            seen<span style="color: #666666">.</span>add(candidate)
            <span style="color: #008000; font-weight: bold">try</span>:
                results <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest<span style="color: #666666">.</span>search(candidate, limit<span style="color: #666666">=</span>limit)
            <span style="color: #008000; font-weight: bold">except</span> sqlite3<span style="color: #666666">.</span>OperationalError:
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">if</span> results:
                <span style="color: #008000; font-weight: bold">return</span> results
        <span style="color: #008000; font-weight: bold">return</span> []
</code></pre>
<h3 id="_tokenize_query">Method: _tokenize_query(self, query: str) -&gt; list[str]</h3>
<p>The function `_tokenize_query` extracts significant terms from a query string for use in relaxed fallback searches. It identifies tokens using a predefined pattern, filters out short or stop words, and ensures uniqueness of the resulting tokens. The output is a list of lowercase, filtered, and deduplicated tokens.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_tokenize_query</span>(<span style="color: #008000">self</span>, query: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Extract significant terms for relaxed fallback queries.&quot;&quot;&quot;</span>

        tokens <span style="color: #666666">=</span> [match<span style="color: #666666">.</span>group(<span style="color: #666666">0</span>)<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">for</span> match <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_TOKEN_PATTERN<span style="color: #666666">.</span>finditer(query)]
        filtered <span style="color: #666666">=</span> [
            token
            <span style="color: #008000; font-weight: bold">for</span> token <span style="color: #AA22FF; font-weight: bold">in</span> tokens
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(token) <span style="color: #666666">&gt;=</span> <span style="color: #666666">3</span> <span style="color: #AA22FF; font-weight: bold">and</span> token <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_STOPWORDS
        ]
        seen: <span style="color: #008000">set</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        unique: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> token <span style="color: #AA22FF; font-weight: bold">in</span> filtered:
            <span style="color: #008000; font-weight: bold">if</span> token <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> seen:
                seen<span style="color: #666666">.</span>add(token)
                unique<span style="color: #666666">.</span>append(token)
        <span style="color: #008000; font-weight: bold">return</span> unique
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
