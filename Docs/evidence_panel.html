<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>evidence_panel</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>evidence_panel</h1>
        <p>This module implements a UI widget for managing evidence records within a citation system, featuring controls for setting inclusion/exclusion states, previewing source content, and handling scope filters. The widget displays evidence records in list format with actions such as copy, open, and locate, while providing visual indicators for record states, scores, tags, and conflicts. Evidence records are represented by a data class containing metadata, state, and identifiers, with the widget supporting both compact and comfortable display densities. The module includes methods for normalizing citation inputs into structured `EvidenceRecord` objects, extracting fields like labels, snippets, metadata, scores, tags, and conflict information from both string and dictionary formats. Supporting functions handle identifier generation, copying selected records to clipboard with formatted text, locating records in source documents, and opening associated files. Event handlers manage selection changes, state updates, and UI interactions including filter resets and preview updates, with utilities for HTML-to-plain text conversion, conflict banner display, and reset button state control based on record modifications. The widget maintains scope state that can be reset or emitted to update external components, and includes signal handling for user interactions such as changing record states or requesting actions on evidence items.</p>
<h2 id="EvidenceRecord">Class: EvidenceRecord</h2>
<p>The `EvidenceRecord` class defines a structured representation of a citation entry with fields for identifier, label, snippet, metadata, path, raw data, state, score, badges, tags, conflict information, and document/passage identifiers. It includes a method `copy_with_state` that creates a new instance with an updated state while preserving all other field values. The class uses default factory functions for mutable fields like `step_badges`, `tags`, and `conflict_sources` to ensure proper initialization.</p>
<h3 id="copy_with_state">Method: copy_with_state(self, state: str) -&gt; &#x27;EvidenceRecord&#x27;</h3>
<p>The function `copy_with_state` creates a new instance of `EvidenceRecord` with the same attributes as the current instance, but with an updated `state` value. It copies all relevant fields including identifier, label, snippet HTML, metadata text, path, raw content, score, step badges, tags, conflict summary, conflict sources, document ID, and passage ID. The new instance is returned with the specified state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">copy_with_state</span>(<span style="color: #008000">self</span>, state: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #BA2121">&quot;EvidenceRecord&quot;</span>:
        updated <span style="color: #666666">=</span> EvidenceRecord(
            identifier<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>identifier,
            label<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>label,
            snippet_html<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_html,
            metadata_text<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_text,
            path<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>path,
            raw<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>raw,
            state<span style="color: #666666">=</span>state,
            score<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>score,
            step_badges<span style="color: #666666">=</span><span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>step_badges),
            tags<span style="color: #666666">=</span><span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>tags),
            conflict_summary<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>conflict_summary,
            conflict_sources<span style="color: #666666">=</span><span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>conflict_sources),
            document_id<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>document_id,
            passage_id<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>passage_id,
        )
        <span style="color: #008000; font-weight: bold">return</span> updated
</code></pre>
<h2 id="_EvidenceRow">Class: _EvidenceRow</h2>
<p>The `_EvidenceRow` class presents a single evidence entry within a Qt application, displaying its label, snippet, metadata, and associated badges. It provides interactive elements such as include/exclude toggles, copy, open, and locate buttons, along with signals for state changes and user actions. The class supports dynamic updates and layout adjustments based on density settings and record modifications.</p>
<h3 id="__init__">Method: __init__(self, record: EvidenceRecord, parent: QWidget | None=None) -&gt; None</h3>
<p>The `__init__` method initializes an `_EvidenceRow` widget, which represents a single evidence item in a user interface. It sets up the layout and components for displaying evidence metadata, including a title, snippet, and metadata text. The row includes interactive elements such as &quot;Include&quot; and &quot;Exclude&quot; toggles, badges, and action buttons (&quot;Copy&quot;, &quot;Open&quot;, &quot;Locate&quot;). The widget is configured with object names for styling and connects signals to handle user interactions. The layout uses `QVBoxLayout` and `QHBoxLayout` to organize components vertically and horizontally, ensuring proper spacing and alignment. The evidence record&#x27;s data is used to populate labels and set button states, and the widget emits signals when actions like copying, opening, or locating are triggered.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, record: EvidenceRecord, parent: QWidget <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">super</span>()<span style="color: #666666">.</span><span style="color: #0000FF">__init__</span>(parent)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>record <span style="color: #666666">=</span> record
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidenceRow&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;comfortable&quot;</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout <span style="color: #666666">=</span> QVBoxLayout(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">12</span>, <span style="color: #666666">12</span>, <span style="color: #666666">12</span>, <span style="color: #666666">12</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">8</span>)

        header <span style="color: #666666">=</span> QHBoxLayout()
        header<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">8</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>addLayout(header)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>title_label <span style="color: #666666">=</span> QLabel(record<span style="color: #666666">.</span>label, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>title_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidenceTitle&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>title_label<span style="color: #666666">.</span>setWordWrap(<span style="color: #008000; font-weight: bold">True</span>)
        header<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>title_label, <span style="color: #666666">1</span>)

        toggles <span style="color: #666666">=</span> QHBoxLayout()
        toggles<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">4</span>)
        header<span style="color: #666666">.</span>addLayout(toggles)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button <span style="color: #666666">=</span> QToolButton(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;includeButton&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>setText(<span style="color: #BA2121">&quot;Include&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>setCheckable(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>setChecked(record<span style="color: #666666">.</span>state <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;include&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>toggled<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_include_toggled)
        toggles<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>include_button)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button <span style="color: #666666">=</span> QToolButton(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;excludeButton&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>setText(<span style="color: #BA2121">&quot;Exclude&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>setCheckable(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>setChecked(record<span style="color: #666666">.</span>state <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;exclude&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>toggled<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_exclude_toggled)
        toggles<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row <span style="color: #666666">=</span> QHBoxLayout()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">6</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>addLayout(<span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_populate_badges()

        <span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label <span style="color: #666666">=</span> QLabel(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidenceSnippet&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label<span style="color: #666666">.</span>setTextFormat(Qt<span style="color: #666666">.</span>TextFormat<span style="color: #666666">.</span>RichText)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label<span style="color: #666666">.</span>setWordWrap(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label<span style="color: #666666">.</span>setText(record<span style="color: #666666">.</span>snippet_html <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&lt;i&gt;No snippet provided.&lt;/i&gt;&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label<span style="color: #666666">.</span>setTextInteractionFlags(Qt<span style="color: #666666">.</span>TextInteractionFlag<span style="color: #666666">.</span>TextSelectableByMouse)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label <span style="color: #666666">=</span> QLabel(record<span style="color: #666666">.</span>metadata_text, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidenceMeta&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label<span style="color: #666666">.</span>setWordWrap(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row <span style="color: #666666">=</span> QHBoxLayout()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">6</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>addLayout(<span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_button <span style="color: #666666">=</span> QToolButton(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;copyEvidence&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_button<span style="color: #666666">.</span>setText(<span style="color: #BA2121">&quot;Copy&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>copy_requested<span style="color: #666666">.</span>emit)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>copy_button)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>open_button <span style="color: #666666">=</span> QToolButton(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>open_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;openEvidence&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>open_button<span style="color: #666666">.</span>setText(<span style="color: #BA2121">&quot;Open&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>open_button<span style="color: #666666">.</span>setEnabled(<span style="color: #008000">bool</span>(record<span style="color: #666666">.</span>path))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>open_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>open_requested<span style="color: #666666">.</span>emit)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>open_button)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>locate_button <span style="color: #666666">=</span> QToolButton(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>locate_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;locateEvidence&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>locate_button<span style="color: #666666">.</span>setText(<span style="color: #BA2121">&quot;Locate&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>locate_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>locate_requested<span style="color: #666666">.</span>emit)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>locate_button)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row<span style="color: #666666">.</span>addStretch(<span style="color: #666666">1</span>)
</code></pre>
<h3 id="set_state">Method: set_state(self, state: str) -&gt; None</h3>
<p>The function `set_state` updates the UI state of an evidence row by synchronizing the checkbox states of `include_button` and `exclude_button` based on the provided `state` string. It uses signal blockers to prevent signal handling during the update to avoid unintended side effects. After updating the UI, it calls `copy_with_state` on the underlying record to reflect the new state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_state</span>(<span style="color: #008000">self</span>, state: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">with</span> _SignalBlocker(<span style="color: #008000">self</span><span style="color: #666666">.</span>include_button), _SignalBlocker(<span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>setChecked(state <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;include&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>setChecked(state <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;exclude&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>copy_with_state(state)
</code></pre>
<h3 id="set_density">Method: set_density(self, density: str) -&gt; None</h3>
<p>The `set_density` function configures the layout and spacing of the `_EvidenceRow` based on a specified density setting. When the density is set to &quot;compact&quot;, it applies tighter margins and spacing values; otherwise, it uses looser spacing. The function updates the content margins of the main layout, the spacing between items in the main layout, and adjusts the spacing for badge and action rows accordingly.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_density</span>(<span style="color: #008000">self</span>, density: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> density
        compact <span style="color: #666666">=</span> density <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span>
        margin <span style="color: #666666">=</span> <span style="color: #666666">8</span> <span style="color: #008000; font-weight: bold">if</span> compact <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">12</span>
        spacing <span style="color: #666666">=</span> <span style="color: #666666">4</span> <span style="color: #008000; font-weight: bold">if</span> compact <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">8</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setContentsMargins(margin, margin, margin, margin)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setSpacing(spacing)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">4</span> <span style="color: #008000; font-weight: bold">if</span> compact <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">6</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row<span style="color: #666666">.</span>setSpacing(spacing)
</code></pre>
<h3 id="refresh">Method: refresh(self) -&gt; None</h3>
<p>The `refresh` method updates the display elements of the `_EvidenceRow` based on the data contained in `self.record`. It sets the title label to the record&#x27;s label, populates the snippet label with either the record&#x27;s HTML snippet or a default message if none is provided, displays the record&#x27;s metadata text, enables or disables the open button depending on whether a file path is present, and calls `_populate_badges()` to update any badges associated with the evidence row.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">refresh</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>title_label<span style="color: #666666">.</span>setText(<span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>label)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>snippet_label<span style="color: #666666">.</span>setText(<span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>snippet_html <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&lt;i&gt;No snippet provided.&lt;/i&gt;&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label<span style="color: #666666">.</span>setText(<span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>metadata_text)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>open_button<span style="color: #666666">.</span>setEnabled(<span style="color: #008000">bool</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>path))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_populate_badges()
</code></pre>
<h3 id="_populate_badges">Method: _populate_badges(self) -&gt; None</h3>
<p>The function `_populate_badges` clears existing widgets from a layout row and repopulates it with badge widgets based on data from `self.record`. It iterates through step badges, tags, score, and conflict summary to create and add corresponding badge widgets to the layout. Each badge is created using the `_make_badge` method with appropriate types and tooltips where applicable. A stretch item is added at the end of the layout to provide spacing.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_populate_badges</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>count():
            item <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>takeAt(<span style="color: #666666">0</span>)
            widget <span style="color: #666666">=</span> item<span style="color: #666666">.</span>widget()
            <span style="color: #008000; font-weight: bold">if</span> widget <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                widget<span style="color: #666666">.</span>deleteLater()
        <span style="color: #008000; font-weight: bold">for</span> step <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>step_badges:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_make_badge(step, <span style="color: #BA2121">&quot;step&quot;</span>))
        <span style="color: #008000; font-weight: bold">for</span> tag <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>tags:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_make_badge(tag, <span style="color: #BA2121">&quot;tag&quot;</span>))
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>score <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>addWidget(
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_make_badge(<span style="color: #BA2121">f&quot;Score </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>score<span style="color: #A45A77; font-weight: bold">:</span><span style="color: #BA2121">.2f</span><span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;score&quot;</span>)
            )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>conflict_summary:
            badge <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_make_badge(<span style="color: #BA2121">&quot;Conflict&quot;</span>, <span style="color: #BA2121">&quot;conflict&quot;</span>)
            badge<span style="color: #666666">.</span>setToolTip(<span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>conflict_summary)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>addWidget(badge)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_badge_row<span style="color: #666666">.</span>addStretch(<span style="color: #666666">1</span>)
</code></pre>
<h3 id="_make_badge">Method: _make_badge(self, text: str, kind: str) -&gt; QLabel</h3>
<p>The function `_make_badge` creates and configures a `QLabel` widget to serve as a badge element. It takes a text string and a kind identifier as inputs, sets the label&#x27;s object name to &quot;evidenceBadge&quot;, assigns the kind as a property, and returns the configured label. This method is used within the `_EvidenceRow` class to generate badge widgets for displaying evidence-related information.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_make_badge</span>(<span style="color: #008000">self</span>, text: <span style="color: #008000">str</span>, kind: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> QLabel:
        badge <span style="color: #666666">=</span> QLabel(text, <span style="color: #008000">self</span>)
        badge<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidenceBadge&quot;</span>)
        badge<span style="color: #666666">.</span>setProperty(<span style="color: #BA2121">&quot;kind&quot;</span>, kind)
        <span style="color: #008000; font-weight: bold">return</span> badge
</code></pre>
<h3 id="_on_include_toggled">Method: _on_include_toggled(self, checked: bool) -&gt; None</h3>
<p>The function `_on_include_toggled` handles the toggling of an include checkbox in an evidence row. When the checkbox is checked, it ensures the exclude button is unchecked, sets the state to &quot;include&quot;, and updates the record and emits a state change signal. When unchecked, it sets the state to &quot;neutral&quot; if the exclude button is also unchecked, otherwise to &quot;exclude&quot;. The record is updated with the new state, and a `state_changed` signal is emitted with the current state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_include_toggled</span>(<span style="color: #008000">self</span>, checked: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> checked:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>isChecked():
                <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>setChecked(<span style="color: #008000; font-weight: bold">False</span>)
            state <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;include&quot;</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            state <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;neutral&quot;</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>exclude_button<span style="color: #666666">.</span>isChecked() <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;exclude&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>copy_with_state(state)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>state_changed<span style="color: #666666">.</span>emit(state)
</code></pre>
<h3 id="_on_exclude_toggled">Method: _on_exclude_toggled(self, checked: bool) -&gt; None</h3>
<p>The function `_on_exclude_toggled` handles the toggle event for an exclude checkbox within an evidence row. When the exclude checkbox is checked, it ensures the include checkbox is unchecked, sets the state to &quot;exclude&quot;, and updates the record with this new state. If the exclude checkbox is unchecked, it checks the state of the include button to determine whether to set the state as &quot;include&quot; or &quot;neutral&quot;. Finally, it emits a `state_changed` signal with the updated state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_exclude_toggled</span>(<span style="color: #008000">self</span>, checked: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> checked:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>isChecked():
                <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>setChecked(<span style="color: #008000; font-weight: bold">False</span>)
            state <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;exclude&quot;</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            state <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;include&quot;</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>include_button<span style="color: #666666">.</span>isChecked() <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;neutral&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>record<span style="color: #666666">.</span>copy_with_state(state)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>state_changed<span style="color: #666666">.</span>emit(state)
</code></pre>
<h2 id="_SignalBlocker">Class: _SignalBlocker</h2>
<p>The `_SignalBlocker` class implements a context manager that temporarily blocks signals on a Qt widget. It stores the widget&#x27;s previous signal blocking state during entry and restores it during exit. The class provides a clean way to prevent signal emission while executing code within its context.</p>
<h3 id="__init__">Method: __init__(self, widget: QWidget) -&gt; None</h3>
<p>The `__init__` method initializes a `_SignalBlocker` instance with a specified `QWidget` and sets an internal flag `_previous` to `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, widget: QWidget) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>widget <span style="color: #666666">=</span> widget
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_previous <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
<h3 id="__enter__">Method: __enter__(self) -&gt; None</h3>
<p>The `__enter__` method of the `_SignalBlocker` class enables context manager functionality. It blocks signals from the widget by calling `blockSignals(True)` and stores the previous signal-blocking state in `self._previous`. This allows temporary suppression of widget signals during specific operations, with the ability to restore the original signal state upon exiting the context.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__enter__</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_previous <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>widget<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
</code></pre>
<h3 id="__exit__">Method: __exit__(self, *_exc: object) -&gt; None</h3>
<p>The `__exit__` method of the `_SignalBlocker` class restores the signal-blocking state of a widget. It takes an arbitrary number of exception arguments and sets the widget&#x27;s signal blocking to its previous state, ensuring that signals are properly re-enabled after the block has been applied.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__exit__</span>(<span style="color: #008000">self</span>, <span style="color: #666666">*</span>_exc: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>widget<span style="color: #666666">.</span>blockSignals(<span style="color: #008000">self</span><span style="color: #666666">.</span>_previous)
</code></pre>
<h2 id="EvidencePanel">Class: EvidencePanel</h2>
<p>The `EvidencePanel` class defines a composite Qt widget for displaying a list of evidence items, each represented by an `EvidenceRecord`. It includes functionality for selecting, previewing, and managing the inclusion or exclusion scope of evidence items. The widget supports dynamic updates to the evidence list, state changes, conflict detection, and interaction signals for copying, locating, and opening evidence sources. It also provides methods to reset the scope of evidence items and adjust the visual density of the list.</p>
<h3 id="__init__">Method: __init__(self, parent: QWidget | None=None) -&gt; None</h3>
<p>Initializes the `EvidencePanel` widget, setting up its internal state and UI components. The panel consists of a list widget for displaying evidence records, a text browser for previewing selected evidence, and metadata display with a reset scope button. It also includes a conflict banner that is initially hidden. The layout is configured with margins and spacing, and connections are established for handling row selection in the list and resetting scope filters. An empty state is initialized for the panel.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, parent: QWidget <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">super</span>()<span style="color: #666666">.</span><span style="color: #0000FF">__init__</span>(parent)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_records: <span style="color: #008000">list</span>[EvidenceRecord] <span style="color: #666666">=</span> []
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_suppress_scope <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;comfortable&quot;</span>

        layout <span style="color: #666666">=</span> QVBoxLayout(<span style="color: #008000">self</span>)
        layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">8</span>, <span style="color: #666666">8</span>, <span style="color: #666666">8</span>, <span style="color: #666666">8</span>)
        layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">8</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner <span style="color: #666666">=</span> QLabel(<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;conflictBanner&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner<span style="color: #666666">.</span>setWordWrap(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">False</span>)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_list <span style="color: #666666">=</span> QListWidget(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidenceList&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setSelectionMode(QAbstractItemView<span style="color: #666666">.</span>SelectionMode<span style="color: #666666">.</span>SingleSelection)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>currentRowChanged<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_row_selected)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_list, <span style="color: #666666">1</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_preview <span style="color: #666666">=</span> QTextBrowser(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_preview<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidencePreview&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_preview<span style="color: #666666">.</span>setOpenExternalLinks(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_preview<span style="color: #666666">.</span>setPlaceholderText(<span style="color: #BA2121">&quot;Select evidence to see highlighted passages.&quot;</span>)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_preview, <span style="color: #666666">2</span>)

        meta_row <span style="color: #666666">=</span> QHBoxLayout()
        meta_row<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>)
        meta_row<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">6</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_metadata_label <span style="color: #666666">=</span> QLabel(<span style="color: #BA2121">&quot;No evidence selected.&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_metadata_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidenceMetadata&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_metadata_label<span style="color: #666666">.</span>setWordWrap(<span style="color: #008000; font-weight: bold">True</span>)
        meta_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_metadata_label, <span style="color: #666666">1</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_reset_scope_button <span style="color: #666666">=</span> QPushButton(<span style="color: #BA2121">&quot;Reset scope&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_reset_scope_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;resetScopeButton&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_reset_scope_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_reset_scope_filters)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_reset_scope_button<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
        meta_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_reset_scope_button)

        layout<span style="color: #666666">.</span>addLayout(meta_row)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_empty_state()
</code></pre>
<h3 id="evidence_items">Method: evidence_items(self) -&gt; list[EvidenceRecord]</h3>
<p>The function `evidence_items` is a method of the `EvidencePanel` class that returns a list of `EvidenceRecord` objects. It retrieves and provides access to the internal collection of evidence records stored in `self._records`. The returned list is a copy of the records, ensuring that modifications to the returned list do not affect the original collection. This method allows external code to obtain and iterate over the evidence items contained within the panel.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">evidence_items</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[EvidenceRecord]:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records)
</code></pre>
<h3 id="evidence_count">Method: evidence_count(self) -&gt; int</h3>
<p>The function `evidence_count` returns the number of records in the `EvidencePanel` instance by calculating the length of the `_records` attribute.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">evidence_count</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records)
</code></pre>
<h3 id="selected_index">Method: selected_index(self) -&gt; int | None</h3>
<p>Returns the index of the currently selected item in the list, or `None` if no item is selected.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">selected_index</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        row <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>currentRow()
        <span style="color: #008000; font-weight: bold">return</span> row <span style="color: #008000; font-weight: bold">if</span> row <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="selected_record">Method: selected_record(self) -&gt; EvidenceRecord | None</h3>
<p>Returns the `EvidenceRecord` object at the currently selected index in the panel&#x27;s records list. If no index is selected or if the index is out of range, returns `None`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">selected_record</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> EvidenceRecord <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        index <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>selected_index
        <span style="color: #008000; font-weight: bold">if</span> index <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records[index]
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">IndexError</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive guard</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="current_scope">Method: current_scope(self) -&gt; dict[str, list[str]]</h3>
<p>The function `current_scope` returns a dictionary representing the current inclusion and exclusion scope of records within the `EvidencePanel`. It iterates through `self._records`, collecting identifiers of records marked with the state &quot;include&quot; into an `include` list and those marked with the state &quot;exclude&quot; into an `exclude` list. The function then returns a dictionary with these two lists under the keys &quot;include&quot; and &quot;exclude&quot;, respectively.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">current_scope</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]]:
        include <span style="color: #666666">=</span> [record<span style="color: #666666">.</span>identifier <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>state <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;include&quot;</span>]
        exclude <span style="color: #666666">=</span> [record<span style="color: #666666">.</span>identifier <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>state <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;exclude&quot;</span>]
        <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;include&quot;</span>: include, <span style="color: #BA2121">&quot;exclude&quot;</span>: exclude}
</code></pre>
<h3 id="clear">Method: clear(self) -&gt; None</h3>
<p>The `clear` method in the `EvidencePanel` class resets the panel&#x27;s state by clearing its internal records and list, updating the empty state display, and refreshing the reset button&#x27;s enabled status.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">clear</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_records<span style="color: #666666">.</span>clear()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>clear()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_empty_state()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_reset_button_state()
</code></pre>
<h3 id="set_evidence">Method: set_evidence(self, citations: Iterable[Any], *, emit_scope: bool=False) -&gt; None</h3>
<p>The `set_evidence` method in the `EvidencePanel` class configures the panel&#x27;s content based on a collection of citations. It processes each citation by normalizing it and assigns the normalized records to the panel. The method updates the list display, selects the first record if available, and refreshes the preview and reset button states. If the `emit_scope` flag is set to True, it emits a signal containing the current include and exclude scope values from the panel&#x27;s scope. The method temporarily suppresses scope-related updates during processing to avoid interference.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_evidence</span>(<span style="color: #008000">self</span>, citations: Iterable[Any], <span style="color: #666666">*</span>, emit_scope: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_suppress_scope <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_records <span style="color: #666666">=</span> [<span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_citation(index, raw) <span style="color: #008000; font-weight: bold">for</span> index, raw <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(citations, start<span style="color: #666666">=1</span>)]
        <span style="color: #008000; font-weight: bold">finally</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_suppress_scope <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_populate_list()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setCurrentRow(<span style="color: #666666">0</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_preview(<span style="color: #666666">0</span>)
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_empty_state()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_reset_button_state()
        <span style="color: #008000; font-weight: bold">if</span> emit_scope:
            scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>current_scope
            <span style="color: #008000">self</span><span style="color: #666666">.</span>scope_changed<span style="color: #666666">.</span>emit(scope[<span style="color: #BA2121">&quot;include&quot;</span>], scope[<span style="color: #BA2121">&quot;exclude&quot;</span>])
</code></pre>
<h3 id="select_index">Method: select_index(self, index: int) -&gt; None</h3>
<p>Selects the item at the specified index in the list widget. If the index is valid (within the range of the list count), it sets the current row of the list to the given index.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">select_index</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">0</span> <span style="color: #666666">&lt;=</span> index <span style="color: #666666">&lt;</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>count():
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setCurrentRow(index)
</code></pre>
<h3 id="set_density">Method: set_density(self, density: str) -&gt; None</h3>
<p>The `set_density` function configures the spacing and density of elements within the `EvidencePanel`. It updates the internal `_density` attribute based on the provided string value (`&quot;compact&quot;` or otherwise). Depending on the density setting, it adjusts the vertical spacing of the panel&#x27;s layout and propagates the density setting to each `_EvidenceRow` widget contained in the panel&#x27;s list. The function ensures consistent visual density across all evidence rows and the overall layout.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_density</span>(<span style="color: #008000">self</span>, density: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> density
        spacing <span style="color: #666666">=</span> <span style="color: #666666">6</span> <span style="color: #008000; font-weight: bold">if</span> density <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">8</span>
        layout <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>layout()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(layout, QVBoxLayout):
            layout<span style="color: #666666">.</span>setSpacing(spacing)
        <span style="color: #008000; font-weight: bold">for</span> row <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>count()):
            widget <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>itemWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>item(row))
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(widget, _EvidenceRow):
                widget<span style="color: #666666">.</span>set_density(density)
</code></pre>
<h3 id="reset_scope">Method: reset_scope(self) -&gt; None</h3>
<p>The `reset_scope` function resets the scope of evidence records by updating their state to &quot;include&quot; and synchronizing the corresponding UI widgets. It temporarily suppresses scope updates during the process, iterates through the records to reset their state and update the associated UI elements, and then emits a signal indicating the scope change. Finally, it updates the state of the reset button.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">reset_scope</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_suppress_scope <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">for</span> index, record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records):
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_records[index] <span style="color: #666666">=</span> record<span style="color: #666666">.</span>copy_with_state(<span style="color: #BA2121">&quot;include&quot;</span>)
                item <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>item(index)
                widget <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>itemWidget(item) <span style="color: #008000; font-weight: bold">if</span> item <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(widget, _EvidenceRow):
                    widget<span style="color: #666666">.</span>set_state(<span style="color: #BA2121">&quot;include&quot;</span>)
        <span style="color: #008000; font-weight: bold">finally</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_suppress_scope <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
        scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>current_scope
        <span style="color: #008000">self</span><span style="color: #666666">.</span>scope_changed<span style="color: #666666">.</span>emit(scope[<span style="color: #BA2121">&quot;include&quot;</span>], scope[<span style="color: #BA2121">&quot;exclude&quot;</span>])
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_reset_button_state()
</code></pre>
<h3 id="_empty_state">Method: _empty_state(self) -&gt; None</h3>
<p>The function `_empty_state` configures the `EvidencePanel` to display an empty state. It sets the preview area to show &quot;No evidence available.&quot;, updates the metadata label to indicate no evidence is selected, hides the conflict banner, and updates the reset button state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_empty_state</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_preview<span style="color: #666666">.</span>setHtml(<span style="color: #BA2121">&quot;&lt;p&gt;No evidence available.&lt;/p&gt;&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_metadata_label<span style="color: #666666">.</span>setText(<span style="color: #BA2121">&quot;No evidence selected.&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_reset_button_state()
</code></pre>
<h3 id="_populate_list">Method: _populate_list(self) -&gt; None</h3>
<p>The `_populate_list` method populates a list widget with evidence items derived from a collection of records. It clears the existing list, creates a custom row widget for each record, and connects signals from the widget to handler methods for state changes, copying, locating, and opening actions. Each widget is associated with its corresponding list item, and the item&#x27;s size hint is set based on the widget&#x27;s dimensions. If a record contains a conflict summary, it is collected and used to update a conflict banner. Finally, the method updates the state of a reset button.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_populate_list</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>clear()
        conflict_messages: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> index, record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records):
            item <span style="color: #666666">=</span> QListWidgetItem(<span style="color: #008000">self</span><span style="color: #666666">.</span>_list)
            widget <span style="color: #666666">=</span> _EvidenceRow(record, <span style="color: #008000">self</span><span style="color: #666666">.</span>_list)
            widget<span style="color: #666666">.</span>state_changed<span style="color: #666666">.</span>connect(
                <span style="color: #008000; font-weight: bold">lambda</span> state, rec<span style="color: #666666">=</span>record: <span style="color: #008000">self</span><span style="color: #666666">.</span>_on_state_changed(rec, state)
            )
            widget<span style="color: #666666">.</span>copy_requested<span style="color: #666666">.</span>connect(
                <span style="color: #008000; font-weight: bold">lambda</span> _checked<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>, rec<span style="color: #666666">=</span>record, item<span style="color: #666666">=</span>item: <span style="color: #008000">self</span><span style="color: #666666">.</span>_handle_copy(rec, item)
            )
            widget<span style="color: #666666">.</span>locate_requested<span style="color: #666666">.</span>connect(
                <span style="color: #008000; font-weight: bold">lambda</span> _checked<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>, rec<span style="color: #666666">=</span>record, item<span style="color: #666666">=</span>item: <span style="color: #008000">self</span><span style="color: #666666">.</span>_handle_locate(rec, item)
            )
            widget<span style="color: #666666">.</span>open_requested<span style="color: #666666">.</span>connect(
                <span style="color: #008000; font-weight: bold">lambda</span> _checked<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>, rec<span style="color: #666666">=</span>record, item<span style="color: #666666">=</span>item: <span style="color: #008000">self</span><span style="color: #666666">.</span>_handle_open(rec, item)
            )
            widget<span style="color: #666666">.</span>set_density(<span style="color: #008000">self</span><span style="color: #666666">.</span>_density)
            item<span style="color: #666666">.</span>setSizeHint(widget<span style="color: #666666">.</span>sizeHint())
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>addItem(item)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setItemWidget(item, widget)
            <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>conflict_summary:
                conflict_messages<span style="color: #666666">.</span>append(record<span style="color: #666666">.</span>conflict_summary)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_conflict_banner(conflict_messages)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_reset_button_state()
</code></pre>
<h3 id="_normalize_citation">Method: _normalize_citation(self, index: int, citation: Any) -&gt; EvidenceRecord</h3>
<p>The function `_normalize_citation` processes a citation object of varying types (string or dictionary) and converts it into an `EvidenceRecord` instance. It extracts and formats information such as label, snippet, metadata, path, score, steps, tags, conflict details, document ID, and passage ID. The function handles different input structures, normalizes data, escapes HTML content, and constructs a standardized record for use in evidence panels. It supports parsing of nested citation data, location details (page, section), step information, and conflict metadata. The output is an `EvidenceRecord` with fields populated based on the input citation&#x27;s contents.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalize_citation</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span>, citation: Any) <span style="color: #666666">-&gt;</span> EvidenceRecord:
        score: <span style="color: #008000">float</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        steps: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        tags: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        conflict_summary: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        conflict_sources: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> []
        document_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        passage_id: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">str</span>):
            label <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">] </span><span style="color: #A45A77; font-weight: bold">{</span>citation<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            snippet <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(citation)
            metadata <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
            path <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">dict</span>):
            data <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(citation)
            nested <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;citation&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(nested, <span style="color: #008000">dict</span>):
                merged <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(nested)
                <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> data<span style="color: #666666">.</span>items():
                    <span style="color: #008000; font-weight: bold">if</span> key <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> merged:
                        merged[key] <span style="color: #666666">=</span> value
                data <span style="color: #666666">=</span> merged
            source <span style="color: #666666">=</span> <span style="color: #008000">str</span>(
                data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">f&quot;Source </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            )<span style="color: #666666">.</span>strip()
            label <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">] </span><span style="color: #A45A77; font-weight: bold">{</span>source<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">if</span> source <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">] Source&quot;</span>
            snippet_raw <span style="color: #666666">=</span> (
                data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;snippet&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;highlight&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;preview&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
            )
            snippet <span style="color: #666666">=</span> snippet_raw <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(snippet_raw, <span style="color: #008000">str</span>) <span style="color: #008000; font-weight: bold">else</span> html<span style="color: #666666">.</span>escape(<span style="color: #008000">str</span>(snippet_raw))
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;&lt;&quot;</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> snippet:
                snippet <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(snippet)
            location_parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
            page <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;page&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;page_number&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> page:
                location_parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Page </span><span style="color: #A45A77; font-weight: bold">{</span>page<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            section <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;section&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;heading&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> section:
                location_parts<span style="color: #666666">.</span>append(<span style="color: #008000">str</span>(section))
            raw_steps <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;steps&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(raw_steps, Iterable) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(raw_steps, (<span style="color: #008000">str</span>, <span style="color: #008000">bytes</span>, <span style="color: #008000">dict</span>)):
                step_ids <span style="color: #666666">=</span> [<span style="color: #008000">str</span>(step)<span style="color: #666666">.</span>strip() <span style="color: #008000; font-weight: bold">for</span> step <span style="color: #AA22FF; font-weight: bold">in</span> raw_steps <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(step)<span style="color: #666666">.</span>strip()]
                <span style="color: #008000; font-weight: bold">if</span> step_ids:
                    steps <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;Step </span><span style="color: #A45A77; font-weight: bold">{</span>value<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">for</span> value <span style="color: #AA22FF; font-weight: bold">in</span> step_ids]
                    location_parts<span style="color: #666666">.</span>insert(<span style="color: #666666">0</span>, <span style="color: #BA2121">f&quot;Steps </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #BA2121">&#39;, &#39;</span><span style="color: #666666">.</span>join(step_ids)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000; font-weight: bold">else</span>:
                single_step <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;step&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;step_index&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(single_step, (<span style="color: #008000">int</span>, <span style="color: #008000">str</span>)):
                    step_value <span style="color: #666666">=</span> <span style="color: #008000">str</span>(single_step)<span style="color: #666666">.</span>strip()
                    <span style="color: #008000; font-weight: bold">if</span> step_value:
                        steps <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;Step </span><span style="color: #A45A77; font-weight: bold">{</span>step_value<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>]
                        location_parts<span style="color: #666666">.</span>insert(<span style="color: #666666">0</span>, <span style="color: #BA2121">f&quot;Step </span><span style="color: #A45A77; font-weight: bold">{</span>step_value<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            metadata <span style="color: #666666">=</span> <span style="color: #BA2121">&quot; | &quot;</span><span style="color: #666666">.</span>join(location_parts)
            path <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;file_path&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(path, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> path<span style="color: #666666">.</span>strip():
                path <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
            score_value <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;score&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;similarity&quot;</span>)
            <span style="color: #008000; font-weight: bold">try</span>:
                score <span style="color: #666666">=</span> <span style="color: #008000">float</span>(score_value) <span style="color: #008000; font-weight: bold">if</span> score_value <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">TypeError</span>, <span style="color: #CB3F38; font-weight: bold">ValueError</span>):
                score <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
            tags_raw <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;tag_names&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;tags&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(tags_raw, Iterable) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(tags_raw, (<span style="color: #008000">str</span>, <span style="color: #008000">bytes</span>, <span style="color: #008000">dict</span>)):
                tags <span style="color: #666666">=</span> [<span style="color: #008000">str</span>(tag)<span style="color: #666666">.</span>strip() <span style="color: #008000; font-weight: bold">for</span> tag <span style="color: #AA22FF; font-weight: bold">in</span> tags_raw <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(tag)<span style="color: #666666">.</span>strip()]
            <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(tags_raw, <span style="color: #008000">str</span>):
                tag_value <span style="color: #666666">=</span> tags_raw<span style="color: #666666">.</span>strip()
                <span style="color: #008000; font-weight: bold">if</span> tag_value:
                    tags <span style="color: #666666">=</span> [tag_value]
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> tags:
                single_tag <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;tag&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;tag_name&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(single_tag, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> single_tag<span style="color: #666666">.</span>strip():
                    tags <span style="color: #666666">=</span> [single_tag<span style="color: #666666">.</span>strip()]
            summary_raw <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;conflict_summary&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;conflictSummary&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(summary_raw, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> summary_raw<span style="color: #666666">.</span>strip():
                conflict_summary <span style="color: #666666">=</span> summary_raw<span style="color: #666666">.</span>strip()
            conflicts_raw <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;conflicts&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(conflicts_raw, Iterable) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(conflicts_raw, (<span style="color: #008000">str</span>, <span style="color: #008000">bytes</span>)):
                conflict_sources <span style="color: #666666">=</span> [c <span style="color: #008000; font-weight: bold">for</span> c <span style="color: #AA22FF; font-weight: bold">in</span> conflicts_raw <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(c, <span style="color: #008000">dict</span>)]
                <span style="color: #008000; font-weight: bold">if</span> conflict_sources:
                    ids <span style="color: #666666">=</span> [
                        <span style="color: #008000">str</span>(conflict<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;passage_id&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> conflict<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document_id&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)
                        <span style="color: #008000; font-weight: bold">for</span> conflict <span style="color: #AA22FF; font-weight: bold">in</span> conflict_sources
                    ]
                    names <span style="color: #666666">=</span> [value <span style="color: #008000; font-weight: bold">for</span> value <span style="color: #AA22FF; font-weight: bold">in</span> ids <span style="color: #008000; font-weight: bold">if</span> value]
                    label_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(names[:<span style="color: #666666">3</span>])
                    remaining <span style="color: #666666">=</span> <span style="color: #008000">max</span>(<span style="color: #666666">0</span>, <span style="color: #008000">len</span>(names) <span style="color: #666666">-</span> <span style="color: #666666">3</span>)
                    <span style="color: #008000; font-weight: bold">if</span> remaining:
                        label_text <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>label_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> +</span><span style="color: #A45A77; font-weight: bold">{</span>remaining<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
                    <span style="color: #008000; font-weight: bold">if</span> label_text:
                        conflict_summary <span style="color: #666666">=</span> (
                            <span style="color: #BA2121">f&quot;Conflicts with </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">len</span>(conflict_sources)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> passages (</span><span style="color: #A45A77; font-weight: bold">{</span>label_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">)&quot;</span>
                        )
                    <span style="color: #008000; font-weight: bold">else</span>:
                        conflict_summary <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Conflicts with </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">len</span>(conflict_sources)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> passages&quot;</span>
            doc_id_raw <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document_id&quot;</span>)
            <span style="color: #008000; font-weight: bold">try</span>:
                document_id <span style="color: #666666">=</span> <span style="color: #008000">int</span>(doc_id_raw) <span style="color: #008000; font-weight: bold">if</span> doc_id_raw <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">TypeError</span>, <span style="color: #CB3F38; font-weight: bold">ValueError</span>):
                document_id <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
            passage <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;passage_id&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>)
            passage_id <span style="color: #666666">=</span> <span style="color: #008000">str</span>(passage)<span style="color: #666666">.</span>strip() <span style="color: #008000; font-weight: bold">if</span> passage <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            label <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">] </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">str</span>(citation)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            snippet <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(<span style="color: #008000">str</span>(citation))
            metadata <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
            path <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        identifier <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_identifier(citation, fallback<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;citation-</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        metadata_text <span style="color: #666666">=</span> metadata <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Location unknown&quot;</span>
        <span style="color: #008000; font-weight: bold">return</span> EvidenceRecord(
            identifier<span style="color: #666666">=</span>identifier,
            label<span style="color: #666666">=</span>label,
            snippet_html<span style="color: #666666">=</span>snippet,
            metadata_text<span style="color: #666666">=</span>metadata_text,
            path<span style="color: #666666">=</span>path,
            raw<span style="color: #666666">=</span>citation,
            state<span style="color: #666666">=</span><span style="color: #BA2121">&quot;include&quot;</span>,
            score<span style="color: #666666">=</span>score,
            step_badges<span style="color: #666666">=</span>steps,
            tags<span style="color: #666666">=</span>tags,
            conflict_summary<span style="color: #666666">=</span>conflict_summary,
            conflict_sources<span style="color: #666666">=</span>conflict_sources,
            document_id<span style="color: #666666">=</span>document_id,
            passage_id<span style="color: #666666">=</span>passage_id,
        )
</code></pre>
<h3 id="_build_identifier">Method: _build_identifier(self, citation: Any, *, fallback: str) -&gt; str</h3>
<p>The function `_build_identifier` constructs a string identifier from a `citation` parameter, which can be either a dictionary or a string. It extracts the identifier from specific keys (`id`, `document_id`, `source`, `path`, `file_path`) in the dictionary if present. If the citation is a non-empty string, it returns the stripped string. Otherwise, it returns a provided fallback string.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_identifier</span>(<span style="color: #008000">self</span>, citation: Any, <span style="color: #666666">*</span>, fallback: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">for</span> key <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;id&quot;</span>, <span style="color: #BA2121">&quot;document_id&quot;</span>, <span style="color: #BA2121">&quot;source&quot;</span>, <span style="color: #BA2121">&quot;path&quot;</span>, <span style="color: #BA2121">&quot;file_path&quot;</span>):
                value <span style="color: #666666">=</span> citation<span style="color: #666666">.</span>get(key)
                <span style="color: #008000; font-weight: bold">if</span> value:
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(value)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> citation<span style="color: #666666">.</span>strip():
            <span style="color: #008000; font-weight: bold">return</span> citation<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">return</span> fallback
</code></pre>
<h3 id="_handle_copy">Method: _handle_copy(self, record: EvidenceRecord, item: QListWidgetItem) -&gt; None</h3>
<p>The function `_handle_copy` processes a copy request for an evidence item within the `EvidencePanel`. It identifies the row of the selected list item, sets it as current, and constructs a payload string from the evidence record&#x27;s label, snippet (converted from HTML), and metadata. The resulting string is emitted through the `copy_requested` signal after stripping any leading or trailing whitespace.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_handle_copy</span>(<span style="color: #008000">self</span>, record: EvidenceRecord, item: QListWidgetItem) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        row <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>row(item)
        <span style="color: #008000; font-weight: bold">if</span> row <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setCurrentRow(row)
        snippet <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_plain_text(record<span style="color: #666666">.</span>snippet_html)
        payload <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(
            part
            <span style="color: #008000; font-weight: bold">for</span> part <span style="color: #AA22FF; font-weight: bold">in</span> [record<span style="color: #666666">.</span>label, snippet, record<span style="color: #666666">.</span>metadata_text]
            <span style="color: #008000; font-weight: bold">if</span> part <span style="color: #AA22FF; font-weight: bold">and</span> part<span style="color: #666666">.</span>strip()
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_requested<span style="color: #666666">.</span>emit(payload<span style="color: #666666">.</span>strip())
</code></pre>
<h3 id="_handle_locate">Method: _handle_locate(self, record: EvidenceRecord, item: QListWidgetItem) -&gt; None</h3>
<p>The function `_handle_locate` processes a click event on an evidence item within the panel. It determines the row index of the clicked item in the list, sets the current row to that index, and emits a `locate_requested` signal with a payload containing the document ID, file path, and passage ID from the provided `EvidenceRecord`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_handle_locate</span>(<span style="color: #008000">self</span>, record: EvidenceRecord, item: QListWidgetItem) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        row <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>row(item)
        <span style="color: #008000; font-weight: bold">if</span> row <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setCurrentRow(row)
        payload <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;document_id&quot;</span>: record<span style="color: #666666">.</span>document_id,
            <span style="color: #BA2121">&quot;path&quot;</span>: record<span style="color: #666666">.</span>path,
            <span style="color: #BA2121">&quot;passage_id&quot;</span>: record<span style="color: #666666">.</span>passage_id,
        }
        <span style="color: #008000">self</span><span style="color: #666666">.</span>locate_requested<span style="color: #666666">.</span>emit(payload)
</code></pre>
<h3 id="_handle_open">Method: _handle_open(self, record: EvidenceRecord, item: QListWidgetItem) -&gt; None</h3>
<p>The function `_handle_open` processes an evidence record by setting the current row in a list widget to the row of a given list item, and then opens the specified evidence record. It retrieves the row index of the item from the list, updates the list&#x27;s current row if the index is valid, and calls `_open_record` with the provided evidence record.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_handle_open</span>(<span style="color: #008000">self</span>, record: EvidenceRecord, item: QListWidgetItem) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        row <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>row(item)
        <span style="color: #008000; font-weight: bold">if</span> row <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_list<span style="color: #666666">.</span>setCurrentRow(row)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_open_record(record)
</code></pre>
<h3 id="_on_row_selected">Method: _on_row_selected(self, row: int) -&gt; None</h3>
<p>The function `_on_row_selected` is triggered when a row in the `EvidencePanel` is selected. It validates the row index against the length of `_records`, clears the panel if the index is invalid, and otherwise updates the preview for the selected row. It then emits an `evidence_selected` signal containing the selected row index and the record&#x27;s identifier.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_row_selected</span>(<span style="color: #008000">self</span>, row: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> (<span style="color: #666666">0</span> <span style="color: #666666">&lt;=</span> row <span style="color: #666666">&lt;</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records)):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_empty_state()
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_preview(row)
        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records[row]
        <span style="color: #008000">self</span><span style="color: #666666">.</span>evidence_selected<span style="color: #666666">.</span>emit(row, record<span style="color: #666666">.</span>identifier)
</code></pre>
<h3 id="_update_preview">Method: _update_preview(self, index: int) -&gt; None</h3>
<p>The function `_update_preview` updates the preview display in the `EvidencePanel` based on the selected record index. It retrieves the record at the specified index from `self._records`, constructs an HTML snippet containing the record&#x27;s content, metadata, conflict summary, and tags, and sets this HTML in `self._preview`. If the index is out of range, it clears the preview by calling `self._empty_state()`. The function also updates the metadata label with the record&#x27;s label and metadata text, and adjusts the reset button state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_preview</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> (<span style="color: #666666">0</span> <span style="color: #666666">&lt;=</span> index <span style="color: #666666">&lt;</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records)):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_empty_state()
            <span style="color: #008000; font-weight: bold">return</span>
        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records[index]
        snippet_html <span style="color: #666666">=</span> record<span style="color: #666666">.</span>snippet_html <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&lt;i&gt;No snippet provided.&lt;/i&gt;&quot;</span>
        style <span style="color: #666666">=</span> (
            <span style="color: #BA2121">&quot;&lt;style&gt;&quot;</span>
            <span style="color: #BA2121">&quot;.snippet{font-size:13px;line-height:1.5;}&quot;</span>
            <span style="color: #BA2121">&quot;.meta{margin-top:8px;color:rgba(140,150,165,0.9);}&quot;</span>
            <span style="color: #BA2121">&quot;.conflict{margin-top:6px;color:#d8893a;font-weight:600;}&quot;</span>
            <span style="color: #BA2121">&quot;.tags{margin-top:4px;color:rgba(140,150,165,0.9);}&quot;</span>
            <span style="color: #BA2121">&quot;&lt;/style&gt;&quot;</span>
        )
        fragments <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;&lt;div class=&#39;snippet&#39;&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>snippet_html<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/div&gt;&quot;</span>]
        <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>metadata_text:
            fragments<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;p class=&#39;meta&#39;&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(record<span style="color: #666666">.</span>metadata_text)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/p&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>conflict_summary:
            fragments<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;p class=&#39;conflict&#39;&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(record<span style="color: #666666">.</span>conflict_summary)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/p&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>tags:
            tags <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(html<span style="color: #666666">.</span>escape(tag) <span style="color: #008000; font-weight: bold">for</span> tag <span style="color: #AA22FF; font-weight: bold">in</span> record<span style="color: #666666">.</span>tags)
            fragments<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;p class=&#39;tags&#39;&gt;Tags: </span><span style="color: #A45A77; font-weight: bold">{</span>tags<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/p&gt;&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_preview<span style="color: #666666">.</span>setHtml(style <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(fragments))
        header <span style="color: #666666">=</span> record<span style="color: #666666">.</span>label
        <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>metadata_text:
            header <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>record<span style="color: #666666">.</span>label<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> ‚Äî </span><span style="color: #A45A77; font-weight: bold">{</span>record<span style="color: #666666">.</span>metadata_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_metadata_label<span style="color: #666666">.</span>setText(header)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_reset_button_state()
</code></pre>
<h3 id="_on_state_changed">Method: _on_state_changed(self, record: EvidenceRecord, state: str) -&gt; None</h3>
<p>The function `_on_state_changed` updates the state of an `EvidenceRecord` within the `EvidencePanel`. It iterates through the existing records to find a match based on the record&#x27;s identifier and replaces it with a copy of the record having the new state. If the scope suppression is not active, it emits a signal indicating a change in the current scope&#x27;s include and exclude filters, and updates the state of the reset button.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_state_changed</span>(<span style="color: #008000">self</span>, record: EvidenceRecord, state: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_suppress_scope:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">for</span> idx, existing <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records):
            <span style="color: #008000; font-weight: bold">if</span> existing<span style="color: #666666">.</span>identifier <span style="color: #666666">==</span> record<span style="color: #666666">.</span>identifier:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_records[idx] <span style="color: #666666">=</span> existing<span style="color: #666666">.</span>copy_with_state(state)
                <span style="color: #008000; font-weight: bold">break</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_suppress_scope:
            scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>current_scope
            <span style="color: #008000">self</span><span style="color: #666666">.</span>scope_changed<span style="color: #666666">.</span>emit(scope[<span style="color: #BA2121">&quot;include&quot;</span>], scope[<span style="color: #BA2121">&quot;exclude&quot;</span>])
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_reset_button_state()
</code></pre>
<h3 id="_reset_scope_filters">Method: _reset_scope_filters(self) -&gt; None</h3>
<p>The function `_reset_scope_filters` checks whether any records in `self._records` have a state other than &quot;include&quot;. If all records are in the &quot;include&quot; state, the function returns without taking action. Otherwise, it calls `self.reset_scope()` to reset the scope of the evidence panel.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_reset_scope_filters</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">any</span>(record<span style="color: #666666">.</span>state <span style="color: #666666">!=</span> <span style="color: #BA2121">&quot;include&quot;</span> <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records):
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>reset_scope()
</code></pre>
<h3 id="_set_conflict_banner">Method: _set_conflict_banner(self, messages: list[str]) -&gt; None</h3>
<p>The function `_set_conflict_banner` updates the visibility and content of a conflict banner UI element based on a list of conflict messages. If the list contains messages, it removes duplicates, escapes HTML characters in each message, joins them with &quot; ‚Ä¢ &quot;, and displays the resulting string in the banner with a warning icon. If the list is empty, it hides the banner.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_set_conflict_banner</span>(<span style="color: #008000">self</span>, messages: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> messages:
            unique <span style="color: #666666">=</span> <span style="color: #008000">list</span>(<span style="color: #008000">dict</span><span style="color: #666666">.</span>fromkeys(messages))
            joined <span style="color: #666666">=</span> <span style="color: #BA2121">&quot; ‚Ä¢ &quot;</span><span style="color: #666666">.</span>join(html<span style="color: #666666">.</span>escape(msg) <span style="color: #008000; font-weight: bold">for</span> msg <span style="color: #AA22FF; font-weight: bold">in</span> unique)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner<span style="color: #666666">.</span>setText(<span style="color: #BA2121">f&quot;‚ö†Ô∏è Conflict detected: </span><span style="color: #A45A77; font-weight: bold">{</span>joined<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_conflict_banner<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_update_reset_button_state">Method: _update_reset_button_state(self) -&gt; None</h3>
<p>The function `_update_reset_button_state` updates the enabled state of a reset button in the `EvidencePanel` class. It checks if the button exists, then determines whether any record in `self._records` has a state other than &quot;include&quot;. If there are dirty records and the records list is not empty, the reset button is enabled; otherwise, it is disabled.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_reset_button_state</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_reset_scope_button&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        dirty <span style="color: #666666">=</span> <span style="color: #008000">any</span>(record<span style="color: #666666">.</span>state <span style="color: #666666">!=</span> <span style="color: #BA2121">&quot;include&quot;</span> <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_records)
        enabled <span style="color: #666666">=</span> dirty <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">bool</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_records)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_reset_scope_button<span style="color: #666666">.</span>setEnabled(enabled)
</code></pre>
<h3 id="_plain_text">Method: _plain_text(self, snippet: str) -&gt; str</h3>
<p>The function `_plain_text` takes an HTML-formatted string `snippet`, creates a `QTextDocument` object, sets the HTML content of the document to the provided snippet (or an empty string if `snippet` is falsy), and returns the plain text version of the document with leading and trailing whitespace removed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_plain_text</span>(<span style="color: #008000">self</span>, snippet: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        document <span style="color: #666666">=</span> QTextDocument()
        document<span style="color: #666666">.</span>setHtml(snippet <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> document<span style="color: #666666">.</span>toPlainText()<span style="color: #666666">.</span>strip()
</code></pre>
<h3 id="_open_record">Method: _open_record(self, record: EvidenceRecord | None) -&gt; None</h3>
<p>The function `_open_record` in the `EvidencePanel` class is designed to open a file specified by an `EvidenceRecord` object. It first checks if the record is valid and contains a file path. If the conditions are met, it constructs a local file URL using `QUrl.fromLocalFile` from the path in the record and opens the file using `QDesktopServices.openUrl`. If the record is None or lacks a path, the function returns without performing any action.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_open_record</span>(<span style="color: #008000">self</span>, record: EvidenceRecord <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #AA22FF; font-weight: bold">not</span> record<span style="color: #666666">.</span>path:
            <span style="color: #008000; font-weight: bold">return</span>
        url <span style="color: #666666">=</span> QUrl<span style="color: #666666">.</span>fromLocalFile(<span style="color: #008000">str</span>(record<span style="color: #666666">.</span>path))
        QDesktopServices<span style="color: #666666">.</span>openUrl(url)
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
