<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_retrieval_index</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_retrieval_index</h1>
        <p>Module defines tests for retrieval index functionality including multi-source retrieval with conflict detection, scope-based filtering, and duplicate suppression. Tests use passage objects with embeddings, metadata, and time-based filtering. Functions validate search results based on document IDs, citation details, and conflict identification. The module includes assertions to verify correct behavior of retrieval operations under various conditions.</p>
<h2>Functions</h2>
<h3 id="_vec">_vec(*values: float) -&gt; tuple[float, ...]</h3>
<p>The function `_vec` takes a variable number of floating-point arguments and returns them as a tuple of floats. It serves as a utility for converting input values into an immutable tuple format.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_vec</span>(<span style="color: #666666">*</span>values: <span style="color: #008000">float</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">float</span>, <span style="color: #666666">...</span>]:
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">tuple</span>(values)
</code></pre>
<h3 id="test_multi_source_retrieval_with_conflict_detection">test_multi_source_retrieval_with_conflict_detection() -&gt; None</h3>
<p>The function `test_multi_source_retrieval_with_conflict_detection` tests the retrieval of passages from a `RetrievalIndex` based on semantic similarity while detecting conflicts between sources. It creates three passages with distinct embeddings and metadata, adds them to the index, and performs a search for passages similar to a given vector. The test verifies that the top results include specific document IDs and checks that conflict detection identifies a passage with opposing stance metadata. The function ensures that the retrieval system correctly handles multi-source data and detects conflicting information based on semantic similarity and metadata attributes.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_multi_source_retrieval_with_conflict_detection</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    index <span style="color: #666666">=</span> RetrievalIndex()
    now <span style="color: #666666">=</span> datetime<span style="color: #666666">.</span>now(UTC)
    base_folder <span style="color: #666666">=</span> Path(<span style="color: #BA2121">&quot;reports&quot;</span>)<span style="color: #666666">.</span>resolve()

    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;alpha&quot;</span>,
            document_id<span style="color: #666666">=1</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Alpha report highlights the rapid adoption of solar storage systems.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">1.0</span>, <span style="color: #666666">0.0</span>),
            tags<span style="color: #666666">=</span>{<span style="color: #666666">1</span>, <span style="color: #666666">2</span>},
            folder<span style="color: #666666">=</span>base_folder <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;alpha&quot;</span>,
            created_at<span style="color: #666666">=</span>now,
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;EN&quot;</span>,
            page<span style="color: #666666">=3</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;overview&quot;</span>,
            metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;statement&quot;</span>: <span style="color: #BA2121">&quot;solar storage is viable&quot;</span>, <span style="color: #BA2121">&quot;stance&quot;</span>: <span style="color: #BA2121">&quot;support&quot;</span>},
        )
    )
    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;beta&quot;</span>,
            document_id<span style="color: #666666">=2</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Beta dossier questions the economic viability of solar storage deployments.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">0.9</span>, <span style="color: #666666">0.1</span>),
            tags<span style="color: #666666">=</span>{<span style="color: #666666">2</span>},
            folder<span style="color: #666666">=</span>base_folder <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;beta&quot;</span>,
            created_at<span style="color: #666666">=</span>now <span style="color: #666666">-</span> timedelta(minutes<span style="color: #666666">=5</span>),
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;en&quot;</span>,
            page<span style="color: #666666">=7</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;analysis&quot;</span>,
            metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;statement&quot;</span>: <span style="color: #BA2121">&quot;solar storage is viable&quot;</span>, <span style="color: #BA2121">&quot;stance&quot;</span>: <span style="color: #BA2121">&quot;challenge&quot;</span>},
        )
    )
    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;gamma&quot;</span>,
            document_id<span style="color: #666666">=3</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Gamma memo discusses fossil fuel subsidies with no mention of renewables.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">-1.0</span>, <span style="color: #666666">0.0</span>),
            tags<span style="color: #666666">=</span>{<span style="color: #666666">3</span>},
            folder<span style="color: #666666">=</span>base_folder <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;gamma&quot;</span>,
            created_at<span style="color: #666666">=</span>now,
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;en&quot;</span>,
            page<span style="color: #666666">=2</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;context&quot;</span>,
        )
    )

    results <span style="color: #666666">=</span> index<span style="color: #666666">.</span>search(_vec(<span style="color: #666666">1.0</span>, <span style="color: #666666">0.0</span>), top_k<span style="color: #666666">=2</span>, diversity<span style="color: #666666">=0.2</span>)

    <span style="color: #008000; font-weight: bold">assert</span> [entry[<span style="color: #BA2121">&quot;document_id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> results] <span style="color: #666666">==</span> [<span style="color: #666666">1</span>, <span style="color: #666666">2</span>]
    <span style="color: #008000; font-weight: bold">assert</span> results[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;citation&quot;</span>][<span style="color: #BA2121">&quot;page&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">3</span>
    conflict_ids <span style="color: #666666">=</span> {
        conflict[<span style="color: #BA2121">&quot;passage_id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> conflict <span style="color: #AA22FF; font-weight: bold">in</span> results[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;conflicts&quot;</span>]
    }
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;beta&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> conflict_ids
</code></pre>
<h3 id="test_scope_filters_trim_results">test_scope_filters_trim_results(tmp_path: Path) -&gt; None</h3>
<p>The function `test_scope_filters_trim_results` tests the filtering capabilities of a `RetrievalIndex` by verifying that search results are correctly trimmed based on a specified `RetrievalScope`. It creates a retrieval index with three passages, each having different attributes such as folder path, creation time, language, and tags. A `RetrievalScope` is defined to include only passages within a specific folder, time range, and language. The function performs a search using this scope and asserts that only the passage matching all criteria (&quot;scoped&quot;) is returned in the results.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_scope_filters_trim_results</span>(tmp_path: Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    index <span style="color: #666666">=</span> RetrievalIndex()
    now <span style="color: #666666">=</span> datetime<span style="color: #666666">.</span>now(UTC)
    scope_folder <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;reports&quot;</span>
    deep_folder <span style="color: #666666">=</span> scope_folder <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;deep&quot;</span>

    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;scoped&quot;</span>,
            document_id<span style="color: #666666">=10</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Scoped insight on market forecasts for solar deployments.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">0.8</span>, <span style="color: #666666">0.2</span>),
            tags<span style="color: #666666">=</span>{<span style="color: #666666">5</span>},
            folder<span style="color: #666666">=</span>scope_folder,
            created_at<span style="color: #666666">=</span>now,
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;en&quot;</span>,
            page<span style="color: #666666">=1</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;summary&quot;</span>,
        )
    )
    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;too_old&quot;</span>,
            document_id<span style="color: #666666">=11</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Outdated analysis that should be removed by the time range filter.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">0.7</span>, <span style="color: #666666">0.3</span>),
            tags<span style="color: #666666">=</span>{<span style="color: #666666">5</span>},
            folder<span style="color: #666666">=</span>deep_folder,
            created_at<span style="color: #666666">=</span>now <span style="color: #666666">-</span> timedelta(days<span style="color: #666666">=5</span>),
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;en&quot;</span>,
            page<span style="color: #666666">=4</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;history&quot;</span>,
        )
    )
    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;wrong_language&quot;</span>,
            document_id<span style="color: #666666">=12</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Analyse du march√© solaire √©crite en fran√ßais uniquement.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">0.75</span>, <span style="color: #666666">0.25</span>),
            tags<span style="color: #666666">=</span>{<span style="color: #666666">5</span>},
            folder<span style="color: #666666">=</span>scope_folder,
            created_at<span style="color: #666666">=</span>now,
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;fr&quot;</span>,
            page<span style="color: #666666">=2</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;fr&quot;</span>,
        )
    )

    scope <span style="color: #666666">=</span> RetrievalScope(
        tags<span style="color: #666666">=</span>{<span style="color: #666666">5</span>},
        folder<span style="color: #666666">=</span>scope_folder,
        recursive<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>,
        start_time<span style="color: #666666">=</span>now <span style="color: #666666">-</span> timedelta(days<span style="color: #666666">=1</span>),
        end_time<span style="color: #666666">=</span>now <span style="color: #666666">+</span> timedelta(days<span style="color: #666666">=1</span>),
        languages<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;en&quot;</span>},
    )

    results <span style="color: #666666">=</span> index<span style="color: #666666">.</span>search(_vec(<span style="color: #666666">0.8</span>, <span style="color: #666666">0.2</span>), top_k<span style="color: #666666">=3</span>, scope<span style="color: #666666">=</span>scope)

    <span style="color: #008000; font-weight: bold">assert</span> [entry[<span style="color: #BA2121">&quot;passage_id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> results] <span style="color: #666666">==</span> [<span style="color: #BA2121">&quot;scoped&quot;</span>]
</code></pre>
<h3 id="test_duplicate_passages_are_suppressed">test_duplicate_passages_are_suppressed() -&gt; None</h3>
<p>The function `test_duplicate_passages_are_suppressed` tests that duplicate passages with identical text content are suppressed during a search operation in a `RetrievalIndex`. It creates two passages with the same text and different IDs, adds them to the index, and then performs a search. The test verifies that only one of the duplicate passages is returned in the search results, ensuring that duplicates are filtered out based on their content.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_duplicate_passages_are_suppressed</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    index <span style="color: #666666">=</span> RetrievalIndex()
    now <span style="color: #666666">=</span> datetime<span style="color: #666666">.</span>now(UTC)

    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;dup_a&quot;</span>,
            document_id<span style="color: #666666">=20</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Repeated finding about long-duration storage performance.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">0.6</span>, <span style="color: #666666">0.4</span>),
            tags<span style="color: #666666">=</span><span style="color: #008000">set</span>(),
            folder<span style="color: #666666">=</span><span style="color: #BA2121">&quot;notes&quot;</span>,
            created_at<span style="color: #666666">=</span>now,
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;en&quot;</span>,
            page<span style="color: #666666">=1</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;insight&quot;</span>,
        )
    )
    index<span style="color: #666666">.</span>add_passage(
        Passage(
            passage_id<span style="color: #666666">=</span><span style="color: #BA2121">&quot;dup_b&quot;</span>,
            document_id<span style="color: #666666">=20</span>,
            text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Repeated finding about long-duration storage performance.&quot;</span>,
            embedding<span style="color: #666666">=</span>_vec(<span style="color: #666666">0.62</span>, <span style="color: #666666">0.38</span>),
            tags<span style="color: #666666">=</span><span style="color: #008000">set</span>(),
            folder<span style="color: #666666">=</span><span style="color: #BA2121">&quot;notes&quot;</span>,
            created_at<span style="color: #666666">=</span>now,
            language<span style="color: #666666">=</span><span style="color: #BA2121">&quot;en&quot;</span>,
            page<span style="color: #666666">=1</span>,
            section<span style="color: #666666">=</span><span style="color: #BA2121">&quot;insight&quot;</span>,
        )
    )

    results <span style="color: #666666">=</span> index<span style="color: #666666">.</span>search(_vec(<span style="color: #666666">0.61</span>, <span style="color: #666666">0.39</span>), top_k<span style="color: #666666">=5</span>, diversity<span style="color: #666666">=0.0</span>)

    returned_ids <span style="color: #666666">=</span> [entry[<span style="color: #BA2121">&quot;passage_id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> results]
    <span style="color: #008000; font-weight: bold">assert</span> returned_ids <span style="color: #666666">==</span> [<span style="color: #BA2121">&quot;dup_b&quot;</span>]
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
