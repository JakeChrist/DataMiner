<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_lmstudio_integration</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_lmstudio_integration</h1>
        <p>This module defines tests and supporting utilities for an LMStudio client and conversation manager. It includes a default chat response generator, HTTP server handling for mocking LMStudio endpoints, and various test cases covering successful interactions, reasoning verbosity controls, streaming behavior, timeout handling, connection failure recovery, and response mode behaviors such as sources-only mode. The tests validate parsing of structured content, request formatting, and the management of conversation state including context window handling and connection status updates.</p>
<h2>Functions</h2>
<h3 id="_default_chat_response">_default_chat_response(payload: dict[str, object]) -&gt; dict[str, object]</h3>
<p>The function `_default_chat_response` generates a mock chat completion response based on input payload data. It extracts the most recent message as a question, determines reasoning options such as verbosity and plan inclusion, and constructs metadata including summary bullets, a plan, assumptions, and self-check results. The content of the response is derived from the question with special handling for a &quot;sources only&quot; response mode. The function returns a dictionary formatted as a chat completion object, including message content, citations, reasoning metadata, and usage statistics.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_default_chat_response</span>(payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]:
    messages <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;messages&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(messages, Sequence) <span style="color: #AA22FF; font-weight: bold">and</span> messages:
        raw_question <span style="color: #666666">=</span> messages[<span style="color: #666666">-1</span>]
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(raw_question, <span style="color: #008000">dict</span>):
            question <span style="color: #666666">=</span> <span style="color: #008000">str</span>(raw_question<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;content&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))
        <span style="color: #008000; font-weight: bold">else</span>:
            question <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
    <span style="color: #008000; font-weight: bold">else</span>:
        question <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
    reasoning_options <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;reasoning&quot;</span>)
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(reasoning_options, <span style="color: #008000">dict</span>):
        reasoning_options <span style="color: #666666">=</span> {}
    verbosity <span style="color: #666666">=</span> <span style="color: #008000">str</span>(reasoning_options<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;verbosity&quot;</span>, <span style="color: #BA2121">&quot;brief&quot;</span>))
    include_plan <span style="color: #666666">=</span> <span style="color: #008000">bool</span>(reasoning_options<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include_plan&quot;</span>, <span style="color: #008000; font-weight: bold">True</span>))
    summary_bullets: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]
    <span style="color: #008000; font-weight: bold">if</span> verbosity <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;minimal&quot;</span>:
        summary_bullets <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;Check context&quot;</span>]
    <span style="color: #008000; font-weight: bold">elif</span> verbosity <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;extended&quot;</span>:
        summary_bullets <span style="color: #666666">=</span> [
            <span style="color: #BA2121">&quot;Check context&quot;</span>,
            <span style="color: #BA2121">&quot;Draft response&quot;</span>,
            <span style="color: #BA2121">&quot;Verify citations&quot;</span>,
        ]
    <span style="color: #008000; font-weight: bold">else</span>:
        summary_bullets <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;Check context&quot;</span>, <span style="color: #BA2121">&quot;Draft response&quot;</span>]
    plan_items: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">str</span>]] <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">if</span> include_plan:
        base_plan <span style="color: #666666">=</span> [
            {<span style="color: #BA2121">&quot;step&quot;</span>: <span style="color: #BA2121">&quot;Gather evidence&quot;</span>, <span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;complete&quot;</span>},
            {<span style="color: #BA2121">&quot;step&quot;</span>: <span style="color: #BA2121">&quot;Compose answer&quot;</span>, <span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;pending&quot;</span>},
            {<span style="color: #BA2121">&quot;step&quot;</span>: <span style="color: #BA2121">&quot;Review assumptions&quot;</span>, <span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;pending&quot;</span>},
        ]
        max_items <span style="color: #666666">=</span> reasoning_options<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;max_plan_items&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(max_items, <span style="color: #008000">int</span>):
            plan_items <span style="color: #666666">=</span> base_plan[: <span style="color: #008000">max</span>(<span style="color: #666666">0</span>, max_items)]
        <span style="color: #008000; font-weight: bold">else</span>:
            plan_items <span style="color: #666666">=</span> base_plan
    reasoning_metadata <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&quot;summary_bullets&quot;</span>: summary_bullets,
        <span style="color: #BA2121">&quot;plan&quot;</span>: plan_items,
        <span style="color: #BA2121">&quot;assumptions&quot;</span>: {
            <span style="color: #BA2121">&quot;used&quot;</span>: [<span style="color: #BA2121">&quot;Assuming a concise summary is acceptable.&quot;</span>],
            <span style="color: #BA2121">&quot;should_ask&quot;</span>: <span style="color: #008000; font-weight: bold">False</span>,
            <span style="color: #BA2121">&quot;rationale&quot;</span>: <span style="color: #BA2121">&quot;Request already specifies a summary format.&quot;</span>,
        },
        <span style="color: #BA2121">&quot;self_check&quot;</span>: {<span style="color: #BA2121">&quot;passed&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>, <span style="color: #BA2121">&quot;flags&quot;</span>: []},
    }
    content <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Echo: </span><span style="color: #A45A77; font-weight: bold">{</span>question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
    <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;response_mode&quot;</span>) <span style="color: #666666">==</span> ResponseMode<span style="color: #666666">.</span>SOURCES_ONLY<span style="color: #666666">.</span>value:
        content <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Facts:</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">- detail one (doc1)</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">- detail two (doc2)&quot;</span>
    <span style="color: #008000; font-weight: bold">return</span> {
        <span style="color: #BA2121">&quot;id&quot;</span>: <span style="color: #BA2121">&quot;chatcmpl-test&quot;</span>,
        <span style="color: #BA2121">&quot;object&quot;</span>: <span style="color: #BA2121">&quot;chat.completion&quot;</span>,
        <span style="color: #BA2121">&quot;created&quot;</span>: <span style="color: #666666">0</span>,
        <span style="color: #BA2121">&quot;choices&quot;</span>: [
            {
                <span style="color: #BA2121">&quot;index&quot;</span>: <span style="color: #666666">0</span>,
                <span style="color: #BA2121">&quot;message&quot;</span>: {
                    <span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;assistant&quot;</span>,
                    <span style="color: #BA2121">&quot;content&quot;</span>: content,
                    <span style="color: #BA2121">&quot;metadata&quot;</span>: {
                        <span style="color: #BA2121">&quot;citations&quot;</span>: [{<span style="color: #BA2121">&quot;source&quot;</span>: <span style="color: #BA2121">&quot;doc1&quot;</span>, <span style="color: #BA2121">&quot;snippet&quot;</span>: <span style="color: #BA2121">&quot;alpha&quot;</span>}],
                        <span style="color: #BA2121">&quot;reasoning&quot;</span>: reasoning_metadata,
                    },
                },
                <span style="color: #BA2121">&quot;finish_reason&quot;</span>: <span style="color: #BA2121">&quot;stop&quot;</span>,
            }
        ],
        <span style="color: #BA2121">&quot;usage&quot;</span>: {<span style="color: #BA2121">&quot;prompt_tokens&quot;</span>: <span style="color: #666666">0</span>, <span style="color: #BA2121">&quot;completion_tokens&quot;</span>: <span style="color: #666666">0</span>, <span style="color: #BA2121">&quot;total_tokens&quot;</span>: <span style="color: #666666">0</span>},
    }
</code></pre>
<h3 id="test_lmstudio_client_parses_structured_content">test_lmstudio_client_parses_structured_content() -&gt; None</h3>
<p>The function `test_lmstudio_client_parses_structured_content` tests the parsing of structured content by the `LMStudioClient`. It defines a sample response structure containing a message with both plain text and typed text components, along with citation metadata. The test verifies that the `_parse_chat_response` method correctly concatenates the text components into a single content string and extracts the citations. The assertion confirms that the parsed message content matches the expected concatenated string and that the citations are accurately preserved.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_lmstudio_client_parses_structured_content</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    data <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&quot;choices&quot;</span>: [
            {
                <span style="color: #BA2121">&quot;message&quot;</span>: {
                    <span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;assistant&quot;</span>,
                    <span style="color: #BA2121">&quot;content&quot;</span>: [
                        <span style="color: #BA2121">&quot;Part one. &quot;</span>,
                        {<span style="color: #BA2121">&quot;type&quot;</span>: <span style="color: #BA2121">&quot;text&quot;</span>, <span style="color: #BA2121">&quot;text&quot;</span>: <span style="color: #BA2121">&quot;Part two.&quot;</span>},
                    ],
                    <span style="color: #BA2121">&quot;metadata&quot;</span>: {
                        <span style="color: #BA2121">&quot;citations&quot;</span>: [{<span style="color: #BA2121">&quot;source&quot;</span>: <span style="color: #BA2121">&quot;doc&quot;</span>, <span style="color: #BA2121">&quot;snippet&quot;</span>: <span style="color: #BA2121">&quot;text&quot;</span>}],
                    },
                }
            }
        ]
    }

    message <span style="color: #666666">=</span> LMStudioClient<span style="color: #666666">.</span>_parse_chat_response(data)

    <span style="color: #008000; font-weight: bold">assert</span> message<span style="color: #666666">.</span>content <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;Part one. Part two.&quot;</span>
    <span style="color: #008000; font-weight: bold">assert</span> message<span style="color: #666666">.</span>citations <span style="color: #666666">==</span> [{<span style="color: #BA2121">&quot;source&quot;</span>: <span style="color: #BA2121">&quot;doc&quot;</span>, <span style="color: #BA2121">&quot;snippet&quot;</span>: <span style="color: #BA2121">&quot;text&quot;</span>}]
</code></pre>
<h3 id="_make_handler">_make_handler(state: dict[str, object]) -&gt; type[BaseHTTPRequestHandler]</h3>
<p>The function `_make_handler` defines and returns a subclass of `BaseHTTPRequestHandler` for handling HTTP requests. The handler supports GET and POST methods. A GET request to `/v1/health` responds with a JSON payload containing health status and body, configurable via the `state` dictionary. All other GET requests return a 404 status. A POST request reads the request body, appends it to a list of requests stored in `state`, and processes the next response from a list of responses also stored in `state`. If no responses are available, it uses a response template or a default chat response function to generate a response. The handler sends back the status code and JSON-encoded body of the response. The `log_message` method is overridden to suppress logging during tests.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_make_handler</span>(state: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">type</span>[BaseHTTPRequestHandler]:
    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">Handler</span>(BaseHTTPRequestHandler):
        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">do_GET</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:  <span style="color: #3D7B7B; font-style: italic"># noqa: N802 - signature defined by BaseHTTPRequestHandler</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>path <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;/v1/health&quot;</span>:
                status <span style="color: #666666">=</span> <span style="color: #008000">int</span>(state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;health_status&quot;</span>, <span style="color: #666666">200</span>))
                body <span style="color: #666666">=</span> state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;health_body&quot;</span>, {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;ok&quot;</span>})
                <span style="color: #008000">self</span><span style="color: #666666">.</span>send_response(status)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>send_header(<span style="color: #BA2121">&quot;Content-Type&quot;</span>, <span style="color: #BA2121">&quot;application/json&quot;</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>end_headers()
                payload <span style="color: #666666">=</span> json<span style="color: #666666">.</span>dumps(body)<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&quot;utf-8&quot;</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>wfile<span style="color: #666666">.</span>write(payload)
            <span style="color: #008000; font-weight: bold">else</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>send_response(<span style="color: #666666">404</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>end_headers()

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">do_POST</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:  <span style="color: #3D7B7B; font-style: italic"># noqa: N802 - signature defined by BaseHTTPRequestHandler</span>
            length <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>headers<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;Content-Length&quot;</span>, <span style="color: #BA2121">&quot;0&quot;</span>))
            raw_body <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>rfile<span style="color: #666666">.</span>read(length)
            <span style="color: #008000; font-weight: bold">try</span>:
                payload <span style="color: #666666">=</span> json<span style="color: #666666">.</span>loads(raw_body<span style="color: #666666">.</span>decode(<span style="color: #BA2121">&quot;utf-8&quot;</span>)) <span style="color: #008000; font-weight: bold">if</span> raw_body <span style="color: #008000; font-weight: bold">else</span> {}
            <span style="color: #008000; font-weight: bold">except</span> json<span style="color: #666666">.</span>JSONDecodeError:
                payload <span style="color: #666666">=</span> {}
            requests <span style="color: #666666">=</span> state<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;requests&quot;</span>, [])
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(requests, <span style="color: #008000">list</span>):
                requests<span style="color: #666666">.</span>append(payload)

            responses <span style="color: #666666">=</span> state<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;responses&quot;</span>, [])
            current: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(responses, <span style="color: #008000">list</span>) <span style="color: #AA22FF; font-weight: bold">and</span> responses:
                current_raw <span style="color: #666666">=</span> responses<span style="color: #666666">.</span>pop(<span style="color: #666666">0</span>)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(current_raw, <span style="color: #008000">dict</span>):
                    current <span style="color: #666666">=</span> current_raw
                <span style="color: #008000; font-weight: bold">else</span>:
                    current <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #666666">200</span>, <span style="color: #BA2121">&quot;body&quot;</span>: {}}
            <span style="color: #008000; font-weight: bold">else</span>:
                template <span style="color: #666666">=</span> state<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;response_template&quot;</span>, _default_chat_response)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(template, Callable):
                    body <span style="color: #666666">=</span> template(payload)
                <span style="color: #008000; font-weight: bold">else</span>:
                    body <span style="color: #666666">=</span> _default_chat_response(payload)
                current <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #666666">200</span>, <span style="color: #BA2121">&quot;body&quot;</span>: body}

            status <span style="color: #666666">=</span> <span style="color: #008000">int</span>(current<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>, <span style="color: #666666">200</span>))
            body <span style="color: #666666">=</span> current<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;body&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(body, (<span style="color: #008000">bytes</span>, <span style="color: #008000">bytearray</span>)):
                body <span style="color: #666666">=</span> json<span style="color: #666666">.</span>dumps(body)<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&quot;utf-8&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>send_response(status)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>send_header(<span style="color: #BA2121">&quot;Content-Type&quot;</span>, <span style="color: #BA2121">&quot;application/json&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>end_headers()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>wfile<span style="color: #666666">.</span>write(body)

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">log_message</span>(<span style="color: #008000">self</span>, <span style="color: #008000">format</span>: <span style="color: #008000">str</span>, <span style="color: #666666">*</span>args: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:  <span style="color: #3D7B7B; font-style: italic"># noqa: D401, N802 - disable noisy logs</span>
<span style="color: #bbbbbb">            </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Silence default request logging during tests.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">return</span> Handler
</code></pre>
<h3 id="lmstudio_server">lmstudio_server() -&gt; tuple[dict[str, object], str]</h3>
<p>The function `lmstudio_server` creates and starts a threaded HTTP server for handling requests, returning the server&#x27;s state and base URL. It initializes a state dictionary with request and response tracking, health status, and a handler function. A `ThreadingHTTPServer` is instantiated on a random port, and a daemon thread is started to run the server. The function yields the server state and its base URL, ensuring the server shuts down and the thread joins upon completion.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">lmstudio_server</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]:
    state: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>] <span style="color: #666666">=</span> {
        <span style="color: #BA2121">&quot;requests&quot;</span>: [],
        <span style="color: #BA2121">&quot;responses&quot;</span>: [],
        <span style="color: #BA2121">&quot;health_status&quot;</span>: <span style="color: #666666">200</span>,
        <span style="color: #BA2121">&quot;health_body&quot;</span>: {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #BA2121">&quot;ok&quot;</span>},
    }
    handler <span style="color: #666666">=</span> _make_handler(state)
    server <span style="color: #666666">=</span> ThreadingHTTPServer((<span style="color: #BA2121">&quot;127.0.0.1&quot;</span>, <span style="color: #666666">0</span>), handler)
    thread <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Thread(target<span style="color: #666666">=</span>server<span style="color: #666666">.</span>serve_forever, daemon<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    thread<span style="color: #666666">.</span>start()
    base_url <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;http://</span><span style="color: #A45A77; font-weight: bold">{</span>server<span style="color: #666666">.</span>server_address[<span style="color: #666666">0</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #A45A77; font-weight: bold">{</span>server<span style="color: #666666">.</span>server_address[<span style="color: #666666">1</span>]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">yield</span> state, base_url
    <span style="color: #008000; font-weight: bold">finally</span>:
        server<span style="color: #666666">.</span>shutdown()
        thread<span style="color: #666666">.</span>join()
</code></pre>
<h3 id="test_lmstudio_client_and_conversation_manager_success">test_lmstudio_client_and_conversation_manager_success(lmstudio_server: tuple[dict[str, object], str]) -&gt; None</h3>
<p>This function tests the integration of an LMStudio client with a conversation manager to verify successful connection and response handling. It initializes a client and manager, checks the connection state, and asserts that the connection is established. It then sends a query using the `ask` method, validating the structure and content of the response, including the answer prefix, citations, response mode, reasoning artifacts, plan, assumptions, and self-check results. The test also verifies that the request payload sent to the server includes correct model, token limits, reasoning settings, and message structure, confirming proper interaction with the LMStudio server.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_lmstudio_client_and_conversation_manager_success</span>(lmstudio_server: <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    state, base_url <span style="color: #666666">=</span> lmstudio_server
    client <span style="color: #666666">=</span> LMStudioClient(base_url<span style="color: #666666">=</span>base_url, model<span style="color: #666666">=</span><span style="color: #BA2121">&quot;test-model&quot;</span>, max_retries<span style="color: #666666">=2</span>, retry_backoff<span style="color: #666666">=0.01</span>)
    manager <span style="color: #666666">=</span> ConversationManager(client, system_prompt<span style="color: #666666">=</span><span style="color: #BA2121">&quot;You are helpful.&quot;</span>, context_window<span style="color: #666666">=2</span>)

    events: <span style="color: #008000">list</span>[<span style="color: #008000">tuple</span>[<span style="color: #008000">bool</span>, <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>]] <span style="color: #666666">=</span> []
    manager<span style="color: #666666">.</span>add_connection_listener(<span style="color: #008000; font-weight: bold">lambda</span> payload: events<span style="color: #666666">.</span>append((payload<span style="color: #666666">.</span>connected, payload<span style="color: #666666">.</span>message)))

    connection_state <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>check_connection()
    <span style="color: #008000; font-weight: bold">assert</span> connection_state<span style="color: #666666">.</span>connected
    <span style="color: #008000; font-weight: bold">if</span> events:
        <span style="color: #008000; font-weight: bold">assert</span> events[<span style="color: #666666">-1</span>][<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>

    turn <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>ask(
        <span style="color: #BA2121">&quot;What is the summary?&quot;</span>,
        context_snippets<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;Document A: important details.&quot;</span>],
        preset<span style="color: #666666">=</span>AnswerLength<span style="color: #666666">.</span>BRIEF,
        reasoning_verbosity<span style="color: #666666">=</span>ReasoningVerbosity<span style="color: #666666">.</span>BRIEF,
    )

    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>answer<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;Echo:&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>citations
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>response_mode <span style="color: #AA22FF; font-weight: bold">is</span> ResponseMode<span style="color: #666666">.</span>GENERATIVE
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>reasoning_artifacts <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>reasoning_bullets
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Check context&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>reasoning_bullets[<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>plan
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>plan[<span style="color: #666666">0</span>]<span style="color: #666666">.</span>is_complete
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>assumptions
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>assumption_decision <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>assumption_decision<span style="color: #666666">.</span>mode <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;assume&quot;</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>assumption_decision<span style="color: #666666">.</span>rationale
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>self_check <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">and</span> turn<span style="color: #666666">.</span>self_check<span style="color: #666666">.</span>passed <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>

    <span style="color: #008000; font-weight: bold">assert</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>] <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">isinstance</span>(state[<span style="color: #BA2121">&quot;requests&quot;</span>], <span style="color: #008000">list</span>)
    payload <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> payload[<span style="color: #BA2121">&quot;model&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;test-model&quot;</span>
    <span style="color: #008000; font-weight: bold">assert</span> payload[<span style="color: #BA2121">&quot;max_tokens&quot;</span>] <span style="color: #666666">==</span> AnswerLength<span style="color: #666666">.</span>BRIEF<span style="color: #666666">.</span>to_request_params()[<span style="color: #BA2121">&quot;max_tokens&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>][<span style="color: #BA2121">&quot;verbosity&quot;</span>] <span style="color: #666666">==</span> ReasoningVerbosity<span style="color: #666666">.</span>BRIEF<span style="color: #666666">.</span>value
    <span style="color: #008000; font-weight: bold">assert</span> payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>][<span style="color: #BA2121">&quot;include_plan&quot;</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
    messages <span style="color: #666666">=</span> payload[<span style="color: #BA2121">&quot;messages&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">isinstance</span>(messages, <span style="color: #008000">list</span>)
    <span style="color: #3D7B7B; font-style: italic"># Expect system prompt, plus user/assistant pairs (none yet), and new user message.</span>
    <span style="color: #008000; font-weight: bold">assert</span> messages[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;role&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;system&quot;</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Context:&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> messages[<span style="color: #666666">-1</span>][<span style="color: #BA2121">&quot;content&quot;</span>]
</code></pre>
<h3 id="test_conversation_manager_populates_retrieval_query">test_conversation_manager_populates_retrieval_query(lmstudio_server: tuple[dict[str, object], str]) -&gt; None</h3>
<p>The function tests that the `ConversationManager` correctly populates the retrieval query when processing a user request. It verifies that the `ask` method includes the provided retrieval options, such as a query and document inclusion list, in the payload sent to the LMStudio client. The test ensures that the query is properly transferred from the `extra_options` parameter into the request payload under the `retrieval` key, and confirms that the original `extra` dictionary remains unchanged.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_conversation_manager_populates_retrieval_query</span>(
    lmstudio_server: <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    state, base_url <span style="color: #666666">=</span> lmstudio_server
    client <span style="color: #666666">=</span> LMStudioClient(base_url<span style="color: #666666">=</span>base_url, retry_backoff<span style="color: #666666">=0.01</span>)
    manager <span style="color: #666666">=</span> ConversationManager(client, context_window<span style="color: #666666">=0</span>)

    extra <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;retrieval&quot;</span>: {<span style="color: #BA2121">&quot;include&quot;</span>: [<span style="color: #BA2121">&quot;doc-1&quot;</span>]}}
    manager<span style="color: #666666">.</span>ask(<span style="color: #BA2121">&quot;Gather context please&quot;</span>, extra_options<span style="color: #666666">=</span>extra)

    <span style="color: #008000; font-weight: bold">assert</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>] <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">isinstance</span>(state[<span style="color: #BA2121">&quot;requests&quot;</span>], <span style="color: #008000">list</span>)
    payload <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">-1</span>]
    <span style="color: #008000; font-weight: bold">assert</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;retrieval&quot;</span>, {})<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;query&quot;</span>) <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;Gather context please&quot;</span>
    <span style="color: #008000; font-weight: bold">assert</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;retrieval&quot;</span>, {})<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>) <span style="color: #666666">==</span> [<span style="color: #BA2121">&quot;doc-1&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;query&quot;</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> extra[<span style="color: #BA2121">&quot;retrieval&quot;</span>]
</code></pre>
<h3 id="test_lmstudio_client_disables_streaming_by_default">test_lmstudio_client_disables_streaming_by_default(lmstudio_server: tuple[dict[str, object], str]) -&gt; None</h3>
<p>The function tests that the LMStudioClient disables streaming by default when making a chat request. It creates an LMStudioClient instance with a provided base URL, sends a chat request with a simple user message, and then verifies that the first request in the state&#x27;s requests list has the &quot;stream&quot; parameter set to False. The test uses a mock server state to capture the request parameters and ensure the default behavior of the client.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_lmstudio_client_disables_streaming_by_default</span>(
    lmstudio_server: <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    state, base_url <span style="color: #666666">=</span> lmstudio_server
    client <span style="color: #666666">=</span> LMStudioClient(base_url<span style="color: #666666">=</span>base_url)

    client<span style="color: #666666">.</span>chat([{<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;user&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: <span style="color: #BA2121">&quot;Hello&quot;</span>}])

    first_request <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">isinstance</span>(first_request, <span style="color: #008000">dict</span>)
    <span style="color: #008000; font-weight: bold">assert</span> first_request<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;stream&quot;</span>) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
<h3 id="test_lmstudio_client_allows_stream_override">test_lmstudio_client_allows_stream_override(lmstudio_server: tuple[dict[str, object], str]) -&gt; None</h3>
<p>The function tests that the LMStudioClient correctly handles a stream override option when making a chat request. It creates an LMStudioClient instance using a provided server URL, sends a chat request with `stream` set to `True` in `extra_options`, and verifies that the resulting request object in the server state has the `stream` parameter explicitly set to `True`. The test ensures that the client properly forwards the stream configuration to the underlying API call.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_lmstudio_client_allows_stream_override</span>(
    lmstudio_server: <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    state, base_url <span style="color: #666666">=</span> lmstudio_server
    client <span style="color: #666666">=</span> LMStudioClient(base_url<span style="color: #666666">=</span>base_url)

    client<span style="color: #666666">.</span>chat(
        [{<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;user&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: <span style="color: #BA2121">&quot;Hello&quot;</span>}],
        extra_options<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;stream&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>},
    )

    first_request <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">isinstance</span>(first_request, <span style="color: #008000">dict</span>)
    <span style="color: #008000; font-weight: bold">assert</span> first_request<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;stream&quot;</span>) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
</code></pre>
<h3 id="test_lmstudio_client_does_not_set_timeout">test_lmstudio_client_does_not_set_timeout(monkeypatch: pytest.MonkeyPatch) -&gt; None</h3>
<p>This function tests that the `LMStudioClient` does not pass a timeout argument when making HTTP requests. It patches the `urlopen` function to capture and validate the request, ensuring no timeout is set. The test verifies the client&#x27;s behavior by asserting that the request is captured and that no timeout is included in the call.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_lmstudio_client_does_not_set_timeout</span>(monkeypatch: pytest<span style="color: #666666">.</span>MonkeyPatch) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    captured: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, request<span style="color: #666666">.</span>Request] <span style="color: #666666">=</span> {}

    <span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">_Response</span>:
        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_body <span style="color: #666666">=</span> json<span style="color: #666666">.</span>dumps(_default_chat_response({}))<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&quot;utf-8&quot;</span>)

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__enter__</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #BA2121">&quot;_Response&quot;</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span>

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__exit__</span>(<span style="color: #008000">self</span>, exc_type, exc, tb) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">getcode</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #666666">200</span>

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bytes</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_body

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_fake_urlopen</span>(req: request<span style="color: #666666">.</span>Request, <span style="color: #666666">*</span>args: <span style="color: #008000">object</span>, <span style="color: #666666">**</span>kwargs: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> _Response:
        <span style="color: #008000; font-weight: bold">if</span> args:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">AssertionError</span>(<span style="color: #BA2121">f&quot;Unexpected positional args: </span><span style="color: #A45A77; font-weight: bold">{</span>args<span style="color: #A45A77; font-weight: bold">!r}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;timeout&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> kwargs:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">AssertionError</span>(<span style="color: #BA2121">&quot;timeout should not be provided to urlopen&quot;</span>)
        captured[<span style="color: #BA2121">&quot;request&quot;</span>] <span style="color: #666666">=</span> req
        <span style="color: #008000; font-weight: bold">return</span> _Response()

    monkeypatch<span style="color: #666666">.</span>setattr(request, <span style="color: #BA2121">&quot;urlopen&quot;</span>, _fake_urlopen)

    client <span style="color: #666666">=</span> LMStudioClient(max_retries<span style="color: #666666">=0</span>)
    client<span style="color: #666666">.</span>chat([{<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;user&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: <span style="color: #BA2121">&quot;Hi&quot;</span>}], preset<span style="color: #666666">=</span>AnswerLength<span style="color: #666666">.</span>DETAILED)

    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;request&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> captured
</code></pre>
<details>
<summary>Subfunction: _fake_urlopen(req: request.Request, *args: object, **kwargs: object) -&gt; _Response</summary>
<h4 id="_fake_urlopen">_fake_urlopen(req: request.Request, *args: object, **kwargs: object) -&gt; _Response</h4>
<p>The function `_fake_urlopen` is a mock implementation of a URL opening function that captures the request object and returns a fake response. It validates that no positional arguments or timeout keyword arguments are passed, raising assertions if they are present. The captured request is stored in a global or enclosing scope variable `captured[&quot;request&quot;]`, and the function always returns an instance of `_Response()`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_fake_urlopen</span>(req: request<span style="color: #666666">.</span>Request, <span style="color: #666666">*</span>args: <span style="color: #008000">object</span>, <span style="color: #666666">**</span>kwargs: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> _Response:
        <span style="color: #008000; font-weight: bold">if</span> args:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">AssertionError</span>(<span style="color: #BA2121">f&quot;Unexpected positional args: </span><span style="color: #A45A77; font-weight: bold">{</span>args<span style="color: #A45A77; font-weight: bold">!r}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #BA2121">&quot;timeout&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> kwargs:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">AssertionError</span>(<span style="color: #BA2121">&quot;timeout should not be provided to urlopen&quot;</span>)
        captured[<span style="color: #BA2121">&quot;request&quot;</span>] <span style="color: #666666">=</span> req
        <span style="color: #008000; font-weight: bold">return</span> _Response()
</code></pre>
</details>
<h3 id="test_lmstudio_client_reports_timeout_without_deadline">test_lmstudio_client_reports_timeout_without_deadline(monkeypatch: pytest.MonkeyPatch) -&gt; None</h3>
<p>This function tests the behavior of the `LMStudioClient` when a timeout occurs during a chat request and no deadline is set. It patches the `urlopen` function from the `request` module to raise a `socket.timeout` exception, simulating a network timeout. The test verifies that the `LMStudioClient` properly raises an `LMStudioConnectionError` with a message containing &quot;timed out&quot; when the patched `urlopen` function is called. It also ensures that the `urlopen` function is called exactly once during the test execution.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_lmstudio_client_reports_timeout_without_deadline</span>(
    monkeypatch: pytest<span style="color: #666666">.</span>MonkeyPatch,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    calls <span style="color: #666666">=</span> <span style="color: #666666">0</span>

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_raise_timeout</span>(req: request<span style="color: #666666">.</span>Request, <span style="color: #666666">*</span>args: <span style="color: #008000">object</span>, <span style="color: #666666">**</span>kwargs: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">nonlocal</span> calls
        calls <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
        <span style="color: #008000; font-weight: bold">raise</span> error<span style="color: #666666">.</span>URLError(socket<span style="color: #666666">.</span>timeout(<span style="color: #BA2121">&quot;timed out&quot;</span>))

    monkeypatch<span style="color: #666666">.</span>setattr(request, <span style="color: #BA2121">&quot;urlopen&quot;</span>, _raise_timeout)

    client <span style="color: #666666">=</span> LMStudioClient(max_retries<span style="color: #666666">=0</span>)

    <span style="color: #008000; font-weight: bold">with</span> pytest<span style="color: #666666">.</span>raises(LMStudioConnectionError) <span style="color: #008000; font-weight: bold">as</span> excinfo:
        client<span style="color: #666666">.</span>chat([{<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;user&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: <span style="color: #BA2121">&quot;Hello&quot;</span>}], preset<span style="color: #666666">=</span>AnswerLength<span style="color: #666666">.</span>DETAILED)

    <span style="color: #008000; font-weight: bold">assert</span> calls <span style="color: #666666">==</span> <span style="color: #666666">1</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;timed out&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">str</span>(excinfo<span style="color: #666666">.</span>value)<span style="color: #666666">.</span>lower()
</code></pre>
<details>
<summary>Subfunction: _raise_timeout(req: request.Request, *args: object, **kwargs: object) -&gt; None</summary>
<h4 id="_raise_timeout">_raise_timeout(req: request.Request, *args: object, **kwargs: object) -&gt; None</h4>
<p>The function `_raise_timeout` is a local helper that increments a call counter and raises a timeout error. It takes a request object and optional arguments, updates a nonlocal variable `calls`, and raises a `URLError` with a `socket.timeout` exception indicating a &quot;timed out&quot; condition.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_raise_timeout</span>(req: request<span style="color: #666666">.</span>Request, <span style="color: #666666">*</span>args: <span style="color: #008000">object</span>, <span style="color: #666666">**</span>kwargs: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">nonlocal</span> calls
        calls <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
        <span style="color: #008000; font-weight: bold">raise</span> error<span style="color: #666666">.</span>URLError(socket<span style="color: #666666">.</span>timeout(<span style="color: #BA2121">&quot;timed out&quot;</span>))
</code></pre>
</details>
<h3 id="test_conversation_manager_handles_failures_and_recovers">test_conversation_manager_handles_failures_and_recovers(lmstudio_server: tuple[dict[str, object], str]) -&gt; None</h3>
<p>The function `test_conversation_manager_handles_failures_and_recovers` tests the behavior of a `ConversationManager` in handling connection failures and recovering from them. It uses an `LMStudioClient` with a mocked server response to simulate various error conditions, including temporary and persistent service unavailability. The test verifies that the manager properly retries failed requests, raises appropriate exceptions when retries are exhausted, and correctly updates its connection state. After restoring service health, it confirms that the manager can resume operations and maintains the conversation context within the specified window. The test also ensures that the correct number of messages are preserved in the context and that the manager&#x27;s `can_ask()` method accurately reflects its ability to process new questions.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_conversation_manager_handles_failures_and_recovers</span>(
    lmstudio_server: <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    state, base_url <span style="color: #666666">=</span> lmstudio_server
    client <span style="color: #666666">=</span> LMStudioClient(base_url<span style="color: #666666">=</span>base_url, max_retries<span style="color: #666666">=1</span>, retry_backoff<span style="color: #666666">=0.01</span>)
    manager <span style="color: #666666">=</span> ConversationManager(client, context_window<span style="color: #666666">=1</span>)
    events: <span style="color: #008000">list</span>[<span style="color: #008000">tuple</span>[<span style="color: #008000">bool</span>, <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>]] <span style="color: #666666">=</span> []
    manager<span style="color: #666666">.</span>add_connection_listener(<span style="color: #008000; font-weight: bold">lambda</span> payload: events<span style="color: #666666">.</span>append((payload<span style="color: #666666">.</span>connected, payload<span style="color: #666666">.</span>message)))

    manager<span style="color: #666666">.</span>check_connection()
    state[<span style="color: #BA2121">&quot;responses&quot;</span>] <span style="color: #666666">=</span> [
        {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #666666">500</span>, <span style="color: #BA2121">&quot;body&quot;</span>: {<span style="color: #BA2121">&quot;error&quot;</span>: <span style="color: #BA2121">&quot;temporary&quot;</span>}},
    ]
    turn <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>ask(<span style="color: #BA2121">&quot;First question?&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>answer<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;Echo:&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(state[<span style="color: #BA2121">&quot;requests&quot;</span>]) <span style="color: #666666">==</span> <span style="color: #666666">2</span>

    <span style="color: #3D7B7B; font-style: italic"># Now exhaust retries with persistent errors.</span>
    state[<span style="color: #BA2121">&quot;responses&quot;</span>] <span style="color: #666666">=</span> [
        {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #666666">503</span>, <span style="color: #BA2121">&quot;body&quot;</span>: {<span style="color: #BA2121">&quot;error&quot;</span>: <span style="color: #BA2121">&quot;down&quot;</span>}},
        {<span style="color: #BA2121">&quot;status&quot;</span>: <span style="color: #666666">503</span>, <span style="color: #BA2121">&quot;body&quot;</span>: {<span style="color: #BA2121">&quot;error&quot;</span>: <span style="color: #BA2121">&quot;still down&quot;</span>}},
    ]
    <span style="color: #008000; font-weight: bold">with</span> pytest<span style="color: #666666">.</span>raises(LMStudioError):
        manager<span style="color: #666666">.</span>ask(<span style="color: #BA2121">&quot;Second question?&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> events[<span style="color: #666666">-1</span>][<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">False</span>
    <span style="color: #008000; font-weight: bold">assert</span> events[<span style="color: #666666">-1</span>][<span style="color: #666666">1</span>]
    <span style="color: #008000; font-weight: bold">assert</span> manager<span style="color: #666666">.</span>can_ask() <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">False</span>

    <span style="color: #008000; font-weight: bold">with</span> pytest<span style="color: #666666">.</span>raises(LMStudioConnectionError):
        manager<span style="color: #666666">.</span>ask(<span style="color: #BA2121">&quot;Should not run&quot;</span>)

    <span style="color: #3D7B7B; font-style: italic"># Restore health and verify context window behaviour.</span>
    state[<span style="color: #BA2121">&quot;health_status&quot;</span>] <span style="color: #666666">=</span> <span style="color: #666666">200</span>
    state[<span style="color: #BA2121">&quot;responses&quot;</span>] <span style="color: #666666">=</span> []
    recovery_state <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>check_connection()
    <span style="color: #008000; font-weight: bold">assert</span> recovery_state<span style="color: #666666">.</span>connected <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
    <span style="color: #008000; font-weight: bold">assert</span> manager<span style="color: #666666">.</span>can_ask() <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
    <span style="color: #008000; font-weight: bold">assert</span> events[<span style="color: #666666">-1</span>][<span style="color: #666666">0</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>

    state[<span style="color: #BA2121">&quot;responses&quot;</span>] <span style="color: #666666">=</span> []
    state[<span style="color: #BA2121">&quot;requests&quot;</span>] <span style="color: #666666">=</span> []
    manager<span style="color: #666666">.</span>ask(<span style="color: #BA2121">&quot;Follow-up?&quot;</span>)
    payload <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">0</span>]
    messages <span style="color: #666666">=</span> payload[<span style="color: #BA2121">&quot;messages&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(messages) <span style="color: #666666">==</span> <span style="color: #666666">3</span>  <span style="color: #3D7B7B; font-style: italic"># previous user+assistant + new user</span>
    <span style="color: #008000; font-weight: bold">assert</span> messages[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;role&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;user&quot;</span>
    <span style="color: #008000; font-weight: bold">assert</span> messages[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;content&quot;</span>]<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;First question?&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> messages[<span style="color: #666666">1</span>][<span style="color: #BA2121">&quot;role&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;assistant&quot;</span>
</code></pre>
<h3 id="test_reasoning_verbosity_controls_request_and_artifacts">test_reasoning_verbosity_controls_request_and_artifacts(lmstudio_server: tuple[dict[str, object], str]) -&gt; None</h3>
<p>The function `test_reasoning_verbosity_controls_request_and_artifacts` tests the behavior of reasoning verbosity controls in a conversation manager integrated with an LMStudio client. It verifies that when asking questions with different verbosity settings (`MINIMAL` and `EXTENDED`), the corresponding request payloads include the correct verbosity levels and plan inclusion flags. Additionally, it checks that the resulting conversation turns contain appropriate reasoning bullets and plan entries based on the specified verbosity level. The test ensures that minimal verbosity excludes the plan and uses concise reasoning, while extended verbosity includes a detailed plan and more extensive reasoning.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_reasoning_verbosity_controls_request_and_artifacts</span>(
    lmstudio_server: <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    state, base_url <span style="color: #666666">=</span> lmstudio_server
    client <span style="color: #666666">=</span> LMStudioClient(base_url<span style="color: #666666">=</span>base_url, retry_backoff<span style="color: #666666">=0.01</span>)
    manager <span style="color: #666666">=</span> ConversationManager(client, context_window<span style="color: #666666">=0</span>)

    manager<span style="color: #666666">.</span>ask(<span style="color: #BA2121">&quot;Minimal please&quot;</span>, reasoning_verbosity<span style="color: #666666">=</span>ReasoningVerbosity<span style="color: #666666">.</span>MINIMAL)
    <span style="color: #008000; font-weight: bold">assert</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>]
    minimal_payload <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> minimal_payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>][<span style="color: #BA2121">&quot;verbosity&quot;</span>] <span style="color: #666666">==</span> ReasoningVerbosity<span style="color: #666666">.</span>MINIMAL<span style="color: #666666">.</span>value
    <span style="color: #008000; font-weight: bold">assert</span> minimal_payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>][<span style="color: #BA2121">&quot;include_plan&quot;</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">False</span>
    minimal_turn <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>turns[<span style="color: #666666">-1</span>]
    <span style="color: #008000; font-weight: bold">assert</span> minimal_turn<span style="color: #666666">.</span>reasoning_bullets
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(minimal_turn<span style="color: #666666">.</span>plan) <span style="color: #666666">==</span> <span style="color: #666666">0</span>

    manager<span style="color: #666666">.</span>ask(<span style="color: #BA2121">&quot;Extended please&quot;</span>, reasoning_verbosity<span style="color: #666666">=</span>ReasoningVerbosity<span style="color: #666666">.</span>EXTENDED)
    extended_payload <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">-1</span>]
    <span style="color: #008000; font-weight: bold">assert</span> extended_payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>][<span style="color: #BA2121">&quot;verbosity&quot;</span>] <span style="color: #666666">==</span> ReasoningVerbosity<span style="color: #666666">.</span>EXTENDED<span style="color: #666666">.</span>value
    <span style="color: #008000; font-weight: bold">assert</span> extended_payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>][<span style="color: #BA2121">&quot;include_plan&quot;</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
    extended_turn <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>turns[<span style="color: #666666">-1</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(extended_turn<span style="color: #666666">.</span>plan) <span style="color: #666666">&gt;=</span> <span style="color: #666666">2</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(extended_turn<span style="color: #666666">.</span>reasoning_bullets) <span style="color: #666666">&gt;=</span> <span style="color: #666666">3</span>
</code></pre>
<h3 id="test_sources_only_mode_tracks_clarification_and_self_check">test_sources_only_mode_tracks_clarification_and_self_check(lmstudio_server: tuple[dict[str, object], str]) -&gt; None</h3>
<p>This function tests the behavior of the system when operating in &quot;sources only&quot; mode, specifically verifying that clarification requests and self-check flags are properly tracked and returned in the conversation turn. It mocks a response from an LMStudio client that includes reasoning metadata with assumptions and self-check information, then asserts that the conversation manager correctly processes and exposes these details in the resulting turn object. The test ensures that when a clarifying question is needed due to ambiguous input, and when a self-check fails because of missing information, both are accurately reflected in the output.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_sources_only_mode_tracks_clarification_and_self_check</span>(
    lmstudio_server: <span style="color: #008000">tuple</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>], <span style="color: #008000">str</span>]
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    state, base_url <span style="color: #666666">=</span> lmstudio_server

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_clarifying_response</span>(payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]:
        base <span style="color: #666666">=</span> _default_chat_response(payload)
        choice <span style="color: #666666">=</span> base[<span style="color: #BA2121">&quot;choices&quot;</span>][<span style="color: #666666">0</span>]
        message <span style="color: #666666">=</span> choice[<span style="color: #BA2121">&quot;message&quot;</span>]
        metadata <span style="color: #666666">=</span> message[<span style="color: #BA2121">&quot;metadata&quot;</span>]
        reasoning <span style="color: #666666">=</span> metadata[<span style="color: #BA2121">&quot;reasoning&quot;</span>]
        reasoning[<span style="color: #BA2121">&quot;assumptions&quot;</span>] <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;used&quot;</span>: [],
            <span style="color: #BA2121">&quot;should_ask&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
            <span style="color: #BA2121">&quot;clarifying_question&quot;</span>: <span style="color: #BA2121">&quot;Which quarter should I analyse?&quot;</span>,
            <span style="color: #BA2121">&quot;rationale&quot;</span>: <span style="color: #BA2121">&quot;Ambiguous timeframe for revenue.&quot;</span>,
        }
        reasoning[<span style="color: #BA2121">&quot;self_check&quot;</span>] <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;passed&quot;</span>: <span style="color: #008000; font-weight: bold">False</span>,
            <span style="color: #BA2121">&quot;flags&quot;</span>: [<span style="color: #BA2121">&quot;Needs timeframe clarification&quot;</span>],
            <span style="color: #BA2121">&quot;notes&quot;</span>: <span style="color: #BA2121">&quot;Unable to validate without timeframe.&quot;</span>,
        }
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;response_mode&quot;</span>) <span style="color: #666666">==</span> ResponseMode<span style="color: #666666">.</span>SOURCES_ONLY<span style="color: #666666">.</span>value:
            message[<span style="color: #BA2121">&quot;content&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Sources only: doc1, doc2&quot;</span>
        <span style="color: #008000; font-weight: bold">return</span> base

    state[<span style="color: #BA2121">&quot;response_template&quot;</span>] <span style="color: #666666">=</span> _clarifying_response

    client <span style="color: #666666">=</span> LMStudioClient(base_url<span style="color: #666666">=</span>base_url, retry_backoff<span style="color: #666666">=0.01</span>)
    manager <span style="color: #666666">=</span> ConversationManager(client)

    turn <span style="color: #666666">=</span> manager<span style="color: #666666">.</span>ask(
        <span style="color: #BA2121">&quot;Summarise recent revenue performance&quot;</span>,
        reasoning_verbosity<span style="color: #666666">=</span>ReasoningVerbosity<span style="color: #666666">.</span>BRIEF,
        response_mode<span style="color: #666666">=</span>ResponseMode<span style="color: #666666">.</span>SOURCES_ONLY,
    )

    payload <span style="color: #666666">=</span> state[<span style="color: #BA2121">&quot;requests&quot;</span>][<span style="color: #666666">-1</span>]
    <span style="color: #008000; font-weight: bold">assert</span> payload[<span style="color: #BA2121">&quot;response_mode&quot;</span>] <span style="color: #666666">==</span> ResponseMode<span style="color: #666666">.</span>SOURCES_ONLY<span style="color: #666666">.</span>value
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>response_mode <span style="color: #AA22FF; font-weight: bold">is</span> ResponseMode<span style="color: #666666">.</span>SOURCES_ONLY
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>assumption_decision <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>assumption_decision<span style="color: #666666">.</span>mode <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;clarify&quot;</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>assumption_decision<span style="color: #666666">.</span>clarifying_question
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #AA22FF; font-weight: bold">not</span> turn<span style="color: #666666">.</span>assumptions
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>self_check <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> turn<span style="color: #666666">.</span>self_check<span style="color: #666666">.</span>passed <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">False</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">any</span>(<span style="color: #BA2121">&quot;timeframe&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> flag<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">for</span> flag <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>self_check<span style="color: #666666">.</span>flags)
</code></pre>
<details>
<summary>Subfunction: _clarifying_response(payload: dict[str, object]) -&gt; dict[str, object]</summary>
<h4 id="_clarifying_response">_clarifying_response(payload: dict[str, object]) -&gt; dict[str, object]</h4>
<p>The function `_clarifying_response` generates a modified chat response payload intended to prompt the user for clarification. It begins by creating a default chat response using `_default_chat_response`, then enhances the response metadata with reasoning information that includes assumptions and self-check flags. The assumptions section indicates the need for a clarifying question about the timeframe of analysis, while the self-check section marks the response as failed due to missing contextual information. If the payload specifies a &quot;sources only&quot; response mode, it updates the message content to reflect this mode. The function returns the modified base response structure.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_clarifying_response</span>(payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]:
        base <span style="color: #666666">=</span> _default_chat_response(payload)
        choice <span style="color: #666666">=</span> base[<span style="color: #BA2121">&quot;choices&quot;</span>][<span style="color: #666666">0</span>]
        message <span style="color: #666666">=</span> choice[<span style="color: #BA2121">&quot;message&quot;</span>]
        metadata <span style="color: #666666">=</span> message[<span style="color: #BA2121">&quot;metadata&quot;</span>]
        reasoning <span style="color: #666666">=</span> metadata[<span style="color: #BA2121">&quot;reasoning&quot;</span>]
        reasoning[<span style="color: #BA2121">&quot;assumptions&quot;</span>] <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;used&quot;</span>: [],
            <span style="color: #BA2121">&quot;should_ask&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
            <span style="color: #BA2121">&quot;clarifying_question&quot;</span>: <span style="color: #BA2121">&quot;Which quarter should I analyse?&quot;</span>,
            <span style="color: #BA2121">&quot;rationale&quot;</span>: <span style="color: #BA2121">&quot;Ambiguous timeframe for revenue.&quot;</span>,
        }
        reasoning[<span style="color: #BA2121">&quot;self_check&quot;</span>] <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;passed&quot;</span>: <span style="color: #008000; font-weight: bold">False</span>,
            <span style="color: #BA2121">&quot;flags&quot;</span>: [<span style="color: #BA2121">&quot;Needs timeframe clarification&quot;</span>],
            <span style="color: #BA2121">&quot;notes&quot;</span>: <span style="color: #BA2121">&quot;Unable to validate without timeframe.&quot;</span>,
        }
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;response_mode&quot;</span>) <span style="color: #666666">==</span> ResponseMode<span style="color: #666666">.</span>SOURCES_ONLY<span style="color: #666666">.</span>value:
            message[<span style="color: #BA2121">&quot;content&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Sources only: doc1, doc2&quot;</span>
        <span style="color: #008000; font-weight: bold">return</span> base
</code></pre>
</details>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
