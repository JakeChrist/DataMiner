<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_ingest_service</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_ingest_service</h1>
        <p>This module defines a set of tests for an ingest service that processes files and directories, tracking progress and managing document storage. Tests cover folder crawling with inclusion and exclusion patterns, recursive directory traversal, document repository population, rescan functionality detecting file changes, job pausing and resuming, job cancellation with rollback, OCR detection for PDFs, and job persistence across service restarts. Each test uses a temporary database manager and verifies various aspects of job execution, status updates, and data integrity. The tests utilize fixtures for database setup and helper functions to wait for job completion or specific statuses.</p>
<h2>Functions</h2>
<h3 id="db_manager">db_manager(tmp_path: Path) -&gt; DatabaseManager</h3>
<p>The function `db_manager` creates and yields a `DatabaseManager` instance configured with a specified SQLite database path. It initializes the database manager, yields it for use, and ensures it is closed after use. The database path is constructed from a provided temporary directory path, and the manager is initialized before being yielded. The function operates as a generator, providing a context-like interface for managing the database lifecycle.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">db_manager</span>(tmp_path: Path) <span style="color: #666666">-&gt;</span> DatabaseManager:
    db_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;ingest.db&quot;</span>
    manager <span style="color: #666666">=</span> DatabaseManager(db_path)
    manager<span style="color: #666666">.</span>initialize()
    <span style="color: #008000; font-weight: bold">yield</span> manager
    manager<span style="color: #666666">.</span>close()
</code></pre>
<h3 id="_wait_for_status">_wait_for_status(service: IngestService, job_id: int, status: str, timeout: float=5.0) -&gt; None</h3>
<p>The function `_wait_for_status` waits for a specified job in an ingest service to reach a given status within a timeout period. It repeatedly checks the job&#x27;s status at 50ms intervals until the desired status is achieved or the timeout expires. If the status is not reached within the timeout, it raises an assertion failure using `pytest.fail`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_wait_for_status</span>(service: IngestService, job_id: <span style="color: #008000">int</span>, status: <span style="color: #008000">str</span>, timeout: <span style="color: #008000">float</span> <span style="color: #666666">=</span> <span style="color: #666666">5.0</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    deadline <span style="color: #666666">=</span> time<span style="color: #666666">.</span>monotonic() <span style="color: #666666">+</span> timeout
    <span style="color: #008000; font-weight: bold">while</span> time<span style="color: #666666">.</span>monotonic() <span style="color: #666666">&lt;</span> deadline:
        record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
        <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">and</span> record[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> status:
            <span style="color: #008000; font-weight: bold">return</span>
        time<span style="color: #666666">.</span>sleep(<span style="color: #666666">0.05</span>)
    pytest<span style="color: #666666">.</span>fail(<span style="color: #BA2121">f&quot;Job </span><span style="color: #A45A77; font-weight: bold">{</span>job_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> did not reach status </span><span style="color: #A45A77; font-weight: bold">{</span>status<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
</code></pre>
<h3 id="_collect_known_files">_collect_known_files(record: dict[str, object]) -&gt; dict[str, object]</h3>
<p>The function `_collect_known_files` extracts a dictionary of known files from a given record. It retrieves the `extra_data` field from the input dictionary, defaults to an empty dictionary if `extra_data` is missing or None, and then navigates through the nested structure to obtain the `known_files` dictionary located under `summary`. If any level in this path is missing, it returns an empty dictionary.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_collect_known_files</span>(record: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]:
    extra <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;extra_data&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
    <span style="color: #008000; font-weight: bold">return</span> extra<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, {})<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {})
</code></pre>
<h3 id="test_folder_crawl_tracks_progress_and_summary">test_folder_crawl_tracks_progress_and_summary(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>This function tests the folder crawling functionality of an `IngestService` by verifying that it correctly tracks progress and summary information when processing files in a directory. It creates a temporary directory with multiple files, including ones that should be included or excluded based on specified patterns. The test ensures that the service properly handles the job lifecycle, updates progress status, and stores processed document metadata in the database. It validates that only the expected file is processed, checks the stored document preview and OCR status, and confirms that the job completes successfully with appropriate progress tracking.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_folder_crawl_tracks_progress_and_summary</span>(tmp_path: Path, db_manager: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    docs <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;docs&quot;</span>
    docs<span style="color: #666666">.</span>mkdir()
    (docs <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;keep.txt&quot;</span>)<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;alpha&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
    (docs <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;skip.log&quot;</span>)<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;should be ignored&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
    (docs <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;other.txt&quot;</span>)<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;beta&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    service <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    updates: <span style="color: #008000">list</span>[<span style="color: #008000">tuple</span>[<span style="color: #008000">int</span>, <span style="color: #008000">str</span>]] <span style="color: #666666">=</span> []

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        updates<span style="color: #666666">.</span>append((job_id, payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(payload, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>))

    service<span style="color: #666666">.</span>subscribe(on_update)

    job_id <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_folder_crawl(
        project_id<span style="color: #666666">=1</span>,
        root<span style="color: #666666">=</span>docs,
        include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>],
        exclude<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;other.*&quot;</span>],
    )

    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(job_id, timeout<span style="color: #666666">=5.0</span>)
    record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> record[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>COMPLETED
    extra <span style="color: #666666">=</span> record[<span style="color: #BA2121">&quot;extra_data&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> extra[<span style="color: #BA2121">&quot;progress&quot;</span>][<span style="color: #BA2121">&quot;total&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">1</span>
    <span style="color: #008000; font-weight: bold">assert</span> extra[<span style="color: #BA2121">&quot;summary&quot;</span>][<span style="color: #BA2121">&quot;success_count&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">1</span>
    known_files <span style="color: #666666">=</span> extra[<span style="color: #BA2121">&quot;summary&quot;</span>][<span style="color: #BA2121">&quot;known_files&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">list</span>(known_files<span style="color: #666666">.</span>keys()) <span style="color: #666666">==</span> [<span style="color: #008000">str</span>((docs <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;keep.txt&quot;</span>)<span style="color: #666666">.</span>resolve())]
    doc_repo <span style="color: #666666">=</span> IngestDocumentRepository(db_manager)
    stored <span style="color: #666666">=</span> doc_repo<span style="color: #666666">.</span>get_latest_by_path(docs <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;keep.txt&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> stored <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> stored[<span style="color: #BA2121">&quot;preview&quot;</span>]<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;alpha&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> stored[<span style="color: #BA2121">&quot;needs_ocr&quot;</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">False</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">any</span>(status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>COMPLETED <span style="color: #008000; font-weight: bold">for</span> _, status <span style="color: #AA22FF; font-weight: bold">in</span> updates)

    service<span style="color: #666666">.</span>shutdown()
</code></pre>
<details>
<summary>Subfunction: on_update(job_id: int, payload: dict[str, object]) -&gt; None</summary>
<h4 id="on_update">on_update(job_id: int, payload: dict[str, object]) -&gt; None</h4>
<p>The function `on_update` accepts a job identifier and a payload dictionary, extracting the status from the payload if it is a dictionary, and appends a tuple of the job ID and extracted status to a list named `updates`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        updates<span style="color: #666666">.</span>append((job_id, payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(payload, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>))
</code></pre>
</details>
<h3 id="test_folder_crawl_recurses_into_subdirectories">test_folder_crawl_recurses_into_subdirectories(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>The function tests that a folder crawl operation recursively processes subdirectories. It creates a temporary directory structure with a nested subdirectory and file, then initiates a folder crawl using the `IngestService` to scan the root directory for files matching the pattern &quot;*.txt&quot;. After confirming the crawl completes successfully, it verifies that the nested file&#x27;s path is included in the list of known files reported by the crawl job. Finally, it shuts down the service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_folder_crawl_recurses_into_subdirectories</span>(
    tmp_path: Path, db_manager: DatabaseManager
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;root&quot;</span>
    root<span style="color: #666666">.</span>mkdir()
    nested <span style="color: #666666">=</span> root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;nested&quot;</span>
    nested<span style="color: #666666">.</span>mkdir()
    nested_file <span style="color: #666666">=</span> nested <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;note.txt&quot;</span>
    nested_file<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;payload&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    service <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    job_id <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_folder_crawl(<span style="color: #008000; font-weight: bold">None</span>, root, include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(job_id, timeout<span style="color: #666666">=5.0</span>)

    record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    known_files <span style="color: #666666">=</span> record[<span style="color: #BA2121">&quot;extra_data&quot;</span>][<span style="color: #BA2121">&quot;summary&quot;</span>][<span style="color: #BA2121">&quot;known_files&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">str</span>(nested_file<span style="color: #666666">.</span>resolve()) <span style="color: #AA22FF; font-weight: bold">in</span> known_files

    service<span style="color: #666666">.</span>shutdown()
</code></pre>
<h3 id="test_completed_job_populates_document_repository">test_completed_job_populates_document_repository(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>This function tests the completion of a document ingestion job and verifies that it correctly populates the document repository. It creates a temporary project directory with a text file, queues a folder crawl job to index the file, and confirms the job completes successfully. It then checks that the document is properly added to the repository with correct metadata, including file size and source path. The test also verifies that the document can be removed from the repository by queuing a removal job and confirming the document is no longer present. Finally, it shuts down the service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_completed_job_populates_document_repository</span>(
    tmp_path: Path, db_manager: DatabaseManager
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;project&quot;</span>
    root<span style="color: #666666">.</span>mkdir()
    tracked <span style="color: #666666">=</span> root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;tracked.txt&quot;</span>
    payload <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;indexed payload&quot;</span>
    tracked<span style="color: #666666">.</span>write_text(payload, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    service <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    projects <span style="color: #666666">=</span> ProjectRepository(db_manager)
    project <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Test Project&quot;</span>)
    project_id <span style="color: #666666">=</span> <span style="color: #008000">int</span>(project[<span style="color: #BA2121">&quot;id&quot;</span>])
    job_id <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_folder_crawl(project_id, root, include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(job_id, timeout<span style="color: #666666">=5.0</span>)

    repo <span style="color: #666666">=</span> DocumentRepository(db_manager)
    ingest_repo <span style="color: #666666">=</span> IngestDocumentRepository(db_manager)
    documents <span style="color: #666666">=</span> repo<span style="color: #666666">.</span>list_for_project(project_id)
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(documents) <span style="color: #666666">==</span> <span style="color: #666666">1</span>
    document <span style="color: #666666">=</span> documents[<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> document[<span style="color: #BA2121">&quot;source_path&quot;</span>] <span style="color: #666666">==</span> <span style="color: #008000">str</span>(tracked<span style="color: #666666">.</span>resolve())
    <span style="color: #008000; font-weight: bold">assert</span> document[<span style="color: #BA2121">&quot;metadata&quot;</span>][<span style="color: #BA2121">&quot;file&quot;</span>][<span style="color: #BA2121">&quot;size&quot;</span>] <span style="color: #666666">==</span> tracked<span style="color: #666666">.</span>stat()<span style="color: #666666">.</span>st_size
    <span style="color: #008000; font-weight: bold">assert</span> ingest_repo<span style="color: #666666">.</span>get_latest_by_path(tracked) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>

    remove_job <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_remove(project_id, root, [tracked])
    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(remove_job, timeout<span style="color: #666666">=5.0</span>)
    <span style="color: #008000; font-weight: bold">assert</span> repo<span style="color: #666666">.</span>list_for_project(project_id) <span style="color: #666666">==</span> []
    <span style="color: #008000; font-weight: bold">assert</span> ingest_repo<span style="color: #666666">.</span>get_latest_by_path(tracked) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>

    service<span style="color: #666666">.</span>shutdown()
</code></pre>
<h3 id="test_rescan_detects_changes_and_removals">test_rescan_detects_changes_and_removals(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>This function tests the ability of the `IngestService` to detect changes and removals during a rescan operation. It sets up a temporary directory with two initial files, queues a folder crawl to index them, and verifies the initial state. It then modifies one file, removes another, and adds a new file. A rescan is queued and completed, after which it asserts that the rescan correctly identifies the modified and added files, and records the removal of the deleted file. It also confirms that the database reflects these changes by checking the presence or absence of document records for each file. Finally, it shuts down the service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_rescan_detects_changes_and_removals</span>(tmp_path: Path, db_manager: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;library&quot;</span>
    root<span style="color: #666666">.</span>mkdir()
    file_a <span style="color: #666666">=</span> root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;a.txt&quot;</span>
    file_b <span style="color: #666666">=</span> root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;b.txt&quot;</span>
    file_a<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;one&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
    file_b<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;two&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    service <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    first_job <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_folder_crawl(<span style="color: #008000; font-weight: bold">None</span>, root, include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(first_job, timeout<span style="color: #666666">=5.0</span>)
    record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(first_job)
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    initial_known <span style="color: #666666">=</span> _collect_known_files(record)
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(initial_known) <span style="color: #666666">==</span> <span style="color: #666666">2</span>

    <span style="color: #3D7B7B; font-style: italic"># Modify a file, remove another, and add a new one before rescanning.</span>
    file_a<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;one-modified&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
    os<span style="color: #666666">.</span>remove(file_b)
    file_c <span style="color: #666666">=</span> root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;c.txt&quot;</span>
    file_c<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;three&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    second_job <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_rescan(<span style="color: #008000; font-weight: bold">None</span>, root, include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(second_job, timeout<span style="color: #666666">=5.0</span>)
    rescan_record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(second_job)
    <span style="color: #008000; font-weight: bold">assert</span> rescan_record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    summary <span style="color: #666666">=</span> rescan_record[<span style="color: #BA2121">&quot;extra_data&quot;</span>][<span style="color: #BA2121">&quot;summary&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> summary[<span style="color: #BA2121">&quot;success_count&quot;</span>] <span style="color: #666666">&gt;=</span> <span style="color: #666666">2</span>  <span style="color: #3D7B7B; font-style: italic"># modified + new</span>
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">set</span>(summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;removed&quot;</span>, [])) <span style="color: #666666">==</span> {<span style="color: #008000">str</span>(file_b<span style="color: #666666">.</span>resolve())}
    known_files <span style="color: #666666">=</span> summary[<span style="color: #BA2121">&quot;known_files&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">str</span>(file_a<span style="color: #666666">.</span>resolve()) <span style="color: #AA22FF; font-weight: bold">in</span> known_files
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">str</span>(file_c<span style="color: #666666">.</span>resolve()) <span style="color: #AA22FF; font-weight: bold">in</span> known_files
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">str</span>(file_b<span style="color: #666666">.</span>resolve()) <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> known_files
    ingest_repo <span style="color: #666666">=</span> IngestDocumentRepository(db_manager)
    <span style="color: #008000; font-weight: bold">assert</span> ingest_repo<span style="color: #666666">.</span>get_latest_by_path(file_b) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> ingest_repo<span style="color: #666666">.</span>get_latest_by_path(file_a) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> ingest_repo<span style="color: #666666">.</span>get_latest_by_path(file_c) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>

    service<span style="color: #666666">.</span>shutdown()
</code></pre>
<h3 id="test_pause_and_resume_persists_progress">test_pause_and_resume_persists_progress(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>The function `test_pause_and_resume_persists_progress` tests the ability of the `IngestService` to pause and resume a document ingestion job while preserving its progress. It creates a temporary directory with five text files, initiates a folder crawl job using the service, and monitors the job&#x27;s status via a callback. When the job reaches a certain processing stage, it pauses the job and verifies that the job state is correctly saved, including the position in the file list. After resuming the job, it waits for completion and asserts that all files are processed successfully. Finally, it shuts down the service. The test ensures that progress is maintained across pause and resume operations.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_pause_and_resume_persists_progress</span>(tmp_path: Path, db_manager: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;pause&quot;</span>
    root<span style="color: #666666">.</span>mkdir()
    <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">5</span>):
        (root <span style="color: #666666">/</span> <span style="color: #BA2121">f&quot;file-</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.txt&quot;</span>)<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">f&quot;payload-</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    service <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    pause_triggered <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Event()

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>) <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>RUNNING:
            progress <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(progress, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> pause_triggered<span style="color: #666666">.</span>is_set():
                pause_triggered<span style="color: #666666">.</span>set()
                service<span style="color: #666666">.</span>pause_job(job_id)

    service<span style="color: #666666">.</span>subscribe(on_update)
    job_id <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_folder_crawl(<span style="color: #008000; font-weight: bold">None</span>, root, include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>])

    <span style="color: #008000; font-weight: bold">assert</span> pause_triggered<span style="color: #666666">.</span>wait(timeout<span style="color: #666666">=5.0</span>)
    _wait_for_status(service, job_id, TaskStatus<span style="color: #666666">.</span>PAUSED)
    record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    state <span style="color: #666666">=</span> record[<span style="color: #BA2121">&quot;extra_data&quot;</span>][<span style="color: #BA2121">&quot;state&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #666666">0</span> <span style="color: #666666">&lt;</span> state[<span style="color: #BA2121">&quot;position&quot;</span>] <span style="color: #666666">&lt;</span> <span style="color: #008000">len</span>(state[<span style="color: #BA2121">&quot;pending_files&quot;</span>])

    service<span style="color: #666666">.</span>resume_job(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(job_id, timeout<span style="color: #666666">=5.0</span>)
    final_record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> final_record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> final_record[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>COMPLETED
    <span style="color: #008000; font-weight: bold">assert</span> final_record[<span style="color: #BA2121">&quot;extra_data&quot;</span>][<span style="color: #BA2121">&quot;summary&quot;</span>][<span style="color: #BA2121">&quot;success_count&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">5</span>
    service<span style="color: #666666">.</span>shutdown()
</code></pre>
<details>
<summary>Subfunction: on_update(job_id: int, payload: dict[str, object]) -&gt; None</summary>
<h4 id="on_update">on_update(job_id: int, payload: dict[str, object]) -&gt; None</h4>
<p>The function `on_update` handles updates for a background job, specifically checking if the job&#x27;s status is &quot;RUNNING&quot;. If so, it examines the progress data within the payload. When the progress indicates that at least one item has been processed and a pause trigger is not already set, it sets the pause trigger and pauses the corresponding job using a service method.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>) <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>RUNNING:
            progress <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(progress, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> pause_triggered<span style="color: #666666">.</span>is_set():
                pause_triggered<span style="color: #666666">.</span>set()
                service<span style="color: #666666">.</span>pause_job(job_id)
</code></pre>
</details>
<h3 id="test_cancel_rolls_back_partial_progress">test_cancel_rolls_back_partial_progress(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>This function tests the cancellation behavior of a document ingestion job, ensuring that partial progress is rolled back correctly when the job is canceled. It creates a temporary directory with three text files, initiates a folder crawl using `IngestService`, and monitors the job&#x27;s progress. Upon detecting that at least one file has been processed, it cancels the job. The test verifies that the job status is updated to `CANCELLED`, and that the summary data indicates rolled-back progress and an empty set of known files, confirming that the cancellation mechanism properly reverts partial changes. Finally, it shuts down the service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_cancel_rolls_back_partial_progress</span>(tmp_path: Path, db_manager: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;cancel&quot;</span>
    root<span style="color: #666666">.</span>mkdir()
    <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">3</span>):
        (root <span style="color: #666666">/</span> <span style="color: #BA2121">f&quot;doc-</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.txt&quot;</span>)<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;data&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    service <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    cancel_triggered <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Event()

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>) <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>RUNNING:
            progress <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(progress, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> cancel_triggered<span style="color: #666666">.</span>is_set():
                cancel_triggered<span style="color: #666666">.</span>set()
                service<span style="color: #666666">.</span>cancel_job(job_id)

    service<span style="color: #666666">.</span>subscribe(on_update)
    job_id <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_folder_crawl(<span style="color: #008000; font-weight: bold">None</span>, root, include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> cancel_triggered<span style="color: #666666">.</span>wait(timeout<span style="color: #666666">=5.0</span>)
    _wait_for_status(service, job_id, TaskStatus<span style="color: #666666">.</span>CANCELLED)
    record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    summary <span style="color: #666666">=</span> record[<span style="color: #BA2121">&quot;extra_data&quot;</span>][<span style="color: #BA2121">&quot;summary&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> summary[<span style="color: #BA2121">&quot;rolled_back&quot;</span>] <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span>
    <span style="color: #008000; font-weight: bold">assert</span> summary[<span style="color: #BA2121">&quot;known_files&quot;</span>] <span style="color: #666666">==</span> {}

    service<span style="color: #666666">.</span>shutdown()
</code></pre>
<details>
<summary>Subfunction: on_update(job_id: int, payload: dict[str, object]) -&gt; None</summary>
<h4 id="on_update">on_update(job_id: int, payload: dict[str, object]) -&gt; None</h4>
<p>The function `on_update` handles updates for a background job by checking if the job&#x27;s status is &quot;RUNNING&quot;. If so, it retrieves the progress information from the payload. When the progress indicates that at least one item has been processed and a cancellation flag (`cancel_triggered`) is not already set, it sets the cancellation flag and cancels the job using the provided job ID.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>) <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>RUNNING:
            progress <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(progress, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> cancel_triggered<span style="color: #666666">.</span>is_set():
                cancel_triggered<span style="color: #666666">.</span>set()
                service<span style="color: #666666">.</span>cancel_job(job_id)
</code></pre>
</details>
<h3 id="test_pdf_without_text_flags_ocr">test_pdf_without_text_flags_ocr(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>The function `test_pdf_without_text_flags_ocr` tests the document ingestion service&#x27;s handling of a PDF file that contains no text and requires OCR processing. It creates a blank PDF using the `fitz` library, queues the file for ingestion via `IngestService`, and verifies that the service correctly identifies the need for OCR. The test confirms that the document is processed, marked with an OCR flag, and stored with relevant metadata indicating OCR necessity and a message describing the OCR requirement. The service is shut down after the test.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_pdf_without_text_flags_ocr</span>(tmp_path: Path, db_manager: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    pdf_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;blank.pdf&quot;</span>
    fitz <span style="color: #666666">=</span> pytest<span style="color: #666666">.</span>importorskip(<span style="color: #BA2121">&quot;fitz&quot;</span>)

    document <span style="color: #666666">=</span> fitz<span style="color: #666666">.</span>open()
    document<span style="color: #666666">.</span>new_page()
    document<span style="color: #666666">.</span>save(pdf_path)
    document<span style="color: #666666">.</span>close()

    service <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    job_id <span style="color: #666666">=</span> service<span style="color: #666666">.</span>queue_file_add(<span style="color: #008000; font-weight: bold">None</span>, [pdf_path], include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.pdf&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> service<span style="color: #666666">.</span>wait_for_completion(job_id, timeout<span style="color: #666666">=5.0</span>)
    record <span style="color: #666666">=</span> service<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> record[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>COMPLETED
    summary <span style="color: #666666">=</span> record[<span style="color: #BA2121">&quot;extra_data&quot;</span>][<span style="color: #BA2121">&quot;summary&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;needs_ocr&quot;</span>)
    needs_ocr_entry <span style="color: #666666">=</span> summary[<span style="color: #BA2121">&quot;needs_ocr&quot;</span>][<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;OCR&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> needs_ocr_entry[<span style="color: #BA2121">&quot;message&quot;</span>]
    repo <span style="color: #666666">=</span> IngestDocumentRepository(db_manager)
    stored <span style="color: #666666">=</span> repo<span style="color: #666666">.</span>get_latest_by_path(pdf_path)
    <span style="color: #008000; font-weight: bold">assert</span> stored <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> stored[<span style="color: #BA2121">&quot;needs_ocr&quot;</span>] <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
    <span style="color: #008000; font-weight: bold">assert</span> stored[<span style="color: #BA2121">&quot;ocr_message&quot;</span>]
    service<span style="color: #666666">.</span>shutdown()
</code></pre>
<h3 id="test_resume_after_restart">test_resume_after_restart(tmp_path: Path, db_manager: DatabaseManager) -&gt; None</h3>
<p>The function `test_resume_after_restart` tests the ability to pause and resume a document ingestion job across service restarts. It creates a temporary directory with four text files, queues a folder crawl using an `IngestService`, and pauses the job once processing begins. After shutting down the first service and creating a new one, it verifies that the job remains in a paused state. The function then resumes the job in the new service, waits for completion, and asserts that all four files were successfully processed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_resume_after_restart</span>(tmp_path: Path, db_manager: DatabaseManager) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;restart&quot;</span>
    root<span style="color: #666666">.</span>mkdir()
    <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">4</span>):
        (root <span style="color: #666666">/</span> <span style="color: #BA2121">f&quot;item-</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.txt&quot;</span>)<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;restart&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

    service_one <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    paused <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Event()

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>) <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>RUNNING:
            progress <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(progress, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> paused<span style="color: #666666">.</span>is_set():
                paused<span style="color: #666666">.</span>set()
                service_one<span style="color: #666666">.</span>pause_job(job_id)

    service_one<span style="color: #666666">.</span>subscribe(on_update)
    job_id <span style="color: #666666">=</span> service_one<span style="color: #666666">.</span>queue_folder_crawl(<span style="color: #008000; font-weight: bold">None</span>, root, include<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;*.txt&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> paused<span style="color: #666666">.</span>wait(timeout<span style="color: #666666">=5.0</span>)
    _wait_for_status(service_one, job_id, TaskStatus<span style="color: #666666">.</span>PAUSED)
    service_one<span style="color: #666666">.</span>shutdown()

    service_two <span style="color: #666666">=</span> IngestService(db_manager, worker_idle_sleep<span style="color: #666666">=0.01</span>)
    <span style="color: #3D7B7B; font-style: italic"># On restore the job remains paused until explicitly resumed.</span>
    record <span style="color: #666666">=</span> service_two<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> record[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>PAUSED

    service_two<span style="color: #666666">.</span>resume_job(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> service_two<span style="color: #666666">.</span>wait_for_completion(job_id, timeout<span style="color: #666666">=5.0</span>)
    final_record <span style="color: #666666">=</span> service_two<span style="color: #666666">.</span>repo<span style="color: #666666">.</span>get(job_id)
    <span style="color: #008000; font-weight: bold">assert</span> final_record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> final_record[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>COMPLETED
    <span style="color: #008000; font-weight: bold">assert</span> final_record[<span style="color: #BA2121">&quot;extra_data&quot;</span>][<span style="color: #BA2121">&quot;summary&quot;</span>][<span style="color: #BA2121">&quot;success_count&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">4</span>

    service_two<span style="color: #666666">.</span>shutdown()
</code></pre>
<details>
<summary>Subfunction: on_update(job_id: int, payload: dict[str, object]) -&gt; None</summary>
<h4 id="on_update">on_update(job_id: int, payload: dict[str, object]) -&gt; None</h4>
<p>The function `on_update` handles updates for a background job by checking if the job&#x27;s status is &quot;RUNNING&quot;. If so, it retrieves the progress information from the payload. If the progress indicates that at least one item has been processed and a `paused` event is not already set, it sets the `paused` event and pauses the job using `service_one.pause_job`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_update</span>(job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">object</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>) <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>RUNNING:
            progress <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(progress, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> paused<span style="color: #666666">.</span>is_set():
                paused<span style="color: #666666">.</span>set()
                service_one<span style="color: #666666">.</span>pause_job(job_id)
</code></pre>
</details>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
