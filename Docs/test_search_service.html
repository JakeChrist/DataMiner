<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_search_service</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_search_service</h1>
        <p>Defines fixtures and tests for search and document hierarchy functionality within a document management system. Includes setup for database connections, repositories, and ingestion handling. Tests cover document searching with scope and highlighting, relaxed query term matching, context snippet collection with metadata inclusion, and hierarchical document organization with tagging and folder structures.</p>
<h2>Functions</h2>
<h3 id="database">database(tmp_path: Path) -&gt; DatabaseManager</h3>
<p>The function `database` is a generator that creates and manages a `DatabaseManager` instance for a specified temporary path. It constructs the database file path using the provided `tmp_path`, initializes the database manager, yields the initialized manager, and ensures the manager is closed after use. The function is designed to provide a context-managed database connection within a temporary directory.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">database</span>(tmp_path: Path) <span style="color: #666666">-&gt;</span> DatabaseManager:
    db_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;dataminer.db&quot;</span>
    manager <span style="color: #666666">=</span> DatabaseManager(db_path)
    manager<span style="color: #666666">.</span>initialize()
    <span style="color: #008000; font-weight: bold">yield</span> manager
    manager<span style="color: #666666">.</span>close()
</code></pre>
<h3 id="project_repo">project_repo(database: DatabaseManager) -&gt; ProjectRepository</h3>
<p>The function `project_repo` takes a `DatabaseManager` instance as input and returns a `ProjectRepository` object initialized with that database manager. It serves as a factory function for creating project repository instances tied to a specific database connection.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">project_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> ProjectRepository:
    <span style="color: #008000; font-weight: bold">return</span> ProjectRepository(database)
</code></pre>
<h3 id="document_repo">document_repo(database: DatabaseManager) -&gt; DocumentRepository</h3>
<p>The function `document_repo` creates and returns a `DocumentRepository` instance initialized with a provided `DatabaseManager` object. It serves as a factory function for generating document repository instances tied to a specific database interface.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">document_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> DocumentRepository:
    <span style="color: #008000; font-weight: bold">return</span> DocumentRepository(database)
</code></pre>
<h3 id="ingest_repo">ingest_repo(database: DatabaseManager) -&gt; IngestDocumentRepository</h3>
<p>The function `ingest_repo` creates and returns an instance of `IngestDocumentRepository`, initialized with a provided `DatabaseManager` object. This repository is responsible for managing document ingestion operations within the application&#x27;s database context.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">ingest_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> IngestDocumentRepository:
    <span style="color: #008000; font-weight: bold">return</span> IngestDocumentRepository(database)
</code></pre>
<h3 id="chat_repo">chat_repo(database: DatabaseManager) -&gt; ChatRepository</h3>
<p>The function `chat_repo` takes a `DatabaseManager` instance as input and returns a `ChatRepository` object initialized with that database manager. It serves as a factory function for creating chat repository instances tied to a specific database connection.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">chat_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> ChatRepository:
    <span style="color: #008000; font-weight: bold">return</span> ChatRepository(database)
</code></pre>
<h3 id="_store_ingest_document">_store_ingest_document(repo: IngestDocumentRepository, path: Path, text: str) -&gt; None</h3>
<p>Stores a parsed document version in the repository using the provided path and text content. The document is stored without checksum, size, mtime, or ctime metadata.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_store_ingest_document</span>(
    repo: IngestDocumentRepository,
    path: Path,
    text: <span style="color: #008000">str</span>,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    parsed <span style="color: #666666">=</span> ParsedDocument(text<span style="color: #666666">=</span>text, metadata<span style="color: #666666">=</span>{})
    repo<span style="color: #666666">.</span>store_version(
        path<span style="color: #666666">=</span><span style="color: #008000">str</span>(path),
        checksum<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        size<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        mtime<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        ctime<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        parsed<span style="color: #666666">=</span>parsed,
    )
</code></pre>
<h3 id="test_search_service_scope_and_highlight">test_search_service_scope_and_highlight(tmp_path: Path, project_repo: ProjectRepository, document_repo: DocumentRepository, ingest_repo: IngestDocumentRepository, chat_repo: ChatRepository) -&gt; None</h3>
<p>This function tests the search service&#x27;s ability to filter documents by scope and highlight search terms. It sets up a project with two tagged documents, ingests their content, and performs searches with specific tag and folder constraints. The test verifies that search results are correctly filtered by tags, highlights the searched term in the results, and maintains search scope across follow-up queries. It also checks that context snippets can be retrieved for specific documents.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_search_service_scope_and_highlight</span>(
    tmp_path: Path,
    project_repo: ProjectRepository,
    document_repo: DocumentRepository,
    ingest_repo: IngestDocumentRepository,
    chat_repo: ChatRepository,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    base <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;corpus&quot;</span>
    alpha_path <span style="color: #666666">=</span> base <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;alpha&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;spec.txt&quot;</span>
    beta_path <span style="color: #666666">=</span> base <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;beta&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;notes.txt&quot;</span>
    alpha_path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    beta_path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    alpha_path<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;Alpha specification includes the starlight keyword.&quot;</span>)
    beta_path<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;Beta notes mention starlight from another source.&quot;</span>)

    project <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Search Project&quot;</span>)
    doc_alpha <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Alpha&quot;</span>, source_path<span style="color: #666666">=</span>alpha_path)
    doc_beta <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Beta&quot;</span>, source_path<span style="color: #666666">=</span>beta_path)

    tag_focus <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create_tag(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;focus&quot;</span>)
    tag_other <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create_tag(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;other&quot;</span>)
    document_repo<span style="color: #666666">.</span>tag_document(doc_alpha[<span style="color: #BA2121">&quot;id&quot;</span>], tag_focus[<span style="color: #BA2121">&quot;id&quot;</span>])
    document_repo<span style="color: #666666">.</span>tag_document(doc_beta[<span style="color: #BA2121">&quot;id&quot;</span>], tag_other[<span style="color: #BA2121">&quot;id&quot;</span>])

    _store_ingest_document(ingest_repo, alpha_path, alpha_path<span style="color: #666666">.</span>read_text())
    _store_ingest_document(ingest_repo, beta_path, beta_path<span style="color: #666666">.</span>read_text())

    chat <span style="color: #666666">=</span> chat_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Analysis&quot;</span>)
    service <span style="color: #666666">=</span> SearchService(ingest_repo, document_repo, chat_repo)

    first_results <span style="color: #666666">=</span> service<span style="color: #666666">.</span>search_documents(
        <span style="color: #BA2121">&quot;starlight&quot;</span>,
        project_id<span style="color: #666666">=</span>project[<span style="color: #BA2121">&quot;id&quot;</span>],
        chat_id<span style="color: #666666">=</span>chat[<span style="color: #BA2121">&quot;id&quot;</span>],
        tags<span style="color: #666666">=</span>[tag_focus[<span style="color: #BA2121">&quot;id&quot;</span>]],
        save_scope<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>,
    )
    <span style="color: #008000; font-weight: bold">assert</span> [item[<span style="color: #BA2121">&quot;document&quot;</span>][<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> first_results] <span style="color: #666666">==</span> [doc_alpha[<span style="color: #BA2121">&quot;id&quot;</span>]]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;&lt;mark&gt;starlight&lt;/mark&gt;&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> first_results[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;highlight&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;starlight&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> first_results[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;context&quot;</span>]

    follow_up <span style="color: #666666">=</span> service<span style="color: #666666">.</span>search_documents(
        <span style="color: #BA2121">&quot;starlight&quot;</span>,
        project_id<span style="color: #666666">=</span>project[<span style="color: #BA2121">&quot;id&quot;</span>],
        chat_id<span style="color: #666666">=</span>chat[<span style="color: #BA2121">&quot;id&quot;</span>],
    )
    <span style="color: #008000; font-weight: bold">assert</span> [item[<span style="color: #BA2121">&quot;document&quot;</span>][<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> follow_up] <span style="color: #666666">==</span> [doc_alpha[<span style="color: #BA2121">&quot;id&quot;</span>]]

    beta_folder <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>get(doc_beta[<span style="color: #BA2121">&quot;id&quot;</span>])[<span style="color: #BA2121">&quot;folder_path&quot;</span>]
    updated_results <span style="color: #666666">=</span> service<span style="color: #666666">.</span>search_documents(
        <span style="color: #BA2121">&quot;starlight&quot;</span>,
        project_id<span style="color: #666666">=</span>project[<span style="color: #BA2121">&quot;id&quot;</span>],
        chat_id<span style="color: #666666">=</span>chat[<span style="color: #BA2121">&quot;id&quot;</span>],
        tags<span style="color: #666666">=</span>[tag_other[<span style="color: #BA2121">&quot;id&quot;</span>]],
        folder<span style="color: #666666">=</span>beta_folder,
        save_scope<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>,
    )
    <span style="color: #008000; font-weight: bold">assert</span> [item[<span style="color: #BA2121">&quot;document&quot;</span>][<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> updated_results] <span style="color: #666666">==</span> [doc_beta[<span style="color: #BA2121">&quot;id&quot;</span>]]

    contexts <span style="color: #666666">=</span> service<span style="color: #666666">.</span>retrieve_context_snippets(
        <span style="color: #BA2121">&quot;starlight&quot;</span>,
        project_id<span style="color: #666666">=</span>project[<span style="color: #BA2121">&quot;id&quot;</span>],
        include_identifiers<span style="color: #666666">=</span>[<span style="color: #008000">str</span>(doc_alpha[<span style="color: #BA2121">&quot;id&quot;</span>])],
    )
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">any</span>(<span style="color: #BA2121">&quot;starlight&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> snippet <span style="color: #008000; font-weight: bold">for</span> snippet <span style="color: #AA22FF; font-weight: bold">in</span> contexts)
</code></pre>
<h3 id="test_context_snippets_relax_query_terms">test_context_snippets_relax_query_terms(tmp_path: Path, project_repo: ProjectRepository, document_repo: DocumentRepository, ingest_repo: IngestDocumentRepository, chat_repo: ChatRepository) -&gt; None</h3>
<p>The function `test_context_snippets_relax_query_terms` tests the ability of the `SearchService` to retrieve relevant context snippets when querying with relaxed terms. It sets up a temporary project and document containing content about &quot;DataMiner Architecture&quot;, then uses the search service to find snippets related to the query &quot;What does the DataMiner system include for its architecture?&quot;. The test verifies that at least one of the retrieved snippets contains the term &quot;DataMiner&quot;.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_context_snippets_relax_query_terms</span>(
    tmp_path: Path,
    project_repo: ProjectRepository,
    document_repo: DocumentRepository,
    ingest_repo: IngestDocumentRepository,
    chat_repo: ChatRepository,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    corpus_dir <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;docs&quot;</span>
    doc_path <span style="color: #666666">=</span> corpus_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;design.md&quot;</span>
    doc_path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    content <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">    # DataMiner Architecture</span>

<span style="color: #BA2121">    The DataMiner system includes a retrieval pipeline with ranking heuristics.</span>
<span style="color: #BA2121">    &quot;&quot;&quot;</span>
    doc_path<span style="color: #666666">.</span>write_text(content)

    project <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Relaxed Query&quot;</span>)
    document_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Design&quot;</span>, source_path<span style="color: #666666">=</span>doc_path)
    _store_ingest_document(ingest_repo, doc_path, content)

    service <span style="color: #666666">=</span> SearchService(ingest_repo, document_repo, chat_repo)

    question <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;What does the DataMiner system include for its architecture?&quot;</span>
    snippets <span style="color: #666666">=</span> service<span style="color: #666666">.</span>retrieve_context_snippets(question, project_id<span style="color: #666666">=</span>project[<span style="color: #BA2121">&quot;id&quot;</span>])

    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">any</span>(<span style="color: #BA2121">&quot;DataMiner&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> snippet <span style="color: #008000; font-weight: bold">for</span> snippet <span style="color: #AA22FF; font-weight: bold">in</span> snippets)
</code></pre>
<h3 id="test_collect_context_records_includes_metadata">test_collect_context_records_includes_metadata(tmp_path: Path, project_repo: ProjectRepository, document_repo: DocumentRepository, ingest_repo: IngestDocumentRepository, chat_repo: ChatRepository) -&gt; None</h3>
<p>The function `test_collect_context_records_includes_metadata` tests the `collect_context_records` method of the `SearchService` class. It verifies that when searching for a term within a document, the resulting context records include expected metadata. The test creates a temporary project and document, stores an ingest document, and then calls `collect_context_records` with a search query. It asserts that the returned records are not empty, that the first record contains the correct document ID, that the context includes the search term, and that the chunk ID is present.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_collect_context_records_includes_metadata</span>(
    tmp_path: Path,
    project_repo: ProjectRepository,
    document_repo: DocumentRepository,
    ingest_repo: IngestDocumentRepository,
    chat_repo: ChatRepository,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    base <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;corpus&quot;</span>
    doc_path <span style="color: #666666">=</span> base <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;report.txt&quot;</span>
    doc_path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    doc_path<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;The quarterly report covers revenue and expenses in detail.&quot;</span>)

    project <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Metadata Project&quot;</span>)
    document <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Report&quot;</span>, source_path<span style="color: #666666">=</span>doc_path)
    _store_ingest_document(ingest_repo, doc_path, doc_path<span style="color: #666666">.</span>read_text())

    service <span style="color: #666666">=</span> SearchService(ingest_repo, document_repo, chat_repo)

    records <span style="color: #666666">=</span> service<span style="color: #666666">.</span>collect_context_records(<span style="color: #BA2121">&quot;revenue&quot;</span>, project_id<span style="color: #666666">=</span>project[<span style="color: #BA2121">&quot;id&quot;</span>])

    <span style="color: #008000; font-weight: bold">assert</span> records
    first <span style="color: #666666">=</span> records[<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> first[<span style="color: #BA2121">&quot;document&quot;</span>][<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #666666">==</span> document[<span style="color: #BA2121">&quot;id&quot;</span>]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;context&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> first <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #BA2121">&quot;revenue&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> first[<span style="color: #BA2121">&quot;context&quot;</span>]<span style="color: #666666">.</span>lower()
    <span style="color: #008000; font-weight: bold">assert</span> first[<span style="color: #BA2121">&quot;chunk&quot;</span>][<span style="color: #BA2121">&quot;id&quot;</span>]
</code></pre>
<h3 id="test_document_hierarchy_service">test_document_hierarchy_service(tmp_path: Path, project_repo: ProjectRepository, document_repo: DocumentRepository) -&gt; None</h3>
<p>The function `test_document_hierarchy_service` tests the functionality of the `DocumentHierarchyService` class by creating a hierarchical file structure and associating documents with tags. It verifies that the service correctly builds a folder tree, assigns documents to their respective folders, and retrieves document views with associated tags. The test ensures proper handling of nested directories, document tagging, and scoped document listing based on tags. The function uses temporary paths and repositories to simulate a project environment and validate the behavior of the document hierarchy service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_document_hierarchy_service</span>(
    tmp_path: Path,
    project_repo: ProjectRepository,
    document_repo: DocumentRepository,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    base <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;hier&quot;</span>
    first <span style="color: #666666">=</span> base <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;alpha&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;doc1.txt&quot;</span>
    second <span style="color: #666666">=</span> base <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;alpha&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;deep&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;doc2.txt&quot;</span>
    third <span style="color: #666666">=</span> base <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;beta&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;doc3.txt&quot;</span>
    third<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    second<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    first<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    first<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;one&quot;</span>)
    second<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;two&quot;</span>)
    third<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;three&quot;</span>)

    project <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Hierarchy&quot;</span>)
    doc_one <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;One&quot;</span>, source_path<span style="color: #666666">=</span>first)
    doc_two <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Two&quot;</span>, source_path<span style="color: #666666">=</span>second)
    doc_three <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Three&quot;</span>, source_path<span style="color: #666666">=</span>third)

    tag_deep <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create_tag(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;deep&quot;</span>)
    document_repo<span style="color: #666666">.</span>tag_document(doc_two[<span style="color: #BA2121">&quot;id&quot;</span>], tag_deep[<span style="color: #BA2121">&quot;id&quot;</span>])

    hierarchy <span style="color: #666666">=</span> DocumentHierarchyService(document_repo)
    tree <span style="color: #666666">=</span> hierarchy<span style="color: #666666">.</span>build_folder_tree(project[<span style="color: #BA2121">&quot;id&quot;</span>])
    top_level <span style="color: #666666">=</span> [child[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> child <span style="color: #AA22FF; font-weight: bold">in</span> tree[<span style="color: #BA2121">&quot;children&quot;</span>]]
    <span style="color: #008000; font-weight: bold">assert</span> top_level <span style="color: #666666">==</span> <span style="color: #008000">sorted</span>(top_level)
    <span style="color: #008000; font-weight: bold">assert</span> {child[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> child <span style="color: #AA22FF; font-weight: bold">in</span> tree[<span style="color: #BA2121">&quot;children&quot;</span>]} <span style="color: #666666">==</span> {<span style="color: #BA2121">&quot;alpha&quot;</span>, <span style="color: #BA2121">&quot;beta&quot;</span>}

    alpha_node <span style="color: #666666">=</span> <span style="color: #008000">next</span>(child <span style="color: #008000; font-weight: bold">for</span> child <span style="color: #AA22FF; font-weight: bold">in</span> tree[<span style="color: #BA2121">&quot;children&quot;</span>] <span style="color: #008000; font-weight: bold">if</span> child[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;alpha&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> {doc[<span style="color: #BA2121">&quot;title&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> alpha_node[<span style="color: #BA2121">&quot;documents&quot;</span>]} <span style="color: #666666">==</span> {<span style="color: #BA2121">&quot;One&quot;</span>}

    deep_node <span style="color: #666666">=</span> <span style="color: #008000">next</span>(child <span style="color: #008000; font-weight: bold">for</span> child <span style="color: #AA22FF; font-weight: bold">in</span> alpha_node[<span style="color: #BA2121">&quot;children&quot;</span>] <span style="color: #008000; font-weight: bold">if</span> child[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;deep&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> {doc[<span style="color: #BA2121">&quot;title&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> deep_node[<span style="color: #BA2121">&quot;documents&quot;</span>]} <span style="color: #666666">==</span> {<span style="color: #BA2121">&quot;Two&quot;</span>}

    beta_node <span style="color: #666666">=</span> <span style="color: #008000">next</span>(child <span style="color: #008000; font-weight: bold">for</span> child <span style="color: #AA22FF; font-weight: bold">in</span> tree[<span style="color: #BA2121">&quot;children&quot;</span>] <span style="color: #008000; font-weight: bold">if</span> child[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;beta&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> {doc[<span style="color: #BA2121">&quot;title&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> beta_node[<span style="color: #BA2121">&quot;documents&quot;</span>]} <span style="color: #666666">==</span> {<span style="color: #BA2121">&quot;Three&quot;</span>}

    view <span style="color: #666666">=</span> hierarchy<span style="color: #666666">.</span>get_document_view(doc_two[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> view <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> {tag[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> tag <span style="color: #AA22FF; font-weight: bold">in</span> view[<span style="color: #BA2121">&quot;tags&quot;</span>]} <span style="color: #666666">==</span> {<span style="color: #BA2121">&quot;deep&quot;</span>}

    scoped <span style="color: #666666">=</span> hierarchy<span style="color: #666666">.</span>list_documents_for_scope(project[<span style="color: #BA2121">&quot;id&quot;</span>], tags<span style="color: #666666">=</span>[tag_deep[<span style="color: #BA2121">&quot;id&quot;</span>]])
    <span style="color: #008000; font-weight: bold">assert</span> [doc[<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> scoped] <span style="color: #666666">==</span> [doc_two[<span style="color: #BA2121">&quot;id&quot;</span>]]
    <span style="color: #008000; font-weight: bold">assert</span> scoped[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;tags&quot;</span>][<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;deep&quot;</span>
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
