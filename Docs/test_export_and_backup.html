<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_export_and_backup</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_export_and_backup</h1>
        <p>Module defines test functions for export, project lifecycle, and backup services. Tests verify export functionality includes reasoning and citations in markdown and HTML formats. Tests cover project creation, setting, loading, and deletion with conversation settings. Tests validate backup and restore operations preserve audit trail and cached data. Uses mocked environment and temporary paths for isolation.</p>
<h2>Functions</h2>
<h3 id="build_project_service">build_project_service(tmp_path: Path) -&gt; ProjectService</h3>
<p>Creates and returns a `ProjectService` instance configured with a specified temporary storage path and a configuration manager initialized for the &quot;DataMinerTest&quot; application with a &quot;projects.json&quot; filename. The service is set up to manage project-related data within the provided temporary directory structure.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">build_project_service</span>(tmp_path: Path) <span style="color: #666666">-&gt;</span> ProjectService:
    config <span style="color: #666666">=</span> ConfigManager(app_name<span style="color: #666666">=</span><span style="color: #BA2121">&quot;DataMinerTest&quot;</span>, filename<span style="color: #666666">=</span><span style="color: #BA2121">&quot;projects.json&quot;</span>)
    service <span style="color: #666666">=</span> ProjectService(storage_root<span style="color: #666666">=</span>tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;storage&quot;</span>, config_manager<span style="color: #666666">=</span>config)
    <span style="color: #008000; font-weight: bold">return</span> service
</code></pre>
<h3 id="test_export_service_includes_reasoning_and_citations">test_export_service_includes_reasoning_and_citations() -&gt; None</h3>
<p>The function `test_export_service_includes_reasoning_and_citations` tests the export functionality of the `ExportService` class. It creates a `ReasoningArtifacts` object containing structured reasoning data such as summary bullets, plan items, assumptions, and self-check results. A `ConversationTurn` is then constructed with a question, answer, citations, and the reasoning artifacts. The test verifies that the `conversation_to_markdown` method correctly includes reasoning and citation information in the output, checking for the presence of specific strings like &quot;Reasoning&quot;, &quot;Doc A&quot;, &quot;Plan&quot;, and &quot;Token Usage&quot;. Similarly, it checks that the `conversation_to_html` method generates HTML with expected elements such as &quot;Turn 1&quot;, &quot;Doc A&quot;, &quot;Reasoning&quot;, and &quot;Self-check&quot;. The test ensures that both markdown and HTML export formats properly incorporate reasoning artifacts and citations.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_export_service_includes_reasoning_and_citations</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    export <span style="color: #666666">=</span> ExportService()
    artifacts <span style="color: #666666">=</span> ReasoningArtifacts(
        summary_bullets<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;Reviewed primary source&quot;</span>],
        plan_items<span style="color: #666666">=</span>[PlanItem(description<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Check tables&quot;</span>, status<span style="color: #666666">=</span><span style="color: #BA2121">&quot;complete&quot;</span>)],
        assumptions<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;Assumed latest revision&quot;</span>],
        assumption_decision<span style="color: #666666">=</span>AssumptionDecision(
            mode<span style="color: #666666">=</span><span style="color: #BA2121">&quot;assume&quot;</span>, rationale<span style="color: #666666">=</span><span style="color: #BA2121">&quot;No conflicting versions&quot;</span>
        ),
        self_check<span style="color: #666666">=</span>SelfCheckResult(passed<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, flags<span style="color: #666666">=</span>[<span style="color: #BA2121">&quot;Verified citations&quot;</span>], notes<span style="color: #666666">=</span><span style="color: #BA2121">&quot;All good&quot;</span>),
    )
    turn <span style="color: #666666">=</span> ConversationTurn(
        question<span style="color: #666666">=</span><span style="color: #BA2121">&quot;What is the outcome?&quot;</span>,
        answer<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Outcome is 42 [1].&quot;</span>,
        citations<span style="color: #666666">=</span>[{<span style="color: #BA2121">&quot;source&quot;</span>: <span style="color: #BA2121">&quot;Doc A&quot;</span>, <span style="color: #BA2121">&quot;snippet&quot;</span>: <span style="color: #BA2121">&quot;&lt;mark&gt;42&lt;/mark&gt; is the result&quot;</span>, <span style="color: #BA2121">&quot;page&quot;</span>: <span style="color: #666666">3</span>}],
        reasoning_artifacts<span style="color: #666666">=</span>artifacts,
        asked_at<span style="color: #666666">=</span>datetime(<span style="color: #666666">2024</span>, <span style="color: #666666">1</span>, <span style="color: #666666">1</span>, <span style="color: #666666">12</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>),
        answered_at<span style="color: #666666">=</span>datetime(<span style="color: #666666">2024</span>, <span style="color: #666666">1</span>, <span style="color: #666666">1</span>, <span style="color: #666666">12</span>, <span style="color: #666666">0</span>, <span style="color: #666666">5</span>),
        latency_ms<span style="color: #666666">=5000</span>,
        token_usage<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;prompt_tokens&quot;</span>: <span style="color: #666666">10</span>, <span style="color: #BA2121">&quot;completion_tokens&quot;</span>: <span style="color: #666666">15</span>},
    )

    markdown <span style="color: #666666">=</span> export<span style="color: #666666">.</span>conversation_to_markdown([turn], metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;Project&quot;</span>: <span style="color: #BA2121">&quot;Demo&quot;</span>})
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Reasoning&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> markdown
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Doc A&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> markdown
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Plan&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> markdown
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Token Usage&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> markdown

    html <span style="color: #666666">=</span> export<span style="color: #666666">.</span>conversation_to_html([turn], metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;Project&quot;</span>: <span style="color: #BA2121">&quot;Demo&quot;</span>})
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;&lt;h2&gt;Turn 1&lt;/h2&gt;&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> html
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Doc A&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> html
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Reasoning&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> html
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Self-check&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> html
</code></pre>
<h3 id="test_project_service_lifecycle_and_settings">test_project_service_lifecycle_and_settings(tmp_path: Path, monkeypatch: pytest.MonkeyPatch) -&gt; None</h3>
<p>The function `test_project_service_lifecycle_and_settings` tests the lifecycle and settings management of a project service. It verifies creating, activating, and deleting projects, as well as saving and loading conversation settings for each project. The test ensures that settings are correctly associated with specific projects, checks the existence of project storage paths, and confirms that deleted projects are removed from the project list. The test uses a temporary path for configuration and cleans up by shutting down the service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_project_service_lifecycle_and_settings</span>(tmp_path: Path, monkeypatch: pytest<span style="color: #666666">.</span>MonkeyPatch) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    monkeypatch<span style="color: #666666">.</span>setenv(<span style="color: #BA2121">&quot;XDG_CONFIG_HOME&quot;</span>, <span style="color: #008000">str</span>(tmp_path))
    service <span style="color: #666666">=</span> build_project_service(tmp_path)
    <span style="color: #008000; font-weight: bold">try</span>:
        default_project <span style="color: #666666">=</span> service<span style="color: #666666">.</span>active_project()
        service<span style="color: #666666">.</span>save_conversation_settings(
            default_project<span style="color: #666666">.</span>id,
            {<span style="color: #BA2121">&quot;show_plan&quot;</span>: <span style="color: #008000; font-weight: bold">False</span>, <span style="color: #BA2121">&quot;answer_length&quot;</span>: <span style="color: #BA2121">&quot;brief&quot;</span>, <span style="color: #BA2121">&quot;model&quot;</span>: <span style="color: #BA2121">&quot;test-small&quot;</span>},
        )

        created <span style="color: #666666">=</span> service<span style="color: #666666">.</span>create_project(<span style="color: #BA2121">&quot;Analysis&quot;</span>, activate<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        service<span style="color: #666666">.</span>save_conversation_settings(
            created<span style="color: #666666">.</span>id,
            {
                <span style="color: #BA2121">&quot;show_plan&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
                <span style="color: #BA2121">&quot;sources_only&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
                <span style="color: #BA2121">&quot;answer_length&quot;</span>: <span style="color: #BA2121">&quot;detailed&quot;</span>,
                <span style="color: #BA2121">&quot;model&quot;</span>: <span style="color: #BA2121">&quot;analysis-large&quot;</span>,
            },
        )

        analysis_root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;analysis_corpus&quot;</span>
        analysis_root<span style="color: #666666">.</span>mkdir()
        service<span style="color: #666666">.</span>add_corpus_root(created<span style="color: #666666">.</span>id, analysis_root)

        service<span style="color: #666666">.</span>set_active_project(default_project<span style="color: #666666">.</span>id)
        original_settings <span style="color: #666666">=</span> service<span style="color: #666666">.</span>load_conversation_settings(default_project<span style="color: #666666">.</span>id)
        <span style="color: #008000; font-weight: bold">assert</span> original_settings<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;show_plan&quot;</span>) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">assert</span> original_settings<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;answer_length&quot;</span>) <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;brief&quot;</span>
        <span style="color: #008000; font-weight: bold">assert</span> original_settings<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;model&quot;</span>) <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;test-small&quot;</span>

        service<span style="color: #666666">.</span>set_active_project(created<span style="color: #666666">.</span>id)
        created_settings <span style="color: #666666">=</span> service<span style="color: #666666">.</span>load_conversation_settings(created<span style="color: #666666">.</span>id)
        <span style="color: #008000; font-weight: bold">assert</span> created_settings<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;show_plan&quot;</span>) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">assert</span> created_settings<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;sources_only&quot;</span>) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">assert</span> created_settings<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;answer_length&quot;</span>) <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;detailed&quot;</span>
        <span style="color: #008000; font-weight: bold">assert</span> created_settings<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;model&quot;</span>) <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;analysis-large&quot;</span>

        storage_path <span style="color: #666666">=</span> service<span style="color: #666666">.</span>get_project_storage(created<span style="color: #666666">.</span>id)
        <span style="color: #008000; font-weight: bold">assert</span> storage_path<span style="color: #666666">.</span>exists()

        service<span style="color: #666666">.</span>set_active_project(default_project<span style="color: #666666">.</span>id)
        service<span style="color: #666666">.</span>delete_project(created<span style="color: #666666">.</span>id)
        remaining_ids <span style="color: #666666">=</span> {record<span style="color: #666666">.</span>id <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> service<span style="color: #666666">.</span>list_projects()}
        <span style="color: #008000; font-weight: bold">assert</span> created<span style="color: #666666">.</span>id <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> remaining_ids
    <span style="color: #008000; font-weight: bold">finally</span>:
        service<span style="color: #666666">.</span>shutdown()
</code></pre>
<h3 id="test_backup_restore_persists_audit_trail">test_backup_restore_persists_audit_trail(tmp_path: Path, monkeypatch: pytest.MonkeyPatch) -&gt; None</h3>
<p>The function `test_backup_restore_persists_audit_trail` tests that a backup and restore operation preserves the audit trail of background tasks and cached data. It sets up a temporary project environment, creates a background task log and cached data, generates a backup, simulates deletion of the log and storage directory, restores from the backup, and verifies that the task log status is preserved and the cached data is restored. The test ensures data integrity during backup and restore processes for project-related tasks and cache files.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_backup_restore_persists_audit_trail</span>(
    tmp_path: Path, monkeypatch: pytest<span style="color: #666666">.</span>MonkeyPatch
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    monkeypatch<span style="color: #666666">.</span>setenv(<span style="color: #BA2121">&quot;XDG_CONFIG_HOME&quot;</span>, <span style="color: #008000">str</span>(tmp_path))
    service <span style="color: #666666">=</span> build_project_service(tmp_path)
    backup <span style="color: #666666">=</span> BackupService(service)
    <span style="color: #008000; font-weight: bold">try</span>:
        project <span style="color: #666666">=</span> service<span style="color: #666666">.</span>active_project()
        corpus_root <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;default_corpus&quot;</span>
        corpus_root<span style="color: #666666">.</span>mkdir()
        service<span style="color: #666666">.</span>add_corpus_root(project<span style="color: #666666">.</span>id, corpus_root)
        log <span style="color: #666666">=</span> service<span style="color: #666666">.</span>background_tasks<span style="color: #666666">.</span>create(
            <span style="color: #BA2121">&quot;ingest&quot;</span>, status<span style="color: #666666">=</span><span style="color: #BA2121">&quot;running&quot;</span>, message<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Started&quot;</span>
        )
        storage_dir <span style="color: #666666">=</span> service<span style="color: #666666">.</span>get_project_storage(project<span style="color: #666666">.</span>id)
        cache_file <span style="color: #666666">=</span> storage_dir <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;cache&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;data.txt&quot;</span>
        cache_file<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        cache_file<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;cached&quot;</span>, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)

        archive <span style="color: #666666">=</span> backup<span style="color: #666666">.</span>create_backup(tmp_path)

        <span style="color: #008000; font-weight: bold">with</span> service<span style="color: #666666">.</span>database_manager<span style="color: #666666">.</span>transaction() <span style="color: #008000; font-weight: bold">as</span> connection:
            connection<span style="color: #666666">.</span>execute(<span style="color: #BA2121">&quot;DELETE FROM background_task_logs&quot;</span>)
        shutil<span style="color: #666666">.</span>rmtree(storage_dir)

        backup<span style="color: #666666">.</span>restore_backup(archive)

        restored <span style="color: #666666">=</span> service<span style="color: #666666">.</span>background_tasks<span style="color: #666666">.</span>get(log[<span style="color: #BA2121">&quot;id&quot;</span>])
        <span style="color: #008000; font-weight: bold">assert</span> restored <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">assert</span> restored[<span style="color: #BA2121">&quot;status&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;running&quot;</span>
        <span style="color: #008000; font-weight: bold">assert</span> (service<span style="color: #666666">.</span>get_project_storage(project<span style="color: #666666">.</span>id) <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;cache&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;data.txt&quot;</span>)<span style="color: #666666">.</span>exists()
    <span style="color: #008000; font-weight: bold">finally</span>:
        service<span style="color: #666666">.</span>shutdown()
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
