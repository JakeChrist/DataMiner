<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>export_service</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>export_service</h1>
        <p>The module defines an `ExportService` class for rendering conversation history and snippets into export-friendly formats. It supports exporting conversations to Markdown and HTML, and snippets to plain text. The service includes methods for generating formatted output in these formats, handling metadata, citations, reasoning steps, and token usage information. It also provides functionality to write the generated content to files. Helper methods manage formatting of individual conversation turns and citation text, as well as stripping HTML tags from content.</p>
<h2 id="ExportService">Class: ExportService</h2>
<p>The `ExportService` class provides methods to convert conversation turns and snippets into markdown, HTML, and plain text formats. It includes functionality for rendering individual conversation turns with metadata, citations, reasoning steps, and token usage in both markdown and HTML. The class also supports exporting these formatted outputs to files.</p>
<h3 id="conversation_to_markdown">Method: conversation_to_markdown(self, turns: Sequence[ConversationTurn] | Iterable[ConversationTurn], *, title: str=&#x27;Conversation Export&#x27;, metadata: dict | None=None) -&gt; str</h3>
<p>The function `conversation_to_markdown` converts a sequence of conversation turns into a markdown-formatted string. It accepts conversation turns, an optional title, and optional metadata. The output includes a header with the title, a timestamp indicating when the export was generated, and formatted metadata if provided. Each conversation turn is processed using a helper method `_turn_to_markdown`, which generates markdown content for individual turns. The final result is a properly formatted markdown document representing the conversation, including all turns and metadata, with appropriate line breaks and formatting.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">conversation_to_markdown</span>(
        <span style="color: #008000">self</span>,
        turns: Sequence[ConversationTurn] <span style="color: #666666">|</span> Iterable[ConversationTurn],
        <span style="color: #666666">*</span>,
        title: <span style="color: #008000">str</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Conversation Export&quot;</span>,
        metadata: <span style="color: #008000">dict</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        entries <span style="color: #666666">=</span> <span style="color: #008000">list</span>(turns)
        lines: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;# </span><span style="color: #A45A77; font-weight: bold">{</span>title<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>]
        timestamp <span style="color: #666666">=</span> _dt<span style="color: #666666">.</span>datetime<span style="color: #666666">.</span>now(_dt<span style="color: #666666">.</span>UTC)<span style="color: #666666">.</span>strftime(<span style="color: #BA2121">&quot;%Y-%m-</span><span style="color: #A45A77; font-weight: bold">%d</span><span style="color: #BA2121"> %H:%M:%SZ&quot;</span>)
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;_Generated: </span><span style="color: #A45A77; font-weight: bold">{</span>timestamp<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">_&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> metadata:
            lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;&quot;</span>)
            <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> metadata<span style="color: #666666">.</span>items():
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;* **</span><span style="color: #A45A77; font-weight: bold">{</span>key<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">**: </span><span style="color: #A45A77; font-weight: bold">{</span>value<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> index, turn <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(entries, start<span style="color: #666666">=1</span>):
            lines<span style="color: #666666">.</span>extend(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turn_to_markdown(turn, index))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(lines)<span style="color: #666666">.</span>strip() <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
</code></pre>
<h3 id="conversation_to_html">Method: conversation_to_html(self, turns: Sequence[ConversationTurn] | Iterable[ConversationTurn], *, title: str=&#x27;Conversation Export&#x27;, metadata: dict | None=None) -&gt; str</h3>
<p>The function `conversation_to_html` converts a sequence of conversation turns into an HTML document. It accepts conversation turns, an optional title, and optional metadata, and returns a formatted HTML string. The output includes a header with styling, a timestamp, optional metadata in a list format, and each conversation turn processed by `_turn_to_html`. The resulting HTML is structured with appropriate semantic elements and CSS styles for rendering the conversation in a readable format.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">conversation_to_html</span>(
        <span style="color: #008000">self</span>,
        turns: Sequence[ConversationTurn] <span style="color: #666666">|</span> Iterable[ConversationTurn],
        <span style="color: #666666">*</span>,
        title: <span style="color: #008000">str</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Conversation Export&quot;</span>,
        metadata: <span style="color: #008000">dict</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        entries <span style="color: #666666">=</span> <span style="color: #008000">list</span>(turns)
        timestamp <span style="color: #666666">=</span> _dt<span style="color: #666666">.</span>datetime<span style="color: #666666">.</span>now(_dt<span style="color: #666666">.</span>UTC)<span style="color: #666666">.</span>strftime(<span style="color: #BA2121">&quot;%Y-%m-</span><span style="color: #A45A77; font-weight: bold">%d</span><span style="color: #BA2121"> %H:%M:%SZ&quot;</span>)
        head <span style="color: #666666">=</span> textwrap<span style="color: #666666">.</span>dedent(
            <span style="color: #BA2121">f&quot;&quot;&quot;</span>
<span style="color: #BA2121">            &lt;!DOCTYPE html&gt;</span>
<span style="color: #BA2121">            &lt;html lang=</span><span style="color: #AA5D1F; font-weight: bold">\&quot;</span><span style="color: #BA2121">en</span><span style="color: #AA5D1F; font-weight: bold">\&quot;</span><span style="color: #BA2121">&gt;</span>
<span style="color: #BA2121">              &lt;head&gt;</span>
<span style="color: #BA2121">                &lt;meta charset=</span><span style="color: #AA5D1F; font-weight: bold">\&quot;</span><span style="color: #BA2121">utf-8</span><span style="color: #AA5D1F; font-weight: bold">\&quot;</span><span style="color: #BA2121"> /&gt;</span>
<span style="color: #BA2121">                &lt;title&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(title)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/title&gt;</span>
<span style="color: #BA2121">                &lt;style&gt;</span>
<span style="color: #BA2121">                  body </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> font-family: Arial, sans-serif; margin: 1.5em; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                  h1 </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> border-bottom: 1px solid #999; padding-bottom: 0.3em; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                  h2 </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> margin-top: 1.4em; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                  .meta </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> color: #555; margin-bottom: 1em; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                  .section </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> margin-top: 0.8em; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                  .section h3 </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> margin-bottom: 0.3em; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                  .citations li </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> margin-bottom: 0.2em; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                  pre </span><span style="color: #AA5D1F; font-weight: bold">{{</span><span style="color: #BA2121"> background: #f6f6f6; padding: 0.6em; overflow-x: auto; </span><span style="color: #AA5D1F; font-weight: bold">}}</span>
<span style="color: #BA2121">                &lt;/style&gt;</span>
<span style="color: #BA2121">              &lt;/head&gt;</span>
<span style="color: #BA2121">              &lt;body&gt;</span>
<span style="color: #BA2121">            &quot;&quot;&quot;</span>
        )<span style="color: #666666">.</span>strip(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>)
        parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> [head, <span style="color: #BA2121">f&quot;&lt;h1&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(title)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/h1&gt;&quot;</span>]
        parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;div class=&#39;meta&#39;&gt;&lt;strong&gt;Generated:&lt;/strong&gt; </span><span style="color: #A45A77; font-weight: bold">{</span>timestamp<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/div&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> metadata:
            items <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(
                <span style="color: #BA2121">f&quot;&lt;li&gt;&lt;strong&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(<span style="color: #008000">str</span>(key))<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:&lt;/strong&gt; </span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(<span style="color: #008000">str</span>(value))<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/li&gt;&quot;</span>
                <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> metadata<span style="color: #666666">.</span>items()
            )
            parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;ul class=&#39;meta&#39;&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>items<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/ul&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">for</span> index, turn <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(entries, start<span style="color: #666666">=1</span>):
            parts<span style="color: #666666">.</span>append(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turn_to_html(turn, index))
        parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;  &lt;/body&gt;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&lt;/html&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(parts)
</code></pre>
<h3 id="snippets_to_text">Method: snippets_to_text(self, snippets: Iterable[dict | str]) -&gt; str</h3>
<p>The function `snippets_to_text` converts an iterable of snippet dictionaries or strings into a formatted text string. For each snippet:


Each processed snippet is stripped of leading/trailing whitespace and joined with double newlines. Empty lines are filtered out before joining. The result is a single text string containing all formatted snippets separated by double newlines.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">snippets_to_text</span>(<span style="color: #008000">self</span>, snippets: Iterable[<span style="color: #008000">dict</span> <span style="color: #666666">|</span> <span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        lines: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> snippet <span style="color: #AA22FF; font-weight: bold">in</span> snippets:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(snippet, <span style="color: #008000">str</span>):
                text <span style="color: #666666">=</span> snippet
            <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(snippet, <span style="color: #008000">dict</span>):
                label <span style="color: #666666">=</span> snippet<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;label&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> snippet<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Snippet&quot;</span>
                content <span style="color: #666666">=</span> snippet<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;snippet_html&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> snippet<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;snippet&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
                text <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>label<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_strip_html(content)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
                metadata <span style="color: #666666">=</span> snippet<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;metadata_text&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> snippet<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;metadata&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> metadata:
                    text <span style="color: #666666">+=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>metadata<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                text <span style="color: #666666">=</span> <span style="color: #008000">str</span>(snippet)
            lines<span style="color: #666666">.</span>append(text<span style="color: #666666">.</span>strip())
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(line <span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> lines <span style="color: #008000; font-weight: bold">if</span> line)
</code></pre>
<h3 id="write_text">Method: write_text(self, destination: str | Path, content: str) -&gt; Path</h3>
<p>The function `write_text` writes the provided string content to a file at the specified destination path. It ensures the parent directory of the destination exists by creating it if necessary. The function returns the `Path` object representing the written file.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">write_text</span>(<span style="color: #008000">self</span>, destination: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path, content: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> Path:
        path <span style="color: #666666">=</span> Path(destination)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>exists():
            path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        path<span style="color: #666666">.</span>write_text(content, encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> path
</code></pre>
<h3 id="export_conversation_markdown">Method: export_conversation_markdown(self, destination: str | Path, turns: Sequence[ConversationTurn] | Iterable[ConversationTurn], *, title: str=&#x27;Conversation Export&#x27;, metadata: dict | None=None) -&gt; Path</h3>
<p>Exports a conversation to a Markdown file at the specified destination.

Parameters:

Returns:

The function converts the conversation turns into a Markdown formatted string using `conversation_to_markdown`, then writes this content to the specified destination using `write_text`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">export_conversation_markdown</span>(
        <span style="color: #008000">self</span>,
        destination: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path,
        turns: Sequence[ConversationTurn] <span style="color: #666666">|</span> Iterable[ConversationTurn],
        <span style="color: #666666">*</span>,
        title: <span style="color: #008000">str</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Conversation Export&quot;</span>,
        metadata: <span style="color: #008000">dict</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> Path:
        content <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_to_markdown(turns, title<span style="color: #666666">=</span>title, metadata<span style="color: #666666">=</span>metadata)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>write_text(destination, content)
</code></pre>
<h3 id="export_conversation_html">Method: export_conversation_html(self, destination: str | Path, turns: Sequence[ConversationTurn] | Iterable[ConversationTurn], *, title: str=&#x27;Conversation Export&#x27;, metadata: dict | None=None) -&gt; Path</h3>
<p>Exports a conversation to an HTML file.

Parameters:

Returns:</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">export_conversation_html</span>(
        <span style="color: #008000">self</span>,
        destination: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path,
        turns: Sequence[ConversationTurn] <span style="color: #666666">|</span> Iterable[ConversationTurn],
        <span style="color: #666666">*</span>,
        title: <span style="color: #008000">str</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Conversation Export&quot;</span>,
        metadata: <span style="color: #008000">dict</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> Path:
        content <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_to_html(turns, title<span style="color: #666666">=</span>title, metadata<span style="color: #666666">=</span>metadata)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>write_text(destination, content)
</code></pre>
<h3 id="export_snippets_text">Method: export_snippets_text(self, destination: str | Path, snippets: Iterable[dict | str]) -&gt; Path</h3>
<p>The function `export_snippets_text` exports a collection of snippets to a text file. It takes a destination path and an iterable of snippets, converts the snippets into text format using the `snippets_to_text` method, and writes the resulting content to the specified destination using the `write_text` method. The function returns the path of the written file.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">export_snippets_text</span>(
        <span style="color: #008000">self</span>, destination: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path, snippets: Iterable[<span style="color: #008000">dict</span> <span style="color: #666666">|</span> <span style="color: #008000">str</span>]
    ) <span style="color: #666666">-&gt;</span> Path:
        content <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>snippets_to_text(snippets)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>write_text(destination, content)
</code></pre>
<h3 id="_turn_to_markdown">Method: _turn_to_markdown(self, turn: ConversationTurn, index: int) -&gt; list[str]</h3>
<p>The function `_turn_to_markdown` converts a `ConversationTurn` object into a list of markdown-formatted strings. It includes details such as the turn index, question, answer, timestamps (asked and answered), latency, citations, reasoning, and token usage. The answer is indented with blockquote syntax, and citations are listed numerically. If no citations are present, it indicates &quot;No citations available.&quot; Reasoning content is appended if available, followed by formatted token usage data. Each line of the resulting markdown content is included as a separate string in the returned list.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_turn_to_markdown</span>(<span style="color: #008000">self</span>, turn: ConversationTurn, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        asked <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>asked_at<span style="color: #666666">.</span>isoformat() <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>asked_at <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>
        answered <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>answered_at<span style="color: #666666">.</span>isoformat() <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>answered_at <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>
        latency <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>turn<span style="color: #666666">.</span>latency_ms<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> ms&quot;</span> <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>latency_ms <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>
        token_json <span style="color: #666666">=</span> json<span style="color: #666666">.</span>dumps(turn<span style="color: #666666">.</span>token_usage <span style="color: #AA22FF; font-weight: bold">or</span> {}, indent<span style="color: #666666">=2</span>, sort_keys<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        lines <span style="color: #666666">=</span> [
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">f&quot;## Turn </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">f&quot;**Question:** </span><span style="color: #A45A77; font-weight: bold">{</span>turn<span style="color: #666666">.</span>question<span style="color: #666666">.</span>strip()<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>turn<span style="color: #666666">.</span>question<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;‚Äî&#39;</span><span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">&quot;**Answer:**&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            textwrap<span style="color: #666666">.</span>indent((turn<span style="color: #666666">.</span>answer <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>)<span style="color: #666666">.</span>strip(), <span style="color: #BA2121">&quot;&gt; &quot;</span>),
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">f&quot;*Asked:* </span><span style="color: #A45A77; font-weight: bold">{</span>asked<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">  &quot;</span>,
            <span style="color: #BA2121">f&quot;*Answered:* </span><span style="color: #A45A77; font-weight: bold">{</span>answered<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">  &quot;</span>,
            <span style="color: #BA2121">f&quot;*Latency:* </span><span style="color: #A45A77; font-weight: bold">{</span>latency<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">&quot;### Citations&quot;</span>,
        ]
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>citations:
            <span style="color: #008000; font-weight: bold">for</span> idx, citation <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(turn<span style="color: #666666">.</span>citations, start<span style="color: #666666">=1</span>):
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">. </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_format_citation_text(citation)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">else</span>:
            lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;No citations available.&quot;</span>)
        reasoning <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_format_reasoning_markdown(turn)
        <span style="color: #008000; font-weight: bold">if</span> reasoning:
            lines<span style="color: #666666">.</span>extend(reasoning)
        lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;### Token Usage&quot;</span>)
        lines<span style="color: #666666">.</span>extend(textwrap<span style="color: #666666">.</span>indent(token_json <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;</span><span style="color: #A45A77; font-weight: bold">{}</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;    &quot;</span>)<span style="color: #666666">.</span>splitlines())
        <span style="color: #008000; font-weight: bold">return</span> lines
</code></pre>
<h3 id="_turn_to_html">Method: _turn_to_html(self, turn: ConversationTurn, index: int) -&gt; str</h3>
<p>The function `_turn_to_html` converts a `ConversationTurn` object into an HTML-formatted string for display in the user interface. It formats the turn&#x27;s question, answer, timestamps, latency, citations, reasoning, and token usage into structured HTML sections. The question and answer text are escaped to prevent XSS issues, with newlines in the answer converted to `&lt;br/&gt;` tags. Citations are rendered as a list, defaulting to &quot;No citations available.&quot; if none exist. Reasoning content is included if present, and token usage is displayed as a formatted JSON block. Each section is wrapped with appropriate HTML tags and classes for styling. The function returns the complete HTML string for a single conversation turn.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_turn_to_html</span>(<span style="color: #008000">self</span>, turn: ConversationTurn, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        asked <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(turn<span style="color: #666666">.</span>asked_at<span style="color: #666666">.</span>isoformat()) <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>asked_at <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>
        answered <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(turn<span style="color: #666666">.</span>answered_at<span style="color: #666666">.</span>isoformat()) <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>answered_at <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>
        latency <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>turn<span style="color: #666666">.</span>latency_ms<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> ms&quot;</span> <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>latency_ms <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>
        answer <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(turn<span style="color: #666666">.</span>answer <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>)<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;&lt;br/&gt;&quot;</span>)
        question <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(turn<span style="color: #666666">.</span>question <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>)
        citations <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(
            <span style="color: #BA2121">f&quot;&lt;li&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(<span style="color: #008000">self</span><span style="color: #666666">.</span>_format_citation_text(citation))<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/li&gt;&quot;</span>
            <span style="color: #008000; font-weight: bold">for</span> citation <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>citations <span style="color: #AA22FF; font-weight: bold">or</span> []
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> citations:
            citations <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&lt;li&gt;No citations available.&lt;/li&gt;&quot;</span>
        reasoning <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_format_reasoning_html(turn)
        token_json <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(json<span style="color: #666666">.</span>dumps(turn<span style="color: #666666">.</span>token_usage <span style="color: #AA22FF; font-weight: bold">or</span> {}, indent<span style="color: #666666">=2</span>, sort_keys<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>))
        sections <span style="color: #666666">=</span> [
            <span style="color: #BA2121">f&quot;&lt;h2&gt;Turn </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/h2&gt;&quot;</span>,
            <span style="color: #BA2121">f&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Question&lt;/h3&gt;&lt;p&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/p&gt;&lt;/div&gt;&quot;</span>,
            <span style="color: #BA2121">f&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Answer&lt;/h3&gt;&lt;p&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>answer<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/p&gt;&lt;/div&gt;&quot;</span>,
            <span style="color: #BA2121">f&quot;&lt;div class=&#39;meta&#39;&gt;Asked: </span><span style="color: #A45A77; font-weight: bold">{</span>asked<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> &amp;nbsp;|&amp;nbsp; Answered: </span><span style="color: #A45A77; font-weight: bold">{</span>answered<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> &amp;nbsp;|&amp;nbsp; Latency: </span><span style="color: #A45A77; font-weight: bold">{</span>latency<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/div&gt;&quot;</span>,
            <span style="color: #BA2121">f&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Citations&lt;/h3&gt;&lt;ul class=&#39;citations&#39;&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>citations<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/ul&gt;&lt;/div&gt;&quot;</span>,
        ]
        <span style="color: #008000; font-weight: bold">if</span> reasoning:
            sections<span style="color: #666666">.</span>append(reasoning)
        sections<span style="color: #666666">.</span>append(
            <span style="color: #BA2121">f&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Token Usage&lt;/h3&gt;&lt;pre&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>token_json<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/pre&gt;&lt;/div&gt;&quot;</span>
        )
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(sections)
</code></pre>
<h3 id="_format_reasoning_markdown">Method: _format_reasoning_markdown(self, turn: ConversationTurn) -&gt; list[str]</h3>
<p>The function `_format_reasoning_markdown` takes a `ConversationTurn` object and formats its reasoning-related attributes into a list of markdown-formatted strings. It includes sections for reasoning bullets, plan items with status, assumptions with an optional decision summary, and self-check results with flags and notes. Each section is only added to the output if the corresponding attribute of the `ConversationTurn` object contains data. The function returns the formatted lines as a list of strings.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_format_reasoning_markdown</span>(<span style="color: #008000">self</span>, turn: ConversationTurn) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        lines: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>reasoning_bullets:
            lines<span style="color: #666666">.</span>extend([<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;### Reasoning&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>])
            <span style="color: #008000; font-weight: bold">for</span> bullet <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>reasoning_bullets:
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>bullet<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>plan:
            lines<span style="color: #666666">.</span>extend([<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;### Plan&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>])
            <span style="color: #008000; font-weight: bold">for</span> idx, item <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(turn<span style="color: #666666">.</span>plan, start<span style="color: #666666">=1</span>):
                status <span style="color: #666666">=</span> item<span style="color: #666666">.</span>status<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;_&quot;</span>, <span style="color: #BA2121">&quot; &quot;</span>) <span style="color: #008000; font-weight: bold">if</span> item<span style="color: #666666">.</span>status <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;pending&quot;</span>
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">. </span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> [</span><span style="color: #A45A77; font-weight: bold">{</span>status<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">]&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>assumptions <span style="color: #AA22FF; font-weight: bold">or</span> turn<span style="color: #666666">.</span>assumption_decision <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            lines<span style="color: #666666">.</span>extend([<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;### Assumptions&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>])
            <span style="color: #008000; font-weight: bold">for</span> assumption <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>assumptions:
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- </span><span style="color: #A45A77; font-weight: bold">{</span>assumption<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            decision <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>assumption_decision
            <span style="color: #008000; font-weight: bold">if</span> decision:
                detail <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;Decision: </span><span style="color: #A45A77; font-weight: bold">{</span>decision<span style="color: #666666">.</span>mode<span style="color: #666666">.</span>title()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>]
                <span style="color: #008000; font-weight: bold">if</span> decision<span style="color: #666666">.</span>rationale:
                    detail<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Rationale: </span><span style="color: #A45A77; font-weight: bold">{</span>decision<span style="color: #666666">.</span>rationale<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> decision<span style="color: #666666">.</span>clarifying_question:
                    detail<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Follow-up: </span><span style="color: #A45A77; font-weight: bold">{</span>decision<span style="color: #666666">.</span>clarifying_question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;- &quot;</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot; | &quot;</span><span style="color: #666666">.</span>join(detail))
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>self_check <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            self_check <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>self_check
            lines<span style="color: #666666">.</span>extend([<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;### Self-check&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>])
            lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;- Status: &quot;</span> <span style="color: #666666">+</span> (<span style="color: #BA2121">&quot;Passed&quot;</span> <span style="color: #008000; font-weight: bold">if</span> self_check<span style="color: #666666">.</span>passed <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;Flagged&quot;</span>))
            <span style="color: #008000; font-weight: bold">for</span> flag <span style="color: #AA22FF; font-weight: bold">in</span> self_check<span style="color: #666666">.</span>flags:
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- Flag: </span><span style="color: #A45A77; font-weight: bold">{</span>flag<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> self_check<span style="color: #666666">.</span>notes:
                lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;- Notes: </span><span style="color: #A45A77; font-weight: bold">{</span>self_check<span style="color: #666666">.</span>notes<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> lines
</code></pre>
<h3 id="_format_reasoning_html">Method: _format_reasoning_html(self, turn: ConversationTurn) -&gt; str</h3>
<p>The function `_format_reasoning_html` generates an HTML-formatted string representing the reasoning components of a conversation turn. It processes and formats the following elements from the `turn` object: reasoning bullets, plan items, assumptions (including assumption decisions), and self-check results. Each component is wrapped in a structured HTML section with appropriate headings and formatting. The function ensures that text content is safely escaped to prevent HTML injection. The resulting HTML string combines all non-empty sections into a single formatted output.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_format_reasoning_html</span>(<span style="color: #008000">self</span>, turn: ConversationTurn) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        sections: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>reasoning_bullets:
            bullets <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;&lt;li&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(item)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/li&gt;&quot;</span> <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>reasoning_bullets)
            sections<span style="color: #666666">.</span>append(
                <span style="color: #BA2121">f&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Reasoning&lt;/h3&gt;&lt;ul&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>bullets<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/ul&gt;&lt;/div&gt;&quot;</span>
            )
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>plan:
            items <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(
                <span style="color: #BA2121">f&quot;&lt;li&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(item<span style="color: #666666">.</span>description)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> &lt;em&gt;[</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(item<span style="color: #666666">.</span>status<span style="color: #bbbbbb"> </span><span style="color: #AA22FF; font-weight: bold">or</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;pending&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">]&lt;/em&gt;&lt;/li&gt;&quot;</span>
                <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>plan
            )
            sections<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Plan&lt;/h3&gt;&lt;ol&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>items<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/ol&gt;&lt;/div&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>assumptions <span style="color: #AA22FF; font-weight: bold">or</span> turn<span style="color: #666666">.</span>assumption_decision <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            assumptions <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(
                <span style="color: #BA2121">f&quot;&lt;li&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(text)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/li&gt;&quot;</span> <span style="color: #008000; font-weight: bold">for</span> text <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>assumptions
            )
            extras: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
            decision <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>assumption_decision
            <span style="color: #008000; font-weight: bold">if</span> decision:
                detail <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;Decision: </span><span style="color: #A45A77; font-weight: bold">{</span>decision<span style="color: #666666">.</span>mode<span style="color: #666666">.</span>title()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>]
                <span style="color: #008000; font-weight: bold">if</span> decision<span style="color: #666666">.</span>rationale:
                    detail<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Rationale: </span><span style="color: #A45A77; font-weight: bold">{</span>decision<span style="color: #666666">.</span>rationale<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> decision<span style="color: #666666">.</span>clarifying_question:
                    detail<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Follow-up: </span><span style="color: #A45A77; font-weight: bold">{</span>decision<span style="color: #666666">.</span>clarifying_question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
                extras<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot; | &quot;</span><span style="color: #666666">.</span>join(html<span style="color: #666666">.</span>escape(part) <span style="color: #008000; font-weight: bold">for</span> part <span style="color: #AA22FF; font-weight: bold">in</span> detail))
            <span style="color: #008000; font-weight: bold">if</span> extras:
                assumptions <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;&lt;li&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>extra<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/li&gt;&quot;</span> <span style="color: #008000; font-weight: bold">for</span> extra <span style="color: #AA22FF; font-weight: bold">in</span> extras)
            sections<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Assumptions&lt;/h3&gt;&lt;ul&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>assumptions<span style="color: #bbbbbb"> </span><span style="color: #AA22FF; font-weight: bold">or</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;&lt;li&gt;None&lt;/li&gt;&#39;</span><span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/ul&gt;&lt;/div&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>self_check <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            self_check <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>self_check
            flags <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;&lt;li&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(flag)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/li&gt;&quot;</span> <span style="color: #008000; font-weight: bold">for</span> flag <span style="color: #AA22FF; font-weight: bold">in</span> self_check<span style="color: #666666">.</span>flags)
            extra <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;&lt;p&gt;Notes: </span><span style="color: #A45A77; font-weight: bold">{</span>html<span style="color: #666666">.</span>escape(self_check<span style="color: #666666">.</span>notes)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/p&gt;&quot;</span> <span style="color: #008000; font-weight: bold">if</span> self_check<span style="color: #666666">.</span>notes <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>
            sections<span style="color: #666666">.</span>append(
                <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(
                    [
                        <span style="color: #BA2121">&quot;&lt;div class=&#39;section&#39;&gt;&lt;h3&gt;Self-check&lt;/h3&gt;&quot;</span>,
                        <span style="color: #BA2121">f&quot;&lt;p&gt;Status: </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #BA2121">&#39;Passed&#39;</span><span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>self_check<span style="color: #666666">.</span>passed<span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;Flagged&#39;</span><span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/p&gt;&quot;</span>,
                        <span style="color: #BA2121">f&quot;&lt;ul&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>flags<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/ul&gt;&quot;</span> <span style="color: #008000; font-weight: bold">if</span> flags <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>,
                        extra,
                        <span style="color: #BA2121">&quot;&lt;/div&gt;&quot;</span>,
                    ]
                )
            )
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(sections)
</code></pre>
<h3 id="_format_citation_text">Method: _format_citation_text(citation: object) -&gt; str</h3>
<p>The function `_format_citation_text` takes a citation object and formats it into a human-readable string. If the citation is a string, it returns the string directly. If it is a dictionary, it extracts fields such as `source`, `title`, `path`, `page`, `section`, and `snippet` to construct a formatted citation. The `source` field is prioritized from `source`, `title`, or `path`. Page and section information are included in parentheses. If a snippet is present, it is stripped of HTML tags and included in the output. If no snippet is provided, only the label and location are returned. For any other type, the citation is converted to a string.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_format_citation_text</span>(citation: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">str</span>):
            <span style="color: #008000; font-weight: bold">return</span> citation
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">dict</span>):
            source <span style="color: #666666">=</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
            location: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
            page <span style="color: #666666">=</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;page&quot;</span>)
            section <span style="color: #666666">=</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;section&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> page <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                location<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;page </span><span style="color: #A45A77; font-weight: bold">{</span>page<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> section:
                location<span style="color: #666666">.</span>append(<span style="color: #008000">str</span>(section))
            snippet <span style="color: #666666">=</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;snippet&quot;</span>)
            label <span style="color: #666666">=</span> source <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Reference&quot;</span>
            tail <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot; (</span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #BA2121">&#39;, &#39;</span><span style="color: #666666">.</span>join(location)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">)&quot;</span> <span style="color: #008000; font-weight: bold">if</span> location <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>
            <span style="color: #008000; font-weight: bold">if</span> snippet:
                snippet_text <span style="color: #666666">=</span> ExportService<span style="color: #666666">.</span>_strip_html(snippet)
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>label<span style="color: #A45A77; font-weight: bold">}{</span>tail<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>snippet_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>label<span style="color: #A45A77; font-weight: bold">}{</span>tail<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(citation)
</code></pre>
<h3 id="_strip_html">Method: _strip_html(value: str | None) -&gt; str</h3>
<p>The function `_strip_html` takes a string input, which may be `None`, and removes HTML tags from it. It replaces `&lt;br&gt;` and `&lt;br/&gt;` with newline characters, then iterates through the string to build a cleaned text output by ignoring content within HTML tags. It uses `html.unescape` to decode HTML entities and returns the resulting text with normalized whitespace. If the input is `None`, it returns an empty string.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_strip_html</span>(value: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> value:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span>
        cleaned <span style="color: #666666">=</span> value<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;&lt;br&gt;&quot;</span>, <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>)<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;&lt;br/&gt;&quot;</span>, <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>)
        result: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        in_tag <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
        buffer: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> char <span style="color: #AA22FF; font-weight: bold">in</span> cleaned:
            <span style="color: #008000; font-weight: bold">if</span> char <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;&lt;&quot;</span>:
                in_tag <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
                <span style="color: #008000; font-weight: bold">if</span> buffer:
                    result<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(buffer))
                    buffer<span style="color: #666666">.</span>clear()
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">if</span> char <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;&gt;&quot;</span>:
                in_tag <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> in_tag:
                buffer<span style="color: #666666">.</span>append(char)
        <span style="color: #008000; font-weight: bold">if</span> buffer:
            result<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(buffer))
        text <span style="color: #666666">=</span> html<span style="color: #666666">.</span>unescape(<span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(result))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">.</span>join(text<span style="color: #666666">.</span>split())
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
