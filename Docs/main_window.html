<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>main_window</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>main_window</h1>
        <p>The module defines a desktop data mining application window with a three-panel split layout comprising a corpus selector tree, conversation display, and evidence viewer. It initializes services and managers for project session management, conversation state handling, and corpus ingestion workflows, including indexing folders and files, rescanning corpus roots, and tracking ingest job progress. The interface supports corpus management, exporting conversations, backup operations, and theme/density adjustments, with a health monitor for LMStudio client status. It includes toast notifications, keyboard shortcuts, and UI elements for managing retrieval scopes, document navigation, and conversation turns. The application handles project-specific storage paths, database snapshots, and session persistence, while integrating with document repositories and UI components such as tree widgets and dialog boxes. Features encompass user interaction handling, settings persistence, token usage processing, context-based question answering, and model configuration, alongside shutdown cleanup operations.</p>
<h2 id="ToastWidget">Class: ToastWidget</h2>
<p>The `ToastWidget` class implements a transient notification overlay that displays messages with optional styling based on message level (info, warning, error). It uses animations to fade messages in and out and positions itself in the top-right corner of its parent widget. The class handles timing for message display and automatically hides the toast after a specified duration.</p>
<h3 id="__init__">Method: __init__(self, parent: QWidget | None=None) -&gt; None</h3>
<p>Initializes a `ToastWidget` instance as a tooltip window with a frameless, translucent background. Sets up a layout containing a label for displaying text and configures a property animation for window opacity transitions. The widget is initialized with a specific object name and window flags to ensure it appears as a non-modal tooltip.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, parent: QWidget <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">super</span>()<span style="color: #666666">.</span><span style="color: #0000FF">__init__</span>(parent, Qt<span style="color: #666666">.</span>WindowType<span style="color: #666666">.</span>ToolTip)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;toast&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setWindowFlag(Qt<span style="color: #666666">.</span>WindowType<span style="color: #666666">.</span>FramelessWindowHint)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setAttribute(Qt<span style="color: #666666">.</span>WidgetAttribute<span style="color: #666666">.</span>WA_TranslucentBackground, <span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_label <span style="color: #666666">=</span> QLabel(<span style="color: #008000">self</span>)
        layout <span style="color: #666666">=</span> QHBoxLayout(<span style="color: #008000">self</span>)
        layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">12</span>, <span style="color: #666666">8</span>, <span style="color: #666666">12</span>, <span style="color: #666666">8</span>)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_label)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation <span style="color: #666666">=</span> QPropertyAnimation(<span style="color: #008000">self</span>, <span style="color: #BA2121">b&quot;windowOpacity&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>setDuration(<span style="color: #666666">250</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>setEasingCurve(QEasingCurve<span style="color: #666666">.</span>Type<span style="color: #666666">.</span>InOutQuad)
</code></pre>
<h3 id="show_message">Method: show_message(self, message: str, level: str=&#x27;info&#x27;, duration_ms: int=4000) -&gt; None</h3>
<p>Displays a styled message in the toast widget with optional duration and visual styling based on message level (error, warning, or info). The message is positioned in the top-right corner of its parent widget, fades in, and then fades out after the specified duration.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">show_message</span>(<span style="color: #008000">self</span>, message: <span style="color: #008000">str</span>, level: <span style="color: #008000">str</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;info&quot;</span>, duration_ms: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">4000</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        palette <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>palette()
        <span style="color: #008000; font-weight: bold">if</span> level <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;error&quot;</span>:
            palette<span style="color: #666666">.</span>setColor(palette<span style="color: #666666">.</span>ColorRole<span style="color: #666666">.</span>Window, Qt<span style="color: #666666">.</span>GlobalColor<span style="color: #666666">.</span>darkRed)
            palette<span style="color: #666666">.</span>setColor(palette<span style="color: #666666">.</span>ColorRole<span style="color: #666666">.</span>WindowText, Qt<span style="color: #666666">.</span>GlobalColor<span style="color: #666666">.</span>white)
        <span style="color: #008000; font-weight: bold">elif</span> level <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;warning&quot;</span>:
            palette<span style="color: #666666">.</span>setColor(palette<span style="color: #666666">.</span>ColorRole<span style="color: #666666">.</span>Window, Qt<span style="color: #666666">.</span>GlobalColor<span style="color: #666666">.</span>darkYellow)
            palette<span style="color: #666666">.</span>setColor(palette<span style="color: #666666">.</span>ColorRole<span style="color: #666666">.</span>WindowText, Qt<span style="color: #666666">.</span>GlobalColor<span style="color: #666666">.</span>black)
        <span style="color: #008000; font-weight: bold">else</span>:
            palette<span style="color: #666666">.</span>setColor(palette<span style="color: #666666">.</span>ColorRole<span style="color: #666666">.</span>Window, Qt<span style="color: #666666">.</span>GlobalColor<span style="color: #666666">.</span>black)
            palette<span style="color: #666666">.</span>setColor(palette<span style="color: #666666">.</span>ColorRole<span style="color: #666666">.</span>WindowText, Qt<span style="color: #666666">.</span>GlobalColor<span style="color: #666666">.</span>white)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setPalette(palette)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setAutoFillBackground(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_label<span style="color: #666666">.</span>setText(message)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>adjustSize()
        parent <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>parentWidget()
        <span style="color: #008000; font-weight: bold">if</span> parent:
            margin <span style="color: #666666">=</span> <span style="color: #666666">24</span>
            geo <span style="color: #666666">=</span> parent<span style="color: #666666">.</span>geometry()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>move(geo<span style="color: #666666">.</span>right() <span style="color: #666666">-</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>width() <span style="color: #666666">-</span> margin, geo<span style="color: #666666">.</span>top() <span style="color: #666666">+</span> margin)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setWindowOpacity(<span style="color: #666666">0.0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>show()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>raise_()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>stop()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>setStartValue(<span style="color: #666666">0.0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>setEndValue(<span style="color: #666666">1.0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>start()
        QTimer<span style="color: #666666">.</span>singleShot(duration_ms, <span style="color: #008000">self</span><span style="color: #666666">.</span>_fade_out)
</code></pre>
<h3 id="_fade_out">Method: _fade_out(self) -&gt; None</h3>
<p>The `_fade_out` method initiates a fade-out animation for the toast widget. It stops any ongoing animation, sets up a transition from full opacity (1.0) to transparent (0.0), disconnects any existing connection to the `hide` method from the animation&#x27;s finished signal, connects the `hide` method to the finished signal, and starts the animation.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_fade_out</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>stop()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>setStartValue(<span style="color: #666666">1.0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>setEndValue(<span style="color: #666666">0.0</span>)
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>finished<span style="color: #666666">.</span>disconnect(<span style="color: #008000">self</span><span style="color: #666666">.</span>hide)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">TypeError</span>:
            <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>finished<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>hide)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_animation<span style="color: #666666">.</span>start()
</code></pre>
<h2 id="MainWindow">Class: MainWindow</h2>
<p>This code defines a PyQt-based application window that serves as the primary interface for a data mining tool, inheriting from `QMainWindow` and integrating multiple core services including settings management, progress tracking, LMStudio client connectivity, project handling, document ingestion, search capabilities, and export functions. The window manages conversation turns, project sessions, and ingest jobs while providing functionality for corpus management such as adding folders or files, rescanning indexed directories, and tracking ingestion job states. It supports UI panel management, state preservation across sessions, splitter widget layouts, and synchronization of action states with service settings. Additional features include project operations like deletion, backup creation, data purging, and path revelation, along with conversation export capabilities to Markdown and HTML formats. The application also implements a chat interface for interacting with an LMStudio model, handling context retrieval and UI updates, and includes mechanisms for connection health checks, proper resource cleanup during shutdown, and asynchronous operation handling through Qt&#x27;s event loop integration.</p>
<h3 id="__init__">Method: __init__(self, *, settings_service: SettingsService, progress_service: ProgressService, lmstudio_client: LMStudioClient, project_service: ProjectService, ingest_service: IngestService, document_hierarchy: DocumentHierarchyService, export_service: ExportService, backup_service: BackupService, enable_health_monitor: bool=True) -&gt; None</h3>
<p>Initializes the `MainWindow` class with various service dependencies and sets up the application&#x27;s window, UI components, and internal state. It configures services for settings, progress tracking, language model interaction, project management, document ingestion, search, and export. The constructor initializes UI elements such as menus, toolbar, status bar, and layout, and connects signals for project changes and ingest updates. It also sets up a timer for handling ingest updates and optionally monitors the health of the LMStudio client.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(
        <span style="color: #008000">self</span>,
        <span style="color: #666666">*</span>,
        settings_service: SettingsService,
        progress_service: ProgressService,
        lmstudio_client: LMStudioClient,
        project_service: ProjectService,
        ingest_service: IngestService,
        document_hierarchy: DocumentHierarchyService,
        export_service: ExportService,
        backup_service: BackupService,
        enable_health_monitor: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">super</span>()<span style="color: #666666">.</span><span style="color: #0000FF">__init__</span>()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service <span style="color: #666666">=</span> settings_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service <span style="color: #666666">=</span> progress_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>lmstudio_client <span style="color: #666666">=</span> lmstudio_client
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service <span style="color: #666666">=</span> project_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest_service <span style="color: #666666">=</span> ingest_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>document_hierarchy <span style="color: #666666">=</span> document_hierarchy
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_service <span style="color: #666666">=</span> export_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>backup_service <span style="color: #666666">=</span> backup_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>enable_health_monitor <span style="color: #666666">=</span> enable_health_monitor
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_splitter_sizes <span style="color: #666666">=</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>splitter_sizes)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_setup_window()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_actions()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_menus_and_toolbar()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_status_bar()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings <span style="color: #666666">=</span> ConversationSettings()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager <span style="color: #666666">=</span> ConversationManager(<span style="color: #008000">self</span><span style="color: #666666">.</span>lmstudio_client)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>search_service <span style="color: #666666">=</span> SearchService(
            project_service<span style="color: #666666">.</span>ingest,
            project_service<span style="color: #666666">.</span>documents,
            project_service<span style="color: #666666">.</span>chats,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns: <span style="color: #008000">list</span>[ConversationTurn] <span style="color: #666666">=</span> []
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_sessions: <span style="color: #008000">dict</span>[<span style="color: #008000">int</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> {}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_jobs: <span style="color: #008000">dict</span>[<span style="color: #008000">int</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> {}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_updates: <span style="color: #BA2121">&quot;queue.Queue[tuple[int, dict[str, Any]]]&quot;</span> <span style="color: #666666">=</span> queue<span style="color: #666666">.</span>Queue()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_connection_unsubscribe <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>add_connection_listener(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_on_connection_state_changed
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]] <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;include&quot;</span>: [], <span style="color: #BA2121">&quot;exclude&quot;</span>: []}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card: TurnCardWidget <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_has_documents: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_toast <span style="color: #666666">=</span> ToastWidget(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button: QPushButton <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_layout()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_density(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>density)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_model_name(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>model_name)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_answer_length(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>answer_length)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_configure_question_settings_menu()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_connect_services()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>apply_theme()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>apply_font_scale()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_lmstudio_status()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>projects_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_projects_changed)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_active_project_changed)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_initialise_project_state()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_unsubscribe <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest_service<span style="color: #666666">.</span>subscribe(<span style="color: #008000">self</span><span style="color: #666666">.</span>_enqueue_ingest_update)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_timer <span style="color: #666666">=</span> QTimer(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_timer<span style="color: #666666">.</span>setInterval(<span style="color: #666666">150</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_timer<span style="color: #666666">.</span>timeout<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_drain_ingest_updates)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_timer<span style="color: #666666">.</span>start()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>enable_health_monitor:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_health_timer <span style="color: #666666">=</span> QTimer(<span style="color: #008000">self</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_health_timer<span style="color: #666666">.</span>timeout<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_update_lmstudio_status)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_health_timer<span style="color: #666666">.</span>start(<span style="color: #666666">15000</span>)
</code></pre>
<h3 id="_setup_window">Method: _setup_window(self) -&gt; None</h3>
<p>The function `_setup_window` configures the main window properties for the `MainWindow` class. It sets the window title to &quot;DataMiner&quot; and resizes the window to 1280 pixels in width and 800 pixels in height.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_setup_window</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setWindowTitle(<span style="color: #BA2121">&quot;DataMiner&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>resize(<span style="color: #666666">1280</span>, <span style="color: #666666">800</span>)
</code></pre>
<h3 id="_create_actions">Method: _create_actions(self) -&gt; None</h3>
<p>The function `_create_actions` initializes and configures a set of `QAction` objects for the `MainWindow` class. These actions correspond to various user interface options such as opening settings, accessing help, toggling themes, managing projects (creating, renaming, deleting, revealing storage, and purging data), backing up and restoring project data, exporting conversations and snippets, and managing corpus content (adding folders/files and rescanning indexed folders). Each action is connected to a respective handler method, and some actions are initially disabled, such as those related to exporting and rescanning. The function sets up the foundational menu and toolbar actions for the application&#x27;s functionality.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_actions</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Settings&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_open_settings)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>help_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Help&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>help_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_open_help)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_theme_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Toggle Theme&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_theme_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>toggle_theme)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>new_project_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;New Project‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>new_project_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_prompt_new_project)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>rename_project_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Rename Project‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>rename_project_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_prompt_rename_project)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>delete_project_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Delete Project&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>delete_project_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_delete_current_project)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>reveal_storage_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Reveal Project Storage&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>reveal_storage_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_reveal_project_storage)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>remove_project_data_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Remove Project Data&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>remove_project_data_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_purge_project_data)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>backup_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Create Backup‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>backup_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_create_backup)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>restore_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Restore from Backup‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>restore_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_restore_backup)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_markdown_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Export Conversation to Markdown‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_markdown_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_export_conversation_markdown)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_html_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Export Conversation to HTML‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_html_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_export_conversation_html)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Export Selected Snippet‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_export_selected_snippet)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_markdown_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_html_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>add_folder_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Add Folder to Corpus‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>add_folder_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_add_folder_to_corpus)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>add_files_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Add Files to Corpus‚Ä¶&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>add_files_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_add_files_to_corpus)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>rescan_corpus_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Rescan Indexed Folders&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>rescan_corpus_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_corpus)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>rescan_corpus_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_create_menus_and_toolbar">Method: _create_menus_and_toolbar(self) -&gt; None</h3>
<p>The function `_create_menus_and_toolbar` creates the main menu bar and toolbar for the `MainWindow` class. It defines several menus including &quot;File&quot;, &quot;Help&quot;, and &quot;View&quot;, and populates them with actions and submenus for project management, corpus handling, export options, backup and restore functionality, and UI customization. The &quot;File&quot; menu includes actions for managing projects, adding corpus items, rescanning the corpus, exporting content, and performing backup/restore operations. The &quot;View&quot; menu allows toggling of corpus and evidence panels, as well as setting the display density. A toolbar is also created with common actions and a project selection combo box.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_menus_and_toolbar</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        menubar <span style="color: #666666">=</span> QMenuBar(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setMenuBar(menubar)

        file_menu <span style="color: #666666">=</span> QMenu(<span style="color: #BA2121">&quot;File&quot;</span>, <span style="color: #008000">self</span>)
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_action)
        file_menu<span style="color: #666666">.</span>addSeparator()
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>new_project_action)
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>rename_project_action)
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>delete_project_action)
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>remove_project_data_action)
        file_menu<span style="color: #666666">.</span>addSeparator()
        corpus_menu <span style="color: #666666">=</span> file_menu<span style="color: #666666">.</span>addMenu(<span style="color: #BA2121">&quot;Corpus&quot;</span>)
        corpus_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>add_folder_action)
        corpus_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>add_files_action)
        corpus_menu<span style="color: #666666">.</span>addSeparator()
        corpus_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>rescan_corpus_action)
        file_menu<span style="color: #666666">.</span>addSeparator()
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>reveal_storage_action)
        file_menu<span style="color: #666666">.</span>addSeparator()
        export_menu <span style="color: #666666">=</span> file_menu<span style="color: #666666">.</span>addMenu(<span style="color: #BA2121">&quot;Export&quot;</span>)
        export_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>export_markdown_action)
        export_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>export_html_action)
        export_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action)
        file_menu<span style="color: #666666">.</span>addSeparator()
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>backup_action)
        file_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>restore_action)
        menubar<span style="color: #666666">.</span>addMenu(file_menu)

        help_menu <span style="color: #666666">=</span> QMenu(<span style="color: #BA2121">&quot;Help&quot;</span>, <span style="color: #008000">self</span>)
        help_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>help_action)
        menubar<span style="color: #666666">.</span>addMenu(help_menu)

        view_menu <span style="color: #666666">=</span> QMenu(<span style="color: #BA2121">&quot;View&quot;</span>, <span style="color: #008000">self</span>)
        view_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_theme_action)
        view_menu<span style="color: #666666">.</span>addSeparator()

        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Show corpus pane&quot;</span>, <span style="color: #008000">self</span>, checkable<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action<span style="color: #666666">.</span>setChecked(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>show_corpus_panel)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action<span style="color: #666666">.</span>toggled<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_toggle_corpus_panel)
        view_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_evidence_panel_action <span style="color: #666666">=</span> QAction(
            <span style="color: #BA2121">&quot;Show evidence pane&quot;</span>, <span style="color: #008000">self</span>, checkable<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_evidence_panel_action<span style="color: #666666">.</span>setChecked(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>show_evidence_panel
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_evidence_panel_action<span style="color: #666666">.</span>toggled<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_toggle_evidence_panel)
        view_menu<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_evidence_panel_action)

        view_menu<span style="color: #666666">.</span>addSeparator()
        density_menu <span style="color: #666666">=</span> view_menu<span style="color: #666666">.</span>addMenu(<span style="color: #BA2121">&quot;Density&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density_group <span style="color: #666666">=</span> QActionGroup(<span style="color: #008000">self</span>)
        <span style="color: #008000; font-weight: bold">for</span> label, value <span style="color: #AA22FF; font-weight: bold">in</span> [(<span style="color: #BA2121">&quot;Comfortable&quot;</span>, <span style="color: #BA2121">&quot;comfortable&quot;</span>), (<span style="color: #BA2121">&quot;Compact&quot;</span>, <span style="color: #BA2121">&quot;compact&quot;</span>)]:
            action <span style="color: #666666">=</span> QAction(label, <span style="color: #008000">self</span>, checkable<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
            action<span style="color: #666666">.</span>setData(value)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>density <span style="color: #666666">==</span> value:
                action<span style="color: #666666">.</span>setChecked(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_density_group<span style="color: #666666">.</span>addAction(action)
            density_menu<span style="color: #666666">.</span>addAction(action)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density_group<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_density_action_triggered)
        menubar<span style="color: #666666">.</span>addMenu(view_menu)

        toolbar <span style="color: #666666">=</span> QToolBar(<span style="color: #BA2121">&quot;Main Toolbar&quot;</span>, <span style="color: #008000">self</span>)
        toolbar<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_action)
        toolbar<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>help_action)
        toolbar<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_theme_action)
        toolbar<span style="color: #666666">.</span>addSeparator()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo <span style="color: #666666">=</span> QComboBox(toolbar)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>setToolTip(<span style="color: #BA2121">&quot;Switch active project&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>currentIndexChanged<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_project_combo_changed)
        toolbar<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo)
        toolbar<span style="color: #666666">.</span>addSeparator()
        toolbar<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>new_project_action)
        toolbar<span style="color: #666666">.</span>addAction(<span style="color: #008000">self</span><span style="color: #666666">.</span>backup_action)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>addToolBar(toolbar)
</code></pre>
<h3 id="_create_status_bar">Method: _create_status_bar(self) -&gt; None</h3>
<p>Creates and configures a status bar for the main window, including a project label and a progress bar. The progress bar is initially hidden and has a maximum width of 200 pixels. The project label displays text generated by the `_project_label_text()` method. The status bar is added to the main window using `setStatusBar()`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_status_bar</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        status <span style="color: #666666">=</span> QStatusBar(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setStatusBar(status)

        project_label <span style="color: #666666">=</span> QLabel(<span style="color: #008000">self</span><span style="color: #666666">.</span>_project_label_text())
        status<span style="color: #666666">.</span>addWidget(project_label)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar <span style="color: #666666">=</span> QProgressBar(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setMaximumWidth(<span style="color: #666666">200</span>)
        status<span style="color: #666666">.</span>addPermanentWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar)
</code></pre>
<h3 id="_create_layout">Method: _create_layout(self) -&gt; None</h3>
<p>The `_create_layout` method defines the main user interface layout for the `MainWindow` class. It creates a horizontal splitter with three panels: a left corpus panel for document ingestion and selection, a center chat panel for conversation and question input, and a right evidence panel for displaying retrieved results. The corpus panel includes controls for indexing folders and files, rescanning indexed folders, and a tree widget for selecting documents. The chat panel contains an `AnswerView` for displaying AI responses, conversation controls, and a `QuestionInputWidget` for user queries. The evidence panel handles citation viewing and navigation. The layout uses splitters to manage panel resizing and applies styling through object names. Keyboard shortcuts are also set up for focusing the corpus panel and copying chat text.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_layout</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        central <span style="color: #666666">=</span> QWidget(<span style="color: #008000">self</span>)
        root_layout <span style="color: #666666">=</span> QHBoxLayout(central)
        root_layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter <span style="color: #666666">=</span> QSplitter(Qt<span style="color: #666666">.</span>Orientation<span style="color: #666666">.</span>Horizontal, central)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>setChildrenCollapsible(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>splitterMoved<span style="color: #666666">.</span>connect(<span style="color: #008000; font-weight: bold">lambda</span> <span style="color: #666666">*</span>_args: <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_splitter_sizes())
        root_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter)

        <span style="color: #3D7B7B; font-style: italic"># Left panel - corpus selector and ingest controls</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_panel <span style="color: #666666">=</span> QWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_panel<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;corpusPane&quot;</span>)
        corpus_layout <span style="color: #666666">=</span> QVBoxLayout(<span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_panel)
        corpus_layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">12</span>, <span style="color: #666666">12</span>, <span style="color: #666666">12</span>, <span style="color: #666666">12</span>)
        corpus_layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">12</span>)

        controls_frame <span style="color: #666666">=</span> QFrame(<span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_panel)
        controls_frame<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;corpusControls&quot;</span>)
        controls_layout <span style="color: #666666">=</span> QVBoxLayout(controls_frame)
        controls_layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">8</span>, <span style="color: #666666">8</span>, <span style="color: #666666">8</span>, <span style="color: #666666">8</span>)
        controls_layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">8</span>)

        controls_header <span style="color: #666666">=</span> QHBoxLayout()
        controls_header<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>)
        controls_header<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">6</span>)
        controls_label <span style="color: #666666">=</span> QLabel(<span style="color: #BA2121">&quot;Corpus&quot;</span>, controls_frame)
        controls_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;corpusLabel&quot;</span>)
        controls_header<span style="color: #666666">.</span>addWidget(controls_label)
        controls_header<span style="color: #666666">.</span>addStretch(<span style="color: #666666">1</span>)
        collapse_left <span style="color: #666666">=</span> QPushButton(<span style="color: #BA2121">&quot;Collapse&quot;</span>, controls_frame)
        collapse_left<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;collapseCorpus&quot;</span>)
        collapse_left<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(
            <span style="color: #008000; font-weight: bold">lambda</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action<span style="color: #666666">.</span>setChecked(<span style="color: #008000; font-weight: bold">False</span>)
        )
        controls_header<span style="color: #666666">.</span>addWidget(collapse_left)
        controls_layout<span style="color: #666666">.</span>addLayout(controls_header)

        add_folder_button <span style="color: #666666">=</span> QPushButton(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>add_folder_action<span style="color: #666666">.</span>text(), controls_frame
        )
        add_folder_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;indexFolderButton&quot;</span>)
        add_folder_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(
            <span style="color: #008000; font-weight: bold">lambda</span> _checked<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>add_folder_action<span style="color: #666666">.</span>trigger()
        )
        controls_layout<span style="color: #666666">.</span>addWidget(add_folder_button)

        add_files_button <span style="color: #666666">=</span> QPushButton(<span style="color: #BA2121">&quot;Index Files‚Ä¶&quot;</span>, controls_frame)
        add_files_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;indexFilesButton&quot;</span>)
        add_files_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(
            <span style="color: #008000; font-weight: bold">lambda</span> _checked<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>add_files_action<span style="color: #666666">.</span>trigger()
        )
        controls_layout<span style="color: #666666">.</span>addWidget(add_files_button)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button <span style="color: #666666">=</span> QPushButton(<span style="color: #BA2121">&quot;Rescan Indexed Folders&quot;</span>, controls_frame)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;rescanCorpusButton&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(
            <span style="color: #008000; font-weight: bold">lambda</span> _checked<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>rescan_corpus_action<span style="color: #666666">.</span>trigger()
        )
        controls_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button)

        controls_layout<span style="color: #666666">.</span>addStretch(<span style="color: #666666">1</span>)
        corpus_layout<span style="color: #666666">.</span>addWidget(controls_frame)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree <span style="color: #666666">=</span> QTreeWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_panel)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;corpusSelector&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setHeaderHidden(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setIndentation(<span style="color: #666666">16</span>)
        corpus_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree, <span style="color: #666666">1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_panel)

        <span style="color: #3D7B7B; font-style: italic"># Center panel - conversation and controls</span>
        chat_panel <span style="color: #666666">=</span> QWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter)
        chat_panel<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;chatPane&quot;</span>)
        chat_layout <span style="color: #666666">=</span> QVBoxLayout(chat_panel)
        chat_layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">12</span>, <span style="color: #666666">12</span>, <span style="color: #666666">12</span>, <span style="color: #666666">12</span>)
        chat_layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">12</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view <span style="color: #666666">=</span> AnswerView(
            settings<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings,
            progress_service<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service,
            parent<span style="color: #666666">=</span>chat_panel,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;answerView&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>citation_activated<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_card_citation)
        chat_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view, <span style="color: #666666">1</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_controls_frame <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_conversation_controls(chat_panel)
        chat_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_controls_frame)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input <span style="color: #666666">=</span> QuestionInputWidget(chat_panel)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>ask_requested<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_handle_ask)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>scope_cleared<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_scope_chip_cleared)
        chat_layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>question_input)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>addWidget(chat_panel)

        <span style="color: #3D7B7B; font-style: italic"># Right panel - evidence viewer</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel <span style="color: #666666">=</span> EvidencePanel(<span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;evidencePanel&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>scope_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_evidence_scope_changed)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>evidence_selected<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_evidence_selected)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>locate_requested<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_evidence_locate_requested)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>copy_requested<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_copy_evidence_snippet)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>setStretchFactor(<span style="color: #666666">0</span>, <span style="color: #666666">1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>setStretchFactor(<span style="color: #666666">1</span>, <span style="color: #666666">3</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>setStretchFactor(<span style="color: #666666">2</span>, <span style="color: #666666">2</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>setCentralWidget(central)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_splitter_preferences()

        <span style="color: #3D7B7B; font-style: italic"># Keyboard shortcuts</span>
        QShortcut(QKeySequence(<span style="color: #BA2121">&quot;Ctrl+L&quot;</span>), <span style="color: #008000">self</span>, activated<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_focus_corpus)
        QShortcut(QKeySequence(<span style="color: #BA2121">&quot;Ctrl+C&quot;</span>), <span style="color: #008000">self</span>, activated<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_copy_chat_text)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_question_prerequisites(<span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>connection_state)
</code></pre>
<h3 id="_apply_splitter_preferences">Method: _apply_splitter_preferences(self) -&gt; None</h3>
<p>The function `_apply_splitter_preferences` configures the splitter layout and panel visibility based on saved settings. It adjusts the sizes of the splitter panes, ensures minimum size constraints, and updates the visibility of the corpus and evidence panels. Additionally, it synchronizes the state of corresponding toggle actions in the user interface with the current settings, temporarily blocking signal handling to prevent recursive updates.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_splitter_preferences</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_splitter&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        sizes <span style="color: #666666">=</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>splitter_sizes)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sizes) <span style="color: #666666">==</span> <span style="color: #666666">3</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">any</span>(size <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span> <span style="color: #008000; font-weight: bold">for</span> size <span style="color: #AA22FF; font-weight: bold">in</span> sizes):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>setSizes([<span style="color: #008000">max</span>(<span style="color: #666666">80</span>, <span style="color: #008000">int</span>(size)) <span style="color: #008000; font-weight: bold">for</span> size <span style="color: #AA22FF; font-weight: bold">in</span> sizes])
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_panel_visibility(<span style="color: #666666">0</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>show_corpus_panel)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_panel_visibility(<span style="color: #666666">2</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>show_evidence_panel)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;toggle_corpus_panel_action&quot;</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action<span style="color: #666666">.</span>setChecked(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>show_corpus_panel)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_corpus_panel_action<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;toggle_evidence_panel_action&quot;</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_evidence_panel_action<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_evidence_panel_action<span style="color: #666666">.</span>setChecked(
                <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>show_evidence_panel
            )
            <span style="color: #008000">self</span><span style="color: #666666">.</span>toggle_evidence_panel_action<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_configure_question_settings_menu">Method: _configure_question_settings_menu(self) -&gt; None</h3>
<p>The function `_configure_question_settings_menu` creates a context menu for configuring response settings within the application&#x27;s question input widget. It adds options for selecting the answer length from predefined presets (using an `AnswerLength` enum) and a separate action to set the model. The menu is associated with the question input field, and the current answer length setting is synchronized with the UI actions. The menu includes a checkable action group for exclusive selection of answer length presets, and connects the selection to a handler function for updating the setting. A separator is added before the model selection action, which triggers a method to prompt the user for a model name. Finally, it synchronizes the UI state with the current conversation settings.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_configure_question_settings_menu</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        menu <span style="color: #666666">=</span> QMenu(<span style="color: #BA2121">&quot;Response settings&quot;</span>, <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input)
        length_menu <span style="color: #666666">=</span> menu<span style="color: #666666">.</span>addMenu(<span style="color: #BA2121">&quot;Answer length&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_length_action_group <span style="color: #666666">=</span> QActionGroup(menu)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_length_action_group<span style="color: #666666">.</span>setExclusive(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000; font-weight: bold">for</span> preset <span style="color: #AA22FF; font-weight: bold">in</span> AnswerLength:
            action <span style="color: #666666">=</span> QAction(preset<span style="color: #666666">.</span>name<span style="color: #666666">.</span>title(), menu)
            action<span style="color: #666666">.</span>setCheckable(<span style="color: #008000; font-weight: bold">True</span>)
            action<span style="color: #666666">.</span>setData(preset)
            <span style="color: #008000; font-weight: bold">if</span> preset <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>answer_length:
                action<span style="color: #666666">.</span>setChecked(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_length_action_group<span style="color: #666666">.</span>addAction(action)
            length_menu<span style="color: #666666">.</span>addAction(action)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_length_action_group<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_answer_length_action_triggered)
        menu<span style="color: #666666">.</span>addSeparator()
        model_action <span style="color: #666666">=</span> QAction(<span style="color: #BA2121">&quot;Set model‚Ä¶&quot;</span>, menu)
        model_action<span style="color: #666666">.</span>triggered<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_prompt_model_name)
        menu<span style="color: #666666">.</span>addAction(model_action)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_settings_menu(menu)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_answer_length_actions(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>answer_length)
</code></pre>
<h3 id="_set_panel_visibility">Method: _set_panel_visibility(self, index: int, visible: bool) -&gt; None</h3>
<p>The function `_set_panel_visibility` controls the visibility of a widget within a splitter layout. It takes an index specifying which widget to modify and a boolean value indicating whether the widget should be visible. If the widget exists, it sets the widget&#x27;s visibility based on the boolean value, calling `show()` if visible is True or `hide()` if False. If the widget does not exist, the function returns without taking action.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_set_panel_visibility</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span>, visible: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        widget <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>widget(index) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_splitter&quot;</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> widget <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        widget<span style="color: #666666">.</span>setVisible(<span style="color: #008000">bool</span>(visible))
        <span style="color: #008000; font-weight: bold">if</span> visible:
            widget<span style="color: #666666">.</span>show()
        <span style="color: #008000; font-weight: bold">else</span>:
            widget<span style="color: #666666">.</span>hide()
</code></pre>
<h3 id="_store_splitter_sizes">Method: _store_splitter_sizes(self) -&gt; None</h3>
<p>Stores the current splitter sizes from the UI into the settings service, but only if the splitter exists, has three sections, and at least one section has a non-zero size. The sizes are also cached locally for potential future use.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_store_splitter_sizes</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_splitter&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        sizes <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>sizes()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(sizes) <span style="color: #666666">!=</span> <span style="color: #666666">3</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">any</span>(size <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span> <span style="color: #008000; font-weight: bold">for</span> size <span style="color: #AA22FF; font-weight: bold">in</span> sizes):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_splitter_sizes <span style="color: #666666">=</span> <span style="color: #008000">list</span>(sizes)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>set_splitter_sizes(sizes)
</code></pre>
<h3 id="_restore_splitter_sizes">Method: _restore_splitter_sizes(self) -&gt; None</h3>
<p>The function `_restore_splitter_sizes` restores the splitter widget sizes from either a previously saved state or default settings. It retrieves the last known splitter sizes from the instance&#x27;s attributes, falling back to settings if no saved sizes exist. If the splitter widget exists and valid size data is available, it applies the sizes to the splitter, ensuring each size is at least 80 pixels.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_restore_splitter_sizes</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        sizes <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_last_splitter_sizes&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> sizes:
            sizes <span style="color: #666666">=</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>splitter_sizes)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_splitter&quot;</span>) <span style="color: #AA22FF; font-weight: bold">and</span> sizes <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">len</span>(sizes) <span style="color: #666666">==</span> <span style="color: #666666">3</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>setSizes([<span style="color: #008000">max</span>(<span style="color: #666666">80</span>, <span style="color: #008000">int</span>(size)) <span style="color: #008000; font-weight: bold">for</span> size <span style="color: #AA22FF; font-weight: bold">in</span> sizes])
</code></pre>
<h3 id="_toggle_corpus_panel">Method: _toggle_corpus_panel(self, visible: bool) -&gt; None</h3>
<p>The function `_toggle_corpus_panel` controls the visibility of the corpus panel in the main window. When `visible` is `True`, it updates the settings to show the corpus panel, makes the panel visible, and restores previous splitter sizes. When `visible` is `False`, it stores the current splitter sizes, hides the panel, and updates the settings to hide the corpus panel.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_toggle_corpus_panel</span>(<span style="color: #008000">self</span>, visible: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> visible:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>set_show_corpus_panel(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_panel_visibility(<span style="color: #666666">0</span>, <span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_restore_splitter_sizes()
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_splitter_sizes()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_panel_visibility(<span style="color: #666666">0</span>, <span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>set_show_corpus_panel(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_toggle_evidence_panel">Method: _toggle_evidence_panel(self, visible: bool) -&gt; None</h3>
<p>The function `_toggle_evidence_panel` controls the visibility of an evidence panel within the application&#x27;s user interface. When `visible` is True, it enables the panel by updating the settings to show the evidence panel, making the panel visible, and restoring previous splitter sizes. When `visible` is False, it disables the panel by storing the current splitter sizes, hiding the panel, and updating the settings to hide the evidence panel. The function interacts with `settings_service` to persist the visibility preference and uses helper methods `_set_panel_visibility` and `_restore_splitter_sizes` or `_store_splitter_sizes` to manage the UI state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_toggle_evidence_panel</span>(<span style="color: #008000">self</span>, visible: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> visible:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>set_show_evidence_panel(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_panel_visibility(<span style="color: #666666">2</span>, <span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_restore_splitter_sizes()
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_splitter_sizes()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_panel_visibility(<span style="color: #666666">2</span>, <span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>set_show_evidence_panel(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_on_density_action_triggered">Method: _on_density_action_triggered(self, action: QAction) -&gt; None</h3>
<p>The function `_on_density_action_triggered` is a slot method that handles the triggering of a density-related action in the user interface. It retrieves a data value from the provided `QAction`, checks if the value is a string, and if so, sets the density setting using the `settings_service` and applies the density change by calling `_apply_density`. This function is typically connected to a menu or toolbar action that allows users to select a density option, which then updates both the application&#x27;s settings and its visual representation.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_density_action_triggered</span>(<span style="color: #008000">self</span>, action: QAction) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        value <span style="color: #666666">=</span> action<span style="color: #666666">.</span>data()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(value, <span style="color: #008000">str</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>set_density(value)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_density(value)
</code></pre>
<h3 id="_apply_density">Method: _apply_density(self, density: str | None=None) -&gt; None</h3>
<p>The function `_apply_density` adjusts the spacing and layout density of UI components in the `MainWindow` based on a specified density mode. It retrieves the density setting from the provided argument or falls back to a default value from the settings service. Depending on whether the mode is &quot;compact&quot; or another value (defaulting to &quot;comfortable&quot;), it sets the spacing for layouts within the splitter widgets to either 8 or 12 pixels. It also applies the density mode to the answer view, evidence panel, and question input components.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_density</span>(<span style="color: #008000">self</span>, density: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        mode <span style="color: #666666">=</span> (density <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>density <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;comfortable&quot;</span>)<span style="color: #666666">.</span>lower()
        spacing <span style="color: #666666">=</span> <span style="color: #666666">8</span> <span style="color: #008000; font-weight: bold">if</span> mode <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">12</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_splitter&quot;</span>):
            <span style="color: #008000; font-weight: bold">for</span> index <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>count()):
                widget <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_splitter<span style="color: #666666">.</span>widget(index)
                <span style="color: #008000; font-weight: bold">if</span> widget:
                    layout <span style="color: #666666">=</span> widget<span style="color: #666666">.</span>layout()
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(layout, (QVBoxLayout, QHBoxLayout)):
                        layout<span style="color: #666666">.</span>setSpacing(spacing)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>set_density(mode)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>set_density(mode)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_density(mode)
</code></pre>
<h3 id="_on_scope_chip_cleared">Method: _on_scope_chip_cleared(self) -&gt; None</h3>
<p>The function `_on_scope_chip_cleared` clears the current retrieval scope when all scope values are empty. It resets the scope to default values, updates the session with the new scope, resets the evidence panel&#x27;s scope, updates the scope chip display, and re-asks the last question if one exists, ensuring the UI and search context are synchronized.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_scope_chip_cleared</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">any</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope<span style="color: #666666">.</span>values()):
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;include&quot;</span>: [], <span style="color: #BA2121">&quot;exclude&quot;</span>: []}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(scope<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>reset_scope()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_scope_chip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ask_question(<span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question, triggered_by_scope<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
</code></pre>
<h3 id="_update_scope_chip">Method: _update_scope_chip(self) -&gt; None</h3>
<p>The function `_update_scope_chip` updates the scope chip in the question input UI element. It retrieves the counts of included and excluded items from the current retrieval scope and passes these counts to the `update_scope_chip` method of the `question_input` widget. This likely reflects the number of documents or tags that are explicitly included or excluded from a search or retrieval operation.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_scope_chip</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        include <span style="color: #666666">=</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>, []))
        exclude <span style="color: #666666">=</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;exclude&quot;</span>, []))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>update_scope_chip(include, exclude)
</code></pre>
<h3 id="_on_evidence_locate_requested">Method: _on_evidence_locate_requested(self, payload: dict[str, Any]) -&gt; None</h3>
<p>Handles an evidence locate request by attempting to select a document in the tree based on its ID, and if that fails, focuses the tree by the specified file path.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_evidence_locate_requested</span>(<span style="color: #008000">self</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        document_id <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document_id&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(payload, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> document_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_select_document_in_tree(<span style="color: #008000">int</span>(document_id)):
            <span style="color: #008000; font-weight: bold">return</span>
        path <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(payload, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> path:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_focus_tree_by_path(<span style="color: #008000">str</span>(path))
</code></pre>
<h3 id="_on_copy_evidence_snippet">Method: _on_copy_evidence_snippet(self, snippet: str) -&gt; None</h3>
<p>The function `_on_copy_evidence_snippet` copies a provided text snippet to the system clipboard and displays a notification indicating that the snippet has been copied. It first checks if the snippet is non-empty; if empty, it returns without performing any action. Otherwise, it sets the clipboard content using `QApplication.clipboard().setText()` and triggers a progress notification through `self.progress_service.notify()`. The notification message is &quot;Evidence snippet copied&quot;, with an info level and a duration of 1800 milliseconds.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_copy_evidence_snippet</span>(<span style="color: #008000">self</span>, snippet: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> snippet:
            <span style="color: #008000; font-weight: bold">return</span>
        QApplication<span style="color: #666666">.</span>clipboard()<span style="color: #666666">.</span>setText(snippet)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>notify(<span style="color: #BA2121">&quot;Evidence snippet copied&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=1800</span>)
</code></pre>
<h3 id="_select_document_in_tree">Method: _select_document_in_tree(self, document_id: int) -&gt; bool</h3>
<p>The function `_select_document_in_tree` locates a document within a corpus tree structure by its ID and selects it. It expands all parent items of the found document to ensure visibility, sets the document as the current item in the tree, and scrolls to its position. The function returns `True` if the document is found and selected, otherwise `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_select_document_in_tree</span>(<span style="color: #008000">self</span>, document_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
        root <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>invisibleRootItem()

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">visit</span>(item: QTreeWidgetItem) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
            <span style="color: #008000; font-weight: bold">if</span> item<span style="color: #666666">.</span>data(<span style="color: #666666">0</span>, Qt<span style="color: #666666">.</span>ItemDataRole<span style="color: #666666">.</span>UserRole) <span style="color: #666666">==</span> document_id:
                current <span style="color: #666666">=</span> item
                <span style="color: #008000; font-weight: bold">while</span> current:
                    current<span style="color: #666666">.</span>setExpanded(<span style="color: #008000; font-weight: bold">True</span>)
                    current <span style="color: #666666">=</span> current<span style="color: #666666">.</span>parent()
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setCurrentItem(item)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>scrollToItem(item)
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(item<span style="color: #666666">.</span>childCount()):
                <span style="color: #008000; font-weight: bold">if</span> visit(item<span style="color: #666666">.</span>child(idx)):
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>

        <span style="color: #008000; font-weight: bold">for</span> index <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(root<span style="color: #666666">.</span>childCount()):
            <span style="color: #008000; font-weight: bold">if</span> visit(root<span style="color: #666666">.</span>child(index)):
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
<details>
<summary>Subfunction: visit(item: QTreeWidgetItem) -&gt; bool</summary>
<h4 id="visit">visit(item: QTreeWidgetItem) -&gt; bool</h4>
<p>The function `visit` is a recursive method that searches through a `QTreeWidgetItem` hierarchy to find a specific item based on a matching `document_id`. When the item is found, it expands all parent items in the tree, selects the item, and scrolls to its position. The function returns `True` if the item is found and processed, otherwise `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">visit</span>(item: QTreeWidgetItem) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
            <span style="color: #008000; font-weight: bold">if</span> item<span style="color: #666666">.</span>data(<span style="color: #666666">0</span>, Qt<span style="color: #666666">.</span>ItemDataRole<span style="color: #666666">.</span>UserRole) <span style="color: #666666">==</span> document_id:
                current <span style="color: #666666">=</span> item
                <span style="color: #008000; font-weight: bold">while</span> current:
                    current<span style="color: #666666">.</span>setExpanded(<span style="color: #008000; font-weight: bold">True</span>)
                    current <span style="color: #666666">=</span> current<span style="color: #666666">.</span>parent()
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setCurrentItem(item)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>scrollToItem(item)
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(item<span style="color: #666666">.</span>childCount()):
                <span style="color: #008000; font-weight: bold">if</span> visit(item<span style="color: #666666">.</span>child(idx)):
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
</details>
<h3 id="_focus_tree_by_path">Method: _focus_tree_by_path(self, path: str) -&gt; None</h3>
<p>The function `_focus_tree_by_path` navigates and focuses a specific item in a corpus tree structure based on a provided file path. It searches through the tree recursively, comparing each item&#x27;s tooltip (which contains a file path) with the target path. When a match is found, it expands all parent items of the matching node, sets the node as the current item in the tree, and scrolls to its position. The function uses a helper nested function `visit` to perform the recursive traversal of the tree. If no matching path is found, the function returns without making changes.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_focus_tree_by_path</span>(<span style="color: #008000">self</span>, path: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        target <span style="color: #666666">=</span> Path(path)
        root <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>invisibleRootItem()

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">visit</span>(item: QTreeWidgetItem) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
            tooltip <span style="color: #666666">=</span> item<span style="color: #666666">.</span>toolTip(<span style="color: #666666">0</span>)
            <span style="color: #008000; font-weight: bold">if</span> tooltip:
                <span style="color: #008000; font-weight: bold">try</span>:
                    current_path <span style="color: #666666">=</span> Path(tooltip)
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
                    current_path <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
                <span style="color: #008000; font-weight: bold">if</span> current_path <span style="color: #AA22FF; font-weight: bold">and</span> current_path <span style="color: #666666">==</span> target:
                    current <span style="color: #666666">=</span> item
                    <span style="color: #008000; font-weight: bold">while</span> current:
                        current<span style="color: #666666">.</span>setExpanded(<span style="color: #008000; font-weight: bold">True</span>)
                        current <span style="color: #666666">=</span> current<span style="color: #666666">.</span>parent()
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setCurrentItem(item)
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>scrollToItem(item)
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(item<span style="color: #666666">.</span>childCount()):
                <span style="color: #008000; font-weight: bold">if</span> visit(item<span style="color: #666666">.</span>child(idx)):
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>

        <span style="color: #008000; font-weight: bold">for</span> index <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(root<span style="color: #666666">.</span>childCount()):
            <span style="color: #008000; font-weight: bold">if</span> visit(root<span style="color: #666666">.</span>child(index)):
                <span style="color: #008000; font-weight: bold">return</span>
</code></pre>
<details>
<summary>Subfunction: visit(item: QTreeWidgetItem) -&gt; bool</summary>
<h4 id="visit">visit(item: QTreeWidgetItem) -&gt; bool</h4>
<p>The function `visit` is a recursive method that traverses a `QTreeWidgetItem` hierarchy to locate a specific item based on a matching path. It checks the tooltip of each item to extract a path, compares it with a target path, and if a match is found, expands all parent items and selects the matching item in a tree view. The function returns `True` if the target item is found and processed, otherwise `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">visit</span>(item: QTreeWidgetItem) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
            tooltip <span style="color: #666666">=</span> item<span style="color: #666666">.</span>toolTip(<span style="color: #666666">0</span>)
            <span style="color: #008000; font-weight: bold">if</span> tooltip:
                <span style="color: #008000; font-weight: bold">try</span>:
                    current_path <span style="color: #666666">=</span> Path(tooltip)
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
                    current_path <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
                <span style="color: #008000; font-weight: bold">if</span> current_path <span style="color: #AA22FF; font-weight: bold">and</span> current_path <span style="color: #666666">==</span> target:
                    current <span style="color: #666666">=</span> item
                    <span style="color: #008000; font-weight: bold">while</span> current:
                        current<span style="color: #666666">.</span>setExpanded(<span style="color: #008000; font-weight: bold">True</span>)
                        current <span style="color: #666666">=</span> current<span style="color: #666666">.</span>parent()
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setCurrentItem(item)
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>scrollToItem(item)
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(item<span style="color: #666666">.</span>childCount()):
                <span style="color: #008000; font-weight: bold">if</span> visit(item<span style="color: #666666">.</span>child(idx)):
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
</details>
<h3 id="_initialise_project_state">Method: _initialise_project_state(self) -&gt; None</h3>
<p>The function `_initialise_project_state` initializes the project state by refreshing the project selector and loading the session for the currently active project. It retrieves the active project using `self.project_service.active_project()` and then loads its session data using `self._load_project_session(active.id)`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_initialise_project_state</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_refresh_project_selector()
        active <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_project_session(active<span style="color: #666666">.</span>id)
</code></pre>
<h3 id="_refresh_project_selector">Method: _refresh_project_selector(self) -&gt; None</h3>
<p>The function `_refresh_project_selector` updates the project selection dropdown in the main window UI. It retrieves the list of available projects from the project service, clears the current items in the combo box, and repopulates it with project names and IDs. It identifies the currently active project and sets it as the selected item in the dropdown. Signal blocking is used to prevent triggering events during the update. Finally, it enables or disables the delete project action based on whether more than one project exists.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_refresh_project_selector</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        projects <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>list_projects()
        current_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>clear()
        current_index <span style="color: #666666">=</span> <span style="color: #666666">-1</span>
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> projects:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>addItem(record<span style="color: #666666">.</span>name, record<span style="color: #666666">.</span>id)
            <span style="color: #008000; font-weight: bold">if</span> record<span style="color: #666666">.</span>id <span style="color: #666666">==</span> current_id:
                current_index <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>count() <span style="color: #666666">-</span> <span style="color: #666666">1</span>
        <span style="color: #008000; font-weight: bold">if</span> current_index <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>setCurrentIndex(current_index)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>delete_project_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000">len</span>(projects) <span style="color: #666666">&gt;</span> <span style="color: #666666">1</span>)
</code></pre>
<h3 id="_on_projects_changed">Method: _on_projects_changed(self, _projects: list[ProjectRecord]) -&gt; None</h3>
<p>The function `_on_projects_changed` is triggered when the list of projects is modified. It calls `_refresh_project_selector()` to update the project selection interface element.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_projects_changed</span>(<span style="color: #008000">self</span>, _projects: <span style="color: #008000">list</span>[ProjectRecord]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_refresh_project_selector()
</code></pre>
<h3 id="_on_active_project_changed">Method: _on_active_project_changed(self, project: ProjectRecord) -&gt; None</h3>
<p>The function `_on_active_project_changed` is triggered when the active project in the application is changed. It performs two main actions: first, it refreshes the project selector UI element by calling `_refresh_project_selector()`. Second, it initializes a new `SearchService` instance using components from the `project_service`, and then loads the session data associated with the newly selected project by calling `_load_project_session(project.id)`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_active_project_changed</span>(<span style="color: #008000">self</span>, project: ProjectRecord) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_refresh_project_selector()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>search_service <span style="color: #666666">=</span> SearchService(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>ingest,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>documents,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>chats,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_project_session(project<span style="color: #666666">.</span>id)
</code></pre>
<h3 id="_on_project_combo_changed">Method: _on_project_combo_changed(self, index: int) -&gt; None</h3>
<p>The function `_on_project_combo_changed` handles the event when the selected project in a combo box is changed. It retrieves the project ID from the combo box, checks if it&#x27;s valid and different from the currently active project, and if so, stores the current session and updates the active project in the project service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_project_combo_changed</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_combo<span style="color: #666666">.</span>itemData(index)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(project_id, <span style="color: #008000">int</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">if</span> project_id <span style="color: #666666">==</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_active_project_session()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>set_active_project(project_id)
</code></pre>
<h3 id="_load_project_session">Method: _load_project_session(self, project_id: int) -&gt; None</h3>
<p>Loads and initializes a project session based on the provided project ID. Retrieves conversation settings, turns, and retrieval scope from the session, and updates the UI components including the answer view, evidence panel, and corpus actions. Restores the conversation context, applies settings, and refreshes related UI elements.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_load_project_session</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        session <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_sessions<span style="color: #666666">.</span>get(project_id)
        <span style="color: #008000; font-weight: bold">if</span> session <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            snapshot <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>load_conversation_settings(project_id)
            session <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;settings&quot;</span>: snapshot}
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_sessions[project_id] <span style="color: #666666">=</span> session
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns <span style="color: #666666">=</span> <span style="color: #008000">list</span>(session<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;turns&quot;</span>, []))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>turns <span style="color: #666666">=</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turns)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>render_turns(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turns)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>cards[<span style="color: #666666">-1</span>] <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>cards <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        scope <span style="color: #666666">=</span> session<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;scope&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(scope, <span style="color: #008000">dict</span>):
            include <span style="color: #666666">=</span> <span style="color: #008000">list</span>(scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>, []))
            exclude <span style="color: #666666">=</span> <span style="color: #008000">list</span>(scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;exclude&quot;</span>, []))
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;include&quot;</span>: include, <span style="color: #BA2121">&quot;exclude&quot;</span>: exclude}
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;include&quot;</span>: [], <span style="color: #BA2121">&quot;exclude&quot;</span>: []}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question <span style="color: #666666">=</span> session<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;last_question&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_conversation_settings_snapshot(session<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;settings&quot;</span>))
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns[<span style="color: #666666">-1</span>]<span style="color: #666666">.</span>citations:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>set_evidence(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turns[<span style="color: #666666">-1</span>]<span style="color: #666666">.</span>citations)
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>clear()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_export_actions()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>selected_index <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_refresh_corpus_view()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_corpus_actions()
</code></pre>
<h3 id="_snapshot_conversation_settings">Method: _snapshot_conversation_settings(self) -&gt; dict[str, Any]</h3>
<p>The function `_snapshot_conversation_settings` returns a dictionary containing the current conversation settings. The dictionary includes the reasoning verbosity level, whether to show the plan and assumptions, whether sources-only mode is enabled, the answer length setting, and the selected model name. These values are extracted from the `conversation_settings` attribute of the `MainWindow` class.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_snapshot_conversation_settings</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        <span style="color: #008000; font-weight: bold">return</span> {
            <span style="color: #BA2121">&quot;reasoning_verbosity&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>reasoning_verbosity<span style="color: #666666">.</span>value,
            <span style="color: #BA2121">&quot;show_plan&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_plan,
            <span style="color: #BA2121">&quot;show_assumptions&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_assumptions,
            <span style="color: #BA2121">&quot;sources_only&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>sources_only_mode,
            <span style="color: #BA2121">&quot;answer_length&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>answer_length<span style="color: #666666">.</span>value,
            <span style="color: #BA2121">&quot;model&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>model_name,
        }
</code></pre>
<h3 id="_apply_conversation_settings_snapshot">Method: _apply_conversation_settings_snapshot(self, snapshot: Any) -&gt; None</h3>
<p>The function `_apply_conversation_settings_snapshot` updates conversation settings based on a provided snapshot dictionary. It processes parameters such as reasoning verbosity, plan visibility, assumption visibility, sources-only mode, answer length, and model name. For each parameter, it resolves the value to the appropriate enumerated type if necessary, and applies the setting only if it differs from the current configuration. The function also configures the LMStudio client with the specified model name if provided.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_conversation_settings_snapshot</span>(<span style="color: #008000">self</span>, snapshot: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> snapshot <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(snapshot, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
        verbosity <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;reasoning_verbosity&quot;</span>)
        resolved: ReasoningVerbosity <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(verbosity, <span style="color: #008000">str</span>):
            <span style="color: #008000; font-weight: bold">try</span>:
                resolved <span style="color: #666666">=</span> ReasoningVerbosity[verbosity<span style="color: #666666">.</span>upper()]
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">KeyError</span>:
                <span style="color: #008000; font-weight: bold">try</span>:
                    resolved <span style="color: #666666">=</span> ReasoningVerbosity(verbosity)
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
                    resolved <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(verbosity, ReasoningVerbosity):
            resolved <span style="color: #666666">=</span> verbosity
        <span style="color: #008000; font-weight: bold">if</span> resolved <span style="color: #AA22FF; font-weight: bold">and</span> resolved <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>reasoning_verbosity:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_reasoning_verbosity(resolved)
        plan <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;show_plan&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(plan, <span style="color: #008000">bool</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_show_plan(plan)
        assumptions <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;show_assumptions&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(assumptions, <span style="color: #008000">bool</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_show_assumptions(assumptions)
        sources_only <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;sources_only&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(sources_only, <span style="color: #008000">bool</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_sources_only_mode(sources_only)
        answer_length <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;answer_length&quot;</span>)
        resolved_length: AnswerLength <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(answer_length, <span style="color: #008000">str</span>):
            <span style="color: #008000; font-weight: bold">try</span>:
                resolved_length <span style="color: #666666">=</span> AnswerLength[answer_length<span style="color: #666666">.</span>upper()]
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">KeyError</span>:
                <span style="color: #008000; font-weight: bold">try</span>:
                    resolved_length <span style="color: #666666">=</span> AnswerLength(answer_length)
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
                    resolved_length <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(answer_length, AnswerLength):
            resolved_length <span style="color: #666666">=</span> answer_length
        <span style="color: #008000; font-weight: bold">if</span> resolved_length <span style="color: #AA22FF; font-weight: bold">and</span> resolved_length <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>answer_length:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_answer_length(resolved_length)
        model <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;model&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(model, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> model<span style="color: #666666">.</span>strip():
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_model_name(model)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>lmstudio_client<span style="color: #666666">.</span>configure(model<span style="color: #666666">=</span>model<span style="color: #666666">.</span>strip())
</code></pre>
<h3 id="_update_session">Method: _update_session(self, project_id: int | None=None, **fields: Any) -&gt; None</h3>
<p>The function `_update_session` updates or initializes a session dictionary for a specified project ID. If no project ID is provided, it uses the currently active project ID from the project service. It retrieves or creates a session dictionary associated with the project ID and updates it with the provided key-value pairs from `fields`. The session dictionaries are stored in `_project_sessions`, which maps project IDs to their respective session data.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_session</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>, <span style="color: #666666">**</span>fields: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> project_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        session <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_sessions<span style="color: #666666">.</span>setdefault(project_id, {})
        session<span style="color: #666666">.</span>update(fields)
</code></pre>
<h3 id="_store_active_project_session">Method: _store_active_project_session(self) -&gt; None</h3>
<p>Stores the current session state for the active project by capturing the conversation settings, turns, retrieval scope, and last question. It updates the session in the project service and saves the conversation settings.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_store_active_project_session</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        snapshot <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_snapshot_conversation_settings()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(
            project_id,
            turns<span style="color: #666666">=</span><span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turns),
            scope<span style="color: #666666">=</span><span style="color: #008000">dict</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope),
            last_question<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question,
            settings<span style="color: #666666">=</span>snapshot,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>save_conversation_settings(project_id, snapshot)
</code></pre>
<h3 id="_build_default_export_path">Method: _build_default_export_path(self, suffix: str) -&gt; str</h3>
<p>The function `_build_default_export_path` constructs a file path for exporting data related to the active project. It retrieves the active project, sanitizes its name to create a URL-safe slug, and uses the project&#x27;s storage location or the default storage root to determine the base directory. The resulting path combines the base directory, the sanitized project name (with a specified suffix), and returns it as a string.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_default_export_path</span>(<span style="color: #008000">self</span>, suffix: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        safe <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(ch<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">if</span> ch<span style="color: #666666">.</span>isalnum() <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;-&quot;</span> <span style="color: #008000; font-weight: bold">for</span> ch <span style="color: #AA22FF; font-weight: bold">in</span> project<span style="color: #666666">.</span>name)
        slug <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;-&quot;</span><span style="color: #666666">.</span>join(<span style="color: #008000">filter</span>(<span style="color: #008000; font-weight: bold">None</span>, safe<span style="color: #666666">.</span>split(<span style="color: #BA2121">&quot;-&quot;</span>))) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;project&quot;</span>
        location <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>get_project_storage_location(project<span style="color: #666666">.</span>id)
        base <span style="color: #666666">=</span> Path(location) <span style="color: #008000; font-weight: bold">if</span> location <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> Path(<span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>storage_root)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(base <span style="color: #666666">/</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>slug<span style="color: #A45A77; font-weight: bold">}{</span>suffix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
</code></pre>
<h3 id="_ingest_include_patterns">Method: _ingest_include_patterns(self) -&gt; list[str]</h3>
<p>The function `_ingest_include_patterns` returns a list of supported file patterns for document ingestion. It retrieves these patterns from the `SUPPORTED_PATTERNS` constant and converts them into a list. This list is used to determine which file types can be processed during corpus ingestion.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_ingest_include_patterns</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">list</span>(SUPPORTED_PATTERNS)
</code></pre>
<h3 id="_ingest_file_filter_spec">Method: _ingest_file_filter_spec(self) -&gt; str</h3>
<p>The function `_ingest_file_filter_spec` constructs a file filter string for document ingestion. It retrieves include patterns using `_ingest_include_patterns`, joins them into a single string, and formats them into a filter specification suitable for file dialogs. The resulting string defines a filter named &quot;Documents&quot; that includes files matching the specified patterns, followed by an &quot;All Files&quot; option.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_ingest_file_filter_spec</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        patterns <span style="color: #666666">=</span> <span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">.</span>join(<span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_include_patterns())
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">f&quot;Documents (</span><span style="color: #A45A77; font-weight: bold">{</span>patterns<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">);;All Files (*)&quot;</span>
</code></pre>
<h3 id="_add_folder_to_corpus">Method: _add_folder_to_corpus(self, _checked: bool=False) -&gt; None</h3>
<p>The function `_add_folder_to_corpus` prompts the user to select a folder for indexing, queues the folder crawl using the ingest service, registers the job, updates the project&#x27;s corpus roots, and displays a notification. It handles exceptions during the queuing process by showing an error message. The function integrates with the project and ingest services to manage corpus ingestion and updates the UI accordingly.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_add_folder_to_corpus</span>(<span style="color: #008000">self</span>, _checked: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        roots <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>list_corpus_roots(project<span style="color: #666666">.</span>id)
        initial <span style="color: #666666">=</span> roots[<span style="color: #666666">-1</span>] <span style="color: #008000; font-weight: bold">if</span> roots <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>
        folder <span style="color: #666666">=</span> QFileDialog<span style="color: #666666">.</span>getExistingDirectory(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Select Folder to Index&quot;</span>,
            initial,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> folder:
            <span style="color: #008000; font-weight: bold">return</span>
        include <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_include_patterns()
        <span style="color: #008000; font-weight: bold">try</span>:
            job_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest_service<span style="color: #666666">.</span>queue_folder_crawl(
                project<span style="color: #666666">.</span>id,
                folder,
                include<span style="color: #666666">=</span>include,
            )
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
            QMessageBox<span style="color: #666666">.</span>critical(
                <span style="color: #008000">self</span>,
                <span style="color: #BA2121">&quot;Add Folder&quot;</span>,
                <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to start indexing for the selected folder.&quot;</span>,
            )
            <span style="color: #008000; font-weight: bold">return</span>
        folder_name <span style="color: #666666">=</span> Path(folder)<span style="color: #666666">.</span>name <span style="color: #AA22FF; font-weight: bold">or</span> Path(folder)<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>name <span style="color: #AA22FF; font-weight: bold">or</span> folder
        description <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Indexing </span><span style="color: #A45A77; font-weight: bold">{</span>folder_name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_register_ingest_job(
            job_id,
            project_id<span style="color: #666666">=</span>project<span style="color: #666666">.</span>id,
            description<span style="color: #666666">=</span>description,
            root<span style="color: #666666">=</span>folder,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>add_corpus_root(project<span style="color: #666666">.</span>id, folder)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_corpus_actions()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Folder queued for indexing.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2500</span>)
</code></pre>
<h3 id="_add_files_to_corpus">Method: _add_files_to_corpus(self, _checked: bool=False) -&gt; None</h3>
<p>The function `_add_files_to_corpus` allows the user to select files for indexing into the active project&#x27;s corpus. It retrieves the active project, displays a file dialog to choose files based on a specified filter, and queues the selected files for ingestion using the ingest service. If no files are selected or an error occurs during queuing, it shows an appropriate error message. Upon successful queuing, it registers the ingestion job with a description and root directory, and displays a notification indicating that the files have been queued for indexing.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_add_files_to_corpus</span>(<span style="color: #008000">self</span>, _checked: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        filter_spec <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_file_filter_spec()
        files, _ <span style="color: #666666">=</span> QFileDialog<span style="color: #666666">.</span>getOpenFileNames(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Select Files to Index&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            filter_spec,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> files:
            <span style="color: #008000; font-weight: bold">return</span>
        include <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_include_patterns()
        <span style="color: #008000; font-weight: bold">try</span>:
            job_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest_service<span style="color: #666666">.</span>queue_file_add(
                project<span style="color: #666666">.</span>id,
                files,
                include<span style="color: #666666">=</span>include,
            )
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
            QMessageBox<span style="color: #666666">.</span>critical(
                <span style="color: #008000">self</span>,
                <span style="color: #BA2121">&quot;Add Files&quot;</span>,
                <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to start indexing for the selected files.&quot;</span>,
            )
            <span style="color: #008000; font-weight: bold">return</span>
        description <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Indexing </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">len</span>(files)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> file(s)&quot;</span>
        root <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(files[<span style="color: #666666">0</span>])<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>parent)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_register_ingest_job(
            job_id,
            project_id<span style="color: #666666">=</span>project<span style="color: #666666">.</span>id,
            description<span style="color: #666666">=</span>description,
            root<span style="color: #666666">=</span>root,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Files queued for indexing.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2500</span>)
</code></pre>
<h3 id="_rescan_corpus">Method: _rescan_corpus(self, _checked: bool=False) -&gt; None</h3>
<p>The function `_rescan_corpus` initiates a rescan of all indexed corpus roots within the active project. It retrieves the list of corpus roots associated with the project and checks if any exist. If no roots are found, it displays an information message to the user. For each root, it attempts to queue a rescan job using the ingest service, handling potential exceptions by showing a warning message. Each successfully queued job is registered with a descriptive label, and a toast notification is displayed indicating how many folders were queued for rescanning.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_rescan_corpus</span>(<span style="color: #008000">self</span>, _checked: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        roots <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>list_corpus_roots(project<span style="color: #666666">.</span>id)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> roots:
            QMessageBox<span style="color: #666666">.</span>information(
                <span style="color: #008000">self</span>,
                <span style="color: #BA2121">&quot;Rescan Corpus&quot;</span>,
                <span style="color: #BA2121">&quot;No indexed folders are available to rescan.&quot;</span>,
            )
            <span style="color: #008000; font-weight: bold">return</span>
        include <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_include_patterns()
        queued <span style="color: #666666">=</span> <span style="color: #666666">0</span>
        <span style="color: #008000; font-weight: bold">for</span> root <span style="color: #AA22FF; font-weight: bold">in</span> roots:
            <span style="color: #008000; font-weight: bold">try</span>:
                job_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest_service<span style="color: #666666">.</span>queue_rescan(
                    project<span style="color: #666666">.</span>id,
                    root,
                    include<span style="color: #666666">=</span>include,
                )
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
                QMessageBox<span style="color: #666666">.</span>warning(
                    <span style="color: #008000">self</span>,
                    <span style="color: #BA2121">&quot;Rescan Corpus&quot;</span>,
                    <span style="color: #BA2121">f&quot;Failed to queue rescan for </span><span style="color: #A45A77; font-weight: bold">{</span>root<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>exc<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
                )
                <span style="color: #008000; font-weight: bold">continue</span>
            root_name <span style="color: #666666">=</span> Path(root)<span style="color: #666666">.</span>name <span style="color: #AA22FF; font-weight: bold">or</span> Path(root)<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>name <span style="color: #AA22FF; font-weight: bold">or</span> root
            description <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Rescanning </span><span style="color: #A45A77; font-weight: bold">{</span>root_name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_register_ingest_job(
                job_id,
                project_id<span style="color: #666666">=</span>project<span style="color: #666666">.</span>id,
                description<span style="color: #666666">=</span>description,
                root<span style="color: #666666">=</span>root,
            )
            queued <span style="color: #666666">+=</span> <span style="color: #666666">1</span>
        <span style="color: #008000; font-weight: bold">if</span> queued:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(
                <span style="color: #BA2121">f&quot;Queued rescan for </span><span style="color: #A45A77; font-weight: bold">{</span>queued<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> folder(s).&quot;</span>,
                level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>,
                duration_ms<span style="color: #666666">=2500</span>,
            )
</code></pre>
<h3 id="_register_ingest_job">Method: _register_ingest_job(self, job_id: int, *, project_id: int, description: str, root: str | None=None) -&gt; None</h3>
<p>Registers an ingest job with the specified parameters and initializes its progress tracking. The job is stored in `_ingest_jobs` with a unique task ID derived from the job ID, and its progress is started using the `progress_service`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_register_ingest_job</span>(
        <span style="color: #008000">self</span>,
        job_id: <span style="color: #008000">int</span>,
        <span style="color: #666666">*</span>,
        project_id: <span style="color: #008000">int</span>,
        description: <span style="color: #008000">str</span>,
        root: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        task_id <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;ingest-</span><span style="color: #A45A77; font-weight: bold">{</span>job_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_jobs[job_id] <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;task_id&quot;</span>: task_id,
            <span style="color: #BA2121">&quot;project_id&quot;</span>: project_id,
            <span style="color: #BA2121">&quot;description&quot;</span>: description,
            <span style="color: #BA2121">&quot;root&quot;</span>: root,
        }
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>start(task_id, description)
</code></pre>
<h3 id="_enqueue_ingest_update">Method: _enqueue_ingest_update(self, job_id: int, payload: dict[str, Any]) -&gt; None</h3>
<p>The function `_enqueue_ingest_update` adds an ingest update task to a queue. It takes a `job_id` and a `payload` dictionary as input parameters and places them into `self._ingest_updates`, which is expected to be a queue-like structure for managing ingest-related updates. The function does not return any value.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_enqueue_ingest_update</span>(<span style="color: #008000">self</span>, job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_updates<span style="color: #666666">.</span>put((job_id, payload))
</code></pre>
<h3 id="_drain_ingest_updates">Method: _drain_ingest_updates(self) -&gt; None</h3>
<p>The function `_drain_ingest_updates` processes all available ingest updates from a queue. It continuously retrieves items from `self._ingest_updates` using `get_nowait()` until the queue is empty, then calls `_handle_ingest_update` for each retrieved item. The function does not block and handles any `queue.Empty` exception by breaking out of the loop when no more items are present.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_drain_ingest_updates</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000; font-weight: bold">True</span>:
            <span style="color: #008000; font-weight: bold">try</span>:
                job_id, payload <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_updates<span style="color: #666666">.</span>get_nowait()
            <span style="color: #008000; font-weight: bold">except</span> queue<span style="color: #666666">.</span>Empty:
                <span style="color: #008000; font-weight: bold">break</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_handle_ingest_update(job_id, payload)
</code></pre>
<h3 id="_handle_ingest_update">Method: _handle_ingest_update(self, job_id: int, payload: dict[str, Any]) -&gt; None</h3>
<p>Handles updates to an ongoing ingest job, updating progress, status, and results. It processes job information from `_ingest_jobs`, updates the UI via `progress_service`, and applies results or shows notifications based on the task&#x27;s status (running, paused, completed, cancelled, failed). Removes the job from `_ingest_jobs` upon completion or failure.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_handle_ingest_update</span>(<span style="color: #008000">self</span>, job_id: <span style="color: #008000">int</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        job_info <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_jobs<span style="color: #666666">.</span>get(job_id)
        <span style="color: #008000; font-weight: bold">if</span> job_info <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        task_id <span style="color: #666666">=</span> job_info[<span style="color: #BA2121">&quot;task_id&quot;</span>]
        description <span style="color: #666666">=</span> job_info<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;description&quot;</span>, <span style="color: #BA2121">&quot;Indexing corpus&quot;</span>)
        status <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>)
        progress <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;progress&quot;</span>, {}) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(payload, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
        total <span style="color: #666666">=</span> <span style="color: #008000">int</span>(progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;total&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #666666">0</span>)
        processed <span style="color: #666666">=</span> <span style="color: #008000">int</span>(progress<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;processed&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #666666">0</span>)
        <span style="color: #008000; font-weight: bold">if</span> status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>RUNNING:
            message <span style="color: #666666">=</span> (
                <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> (</span><span style="color: #A45A77; font-weight: bold">{</span>processed<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">/</span><span style="color: #A45A77; font-weight: bold">{</span>total<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">)&quot;</span> <span style="color: #008000; font-weight: bold">if</span> total <span style="color: #008000; font-weight: bold">else</span> description
            )
            percent <span style="color: #666666">=</span> (processed <span style="color: #666666">/</span> total <span style="color: #666666">*</span> <span style="color: #666666">100.0</span>) <span style="color: #008000; font-weight: bold">if</span> total <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>update(task_id, message<span style="color: #666666">=</span>message, percent<span style="color: #666666">=</span>percent)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">if</span> status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>PAUSED:
            message <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> (paused)&quot;</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>update(task_id, message<span style="color: #666666">=</span>message, indeterminate<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">if</span> status <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> TaskStatus<span style="color: #666666">.</span>FINAL:
            <span style="color: #008000; font-weight: bold">return</span>

        summary <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, {}) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(payload, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
        errors <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;errors&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;errors&quot;</span>)

        <span style="color: #008000; font-weight: bold">if</span> status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>COMPLETED:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>finish(task_id, <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> complete&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_ingest_results(job_info, payload)
            success <span style="color: #666666">=</span> <span style="color: #008000">int</span>(summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;success_count&quot;</span>, <span style="color: #666666">0</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #666666">0</span>)
            removed <span style="color: #666666">=</span> summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;removed&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
            details <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Indexed </span><span style="color: #A45A77; font-weight: bold">{</span>success<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> document(s)&quot;</span>
            <span style="color: #008000; font-weight: bold">if</span> removed:
                details <span style="color: #666666">+=</span> <span style="color: #BA2121">f&quot;, removed </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">len</span>(removed)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(details <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=3500</span>)
        <span style="color: #008000; font-weight: bold">elif</span> status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>CANCELLED:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>finish(task_id, <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> cancelled&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Ingest cancelled.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;warning&quot;</span>, duration_ms<span style="color: #666666">=3000</span>)
        <span style="color: #008000; font-weight: bold">elif</span> status <span style="color: #666666">==</span> TaskStatus<span style="color: #666666">.</span>FAILED:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>finish(task_id, <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> failed&quot;</span>)
            message <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;; &quot;</span><span style="color: #666666">.</span>join(<span style="color: #008000">str</span>(err) <span style="color: #008000; font-weight: bold">for</span> err <span style="color: #AA22FF; font-weight: bold">in</span> errors) <span style="color: #008000; font-weight: bold">if</span> errors <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;Ingest failed&quot;</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(message, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;error&quot;</span>, duration_ms<span style="color: #666666">=5000</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_jobs<span style="color: #666666">.</span>pop(job_id, <span style="color: #008000; font-weight: bold">None</span>)
</code></pre>
<h3 id="_apply_ingest_results">Method: _apply_ingest_results(self, job_info: dict[str, Any], payload: dict[str, Any]) -&gt; None</h3>
<p>The function `_apply_ingest_results` processes the results of a document ingestion job. It retrieves the project ID from the job information and, if valid, extracts summary data including known files and removed items. It synchronizes the document list with the known files and updates the corpus view and actions. It attempts to export a database snapshot for the project and stores the snapshot path in the project sessions if successful. If the export fails, it logs the exception.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_ingest_results</span>(<span style="color: #008000">self</span>, job_info: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any], payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project_id <span style="color: #666666">=</span> job_info<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;project_id&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(project_id, <span style="color: #008000">int</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        summary <span style="color: #666666">=</span> payload<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;summary&quot;</span>, {}) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(payload, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
        known_files <span style="color: #666666">=</span> summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;known_files&quot;</span>, {}) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(summary, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
        removed <span style="color: #666666">=</span> summary<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;removed&quot;</span>, []) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(summary, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> []
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_documents_with_known_files(project_id, known_files, removed)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_refresh_corpus_view()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_corpus_actions()
        <span style="color: #008000; font-weight: bold">try</span>:
            snapshot <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>export_project_database_snapshot(project_id)
        <span style="color: #008000; font-weight: bold">except</span> DatabaseError:
            LOGGER<span style="color: #666666">.</span>exception(
                <span style="color: #BA2121">&quot;Failed to write database snapshot for project </span><span style="color: #A45A77; font-weight: bold">%s</span><span style="color: #BA2121">&quot;</span>, project_id
            )
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">if</span> snapshot <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                session <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_sessions<span style="color: #666666">.</span>setdefault(project_id, {})
                session[<span style="color: #BA2121">&quot;database_snapshot&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">str</span>(snapshot)
</code></pre>
<h3 id="_sync_documents_with_known_files">Method: _sync_documents_with_known_files(self, project_id: int, known_files: Any, removed: Any) -&gt; None</h3>
<p>The function `_sync_documents_with_known_files` synchronizes the list of documents stored in a project with a set of known files. It takes a project ID, a dictionary or structure of known files, and a list of removed file paths as inputs. The function first retrieves all existing documents for the project and maps them by their resolved source paths. It then processes the known files, creating new document entries for any files not already present in the project, and updates metadata for existing documents if changes are detected. Finally, it removes from the project any documents whose source paths are found in the list of removed files. The function ensures that the document repository stays aligned with the actual file system state by adding, updating, or deleting document records as needed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sync_documents_with_known_files</span>(
        <span style="color: #008000">self</span>,
        project_id: <span style="color: #008000">int</span>,
        known_files: Any,
        removed: Any,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        repo <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>documents
        existing_docs <span style="color: #666666">=</span> {
            <span style="color: #008000">str</span>(Path(doc[<span style="color: #BA2121">&quot;source_path&quot;</span>])<span style="color: #666666">.</span>resolve()): doc
            <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> repo<span style="color: #666666">.</span>list_for_project(project_id)
            <span style="color: #008000; font-weight: bold">if</span> doc<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
        }
        normalized_known: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(known_files, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">for</span> path, metadata <span style="color: #AA22FF; font-weight: bold">in</span> known_files<span style="color: #666666">.</span>items():
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(path, <span style="color: #008000">str</span>):
                    <span style="color: #008000; font-weight: bold">continue</span>
                normalized_path <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve())
                normalized_known[normalized_path] <span style="color: #666666">=</span> (
                    <span style="color: #008000">dict</span>(metadata) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(metadata, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
                )
                document <span style="color: #666666">=</span> existing_docs<span style="color: #666666">.</span>get(normalized_path)
                payload <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;file&quot;</span>: normalized_known[normalized_path]}
                <span style="color: #008000; font-weight: bold">if</span> document <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                    title <span style="color: #666666">=</span> Path(normalized_path)<span style="color: #666666">.</span>stem <span style="color: #AA22FF; font-weight: bold">or</span> Path(normalized_path)<span style="color: #666666">.</span>name
                    repo<span style="color: #666666">.</span>create(
                        project_id,
                        title,
                        source_type<span style="color: #666666">=</span><span style="color: #BA2121">&quot;file&quot;</span>,
                        source_path<span style="color: #666666">=</span>normalized_path,
                        metadata<span style="color: #666666">=</span>payload,
                    )
                <span style="color: #008000; font-weight: bold">else</span>:
                    updates: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
                    <span style="color: #008000; font-weight: bold">if</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>) <span style="color: #666666">!=</span> normalized_path:
                        updates[<span style="color: #BA2121">&quot;source_path&quot;</span>] <span style="color: #666666">=</span> normalized_path
                    current_meta <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;metadata&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
                    <span style="color: #008000; font-weight: bold">if</span> current_meta<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;file&quot;</span>) <span style="color: #666666">!=</span> normalized_known[normalized_path]:
                        updates[<span style="color: #BA2121">&quot;metadata&quot;</span>] <span style="color: #666666">=</span> payload
                    <span style="color: #008000; font-weight: bold">if</span> updates:
                        repo<span style="color: #666666">.</span>update(document[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #666666">**</span>updates)
        removed_paths <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(removed, (<span style="color: #008000">list</span>, <span style="color: #008000">tuple</span>, <span style="color: #008000">set</span>)):
            removed_paths <span style="color: #666666">=</span> [<span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve()) <span style="color: #008000; font-weight: bold">for</span> path <span style="color: #AA22FF; font-weight: bold">in</span> removed <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(path, <span style="color: #008000">str</span>)]
        <span style="color: #008000; font-weight: bold">if</span> removed_paths:
            <span style="color: #008000; font-weight: bold">for</span> document <span style="color: #AA22FF; font-weight: bold">in</span> repo<span style="color: #666666">.</span>list_for_project(project_id):
                source_path <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> source_path:
                    <span style="color: #008000; font-weight: bold">continue</span>
                normalized <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(source_path)<span style="color: #666666">.</span>resolve())
                <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #AA22FF; font-weight: bold">in</span> removed_paths:
                    repo<span style="color: #666666">.</span>delete(document[<span style="color: #BA2121">&quot;id&quot;</span>])
</code></pre>
<h3 id="_refresh_corpus_view">Method: _refresh_corpus_view(self) -&gt; None</h3>
<p>The function `_refresh_corpus_view` updates the corpus tree view in the main window. It clears the existing tree, retrieves documents for the active project, and populates the tree with a hierarchical folder structure if documents exist. If no documents are found, it displays a placeholder message and disables the tree. The root item of the tree is labeled based on the project&#x27;s corpus path or name, and the tree is expanded with appropriate tooltips. Finally, it resizes the column to fit the contents and updates prerequisites for question answering based on the conversation manager&#x27;s connection state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_refresh_corpus_view</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>clear()
        <span style="color: #008000; font-weight: bold">try</span>:
            project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_has_documents <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        documents <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>documents<span style="color: #666666">.</span>list_for_project(project_id)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_has_documents <span style="color: #666666">=</span> <span style="color: #008000">bool</span>(documents)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> documents:
            placeholder <span style="color: #666666">=</span> QTreeWidgetItem([<span style="color: #BA2121">&quot;No documents indexed&quot;</span>])
            placeholder<span style="color: #666666">.</span>setFlags(Qt<span style="color: #666666">.</span>ItemFlag<span style="color: #666666">.</span>ItemIsEnabled)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>addTopLevelItem(placeholder)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">True</span>)
        tree <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>document_hierarchy<span style="color: #666666">.</span>build_folder_tree(project_id)
        label_path <span style="color: #666666">=</span> tree<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> label_path:
            <span style="color: #008000; font-weight: bold">try</span>:
                root_label <span style="color: #666666">=</span> Path(label_path)<span style="color: #666666">.</span>name <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000">str</span>(Path(label_path))
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
                root_label <span style="color: #666666">=</span> <span style="color: #008000">str</span>(label_path)
        <span style="color: #008000; font-weight: bold">else</span>:
            root_label <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()<span style="color: #666666">.</span>name <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Corpus&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> root_label:
            root_label <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Corpus&quot;</span>
        root_item <span style="color: #666666">=</span> QTreeWidgetItem([root_label])
        <span style="color: #008000; font-weight: bold">if</span> label_path:
            root_item<span style="color: #666666">.</span>setToolTip(<span style="color: #666666">0</span>, <span style="color: #008000">str</span>(label_path))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>addTopLevelItem(root_item)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_populate_corpus_tree(root_item, tree)
        root_item<span style="color: #666666">.</span>setExpanded(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>resizeColumnToContents(<span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_question_prerequisites(<span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>connection_state)
</code></pre>
<h3 id="_populate_corpus_tree">Method: _populate_corpus_tree(self, parent: QTreeWidgetItem, node: dict[str, Any]) -&gt; None</h3>
<p>The function `_populate_corpus_tree` recursively populates a `QTreeWidgetItem` hierarchy to represent the structure of a corpus. It processes nodes and documents from a dictionary structure, creating tree items for each child node and document. For each node, it sets the item&#x27;s text to the node&#x27;s name or &quot;(root)&quot; if no name is present, and adds a tooltip with the node&#x27;s path if available. For documents, it uses the document&#x27;s title or derives it from the source path if missing, defaulting to &quot;Untitled&quot; if neither is available. It also sets the document&#x27;s ID as user data on the item for later retrieval. The function builds the tree by recursively calling itself on child nodes and adding both child nodes and documents as children of the current parent item.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_populate_corpus_tree</span>(<span style="color: #008000">self</span>, parent: QTreeWidgetItem, node: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">for</span> child <span style="color: #AA22FF; font-weight: bold">in</span> node<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;children&quot;</span>, []):
            name <span style="color: #666666">=</span> child<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;(root)&quot;</span>
            item <span style="color: #666666">=</span> QTreeWidgetItem([name])
            path <span style="color: #666666">=</span> child<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> path:
                item<span style="color: #666666">.</span>setToolTip(<span style="color: #666666">0</span>, <span style="color: #008000">str</span>(path))
            parent<span style="color: #666666">.</span>addChild(item)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_populate_corpus_tree(item, child)
        <span style="color: #008000; font-weight: bold">for</span> document <span style="color: #AA22FF; font-weight: bold">in</span> node<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;documents&quot;</span>, []):
            source_path <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>)
            title <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> title <span style="color: #AA22FF; font-weight: bold">and</span> source_path:
                title <span style="color: #666666">=</span> Path(source_path)<span style="color: #666666">.</span>name
            title <span style="color: #666666">=</span> title <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Untitled&quot;</span>
            item <span style="color: #666666">=</span> QTreeWidgetItem([title])
            <span style="color: #008000; font-weight: bold">if</span> source_path:
                item<span style="color: #666666">.</span>setToolTip(<span style="color: #666666">0</span>, <span style="color: #008000">str</span>(source_path))
            doc_id <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> doc_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                item<span style="color: #666666">.</span>setData(<span style="color: #666666">0</span>, Qt<span style="color: #666666">.</span>ItemDataRole<span style="color: #666666">.</span>UserRole, doc_id)
            parent<span style="color: #666666">.</span>addChild(item)
</code></pre>
<h3 id="_update_corpus_actions">Method: _update_corpus_actions(self) -&gt; None</h3>
<p>The function `_update_corpus_actions` updates the enabled state of corpus-related actions and buttons based on whether there are corpus roots associated with the active project. It first attempts to retrieve the active project ID from the project service. If a `RuntimeError` occurs, it disables both the &quot;rescan corpus&quot; action and the rescan button (if it exists). If the project ID is successfully retrieved, it lists the corpus roots for that project and enables the &quot;rescan corpus&quot; action and the rescan button only if there are existing corpus roots.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_corpus_actions</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">try</span>:
            project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>rescan_corpus_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        roots <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>list_corpus_roots(project_id)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>rescan_corpus_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000">bool</span>(roots))
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_rescan_button<span style="color: #666666">.</span>setEnabled(<span style="color: #008000">bool</span>(roots))
</code></pre>
<h3 id="_prompt_new_project">Method: _prompt_new_project(self) -&gt; None</h3>
<p>The function `_prompt_new_project` displays a dialog box to the user for entering a new project name. If the user provides a valid, non-empty name, it creates a new project using the `project_service` and shows a toast notification confirming the creation of the project. If the user cancels or provides an empty name, the function returns without creating a project.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_prompt_new_project</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        name, ok <span style="color: #666666">=</span> QInputDialog<span style="color: #666666">.</span>getText(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;New Project&quot;</span>,
            <span style="color: #BA2121">&quot;Project name:&quot;</span>,
            QLineEdit<span style="color: #666666">.</span>EchoMode<span style="color: #666666">.</span>Normal,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> ok:
            <span style="color: #008000; font-weight: bold">return</span>
        cleaned <span style="color: #666666">=</span> name<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> cleaned:
            <span style="color: #008000; font-weight: bold">return</span>
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>create_project(cleaned)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">f&quot;Project &#39;</span><span style="color: #A45A77; font-weight: bold">{</span>project<span style="color: #666666">.</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&#39; created.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2500</span>)
</code></pre>
<h3 id="_prompt_rename_project">Method: _prompt_rename_project(self) -&gt; None</h3>
<p>The function `_prompt_rename_project` prompts the user to rename the active project through a dialog interface. It retrieves the current project name, displays it in an input dialog, and updates the project&#x27;s name in the project service if the user provides a valid new name. A success message is shown via a toast notification if the renaming is completed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_prompt_rename_project</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        name, ok <span style="color: #666666">=</span> QInputDialog<span style="color: #666666">.</span>getText(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Rename Project&quot;</span>,
            <span style="color: #BA2121">&quot;Project name:&quot;</span>,
            QLineEdit<span style="color: #666666">.</span>EchoMode<span style="color: #666666">.</span>Normal,
            project<span style="color: #666666">.</span>name,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> ok:
            <span style="color: #008000; font-weight: bold">return</span>
        cleaned <span style="color: #666666">=</span> name<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> cleaned <span style="color: #AA22FF; font-weight: bold">or</span> cleaned <span style="color: #666666">==</span> project<span style="color: #666666">.</span>name:
            <span style="color: #008000; font-weight: bold">return</span>
        updated <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>rename_project(project<span style="color: #666666">.</span>id, name<span style="color: #666666">=</span>cleaned)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">f&quot;Project renamed to </span><span style="color: #A45A77; font-weight: bold">{</span>updated<span style="color: #666666">.</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2000</span>)
</code></pre>
<h3 id="_delete_current_project">Method: _delete_current_project(self) -&gt; None</h3>
<p>The function `_delete_current_project` handles the deletion of the currently active project. It first retrieves the active project and identifies alternative projects available for selection. If no alternatives exist, it shows an information message prompting the user to create another project before deleting the current one. If alternatives are present, it displays a confirmation dialog asking the user to confirm the deletion of the active project. If the user confirms, the function stores the current project session, sets a replacement project as active, deletes the original project, removes its session data, and shows a toast notification indicating that the project has been deleted.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_delete_current_project</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        alternatives <span style="color: #666666">=</span> [p <span style="color: #008000; font-weight: bold">for</span> p <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>list_projects() <span style="color: #008000; font-weight: bold">if</span> p<span style="color: #666666">.</span>id <span style="color: #666666">!=</span> project<span style="color: #666666">.</span>id]
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> alternatives:
            QMessageBox<span style="color: #666666">.</span>information(
                <span style="color: #008000">self</span>,
                <span style="color: #BA2121">&quot;Delete Project&quot;</span>,
                <span style="color: #BA2121">&quot;Create another project before deleting this one.&quot;</span>,
            )
            <span style="color: #008000; font-weight: bold">return</span>
        reply <span style="color: #666666">=</span> QMessageBox<span style="color: #666666">.</span>question(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Delete Project&quot;</span>,
            <span style="color: #BA2121">f&quot;Delete project &#39;</span><span style="color: #A45A77; font-weight: bold">{</span>project<span style="color: #666666">.</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&#39;? This action cannot be undone.&quot;</span>,
            QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>Yes <span style="color: #666666">|</span> QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>No,
            QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>No,
        )
        <span style="color: #008000; font-weight: bold">if</span> reply <span style="color: #666666">!=</span> QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>Yes:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_active_project_session()
        replacement <span style="color: #666666">=</span> alternatives[<span style="color: #666666">0</span>]
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>set_active_project(replacement<span style="color: #666666">.</span>id)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>delete_project(project<span style="color: #666666">.</span>id)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_sessions<span style="color: #666666">.</span>pop(project<span style="color: #666666">.</span>id, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Project deleted.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;warning&quot;</span>, duration_ms<span style="color: #666666">=2500</span>)
</code></pre>
<h3 id="_reveal_project_storage">Method: _reveal_project_storage(self) -&gt; None</h3>
<p>The function `_reveal_project_storage` retrieves the storage path for the active project, ensures the directory exists by creating it if necessary, and then opens the directory in the system&#x27;s default file explorer.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_reveal_project_storage</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>get_project_storage(project<span style="color: #666666">.</span>id)
        path<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        QDesktopServices<span style="color: #666666">.</span>openUrl(QUrl<span style="color: #666666">.</span>fromLocalFile(<span style="color: #008000">str</span>(path)))
</code></pre>
<h3 id="_purge_project_data">Method: _purge_project_data(self) -&gt; None</h3>
<p>The function `_purge_project_data` removes all indexed data, chat history, and cached assets associated with the currently active project. It prompts the user for confirmation via a message box before proceeding. If confirmed, it clears the project data using the project service, resets various UI components such as conversation turns, answer view, and evidence panel, and updates the session state. It also disables export actions, shows a confirmation toast message, and refreshes the corpus view and actions.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_purge_project_data</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        reply <span style="color: #666666">=</span> QMessageBox<span style="color: #666666">.</span>question(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Remove Project Data&quot;</span>,
            <span style="color: #BA2121">&quot;Remove indexed data, chats, and cached assets for this project?&quot;</span>,
            QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>Yes <span style="color: #666666">|</span> QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>No,
            QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>No,
        )
        <span style="color: #008000; font-weight: bold">if</span> reply <span style="color: #666666">!=</span> QMessageBox<span style="color: #666666">.</span>StandardButton<span style="color: #666666">.</span>Yes:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>purge_project_data(project<span style="color: #666666">.</span>id)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns<span style="color: #666666">.</span>clear()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>turns<span style="color: #666666">.</span>clear()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>clear()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;include&quot;</span>: [], <span style="color: #BA2121">&quot;exclude&quot;</span>: []}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>clear()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_export_actions()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(turns<span style="color: #666666">=</span>[], scope<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope, last_question<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Project data removed.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=3000</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_refresh_corpus_view()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_corpus_actions()
</code></pre>
<h3 id="_create_backup">Method: _create_backup(self) -&gt; None</h3>
<p>The function `_create_backup` initiates the creation of a backup archive for the application. It prompts the user to select a destination path using a file dialog, defaulting to a name based on the project&#x27;s export path with a &quot;-backup.zip&quot; suffix. If no path is chosen, the function exits. It then attempts to create the backup at the specified location using the `backup_service.create_backup` method. If an exception occurs during the process, an error message is displayed to the user. On successful completion, a toast notification confirms the backup location.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_backup</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        default_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_default_export_path(<span style="color: #BA2121">&quot;-backup.zip&quot;</span>)
        path, _ <span style="color: #666666">=</span> QFileDialog<span style="color: #666666">.</span>getSaveFileName(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Create Backup&quot;</span>,
            default_path,
            <span style="color: #BA2121">&quot;Zip Archives (*.zip)&quot;</span>,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            saved <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>backup_service<span style="color: #666666">.</span>create_backup(path)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
            QMessageBox<span style="color: #666666">.</span>critical(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Backup Failed&quot;</span>, <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to create backup.&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">f&quot;Backup saved to </span><span style="color: #A45A77; font-weight: bold">{</span>saved<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=3000</span>)
</code></pre>
<h3 id="_restore_backup">Method: _restore_backup(self) -&gt; None</h3>
<p>The function `_restore_backup` provides a user interface element for restoring application data from a backup file. It opens a file dialog to allow the user to select a `.zip` archive, clears existing project sessions, and attempts to restore the backup using a `backup_service`. If the operation fails, it displays an error message; otherwise, it shows a success notification.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_restore_backup</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        path, _ <span style="color: #666666">=</span> QFileDialog<span style="color: #666666">.</span>getOpenFileName(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Restore Backup&quot;</span>,
            <span style="color: #BA2121">&quot;&quot;</span>,
            <span style="color: #BA2121">&quot;Zip Archives (*.zip)&quot;</span>,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_sessions<span style="color: #666666">.</span>clear()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>backup_service<span style="color: #666666">.</span>restore_backup(path)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
            QMessageBox<span style="color: #666666">.</span>critical(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Restore Failed&quot;</span>, <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to restore backup.&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Backup restored.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=3000</span>)
</code></pre>
<h3 id="_export_conversation_markdown">Method: _export_conversation_markdown(self) -&gt; None</h3>
<p>Exports the current conversation turns to a Markdown file. Displays an information message if no conversation is available. Uses a file dialog to select the export path with a default name based on the active project. Handles exceptions during export and shows a critical message if the export fails. On successful export, displays a toast notification.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_export_conversation_markdown</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns:
            QMessageBox<span style="color: #666666">.</span>information(
                <span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Export Conversation&quot;</span>, <span style="color: #BA2121">&quot;No conversation available to export.&quot;</span>
            )
            <span style="color: #008000; font-weight: bold">return</span>
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        default_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_default_export_path(<span style="color: #BA2121">&quot;-conversation.md&quot;</span>)
        path, _ <span style="color: #666666">=</span> QFileDialog<span style="color: #666666">.</span>getSaveFileName(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Export Conversation to Markdown&quot;</span>,
            default_path,
            <span style="color: #BA2121">&quot;Markdown Files (*.md)&quot;</span>,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>export_service<span style="color: #666666">.</span>export_conversation_markdown(
                path,
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns,
                title<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>project<span style="color: #666666">.</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> Conversation&quot;</span>,
                metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;Project&quot;</span>: project<span style="color: #666666">.</span>name},
            )
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
            QMessageBox<span style="color: #666666">.</span>critical(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Export Failed&quot;</span>, <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to export conversation.&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Conversation exported.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2500</span>)
</code></pre>
<h3 id="_export_conversation_html">Method: _export_conversation_html(self) -&gt; None</h3>
<p>Exports the current conversation to an HTML file. Displays an error message if no conversation is available. Uses a file dialog to prompt the user for a save location and calls the export service to generate the HTML file with the conversation data and project metadata. Shows a success toast notification upon completion. If the export fails, displays an error message.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_export_conversation_html</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns:
            QMessageBox<span style="color: #666666">.</span>information(
                <span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Export Conversation&quot;</span>, <span style="color: #BA2121">&quot;No conversation available to export.&quot;</span>
            )
            <span style="color: #008000; font-weight: bold">return</span>
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project()
        default_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_default_export_path(<span style="color: #BA2121">&quot;-conversation.html&quot;</span>)
        path, _ <span style="color: #666666">=</span> QFileDialog<span style="color: #666666">.</span>getSaveFileName(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Export Conversation to HTML&quot;</span>,
            default_path,
            <span style="color: #BA2121">&quot;HTML Files (*.html)&quot;</span>,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>export_service<span style="color: #666666">.</span>export_conversation_html(
                path,
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns,
                title<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>project<span style="color: #666666">.</span>name<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> Conversation&quot;</span>,
                metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;Project&quot;</span>: project<span style="color: #666666">.</span>name},
            )
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
            QMessageBox<span style="color: #666666">.</span>critical(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Export Failed&quot;</span>, <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to export conversation.&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Conversation exported.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2500</span>)
</code></pre>
<h3 id="_export_selected_snippet">Method: _export_selected_snippet(self) -&gt; None</h3>
<p>Exports the selected evidence snippet from the `_evidence_panel` to a text file. If no snippet is selected, it shows an information message. It prompts the user to choose a save location with a default path, prepares the snippet data including label, HTML content, and metadata, and uses `export_service` to write the data to the chosen file. If the export fails, it displays a critical error message. On successful export, it shows a toast notification.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_export_selected_snippet</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>selected_record()
        <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            QMessageBox<span style="color: #666666">.</span>information(
                <span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Export Snippet&quot;</span>, <span style="color: #BA2121">&quot;Select an evidence snippet to export first.&quot;</span>
            )
            <span style="color: #008000; font-weight: bold">return</span>
        default_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_default_export_path(<span style="color: #BA2121">&quot;-snippet.txt&quot;</span>)
        path, _ <span style="color: #666666">=</span> QFileDialog<span style="color: #666666">.</span>getSaveFileName(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Export Selected Snippet&quot;</span>,
            default_path,
            <span style="color: #BA2121">&quot;Text Files (*.txt)&quot;</span>,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> path:
            <span style="color: #008000; font-weight: bold">return</span>
        payload <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;label&quot;</span>: record<span style="color: #666666">.</span>label,
            <span style="color: #BA2121">&quot;snippet_html&quot;</span>: record<span style="color: #666666">.</span>snippet_html,
            <span style="color: #BA2121">&quot;metadata_text&quot;</span>: record<span style="color: #666666">.</span>metadata_text,
        }
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>export_service<span style="color: #666666">.</span>export_snippets_text(path, [payload])
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - user feedback path</span>
            QMessageBox<span style="color: #666666">.</span>critical(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Export Failed&quot;</span>, <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to export snippet.&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">&quot;Snippet exported.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2000</span>)
</code></pre>
<h3 id="_create_conversation_controls">Method: _create_conversation_controls(self, parent: QWidget) -&gt; QFrame</h3>
<p>Creates a frame containing controls for configuring conversation settings, including reasoning verbosity, plan visibility, assumption visibility, and sources-only mode. The frame includes a label and combo box for selecting reasoning verbosity levels, checkboxes for toggling plan and assumption visibility, and a checkbox for enabling sources-only mode. Connections are established between the controls and corresponding event handlers and settings properties to synchronize state changes.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_conversation_controls</span>(<span style="color: #008000">self</span>, parent: QWidget) <span style="color: #666666">-&gt;</span> QFrame:
        frame <span style="color: #666666">=</span> QFrame(parent)
        layout <span style="color: #666666">=</span> QHBoxLayout(frame)
        layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>)
        layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">8</span>)

        reasoning_label <span style="color: #666666">=</span> QLabel(<span style="color: #BA2121">&quot;Reasoning:&quot;</span>, frame)
        layout<span style="color: #666666">.</span>addWidget(reasoning_label)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo <span style="color: #666666">=</span> QComboBox(frame)
        <span style="color: #008000; font-weight: bold">for</span> option <span style="color: #AA22FF; font-weight: bold">in</span> ReasoningVerbosity:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>addItem(option<span style="color: #666666">.</span>name<span style="color: #666666">.</span>title(), userData<span style="color: #666666">=</span>option)
        index <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>findData(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>reasoning_verbosity)
        <span style="color: #008000; font-weight: bold">if</span> index <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>setCurrentIndex(index)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>currentIndexChanged<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_reasoning_verbosity_changed)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox <span style="color: #666666">=</span> QCheckBox(<span style="color: #BA2121">&quot;Show plan&quot;</span>, frame)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;togglePlan&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox<span style="color: #666666">.</span>setChecked(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_plan)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox<span style="color: #666666">.</span>toggled<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_show_plan)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox <span style="color: #666666">=</span> QCheckBox(<span style="color: #BA2121">&quot;Show assumptions&quot;</span>, frame)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;toggleAssumptions&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox<span style="color: #666666">.</span>setChecked(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_assumptions)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox<span style="color: #666666">.</span>toggled<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_show_assumptions)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox)

        layout<span style="color: #666666">.</span>addStretch(<span style="color: #666666">1</span>)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox <span style="color: #666666">=</span> QCheckBox(<span style="color: #BA2121">&quot;Sources only&quot;</span>, frame)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;toggleSourcesOnly&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox<span style="color: #666666">.</span>setChecked(<span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>sources_only_mode)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox<span style="color: #666666">.</span>toggled<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_sources_only_toggled)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>reasoning_verbosity_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_reasoning_combo)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_plan_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_plan_checkbox)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_assumptions_changed<span style="color: #666666">.</span>connect(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_assumptions_checkbox
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>sources_only_mode_changed<span style="color: #666666">.</span>connect(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_sources_checkbox
        )

        <span style="color: #008000; font-weight: bold">return</span> frame
</code></pre>
<h3 id="_connect_services">Method: _connect_services(self) -&gt; None</h3>
<p>The function `_connect_services` establishes signal-slot connections between various service objects and corresponding handler methods within the `MainWindow` class. It links theme, font scale, and density changes from the `settings_service` to UI update functions. Additionally, it connects progress-related signals from `progress_service` to handlers for progress updates and toast notifications. The function also connects changes in conversation settings‚Äîsuch as reasoning verbosity, plan visibility, assumption visibility, sources-only mode, answer length, and model selection‚Äîto their respective event handlers and persistence mechanisms.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_connect_services</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>theme_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_theme)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>font_scale_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_font_scale)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>density_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_density)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>progress_started<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_progress_started)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>progress_updated<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_progress_updated)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>progress_finished<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_progress_finished)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>toast_requested<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>reasoning_verbosity_changed<span style="color: #666666">.</span>connect(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist_conversation_settings
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_plan_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_persist_conversation_settings)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>show_assumptions_changed<span style="color: #666666">.</span>connect(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist_conversation_settings
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>sources_only_mode_changed<span style="color: #666666">.</span>connect(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist_conversation_settings
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>answer_length_changed<span style="color: #666666">.</span>connect(
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_on_answer_length_changed
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>model_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_model_changed)
</code></pre>
<h3 id="_on_reasoning_verbosity_changed">Method: _on_reasoning_verbosity_changed(self, index: int) -&gt; None</h3>
<p>The function `_on_reasoning_verbosity_changed` handles changes to the reasoning verbosity setting in the user interface. It retrieves the selected verbosity level from a combo box, verifies that the selected data is of type `ReasoningVerbosity`, and updates the conversation settings with the new verbosity level.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_reasoning_verbosity_changed</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>itemData(index)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(data, ReasoningVerbosity):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_reasoning_verbosity(data)
</code></pre>
<h3 id="_sync_reasoning_combo">Method: _sync_reasoning_combo(self, verbosity: ReasoningVerbosity) -&gt; None</h3>
<p>The function `_sync_reasoning_combo` synchronizes the current selection of a combo box (`_verbosity_combo`) with a given `ReasoningVerbosity` value. It first finds the index of the data corresponding to the verbosity level. If the index is valid and differs from the currently selected index, it temporarily blocks signals from the combo box, updates the current index to match the verbosity level, and then re-enables signal handling. This ensures the UI reflects the provided verbosity setting without triggering unintended events.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sync_reasoning_combo</span>(<span style="color: #008000">self</span>, verbosity: ReasoningVerbosity) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        index <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>findData(verbosity)
        <span style="color: #008000; font-weight: bold">if</span> index <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span> <span style="color: #AA22FF; font-weight: bold">and</span> index <span style="color: #666666">!=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>currentIndex():
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>setCurrentIndex(index)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_verbosity_combo<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_sync_plan_checkbox">Method: _sync_plan_checkbox(self, enabled: bool) -&gt; None</h3>
<p>The function `_sync_plan_checkbox` synchronizes the checked state of a checkbox widget (`_plan_checkbox`) with a provided boolean value. If the current checked state of the checkbox does not match the provided value, it temporarily blocks signals from the checkbox, updates its checked state, and then re-enables signals. This ensures that the checkbox state is updated without triggering any associated signal handlers during the update process.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sync_plan_checkbox</span>(<span style="color: #008000">self</span>, enabled: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox<span style="color: #666666">.</span>isChecked() <span style="color: #666666">!=</span> enabled:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox<span style="color: #666666">.</span>setChecked(enabled)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_plan_checkbox<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_sync_assumptions_checkbox">Method: _sync_assumptions_checkbox(self, enabled: bool) -&gt; None</h3>
<p>The function `_sync_assumptions_checkbox` synchronizes the checked state of a checkbox widget (`_assumptions_checkbox`) with a provided boolean value (`enabled`). If the current checked state of the checkbox does not match the `enabled` value, it temporarily blocks signals from the checkbox, updates its checked state, and then re-enables signals. This ensures that the UI state reflects the desired enabled status without triggering any signal handlers during the update.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sync_assumptions_checkbox</span>(<span style="color: #008000">self</span>, enabled: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox<span style="color: #666666">.</span>isChecked() <span style="color: #666666">!=</span> enabled:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox<span style="color: #666666">.</span>setChecked(enabled)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_assumptions_checkbox<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_on_sources_only_toggled">Method: _on_sources_only_toggled(self, enabled: bool) -&gt; None</h3>
<p>The function `_on_sources_only_toggled` is a slot method that responds to a toggle event, likely from a UI element such as a checkbox. When triggered, it updates the conversation settings to enable or disable &quot;sources only&quot; mode based on the boolean value provided. This mode likely restricts responses to only include information sourced from the document corpus, excluding general knowledge or inference. The method calls `set_sources_only_mode` on the `conversation_settings` object, passing the `enabled` state as an argument.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_sources_only_toggled</span>(<span style="color: #008000">self</span>, enabled: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_sources_only_mode(enabled)
</code></pre>
<h3 id="_sync_sources_checkbox">Method: _sync_sources_checkbox(self, enabled: bool) -&gt; None</h3>
<p>The function `_sync_sources_checkbox` synchronizes the checked state of the `_sources_only_checkbox` widget to a specified boolean value. If the current state of the checkbox does not match the provided `enabled` value, it temporarily blocks signals to prevent signal handling during the state change, updates the checkbox state, and then re-enables signal handling.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sync_sources_checkbox</span>(<span style="color: #008000">self</span>, enabled: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox<span style="color: #666666">.</span>isChecked() <span style="color: #666666">!=</span> enabled:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox<span style="color: #666666">.</span>setChecked(enabled)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_sources_only_checkbox<span style="color: #666666">.</span>blockSignals(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_persist_conversation_settings">Method: _persist_conversation_settings(self, *_args: object) -&gt; None</h3>
<p>The function `_persist_conversation_settings` saves the current conversation settings by taking a snapshot of the settings, retrieving the active project ID, updating the session with the snapshot, and then saving the conversation settings to the project service.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_persist_conversation_settings</span>(<span style="color: #008000">self</span>, <span style="color: #666666">*</span>_args: <span style="color: #008000">object</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        snapshot <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_snapshot_conversation_settings()
        project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(project_id, settings<span style="color: #666666">=</span>snapshot)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>save_conversation_settings(project_id, snapshot)
</code></pre>
<h3 id="_update_export_actions">Method: _update_export_actions(self) -&gt; None</h3>
<p>The function `_update_export_actions` enables or disables the markdown and HTML export actions in the main window based on whether there are conversation turns available. If there are turns, the export actions are enabled; otherwise, they are disabled.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_export_actions</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        has_turns <span style="color: #666666">=</span> <span style="color: #008000">bool</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turns)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_markdown_action<span style="color: #666666">.</span>setEnabled(has_turns)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_html_action<span style="color: #666666">.</span>setEnabled(has_turns)
</code></pre>
<h3 id="_handle_ask">Method: _handle_ask(self, text: str) -&gt; None</h3>
<p>The function `_handle_ask` processes a user&#x27;s question input by first checking if the input is empty and returning early if it is. It then checks the connection state of the conversation manager. If the system is not connected to LMStudio, it updates prerequisites, notifies the user of the connection issue, and returns. If connected, it marks the input as busy and proceeds to ask the question using the `_ask_question` method.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_handle_ask</span>(<span style="color: #008000">self</span>, text: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> text<span style="color: #666666">.</span>strip():
            <span style="color: #008000; font-weight: bold">return</span>

        state <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>connection_state
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> state<span style="color: #666666">.</span>connected:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_question_prerequisites(state)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>notify(
                state<span style="color: #666666">.</span>message <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;LMStudio is unavailable.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;error&quot;</span>, duration_ms<span style="color: #666666">=4000</span>
            )
            <span style="color: #008000; font-weight: bold">return</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_busy(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ask_question(text, triggered_by_scope<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_focus_corpus">Method: _focus_corpus(self) -&gt; None</h3>
<p>The function `_focus_corpus` sets the focus to the corpus tree widget within the main window.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_focus_corpus</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_corpus_tree<span style="color: #666666">.</span>setFocus()
</code></pre>
<h3 id="_copy_chat_text">Method: _copy_chat_text(self) -&gt; None</h3>
<p>The function `_copy_chat_text` copies the plain text content from `self.answer_view` to the system clipboard and displays a notification indicating that the conversation has been copied.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_copy_chat_text</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        text <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>to_plain_text()
        QApplication<span style="color: #666666">.</span>clipboard()<span style="color: #666666">.</span>setText(text)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>notify(<span style="color: #BA2121">&quot;Conversation copied&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=2000</span>)
</code></pre>
<h3 id="_extract_token_usage">Method: _extract_token_usage(self, turn: ConversationTurn) -&gt; dict[str, int] | None</h3>
<p>The function `_extract_token_usage` extracts token usage information from a `ConversationTurn` object&#x27;s raw response. It retrieves the `usage` dictionary from the response, validates its type, and attempts to convert all values to integers. The function returns a dictionary mapping usage keys to their integer values, or `None` if the input is invalid or no valid data is found.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_extract_token_usage</span>(<span style="color: #008000">self</span>, turn: ConversationTurn) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        raw <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>raw_response <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(turn<span style="color: #666666">.</span>raw_response, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        usage <span style="color: #666666">=</span> raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;usage&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> raw <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(usage, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        parsed: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">int</span>] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> usage<span style="color: #666666">.</span>items():
            <span style="color: #008000; font-weight: bold">try</span>:
                parsed[key] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(value)
            <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">TypeError</span>, <span style="color: #CB3F38; font-weight: bold">ValueError</span>):
                <span style="color: #008000; font-weight: bold">continue</span>
        <span style="color: #008000; font-weight: bold">return</span> parsed <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="_ask_question">Method: _ask_question(self, question: str, *, triggered_by_scope: bool) -&gt; None</h3>
<p>The function `_ask_question` handles the process of submitting a user question to an AI language model via the `conversation_manager`. It first checks if the question is valid and if the LMStudio connection is available. If not, it notifies the user of the issue and returns early. If the connection is active, it updates the session state, sets the UI to busy, and initiates a progress indicator.

The function builds context and extra options for the request, then calls `conversation_manager.ask` to send the question. If an `LMStudioError` occurs during the request, it handles the error by notifying the user, updating the UI, and returning early.

Upon successful submission, it records timing information, token usage, and appends the turn to the conversation history. It updates the UI with the new answer card, evidence panel, and export actions. Finally, it completes the progress indicator and updates the UI state to reflect the completed question submission.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_ask_question</span>(<span style="color: #008000">self</span>, question: <span style="color: #008000">str</span>, <span style="color: #666666">*</span>, triggered_by_scope: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> question<span style="color: #666666">.</span>strip():
            <span style="color: #008000; font-weight: bold">return</span>

        state <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>connection_state
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> state<span style="color: #666666">.</span>connected:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_question_prerequisites(state)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>notify(
                state<span style="color: #666666">.</span>message <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;LMStudio is unavailable.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;error&quot;</span>, duration_ms<span style="color: #666666">=4000</span>
            )
            <span style="color: #008000; font-weight: bold">return</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question <span style="color: #666666">=</span> question
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(last_question<span style="color: #666666">=</span>question)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_busy(<span style="color: #008000; font-weight: bold">True</span>)
        progress_message <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Refreshing evidence...&quot;</span> <span style="color: #008000; font-weight: bold">if</span> triggered_by_scope <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;Submitting question...&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>start(<span style="color: #BA2121">&quot;chat-send&quot;</span>, progress_message)
        asked_at <span style="color: #666666">=</span> datetime<span style="color: #666666">.</span>now()
        step_context_provider <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_step_context_provider(question)
        extra_options <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_extra_request_options(question)
        <span style="color: #008000; font-weight: bold">try</span>:
            turn <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>ask(
                question,
                reasoning_verbosity<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>reasoning_verbosity,
                response_mode<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>response_mode,
                preset<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>answer_length,
                extra_options<span style="color: #666666">=</span>extra_options <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000; font-weight: bold">None</span>,
                context_provider<span style="color: #666666">=</span>step_context_provider,
            )
        <span style="color: #008000; font-weight: bold">except</span> LMStudioError <span style="color: #008000; font-weight: bold">as</span> exc:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>finish(<span style="color: #BA2121">&quot;chat-send&quot;</span>, <span style="color: #BA2121">&quot;Send failed&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>notify(<span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Failed to contact LMStudio&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;error&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_busy(<span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_question_prerequisites(<span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>connection_state)
            <span style="color: #008000; font-weight: bold">return</span>

        answered_at <span style="color: #666666">=</span> datetime<span style="color: #666666">.</span>now()
        turn<span style="color: #666666">.</span>asked_at <span style="color: #666666">=</span> asked_at
        turn<span style="color: #666666">.</span>answered_at <span style="color: #666666">=</span> answered_at
        turn<span style="color: #666666">.</span>latency_ms <span style="color: #666666">=</span> <span style="color: #008000">int</span>((answered_at <span style="color: #666666">-</span> asked_at)<span style="color: #666666">.</span>total_seconds() <span style="color: #666666">*</span> <span style="color: #666666">1000</span>)
        turn<span style="color: #666666">.</span>token_usage <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_extract_token_usage(turn)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_turns<span style="color: #666666">.</span>append(turn)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(turns<span style="color: #666666">=</span><span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_turns))
        card <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>add_turn(turn)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card <span style="color: #666666">=</span> card
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_evidence_panel(turn)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_export_actions()
        finish_message <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Evidence refreshed&quot;</span> <span style="color: #008000; font-weight: bold">if</span> triggered_by_scope <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;Answer received&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>progress_service<span style="color: #666666">.</span>finish(<span style="color: #BA2121">&quot;chat-send&quot;</span>, finish_message)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_busy(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_question_prerequisites(<span style="color: #008000">self</span><span style="color: #666666">.</span>_conversation_manager<span style="color: #666666">.</span>connection_state)
</code></pre>
<h3 id="_build_extra_request_options">Method: _build_extra_request_options(self, question: str | None=None, *, retrieval_documents: list[dict[str, Any]] | None=None) -&gt; dict[str, Any]</h3>
<p>The function `_build_extra_request_options` constructs and returns a dictionary of options for use in a request, based on the current retrieval scope and provided parameters. It initializes an empty dictionary `options`, retrieves include and exclude filters from the current retrieval scope, and populates a `retrieval` sub-dictionary with query text, inclusion criteria, exclusion criteria, and document references if they are provided. The resulting `retrieval` dictionary is then added to `options` under the key `&quot;retrieval&quot;` only if it contains any data. The function supports optional parameters for a question string and a list of retrieval documents.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_extra_request_options</span>(
        <span style="color: #008000">self</span>,
        question: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        <span style="color: #666666">*</span>,
        retrieval_documents: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
        scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope
        include <span style="color: #666666">=</span> <span style="color: #008000">list</span>(scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>, [])) <span style="color: #008000; font-weight: bold">if</span> scope <span style="color: #008000; font-weight: bold">else</span> []
        exclude <span style="color: #666666">=</span> <span style="color: #008000">list</span>(scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;exclude&quot;</span>, [])) <span style="color: #008000; font-weight: bold">if</span> scope <span style="color: #008000; font-weight: bold">else</span> []
        retrieval: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">if</span> question <span style="color: #AA22FF; font-weight: bold">and</span> question<span style="color: #666666">.</span>strip():
            retrieval[<span style="color: #BA2121">&quot;query&quot;</span>] <span style="color: #666666">=</span> question<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> include:
            retrieval[<span style="color: #BA2121">&quot;include&quot;</span>] <span style="color: #666666">=</span> include
        <span style="color: #008000; font-weight: bold">if</span> exclude:
            retrieval[<span style="color: #BA2121">&quot;exclude&quot;</span>] <span style="color: #666666">=</span> exclude
        <span style="color: #008000; font-weight: bold">if</span> retrieval_documents:
            retrieval[<span style="color: #BA2121">&quot;documents&quot;</span>] <span style="color: #666666">=</span> retrieval_documents
        <span style="color: #008000; font-weight: bold">if</span> retrieval:
            options[<span style="color: #BA2121">&quot;retrieval&quot;</span>] <span style="color: #666666">=</span> retrieval
        <span style="color: #008000; font-weight: bold">return</span> options
</code></pre>
<h3 id="_build_step_context_provider">Method: _build_step_context_provider(self, question: str) -&gt; Callable[[PlanItem, int, int], Iterable[StepContextBatch]]</h3>
<p>The function `_build_step_context_provider` constructs and returns a callable that generates context batches for a given plan item during a step in a process. It takes a question string as input and prepares a provider function that, when invoked with a `PlanItem`, step index, and total steps, retrieves relevant context records using the search service. The retrieved records are then chunked and formatted into `StepContextBatch` objects, which contain snippets and document references. The provider uses a normalized version of the input question combined with the plan item&#x27;s description to perform the search, and it respects inclusion and exclusion scopes defined in `_current_retrieval_scope`. If no active project is found, it returns an empty iterable.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_step_context_provider</span>(
        <span style="color: #008000">self</span>, question: <span style="color: #008000">str</span>
    ) <span style="color: #666666">-&gt;</span> Callable[[PlanItem, <span style="color: #008000">int</span>, <span style="color: #008000">int</span>], Iterable[StepContextBatch]]:
        normalized <span style="color: #666666">=</span> question<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">try</span>:
            project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">lambda</span> <span style="color: #666666">*</span>_args, <span style="color: #666666">**</span>_kwargs: []

        scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #AA22FF; font-weight: bold">or</span> {<span style="color: #BA2121">&quot;include&quot;</span>: [], <span style="color: #BA2121">&quot;exclude&quot;</span>: []}
        include <span style="color: #666666">=</span> <span style="color: #008000">list</span>(scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> [])
        exclude <span style="color: #666666">=</span> <span style="color: #008000">list</span>(scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;exclude&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> [])
        chunk_size <span style="color: #666666">=</span> <span style="color: #666666">3</span>
        limit <span style="color: #666666">=</span> <span style="color: #666666">9</span>

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">provider</span>(plan_item: PlanItem, step_index: <span style="color: #008000">int</span>, total_steps: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[StepContextBatch]:
            step_prompt <span style="color: #666666">=</span> plan_item<span style="color: #666666">.</span>description<span style="color: #666666">.</span>strip()
            combined_query <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(
                part <span style="color: #008000; font-weight: bold">for</span> part <span style="color: #AA22FF; font-weight: bold">in</span> [normalized, step_prompt] <span style="color: #008000; font-weight: bold">if</span> part
            )
            records <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>search_service<span style="color: #666666">.</span>collect_context_records(
                combined_query,
                project_id<span style="color: #666666">=</span>project_id,
                include_identifiers<span style="color: #666666">=</span>include,
                exclude_identifiers<span style="color: #666666">=</span>exclude,
                limit<span style="color: #666666">=</span>limit,
            )
            batches: <span style="color: #008000">list</span>[StepContextBatch] <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">for</span> chunk <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_chunk_records(records, chunk_size):
                snippets, documents <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_context_payload_from_records(
                    chunk,
                    project_id,
                    step_index<span style="color: #666666">=</span>step_index,
                )
                <span style="color: #008000; font-weight: bold">if</span> snippets <span style="color: #AA22FF; font-weight: bold">or</span> documents:
                    batches<span style="color: #666666">.</span>append(StepContextBatch(snippets<span style="color: #666666">=</span>snippets, documents<span style="color: #666666">=</span>documents))
            <span style="color: #008000; font-weight: bold">return</span> batches

        <span style="color: #008000; font-weight: bold">return</span> provider
</code></pre>
<details>
<summary>Subfunction: provider(plan_item: PlanItem, step_index: int, total_steps: int) -&gt; list[StepContextBatch]</summary>
<h4 id="provider">provider(plan_item: PlanItem, step_index: int, total_steps: int) -&gt; list[StepContextBatch]</h4>
<p>The function `provider` generates a list of `StepContextBatch` objects based on a `PlanItem`, step index, and total steps. It constructs a combined query from a normalized input and the plan item&#x27;s description, then retrieves context records using a search service. These records are chunked and processed into batches containing snippets and documents, which are returned as a list of `StepContextBatch` objects.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">provider</span>(plan_item: PlanItem, step_index: <span style="color: #008000">int</span>, total_steps: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[StepContextBatch]:
            step_prompt <span style="color: #666666">=</span> plan_item<span style="color: #666666">.</span>description<span style="color: #666666">.</span>strip()
            combined_query <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(
                part <span style="color: #008000; font-weight: bold">for</span> part <span style="color: #AA22FF; font-weight: bold">in</span> [normalized, step_prompt] <span style="color: #008000; font-weight: bold">if</span> part
            )
            records <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>search_service<span style="color: #666666">.</span>collect_context_records(
                combined_query,
                project_id<span style="color: #666666">=</span>project_id,
                include_identifiers<span style="color: #666666">=</span>include,
                exclude_identifiers<span style="color: #666666">=</span>exclude,
                limit<span style="color: #666666">=</span>limit,
            )
            batches: <span style="color: #008000">list</span>[StepContextBatch] <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">for</span> chunk <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_chunk_records(records, chunk_size):
                snippets, documents <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_context_payload_from_records(
                    chunk,
                    project_id,
                    step_index<span style="color: #666666">=</span>step_index,
                )
                <span style="color: #008000; font-weight: bold">if</span> snippets <span style="color: #AA22FF; font-weight: bold">or</span> documents:
                    batches<span style="color: #666666">.</span>append(StepContextBatch(snippets<span style="color: #666666">=</span>snippets, documents<span style="color: #666666">=</span>documents))
            <span style="color: #008000; font-weight: bold">return</span> batches
</code></pre>
</details>
<h3 id="_prepare_retrieval_context">Method: _prepare_retrieval_context(self, question: str) -&gt; tuple[list[str], list[dict[str, Any]]]</h3>
<p>The function `_prepare_retrieval_context` prepares the context for a retrieval operation based on a given question. It first checks if the question is non-empty and retrieves the active project ID from the project service. If no project is active, it returns empty lists. It then determines the inclusion and exclusion identifiers from the current retrieval scope, defaulting to empty lists if not set. Using these parameters, it collects relevant context records through the search service. Finally, it processes these records into a payload format using `_context_payload_from_records` and returns the resulting list of context strings and associated metadata dictionaries.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_prepare_retrieval_context</span>(
        <span style="color: #008000">self</span>, question: <span style="color: #008000">str</span>
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">list</span>[<span style="color: #008000">str</span>], <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]]:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> question<span style="color: #666666">.</span>strip():
            <span style="color: #008000; font-weight: bold">return</span> [], []
        <span style="color: #008000; font-weight: bold">try</span>:
            project_id <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>project_service<span style="color: #666666">.</span>active_project_id
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>:
            <span style="color: #008000; font-weight: bold">return</span> [], []
        scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #AA22FF; font-weight: bold">or</span> {<span style="color: #BA2121">&quot;include&quot;</span>: [], <span style="color: #BA2121">&quot;exclude&quot;</span>: []}
        include <span style="color: #666666">=</span> scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;include&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
        exclude <span style="color: #666666">=</span> scope<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;exclude&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> []
        records <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>search_service<span style="color: #666666">.</span>collect_context_records(
            question,
            project_id<span style="color: #666666">=</span>project_id,
            include_identifiers<span style="color: #666666">=</span>include,
            exclude_identifiers<span style="color: #666666">=</span>exclude,
        )
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_context_payload_from_records(records, project_id)
</code></pre>
<h3 id="_context_payload_from_records">Method: _context_payload_from_records(self, records: Iterable[dict[str, Any]], project_id: int, *, step_index: int | None=None) -&gt; tuple[list[str], list[dict[str, Any]]]</h3>
<p>The function `_context_payload_from_records` processes an iterable of record dictionaries to generate two outputs: a list of formatted text snippets and a list of document payloads. Each record is expected to contain information about a document, chunk, and context text. The function extracts and formats metadata such as title, source path, identifiers, and scoring information. It constructs snippet headers with optional step prefixes and combines them with context text. The resulting snippets are plain-text representations, while the payloads are structured dictionaries containing detailed metadata for each retrieved document chunk, including offsets, scores, and identifiers. The function handles missing or invalid data gracefully by providing default values or skipping entries.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_context_payload_from_records</span>(
        <span style="color: #008000">self</span>,
        records: Iterable[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]],
        project_id: <span style="color: #008000">int</span>,
        <span style="color: #666666">*</span>,
        step_index: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">list</span>[<span style="color: #008000">str</span>], <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]]:
        snippets: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        retrieval_documents: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> []
        prefix <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Step </span><span style="color: #A45A77; font-weight: bold">{</span>step_index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: &quot;</span> <span style="color: #008000; font-weight: bold">if</span> step_index <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> records:
            document <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            chunk <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;chunk&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            context_text <span style="color: #666666">=</span> <span style="color: #008000">str</span>(record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;context&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)<span style="color: #666666">.</span>strip()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> context_text:
                <span style="color: #008000; font-weight: bold">continue</span>
            source_path <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source_path&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
            title <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> title <span style="color: #AA22FF; font-weight: bold">and</span> source_path:
                <span style="color: #008000; font-weight: bold">try</span>:
                    path_obj <span style="color: #666666">=</span> Path(source_path)
                    title <span style="color: #666666">=</span> path_obj<span style="color: #666666">.</span>name <span style="color: #AA22FF; font-weight: bold">or</span> path_obj<span style="color: #666666">.</span>stem
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
                    title <span style="color: #666666">=</span> <span style="color: #008000">str</span>(source_path)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> title:
                title <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Document&quot;</span>
            identifiers <span style="color: #666666">=</span> <span style="color: #008000">sorted</span>(SearchService<span style="color: #666666">.</span>_document_identifiers(document))
            primary_identifier <span style="color: #666666">=</span> identifiers[<span style="color: #666666">0</span>] <span style="color: #008000; font-weight: bold">if</span> identifiers <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>(document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> title)
            header_parts <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">if</span> prefix:
                header_parts<span style="color: #666666">.</span>append(prefix<span style="color: #666666">.</span>strip())
            <span style="color: #008000; font-weight: bold">if</span> primary_identifier:
                header_parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>primary_identifier<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">] </span><span style="color: #A45A77; font-weight: bold">{</span>title<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000; font-weight: bold">else</span>:
                header_parts<span style="color: #666666">.</span>append(title)
            snippet_header <span style="color: #666666">=</span> <span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">.</span>join(header_parts)
            snippets<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>snippet_header<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>context_text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)

            payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {
                <span style="color: #BA2121">&quot;id&quot;</span>: primary_identifier,
                <span style="color: #BA2121">&quot;source&quot;</span>: title,
                <span style="color: #BA2121">&quot;identifiers&quot;</span>: identifiers,
                <span style="color: #BA2121">&quot;text&quot;</span>: context_text,
                <span style="color: #BA2121">&quot;project_id&quot;</span>: project_id,
            }
            score <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;score&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> score <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">try</span>:
                    payload[<span style="color: #BA2121">&quot;score&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">float</span>(score)
                <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">TypeError</span>, <span style="color: #CB3F38; font-weight: bold">ValueError</span>):
                    <span style="color: #008000; font-weight: bold">pass</span>
            <span style="color: #008000; font-weight: bold">if</span> source_path:
                payload[<span style="color: #BA2121">&quot;path&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">str</span>(source_path)
            document_id <span style="color: #666666">=</span> document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> document_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                payload[<span style="color: #BA2121">&quot;document_id&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(document_id)
            chunk_id <span style="color: #666666">=</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(chunk, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000; font-weight: bold">if</span> chunk_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                payload[<span style="color: #BA2121">&quot;chunk_id&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(chunk_id)
            chunk_index <span style="color: #666666">=</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;index&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(chunk, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000; font-weight: bold">if</span> chunk_index <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                payload[<span style="color: #BA2121">&quot;chunk_index&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(chunk_index)
            start_offset <span style="color: #666666">=</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;start_offset&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(chunk, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000; font-weight: bold">if</span> start_offset <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                payload[<span style="color: #BA2121">&quot;start_offset&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(start_offset)
            end_offset <span style="color: #666666">=</span> chunk<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;end_offset&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(chunk, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #008000; font-weight: bold">if</span> end_offset <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                payload[<span style="color: #BA2121">&quot;end_offset&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(end_offset)
            highlight <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;highlight&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> highlight:
                payload[<span style="color: #BA2121">&quot;snippet&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">str</span>(highlight)
            ingest_doc <span style="color: #666666">=</span> record<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;ingest_document&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> {}
            ingest_id <span style="color: #666666">=</span> ingest_doc<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;id&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> ingest_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                payload[<span style="color: #BA2121">&quot;ingest_document_id&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(ingest_id)
            ingest_version <span style="color: #666666">=</span> ingest_doc<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;version&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> ingest_version <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
                payload[<span style="color: #BA2121">&quot;ingest_version&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(ingest_version)
            retrieval_documents<span style="color: #666666">.</span>append(payload)

        <span style="color: #008000; font-weight: bold">return</span> snippets, retrieval_documents
</code></pre>
<h3 id="_chunk_records">Method: _chunk_records(records: Iterable[dict[str, Any]], chunk_size: int) -&gt; Iterable[list[dict[str, Any]]]</h3>
<p>The function `_chunk_records` takes an iterable of dictionaries (`records`) and a chunk size (`chunk_size`) as input. It processes the records sequentially, grouping them into sublists (chunks) of the specified size. Each yielded chunk is a list of dictionaries from the input iterable. If the total number of records is not evenly divisible by the chunk size, the final chunk will contain the remaining records. This function is useful for processing large datasets in fixed-size batches.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_chunk_records</span>(
        records: Iterable[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]], chunk_size: <span style="color: #008000">int</span>
    ) <span style="color: #666666">-&gt;</span> Iterable[<span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]]:
        chunk: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> records:
            chunk<span style="color: #666666">.</span>append(record)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(chunk) <span style="color: #666666">&gt;=</span> chunk_size:
                <span style="color: #008000; font-weight: bold">yield</span> chunk
                chunk <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">if</span> chunk:
            <span style="color: #008000; font-weight: bold">yield</span> chunk
</code></pre>
<h3 id="_update_evidence_panel">Method: _update_evidence_panel(self, turn: ConversationTurn) -&gt; None</h3>
<p>The function `_update_evidence_panel` updates the evidence panel in the user interface based on the citations present in a given `ConversationTurn`. If no citations are found, it clears the evidence panel, resets the retrieval scope, and disables the export snippet action. If citations exist, it populates the evidence panel with the citations, updates the current retrieval scope from the panel, refreshes the session with this scope, enables or disables the export snippet action based on the number of evidences, updates the scope chip display, and highlights the citation in the answer view.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_evidence_panel</span>(<span style="color: #008000">self</span>, turn: ConversationTurn) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> turn<span style="color: #666666">.</span>citations:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>clear()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;include&quot;</span>: [], <span style="color: #BA2121">&quot;exclude&quot;</span>: []}
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(scope<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_scope_chip()
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>set_evidence(turn<span style="color: #666666">.</span>citations)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>current_scope
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(scope<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action<span style="color: #666666">.</span>setEnabled(<span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>evidence_count <span style="color: #666666">&gt;</span> <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_scope_chip()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>highlight_citation(<span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card, <span style="color: #008000; font-weight: bold">None</span>)
</code></pre>
<h3 id="_on_card_citation">Method: _on_card_citation(self, card: TurnCardWidget, index: int) -&gt; None</h3>
<p>The function `_on_card_citation` handles the event when a citation card is clicked within the user interface. It updates the active card, sets the evidence panel to display citations from the clicked card&#x27;s turn, updates the current retrieval scope, highlights the corresponding citation in the answer view, and selects the associated index in the evidence panel.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_card_citation</span>(<span style="color: #008000">self</span>, card: TurnCardWidget, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> card <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card <span style="color: #666666">=</span> card
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>set_evidence(card<span style="color: #666666">.</span>turn<span style="color: #666666">.</span>citations)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>current_scope
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>highlight_citation(card, index)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_evidence_panel<span style="color: #666666">.</span>select_index(index <span style="color: #666666">-</span> <span style="color: #666666">1</span>)
</code></pre>
<h3 id="_on_evidence_selected">Method: _on_evidence_selected(self, index: int, _identifier: str) -&gt; None</h3>
<p>The function `_on_evidence_selected` handles the event when a piece of evidence is selected in the user interface. It first checks if there is an active card; if not, it returns early. If an active card exists, it highlights the corresponding citation in the answer view based on the selected index and updates the export snippet action&#x27;s enabled state depending on whether a valid index was selected.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_evidence_selected</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span>, _identifier: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_view<span style="color: #666666">.</span>highlight_citation(<span style="color: #008000">self</span><span style="color: #666666">.</span>_active_card, index <span style="color: #666666">+</span> <span style="color: #666666">1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>export_snippet_action<span style="color: #666666">.</span>setEnabled(index <span style="color: #666666">&gt;=</span> <span style="color: #666666">0</span>)
</code></pre>
<h3 id="_on_evidence_scope_changed">Method: _on_evidence_scope_changed(self, include: list[str], exclude: list[str]) -&gt; None</h3>
<p>The function `_on_evidence_scope_changed` updates the current retrieval scope based on included and excluded tags, then updates the session with the new scope, refreshes the scope chip display, and re-asks the last question if one exists, ensuring the question is asked with the updated scope.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_evidence_scope_changed</span>(<span style="color: #008000">self</span>, include: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>], exclude: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;include&quot;</span>: <span style="color: #008000">list</span>(include), <span style="color: #BA2121">&quot;exclude&quot;</span>: <span style="color: #008000">list</span>(exclude)}
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_session(scope<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_current_retrieval_scope)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_scope_chip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ask_question(<span style="color: #008000">self</span><span style="color: #666666">.</span>_last_question, triggered_by_scope<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
</code></pre>
<h3 id="_update_question_prerequisites">Method: _update_question_prerequisites(self, state: ConnectionState) -&gt; None</h3>
<p>The function `_update_question_prerequisites` updates the state of the question input widget based on the connection status and document availability. It checks if the LMStudio is connected and if at least one document has been indexed. If the connection is unavailable, it sets an appropriate error message. If the connection is valid but no documents are present, it disables the question input and shows a message prompting the user to index at least one document. The function ultimately calls `set_prerequisites_met` on the `question_input` widget to reflect the current state and associated message.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_question_prerequisites</span>(<span style="color: #008000">self</span>, state: ConnectionState) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        ok <span style="color: #666666">=</span> state<span style="color: #666666">.</span>connected
        message: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> state<span style="color: #666666">.</span>connected:
            message <span style="color: #666666">=</span> state<span style="color: #666666">.</span>message <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;LMStudio connection unavailable.&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> ok <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_has_documents:
            ok <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
            message <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Index at least one document to enable questions.&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_prerequisites_met(ok, message)
</code></pre>
<h3 id="_on_connection_state_changed">Method: _on_connection_state_changed(self, state: ConnectionState) -&gt; None</h3>
<p>The function `_on_connection_state_changed` updates the UI based on the connection state with LMStudio. It sets the connection state in the question input widget, displays a message in the status bar indicating the connection status or an unavailable message if not connected, and updates the prerequisites for asking questions.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_connection_state_changed</span>(<span style="color: #008000">self</span>, state: ConnectionState) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_connection_state(state)
        <span style="color: #008000; font-weight: bold">if</span> state<span style="color: #666666">.</span>message:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>statusBar()<span style="color: #666666">.</span>showMessage(state<span style="color: #666666">.</span>message, <span style="color: #666666">4000</span>)
        <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #AA22FF; font-weight: bold">not</span> state<span style="color: #666666">.</span>connected:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>statusBar()<span style="color: #666666">.</span>showMessage(<span style="color: #BA2121">&quot;LMStudio connection unavailable.&quot;</span>, <span style="color: #666666">4000</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_question_prerequisites(state)
</code></pre>
<h3 id="_open_settings">Method: _open_settings(self) -&gt; None</h3>
<p>The function `_open_settings` is a method of the `MainWindow` class that displays an information message box with the title &quot;Settings&quot; and the message &quot;Settings dialog coming soon.&quot; This function currently serves as a placeholder for future implementation of a settings dialog.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_open_settings</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        QMessageBox<span style="color: #666666">.</span>information(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Settings&quot;</span>, <span style="color: #BA2121">&quot;Settings dialog coming soon.&quot;</span>)
</code></pre>
<h3 id="_open_help">Method: _open_help(self) -&gt; None</h3>
<p>The function `_open_help` displays an information message box with the title &quot;Help&quot; and the message &quot;Visit the documentation for assistance.&quot; It is triggered from the `MainWindow` class and does not return any value.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_open_help</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        QMessageBox<span style="color: #666666">.</span>information(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;Help&quot;</span>, <span style="color: #BA2121">&quot;Visit the documentation for assistance.&quot;</span>)
</code></pre>
<h3 id="_apply_theme">Method: _apply_theme(self, theme: str) -&gt; None</h3>
<p>The function `_apply_theme` applies a specified theme by calling the `apply_theme()` method from the `settings_service` and displays a toast message indicating the theme change.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_theme</span>(<span style="color: #008000">self</span>, theme: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>apply_theme()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_show_toast(<span style="color: #BA2121">f&quot;Theme set to </span><span style="color: #A45A77; font-weight: bold">{</span>theme<span style="color: #666666">.</span>title()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=1500</span>)
</code></pre>
<h3 id="_apply_font_scale">Method: _apply_font_scale(self, _scale: float) -&gt; None</h3>
<p>The function `_apply_font_scale` is a method of the `MainWindow` class that applies a font scale adjustment by calling the `apply_font_scale()` method from the `settings_service` instance. It takes a single parameter `_scale` of type `float`, which is intended to define the scaling factor for fonts, although the parameter is not used within the function body. The method does not return any value.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_font_scale</span>(<span style="color: #008000">self</span>, _scale: <span style="color: #008000">float</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>settings_service<span style="color: #666666">.</span>apply_font_scale()
</code></pre>
<h3 id="_on_model_changed">Method: _on_model_changed(self, name: str) -&gt; None</h3>
<p>The function `_on_model_changed` is triggered when the selected AI model is changed. It takes a model name as input, strips any leading or trailing whitespace, and if the resulting string is not empty, it updates the LMStudio client with the new model, sets the model name in the question input field, and persists the updated conversation settings.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_model_changed</span>(<span style="color: #008000">self</span>, name: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        cleaned <span style="color: #666666">=</span> <span style="color: #008000">str</span>(name)<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> cleaned:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>lmstudio_client<span style="color: #666666">.</span>configure(model<span style="color: #666666">=</span>cleaned)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_model_name(cleaned)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist_conversation_settings()
</code></pre>
<h3 id="_on_answer_length_changed">Method: _on_answer_length_changed(self, preset: AnswerLength) -&gt; None</h3>
<p>The function `_on_answer_length_changed` updates the answer length setting in the question input field and synchronizes the corresponding UI actions. It also persists the updated conversation settings. The parameter `preset` is expected to be an instance of the `AnswerLength` enum, which determines the length of the AI-generated answers. The function ensures that the UI reflects the selected answer length and saves the configuration.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_answer_length_changed</span>(<span style="color: #008000">self</span>, preset: AnswerLength) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(preset, AnswerLength):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_answer_length(preset)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_sync_answer_length_actions(preset)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_persist_conversation_settings()
</code></pre>
<h3 id="_on_answer_length_action_triggered">Method: _on_answer_length_action_triggered(self, action: QAction) -&gt; None</h3>
<p>The function `_on_answer_length_action_triggered` is a slot method that handles changes to the answer length setting in the user interface. It retrieves an `AnswerLength` preset from the triggered `QAction`, validates its type, and applies it to the current conversation settings. This allows users to select predefined answer length options, which are then used to configure the response length for AI-generated answers within the application&#x27;s conversation context.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_answer_length_action_triggered</span>(<span style="color: #008000">self</span>, action: QAction) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        preset <span style="color: #666666">=</span> action<span style="color: #666666">.</span>data()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(preset, AnswerLength):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_answer_length(preset)
</code></pre>
<h3 id="_sync_answer_length_actions">Method: _sync_answer_length_actions(self, preset: AnswerLength) -&gt; None</h3>
<p>The function `_sync_answer_length_actions` synchronizes the checked state of actions within a QActionGroup based on the provided `AnswerLength` preset. It retrieves the action group using the attribute name `_length_action_group`, and if the group exists, it iterates through its actions. For each action with data of type `AnswerLength`, it sets the action&#x27;s checked state to `True` if the action&#x27;s data matches the provided preset, otherwise `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sync_answer_length_actions</span>(<span style="color: #008000">self</span>, preset: AnswerLength) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        group <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_length_action_group&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> group <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">for</span> action <span style="color: #AA22FF; font-weight: bold">in</span> group<span style="color: #666666">.</span>actions():
            data <span style="color: #666666">=</span> action<span style="color: #666666">.</span>data()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(data, AnswerLength):
                action<span style="color: #666666">.</span>setChecked(data <span style="color: #AA22FF; font-weight: bold">is</span> preset)
</code></pre>
<h3 id="_prompt_model_name">Method: _prompt_model_name(self) -&gt; None</h3>
<p>The function `_prompt_model_name` displays a dialog box to allow the user to set or modify the LMStudio model identifier. It retrieves the current model name from `self.conversation_settings`, shows it in a text input dialog, and updates the settings with the new value if the user confirms the change. If the user cancels the dialog or provides an empty string, no changes are made.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_prompt_model_name</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        current <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>model_name
        name, ok <span style="color: #666666">=</span> QInputDialog<span style="color: #666666">.</span>getText(
            <span style="color: #008000">self</span>,
            <span style="color: #BA2121">&quot;Set LMStudio Model&quot;</span>,
            <span style="color: #BA2121">&quot;Model identifier:&quot;</span>,
            QLineEdit<span style="color: #666666">.</span>EchoMode<span style="color: #666666">.</span>Normal,
            current,
        )
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> ok:
            <span style="color: #008000; font-weight: bold">return</span>
        cleaned <span style="color: #666666">=</span> name<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> cleaned:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>conversation_settings<span style="color: #666666">.</span>set_model_name(cleaned)
</code></pre>
<h3 id="_on_progress_started">Method: _on_progress_started(self, update: ProgressUpdate) -&gt; None</h3>
<p>The function `_on_progress_started` updates the progress bar UI element based on the provided `ProgressUpdate` object. It sets the progress bar&#x27;s format to the message from the update, configures its range and value according to whether the progress is indeterminate or has a percentage, and ensures the progress bar is visible.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_progress_started</span>(<span style="color: #008000">self</span>, update: ProgressUpdate) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setFormat(update<span style="color: #666666">.</span>message <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Working...&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setRange(<span style="color: #666666">0</span>, <span style="color: #666666">0</span> <span style="color: #008000; font-weight: bold">if</span> update<span style="color: #666666">.</span>indeterminate <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">100</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setValue(<span style="color: #666666">0</span> <span style="color: #008000; font-weight: bold">if</span> update<span style="color: #666666">.</span>percent <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">int</span>(update<span style="color: #666666">.</span>percent))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">True</span>)
</code></pre>
<h3 id="_on_progress_updated">Method: _on_progress_updated(self, update: ProgressUpdate) -&gt; None</h3>
<p>The function `_on_progress_updated` updates the progress bar in the main window based on a `ProgressUpdate` object. It sets the progress bar&#x27;s format to the message provided in the update, adjusts the range to indeterminate mode if specified, or sets a determinate range with a percentage value clamped between 0 and 100.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_progress_updated</span>(<span style="color: #008000">self</span>, update: ProgressUpdate) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> update<span style="color: #666666">.</span>message:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setFormat(update<span style="color: #666666">.</span>message)
        <span style="color: #008000; font-weight: bold">if</span> update<span style="color: #666666">.</span>indeterminate:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setRange(<span style="color: #666666">0</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000; font-weight: bold">elif</span> update<span style="color: #666666">.</span>percent <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setRange(<span style="color: #666666">0</span>, <span style="color: #666666">100</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setValue(<span style="color: #008000">int</span>(<span style="color: #008000">max</span>(<span style="color: #666666">0</span>, <span style="color: #008000">min</span>(<span style="color: #666666">100</span>, update<span style="color: #666666">.</span>percent))))
</code></pre>
<h3 id="_on_progress_finished">Method: _on_progress_finished(self, update: ProgressUpdate) -&gt; None</h3>
<p>The function `_on_progress_finished` handles the completion of a progress update by displaying an optional message in the status bar and hiding the progress bar. It checks if a message is present in the `update` object, shows it in the status bar for 3 seconds, and then makes the progress bar invisible.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_progress_finished</span>(<span style="color: #008000">self</span>, update: ProgressUpdate) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> update<span style="color: #666666">.</span>message:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>statusBar()<span style="color: #666666">.</span>showMessage(update<span style="color: #666666">.</span>message, <span style="color: #666666">3000</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress_bar<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_show_toast">Method: _show_toast(self, message: str, level: str, duration_ms: int) -&gt; None</h3>
<p>Displays a toast message with the specified content, level, and duration using the application&#x27;s toast notification system.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_show_toast</span>(<span style="color: #008000">self</span>, message: <span style="color: #008000">str</span>, level: <span style="color: #008000">str</span>, duration_ms: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_toast<span style="color: #666666">.</span>show_message(message, level<span style="color: #666666">=</span>level, duration_ms<span style="color: #666666">=</span>duration_ms)
</code></pre>
<h3 id="_project_label_text">Method: _project_label_text(self) -&gt; str</h3>
<p>The function `_project_label_text` retrieves the version of the `DataMiner` package using `importlib.metadata.version`. If the package is not found, it defaults to version &quot;0.0.0&quot;. It then returns a formatted string &quot;DataMiner v{version}&quot; representing the project&#x27;s label text.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_project_label_text</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">try</span>:
            version <span style="color: #666666">=</span> metadata<span style="color: #666666">.</span>version(<span style="color: #BA2121">&quot;DataMiner&quot;</span>)
        <span style="color: #008000; font-weight: bold">except</span> metadata<span style="color: #666666">.</span>PackageNotFoundError:
            version <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;0.0.0&quot;</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">f&quot;DataMiner v</span><span style="color: #A45A77; font-weight: bold">{</span>version<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
</code></pre>
<h3 id="_update_lmstudio_status">Method: _update_lmstudio_status(self) -&gt; None</h3>
<p>The function `_update_lmstudio_status` checks the health status of the LMStudio client if the health monitor is enabled. If the monitor is disabled, it sets a warning message in the question input field. Otherwise, it initiates a background thread to perform a health check on the LMStudio client and updates the UI with the result using a Qt timer.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_lmstudio_status</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>enable_health_monitor:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_status_message(<span style="color: #BA2121">&quot;LMStudio monitor off&quot;</span>, <span style="color: #BA2121">&quot;warning&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span>

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">worker</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
            healthy <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>lmstudio_client<span style="color: #666666">.</span>health_check()
            QTimer<span style="color: #666666">.</span>singleShot(<span style="color: #666666">0</span>, partial(<span style="color: #008000">self</span><span style="color: #666666">.</span>_set_lmstudio_status, healthy))

        threading<span style="color: #666666">.</span>Thread(target<span style="color: #666666">=</span>worker, daemon<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)<span style="color: #666666">.</span>start()
</code></pre>
<details>
<summary>Subfunction: worker() -&gt; None</summary>
<h4 id="worker">worker() -&gt; None</h4>
<p>The `worker` function performs a health check on the LMStudio client and updates the status UI element with the result. It is designed to run asynchronously, using `QTimer.singleShot` to schedule the status update without blocking the main thread. The function retrieves the health status of the LMStudio client and passes it to `_set_lmstudio_status` for UI rendering.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">worker</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
            healthy <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>lmstudio_client<span style="color: #666666">.</span>health_check()
            QTimer<span style="color: #666666">.</span>singleShot(<span style="color: #666666">0</span>, partial(<span style="color: #008000">self</span><span style="color: #666666">.</span>_set_lmstudio_status, healthy))
</code></pre>
</details>
<h3 id="_set_lmstudio_status">Method: _set_lmstudio_status(self, healthy: bool) -&gt; None</h3>
<p>The function `_set_lmstudio_status` updates the connection state of the LMStudio client within the application&#x27;s user interface. It accepts a boolean parameter `healthy` indicating the health status of the LMStudio service. If the service is not healthy, it sets an error message indicating that the health probe failed. The function then updates the connection state of the question input field using the `ConnectionState` class, which likely triggers a visual update in the GUI to reflect the connection status.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_set_lmstudio_status</span>(<span style="color: #008000">self</span>, healthy: <span style="color: #008000">bool</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        message <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">if</span> healthy <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;LMStudio health probe failed&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_input<span style="color: #666666">.</span>set_connection_state(ConnectionState(healthy, message))
</code></pre>
<h3 id="closeEvent">Method: closeEvent(self, event: QCloseEvent) -&gt; None</h3>
<p>The `closeEvent` function handles the window closing process for the `MainWindow` class. It performs cleanup operations including stopping health and ingest timers, unsubscribing from connection and ingest events, and storing splitter sizes and active project session data. The function ensures that all resources are properly released and state is persisted before the application window is closed, then delegates to the parent class&#x27;s close event handler.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">closeEvent</span>(<span style="color: #008000">self</span>, event: QCloseEvent) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:  <span style="color: #3D7B7B; font-style: italic"># type: ignore[override]</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_health_timer&quot;</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_health_timer<span style="color: #666666">.</span>stop()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_ingest_timer&quot;</span>):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ingest_timer<span style="color: #666666">.</span>stop()
        unsubscribe <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_connection_unsubscribe&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> callable(unsubscribe):
            <span style="color: #008000; font-weight: bold">try</span>:
                unsubscribe()
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
                <span style="color: #008000; font-weight: bold">pass</span>
        ingest_unsubscribe <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(<span style="color: #008000">self</span>, <span style="color: #BA2121">&quot;_ingest_unsubscribe&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> callable(ingest_unsubscribe):
            <span style="color: #008000; font-weight: bold">try</span>:
                ingest_unsubscribe()
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
                <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_splitter_sizes()
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
            <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_active_project_session()
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:
            <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">super</span>()<span style="color: #666666">.</span>closeEvent(event)
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
