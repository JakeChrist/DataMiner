<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>test_storage</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>test_storage</h1>
        <p>This module defines tests for repository classes that manage project, document, chat, and ingest data within a database. It includes fixtures to set up and tear down database connections and repositories, and tests cover basic CRUD operations, cascading deletes, data isolation between projects, tag management with counts, and searching of document chunks. The tests verify correct behavior of the storage layer including file versioning, tagging, citations, reasoning summaries, and scope-based queries.</p>
<h2>Functions</h2>
<h3 id="database">database(tmp_path: Path) -&gt; DatabaseManager</h3>
<p>The function `database` is a generator that creates and manages a `DatabaseManager` instance for a specified temporary path. It constructs the database file path using the provided `tmp_path`, initializes the database manager, yields the initialized manager, and ensures the database connection is closed after use. The function is designed to provide a context-managed database interface within a temporary directory.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">database</span>(tmp_path: Path) <span style="color: #666666">-&gt;</span> DatabaseManager:
    db_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;dataminer.db&quot;</span>
    manager <span style="color: #666666">=</span> DatabaseManager(db_path)
    manager<span style="color: #666666">.</span>initialize()
    <span style="color: #008000; font-weight: bold">yield</span> manager
    manager<span style="color: #666666">.</span>close()
</code></pre>
<h3 id="project_repo">project_repo(database: DatabaseManager) -&gt; ProjectRepository</h3>
<p>The function `project_repo` takes a `DatabaseManager` instance as input and returns a `ProjectRepository` object initialized with that database manager. This function serves as a factory for creating `ProjectRepository` instances, which are likely responsible for managing project-related data operations through the provided database interface.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">project_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> ProjectRepository:
    <span style="color: #008000; font-weight: bold">return</span> ProjectRepository(database)
</code></pre>
<h3 id="document_repo">document_repo(database: DatabaseManager) -&gt; DocumentRepository</h3>
<p>The function `document_repo` takes a `DatabaseManager` instance as input and returns a `DocumentRepository` object initialized with that database manager. This function serves as a factory for creating `DocumentRepository` instances, which are likely responsible for managing document-related operations within the application&#x27;s data layer.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">document_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> DocumentRepository:
    <span style="color: #008000; font-weight: bold">return</span> DocumentRepository(database)
</code></pre>
<h3 id="chat_repo">chat_repo(database: DatabaseManager) -&gt; ChatRepository</h3>
<p>The function `chat_repo` takes a `DatabaseManager` instance as input and returns a `ChatRepository` object initialized with that database manager. It serves as a factory function for creating chat repository instances tied to a specific database connection.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">chat_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> ChatRepository:
    <span style="color: #008000; font-weight: bold">return</span> ChatRepository(database)
</code></pre>
<h3 id="ingest_repo">ingest_repo(database: DatabaseManager) -&gt; IngestDocumentRepository</h3>
<p>The function `ingest_repo` creates and returns an instance of `IngestDocumentRepository`, initialized with a provided `DatabaseManager` object. This repository is responsible for managing document ingestion operations within the application&#x27;s database context.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">ingest_repo</span>(database: DatabaseManager) <span style="color: #666666">-&gt;</span> IngestDocumentRepository:
    <span style="color: #008000; font-weight: bold">return</span> IngestDocumentRepository(database)
</code></pre>
<h3 id="test_project_crud">test_project_crud(project_repo: ProjectRepository) -&gt; None</h3>
<p>The function `test_project_crud` tests the basic CRUD (Create, Read, Update, Delete) operations on a project repository. It creates a project with the name &quot;Project Alpha&quot; and verifies its creation. It then retrieves the project and checks that the retrieved data matches the original. The function updates the project&#x27;s name to &quot;Renamed&quot; and confirms the update. It lists all projects and ensures only one exists. Finally, it deletes the project and verifies that the project is no longer retrievable.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_project_crud</span>(project_repo: ProjectRepository) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    project <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Project Alpha&quot;</span>, description<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Primary&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> project[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;Project Alpha&quot;</span>

    fetched <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>get(project[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> fetched <span style="color: #666666">==</span> project

    updated <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>update(project[<span style="color: #BA2121">&quot;id&quot;</span>], name<span style="color: #666666">=</span><span style="color: #BA2121">&quot;Renamed&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> updated[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;Renamed&quot;</span>

    all_projects <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>list()
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">len</span>(all_projects) <span style="color: #666666">==</span> <span style="color: #666666">1</span>

    project_repo<span style="color: #666666">.</span>delete(project[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> project_repo<span style="color: #666666">.</span>get(project[<span style="color: #BA2121">&quot;id&quot;</span>]) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="test_document_crud_and_cascade">test_document_crud_and_cascade(tmp_path: Path, project_repo: ProjectRepository, document_repo: DocumentRepository, chat_repo: ChatRepository) -&gt; None</h3>
<p>The function `test_document_crud_and_cascade` tests the creation, modification, and deletion of documents and related entities within a project, ensuring proper cascading behavior when a project is deleted. It creates a project, document, file version, tag, chat, citation, and reasoning summary. It verifies that these entities are correctly associated and that deleting the project results in the removal of all related data including documents, versions, chats, citations, and summaries. The test also confirms that the underlying file remains intact after deletion.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_document_crud_and_cascade</span>(
    tmp_path: Path,
    project_repo: ProjectRepository,
    document_repo: DocumentRepository,
    chat_repo: ChatRepository,
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    project <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Project Beta&quot;</span>)
    document <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(
        project[<span style="color: #BA2121">&quot;id&quot;</span>],
        <span style="color: #BA2121">&quot;Spec Sheet&quot;</span>,
        source_type<span style="color: #666666">=</span><span style="color: #BA2121">&quot;file&quot;</span>,
        source_path<span style="color: #666666">=</span>tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;spec.pdf&quot;</span>,
        metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;pages&quot;</span>: <span style="color: #666666">12</span>},
    )
    <span style="color: #008000; font-weight: bold">assert</span> document[<span style="color: #BA2121">&quot;metadata&quot;</span>] <span style="color: #666666">==</span> {<span style="color: #BA2121">&quot;pages&quot;</span>: <span style="color: #666666">12</span>}

    file_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;spec.pdf&quot;</span>
    file_path<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;dummy data&quot;</span>)
    version <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>add_file_version(
        document[<span style="color: #BA2121">&quot;id&quot;</span>],
        file_path<span style="color: #666666">=</span>file_path,
        checksum<span style="color: #666666">=</span><span style="color: #BA2121">&quot;abc123&quot;</span>,
        file_size<span style="color: #666666">=</span>file_path<span style="color: #666666">.</span>stat()<span style="color: #666666">.</span>st_size,
    )
    <span style="color: #008000; font-weight: bold">assert</span> version[<span style="color: #BA2121">&quot;version&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">1</span>

    tag <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create_tag(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;urgent&quot;</span>)
    document_repo<span style="color: #666666">.</span>tag_document(document[<span style="color: #BA2121">&quot;id&quot;</span>], tag[<span style="color: #BA2121">&quot;id&quot;</span>])
    tags <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>list_tags_for_document(document[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> tags[<span style="color: #666666">0</span>][<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;urgent&quot;</span>

    chat <span style="color: #666666">=</span> chat_repo<span style="color: #666666">.</span>create(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Review&quot;</span>)
    citation <span style="color: #666666">=</span> chat_repo<span style="color: #666666">.</span>add_citation(chat[<span style="color: #BA2121">&quot;id&quot;</span>], document_id<span style="color: #666666">=</span>document[<span style="color: #BA2121">&quot;id&quot;</span>], snippet<span style="color: #666666">=</span><span style="color: #BA2121">&quot;See section 2&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> citation[<span style="color: #BA2121">&quot;document_id&quot;</span>] <span style="color: #666666">==</span> document[<span style="color: #BA2121">&quot;id&quot;</span>]
    summary <span style="color: #666666">=</span> chat_repo<span style="color: #666666">.</span>add_reasoning_summary(chat[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Relevant to requirements&quot;</span>)
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #BA2121">&quot;Relevant&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> summary[<span style="color: #BA2121">&quot;content&quot;</span>]

    <span style="color: #3D7B7B; font-style: italic"># deleting the project should cascade to documents, versions, chats, etc.</span>
    project_repo<span style="color: #666666">.</span>delete(project[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> document_repo<span style="color: #666666">.</span>get(document[<span style="color: #BA2121">&quot;id&quot;</span>]) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> document_repo<span style="color: #666666">.</span>get_file_version(version[<span style="color: #BA2121">&quot;id&quot;</span>]) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> chat_repo<span style="color: #666666">.</span>get(chat[<span style="color: #BA2121">&quot;id&quot;</span>]) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> chat_repo<span style="color: #666666">.</span>get_citation(citation[<span style="color: #BA2121">&quot;id&quot;</span>]) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">assert</span> chat_repo<span style="color: #666666">.</span>get_reasoning_summary(summary[<span style="color: #BA2121">&quot;id&quot;</span>]) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>

    <span style="color: #3D7B7B; font-style: italic"># ensure the backing file remains untouched</span>
    <span style="color: #008000; font-weight: bold">assert</span> file_path<span style="color: #666666">.</span>exists()
</code></pre>
<h3 id="test_project_isolation">test_project_isolation(project_repo: ProjectRepository, document_repo: DocumentRepository) -&gt; None</h3>
<p>The function `test_project_isolation` verifies that projects within the repository system are properly isolated from one another. It creates two distinct projects, &quot;Project A&quot; and &quot;Project B&quot;, and associates each with a unique document. The test confirms that each project&#x27;s documents can be retrieved correctly using its respective project ID. It then deletes &quot;Project A&quot; and ensures that the document belonging to &quot;Project B&quot; remains accessible, validating that deletion of one project does not affect another project&#x27;s data.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_project_isolation</span>(
    project_repo: ProjectRepository, document_repo: DocumentRepository
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    project_a <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Project A&quot;</span>)
    project_b <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Project B&quot;</span>)

    doc_a <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project_a[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Doc A&quot;</span>)
    doc_b <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(project_b[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;Doc B&quot;</span>)

    docs_for_a <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>list_for_project(project_a[<span style="color: #BA2121">&quot;id&quot;</span>])
    docs_for_b <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>list_for_project(project_b[<span style="color: #BA2121">&quot;id&quot;</span>])

    <span style="color: #008000; font-weight: bold">assert</span> {doc[<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> docs_for_a} <span style="color: #666666">==</span> {doc_a[<span style="color: #BA2121">&quot;id&quot;</span>]}
    <span style="color: #008000; font-weight: bold">assert</span> {doc[<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> docs_for_b} <span style="color: #666666">==</span> {doc_b[<span style="color: #BA2121">&quot;id&quot;</span>]}

    <span style="color: #3D7B7B; font-style: italic"># deleting one project should not remove the other project&#39;s data</span>
    project_repo<span style="color: #666666">.</span>delete(project_a[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> document_repo<span style="color: #666666">.</span>get(doc_b[<span style="color: #BA2121">&quot;id&quot;</span>]) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="test_tag_counts_and_scope_queries">test_tag_counts_and_scope_queries(tmp_path: Path, project_repo: ProjectRepository, document_repo: DocumentRepository) -&gt; None</h3>
<p>The function `test_tag_counts_and_scope_queries` tests the tagging and scoping functionality within a document repository. It creates a project and a document, then associates the document with two tags: &quot;focus&quot; and &quot;aux&quot;. It verifies that tag counts are correctly updated when documents are tagged and untagged. The test also ensures that documents can be retrieved by tag or folder scope, and confirms that tag counts are properly decremented when a document is deleted. The function validates the behavior of tag-based queries and scope filtering in the document repository.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_tag_counts_and_scope_queries</span>(
    tmp_path: Path, project_repo: ProjectRepository, document_repo: DocumentRepository
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    project <span style="color: #666666">=</span> project_repo<span style="color: #666666">.</span>create(<span style="color: #BA2121">&quot;Project Tags&quot;</span>)
    doc_path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;corpus&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;alpha&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;plan.txt&quot;</span>
    doc_path<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
    doc_path<span style="color: #666666">.</span>write_text(<span style="color: #BA2121">&quot;content&quot;</span>)

    document <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create(
        project[<span style="color: #BA2121">&quot;id&quot;</span>],
        <span style="color: #BA2121">&quot;Launch Plan&quot;</span>,
        source_path<span style="color: #666666">=</span>doc_path,
        metadata<span style="color: #666666">=</span>{<span style="color: #BA2121">&quot;pages&quot;</span>: <span style="color: #666666">3</span>},
    )
    tag_focus <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create_tag(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;focus&quot;</span>)
    tag_aux <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>create_tag(project[<span style="color: #BA2121">&quot;id&quot;</span>], <span style="color: #BA2121">&quot;aux&quot;</span>)

    <span style="color: #008000; font-weight: bold">assert</span> tag_focus[<span style="color: #BA2121">&quot;document_count&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">0</span>

    document_repo<span style="color: #666666">.</span>tag_document(document[<span style="color: #BA2121">&quot;id&quot;</span>], tag_focus[<span style="color: #BA2121">&quot;id&quot;</span>])
    document_repo<span style="color: #666666">.</span>tag_document(document[<span style="color: #BA2121">&quot;id&quot;</span>], tag_aux[<span style="color: #BA2121">&quot;id&quot;</span>])

    refreshed <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>get_tag(tag_focus[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> refreshed[<span style="color: #BA2121">&quot;document_count&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">1</span>

    tags_for_project <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>list_tags_for_project(project[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> {tag[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> tag <span style="color: #AA22FF; font-weight: bold">in</span> tags_for_project} <span style="color: #666666">==</span> {<span style="color: #BA2121">&quot;focus&quot;</span>, <span style="color: #BA2121">&quot;aux&quot;</span>}

    document_repo<span style="color: #666666">.</span>untag_document(document[<span style="color: #BA2121">&quot;id&quot;</span>], tag_focus[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> document_repo<span style="color: #666666">.</span>get_tag(tag_focus[<span style="color: #BA2121">&quot;id&quot;</span>])[<span style="color: #BA2121">&quot;document_count&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">0</span>

    folder_docs <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>list_for_folder(project[<span style="color: #BA2121">&quot;id&quot;</span>], document[<span style="color: #BA2121">&quot;folder_path&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> [doc[<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> folder_docs] <span style="color: #666666">==</span> [document[<span style="color: #BA2121">&quot;id&quot;</span>]]

    tag_docs <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>list_for_tag(project[<span style="color: #BA2121">&quot;id&quot;</span>], tag_aux[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> [doc[<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> tag_docs] <span style="color: #666666">==</span> [document[<span style="color: #BA2121">&quot;id&quot;</span>]]

    scoped_docs <span style="color: #666666">=</span> document_repo<span style="color: #666666">.</span>list_for_scope(
        project[<span style="color: #BA2121">&quot;id&quot;</span>], tags<span style="color: #666666">=</span>[tag_aux[<span style="color: #BA2121">&quot;id&quot;</span>]], folder<span style="color: #666666">=</span>document[<span style="color: #BA2121">&quot;folder_path&quot;</span>]
    )
    <span style="color: #008000; font-weight: bold">assert</span> [doc[<span style="color: #BA2121">&quot;id&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> scoped_docs] <span style="color: #666666">==</span> [document[<span style="color: #BA2121">&quot;id&quot;</span>]]

    document_repo<span style="color: #666666">.</span>delete(document[<span style="color: #BA2121">&quot;id&quot;</span>])
    <span style="color: #008000; font-weight: bold">assert</span> document_repo<span style="color: #666666">.</span>get_tag(tag_aux[<span style="color: #BA2121">&quot;id&quot;</span>])[<span style="color: #BA2121">&quot;document_count&quot;</span>] <span style="color: #666666">==</span> <span style="color: #666666">0</span>
</code></pre>
<h3 id="test_ingest_chunk_storage">test_ingest_chunk_storage(tmp_path: Path, ingest_repo: IngestDocumentRepository) -&gt; None</h3>
<p>The function `test_ingest_chunk_storage` tests the document ingestion and chunk storage functionality. It creates a temporary text file with sample content, parses the content into a `ParsedDocument`, and stores it using an `IngestDocumentRepository`. It then searches for chunks containing the term &quot;gamma&quot; and verifies that matching chunks are returned. The test also confirms that at least one chunk is stored in the database table `ingest_document_chunks`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">test_ingest_chunk_storage</span>(
    tmp_path: Path, ingest_repo: IngestDocumentRepository
) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
    path <span style="color: #666666">=</span> tmp_path <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;evidence.txt&quot;</span>
    path<span style="color: #666666">.</span>write_text(
        <span style="color: #BA2121">&quot;Alpha beta gamma delta epsilon zeta eta theta iota.&quot;</span>,
        encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>,
    )
    parsed <span style="color: #666666">=</span> ParsedDocument(text<span style="color: #666666">=</span>path<span style="color: #666666">.</span>read_text(encoding<span style="color: #666666">=</span><span style="color: #BA2121">&quot;utf-8&quot;</span>), metadata<span style="color: #666666">=</span>{})
    record <span style="color: #666666">=</span> ingest_repo<span style="color: #666666">.</span>store_version(
        path<span style="color: #666666">=</span><span style="color: #008000">str</span>(path),
        checksum<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        size<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        mtime<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        ctime<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>,
        parsed<span style="color: #666666">=</span>parsed,
    )
    <span style="color: #008000; font-weight: bold">assert</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
    chunk_results <span style="color: #666666">=</span> ingest_repo<span style="color: #666666">.</span>search_chunks(<span style="color: #BA2121">&quot;gamma&quot;</span>, limit<span style="color: #666666">=5</span>)
    <span style="color: #008000; font-weight: bold">assert</span> chunk_results
    texts <span style="color: #666666">=</span> [entry[<span style="color: #BA2121">&quot;chunk&quot;</span>][<span style="color: #BA2121">&quot;text&quot;</span>] <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> chunk_results <span style="color: #008000; font-weight: bold">if</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;chunk&quot;</span>)]
    <span style="color: #008000; font-weight: bold">assert</span> <span style="color: #008000">any</span>(<span style="color: #BA2121">&quot;gamma&quot;</span> <span style="color: #AA22FF; font-weight: bold">in</span> text <span style="color: #008000; font-weight: bold">for</span> text <span style="color: #AA22FF; font-weight: bold">in</span> texts)
    count <span style="color: #666666">=</span> ingest_repo<span style="color: #666666">.</span>db<span style="color: #666666">.</span>connect()<span style="color: #666666">.</span>execute(
        <span style="color: #BA2121">&quot;SELECT COUNT(*) FROM ingest_document_chunks&quot;</span>
    )<span style="color: #666666">.</span>fetchone()[<span style="color: #666666">0</span>]
    <span style="color: #008000; font-weight: bold">assert</span> count <span style="color: #666666">&gt;=</span> <span style="color: #666666">1</span>
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
