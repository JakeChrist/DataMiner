<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>index</h1>
        <p>The module defines components for semantic passage retrieval using vector similarity. It includes functions to normalize vectors and compute cosine similarity. The `Passage` data class stores passage information, including embeddings, metadata, and normalized fields. The `RetrievalScope` class specifies constraints for filtering passages during retrieval. The `Citation` class maps retrieved passages to their source documents. The `RetrievedPassage` class structures the output of a retrieval query. The `RetrievalIndex` class manages a collection of passages and performs semantic search with optional diversity filtering and conflict detection. Helper methods support deduplication, preview generation, and conflict resolution based on metadata.</p>
<h2 id="Passage">Class: Passage</h2>
<p>The `Passage` class defines a container for storing textual passages along with associated metadata such as document ID, embedding, tags, and location information. It includes normalized versions of embedding, text, folder path, language, and tags, which are computed during object initialization. The class provides properties to access these normalized values and a deduplication key based on document ID, section, page, and lowercase normalized text.</p>
<h3 id="__post_init__">Method: __post_init__(self) -&gt; None</h3>
<p>The `__post_init__` method initializes several normalized and processed attributes of the `Passage` object after its creation. It normalizes the embedding vector, cleans and normalizes the text content, normalizes the folder path, converts the language to lowercase, creates a frozen set of integer tags, and ensures metadata is stored as a dictionary.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__post_init__</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:  <span style="color: #3D7B7B; font-style: italic"># noqa: D401 - documented on class</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalized_embedding <span style="color: #666666">=</span> _normalize_vector(<span style="color: #008000">self</span><span style="color: #666666">.</span>embedding)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalized_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">.</span>join(<span style="color: #008000">self</span><span style="color: #666666">.</span>text<span style="color: #666666">.</span>split())
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalized_folder <span style="color: #666666">=</span> _normalise_folder(<span style="color: #008000">self</span><span style="color: #666666">.</span>folder)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_language <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>language<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>language <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_tags <span style="color: #666666">=</span> <span style="color: #008000">frozenset</span>(<span style="color: #008000">int</span>(tag) <span style="color: #008000; font-weight: bold">for</span> tag <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>tags)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>metadata <span style="color: #AA22FF; font-weight: bold">or</span> {})
</code></pre>
<h3 id="normalized_embedding">Method: normalized_embedding(self) -&gt; tuple[float, ...]</h3>
<p>The function `normalized_embedding` is a property method within the `Passage` class that returns the normalized embedding vector associated with the passage. The embedding is stored as a tuple of floating-point numbers and is accessed via the private attribute `_normalized_embedding`. This method provides read-only access to the precomputed normalized embedding, which is typically used for similarity comparisons or indexing purposes in retrieval-augmented generation (RAG) systems.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">normalized_embedding</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">float</span>, <span style="color: #666666">...</span>]:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalized_embedding
</code></pre>
<h3 id="normalized_folder">Method: normalized_folder(self) -&gt; str | None</h3>
<p>The function `normalized_folder` is a property method within the `Passage` class that returns the value of the private attribute `_normalized_folder`. This attribute likely stores a standardized or processed version of a folder path, and the method provides read-only access to this value. The return type is annotated as `str | None`, indicating it may return either a string representing the normalized folder path or None if no such path is set.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">normalized_folder</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalized_folder
</code></pre>
<h3 id="normalized_language">Method: normalized_language(self) -&gt; str | None</h3>
<p>The `normalized_language` function is a property method within the `Passage` class that returns the normalized language identifier stored in the private attribute `_language`. The return type is annotated as `str | None`, indicating it can either return a string representing the language or `None` if no language information is available. This function provides read-only access to the language attribute of a passage instance.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">normalized_language</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_language
</code></pre>
<h3 id="tag_set">Method: tag_set(self) -&gt; frozenset[int]</h3>
<p>The function `tag_set` is a read-only property of the `Passage` class that returns a frozen set of integers representing the tags associated with the passage. The tags are stored in the private attribute `_tags`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">tag_set</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">frozenset</span>[<span style="color: #008000">int</span>]:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_tags
</code></pre>
<h3 id="deduplication_key">Method: deduplication_key(self) -&gt; tuple[int, str | None, int | None, str]</h3>
<p>The function `deduplication_key` returns a tuple that serves as a unique identifier for deduplication purposes within the `Passage` class. The tuple consists of four elements: the document ID, the section name, the page number, and the lowercase normalized text of the passage. This key enables identification of duplicate passages based on these attributes.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">deduplication_key</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">int</span>, <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, <span style="color: #008000">str</span>]:
        <span style="color: #008000; font-weight: bold">return</span> (
            <span style="color: #008000">self</span><span style="color: #666666">.</span>document_id,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>page,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalized_text<span style="color: #666666">.</span>lower(),
        )
</code></pre>
<h2 id="RetrievalScope">Class: RetrievalScope</h2>
<p>The `RetrievalScope` class defines a set of constraints for filtering retrieval results based on tags, folder paths, time ranges, and language settings. It normalizes and stores these constraints during initialization and provides a `matches` method to determine if a given passage satisfies all specified conditions. The class supports recursive folder matching, inclusive time range checks, and case-insensitive language filtering.</p>
<h3 id="__post_init__">Method: __post_init__(self) -&gt; None</h3>
<p>The `__post_init__` method initializes and normalizes attributes of the `RetrievalScope` class. It converts the `tags` and `languages` lists into tuples, creates a frozen set of integer tag IDs from `tags`, normalizes the `folder` path using `_normalise_folder`, and creates a frozen set of lowercase language codes from `languages`. The method ensures that `tags` and `languages` are properly structured as immutable collections for efficient lookup and comparison.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__post_init__</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:  <span style="color: #3D7B7B; font-style: italic"># noqa: D401 - documented on class</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>tags <span style="color: #666666">=</span> <span style="color: #008000">tuple</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>tags <span style="color: #AA22FF; font-weight: bold">or</span> [])
        <span style="color: #008000">self</span><span style="color: #666666">.</span>languages <span style="color: #666666">=</span> <span style="color: #008000">tuple</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>languages <span style="color: #AA22FF; font-weight: bold">or</span> [])
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_tags <span style="color: #666666">=</span> <span style="color: #008000">frozenset</span>(<span style="color: #008000">int</span>(tag) <span style="color: #008000; font-weight: bold">for</span> tag <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>tags)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_folder <span style="color: #666666">=</span> _normalise_folder(<span style="color: #008000">self</span><span style="color: #666666">.</span>folder)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_languages <span style="color: #666666">=</span> <span style="color: #008000">frozenset</span>(lang<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">for</span> lang <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>languages)
</code></pre>
<h3 id="matches">Method: matches(self, passage: Passage) -&gt; bool</h3>
<p>The `matches` function evaluates whether a given `Passage` object satisfies the filtering criteria defined by the `RetrievalScope`. It checks multiple conditions based on tags, folder path, time range, and language. If any condition fails, the function returns `False`. Otherwise, it returns `True`, indicating the passage is within the specified scope. The function considers optional filters such as tag inclusion, recursive or exact folder matching, start and end times, and supported languages.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">matches</span>(<span style="color: #008000">self</span>, passage: Passage) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_tags <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_tags<span style="color: #666666">.</span>issubset(passage<span style="color: #666666">.</span>tag_set):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_folder <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            folder <span style="color: #666666">=</span> passage<span style="color: #666666">.</span>normalized_folder
            <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>recursive:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> folder<span style="color: #666666">.</span>startswith(<span style="color: #008000">self</span><span style="color: #666666">.</span>_folder):
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #666666">!=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_folder:
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>start_time <span style="color: #AA22FF; font-weight: bold">and</span> (
            passage<span style="color: #666666">.</span>created_at <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">or</span> passage<span style="color: #666666">.</span>created_at <span style="color: #666666">&lt;</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>start_time
        ):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>end_time <span style="color: #AA22FF; font-weight: bold">and</span> (
            passage<span style="color: #666666">.</span>created_at <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">or</span> passage<span style="color: #666666">.</span>created_at <span style="color: #666666">&gt;</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>end_time
        ):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_languages <span style="color: #AA22FF; font-weight: bold">and</span> (
            passage<span style="color: #666666">.</span>normalized_language <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>
            <span style="color: #AA22FF; font-weight: bold">or</span> passage<span style="color: #666666">.</span>normalized_language <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_languages
        ):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
</code></pre>
<h2 id="Citation">Class: Citation</h2>
<p>The `Citation` class represents a reference to a specific location within a document, storing the document ID along with optional page number and section information. It provides a `to_dict()` method that serializes the citation data into a dictionary format containing the document identifier, page, and section. The class is designed to map passages back to their original document locations using typed attributes for document ID, page, and section.</p>
<h3 id="to_dict">Method: to_dict(self) -&gt; dict[str, Any]</h3>
<p>The function `to_dict` defines a method in the `Citation` class that returns a dictionary representation of the citation&#x27;s attributes. The dictionary includes the document ID, page number, and section information, mapping each to corresponding instance variables. This facilitates serialization or data exchange with other components.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">to_dict</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        <span style="color: #008000; font-weight: bold">return</span> {
            <span style="color: #BA2121">&quot;document_id&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>document_id,
            <span style="color: #BA2121">&quot;page&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>page,
            <span style="color: #BA2121">&quot;section&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>section,
        }
</code></pre>
<h2 id="RetrievedPassage">Class: RetrievedPassage</h2>
<p>The `RetrievedPassage` class represents a structured result payload containing retrieved passage data, including the passage itself, its score, preview text, citation information, and conflict details. It provides a `to_dict()` method that serializes the object&#x27;s attributes into a dictionary format, incorporating passage metadata, language, tags, folder, and creation timestamp when available. The serialized output includes fields such as passage ID, document ID, text content, score, preview, citation, metadata, and conflicts.</p>
<h3 id="to_dict">Method: to_dict(self) -&gt; dict[str, Any]</h3>
<p>The function `to_dict` converts the `RetrievedPassage` object into a dictionary representation. It includes fields from the embedded `passage` object such as `passage_id`, `document_id`, `text`, and `metadata`, along with additional attributes of the `RetrievedPassage` like `score`, `preview`, `citation`, and `conflicts`. Optional fields are included conditionally, such as `language`, `tags`, `folder`, and `created_at`, depending on whether they are set. The resulting dictionary provides a structured overview of the retrieved passage and its associated data.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">to_dict</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        record <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;passage_id&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>passage_id,
            <span style="color: #BA2121">&quot;document_id&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>document_id,
            <span style="color: #BA2121">&quot;text&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>text,
            <span style="color: #BA2121">&quot;score&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>score,
            <span style="color: #BA2121">&quot;preview&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>preview,
            <span style="color: #BA2121">&quot;citation&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>citation<span style="color: #666666">.</span>to_dict(),
            <span style="color: #BA2121">&quot;metadata&quot;</span>: <span style="color: #008000">dict</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>metadata),
            <span style="color: #BA2121">&quot;conflicts&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>conflicts,
        }
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>normalized_language <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            record[<span style="color: #BA2121">&quot;language&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>normalized_language
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>tag_set:
            record[<span style="color: #BA2121">&quot;tags&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">sorted</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>tag_set)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>normalized_folder <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            record[<span style="color: #BA2121">&quot;folder&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>normalized_folder
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>created_at <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            record[<span style="color: #BA2121">&quot;created_at&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>passage<span style="color: #666666">.</span>created_at
        <span style="color: #008000; font-weight: bold">return</span> record
</code></pre>
<h2 id="RetrievalIndex">Class: RetrievalIndex</h2>
<p>The `RetrievalIndex` class manages and retrieves passages based on semantic similarity using vector embeddings. It supports adding, removing, and clearing passages, and performs search operations that return top-k results while applying diversity filtering and conflict detection. The search method uses cosine similarity for scoring, deduplicates results, and constructs previews of passage content.</p>
<h3 id="__init__">Method: __init__(self) -&gt; None</h3>
<p>Initializes the `RetrievalIndex` class with an empty dictionary to store passages, where each passage is indexed by a string identifier.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_passages: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Passage] <span style="color: #666666">=</span> {}
</code></pre>
<h3 id="add_passage">Method: add_passage(self, passage: Passage) -&gt; None</h3>
<p>The function `add_passage` stores or replaces a passage in the vector index. It takes a `Passage` object as input and updates the internal `_passages` dictionary with the passage, using the passage&#x27;s ID as the key.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">add_passage</span>(<span style="color: #008000">self</span>, passage: Passage) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Store or replace a passage in the vector index.&quot;&quot;&quot;</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_passages[passage<span style="color: #666666">.</span>passage_id] <span style="color: #666666">=</span> passage
</code></pre>
<h3 id="remove_passage">Method: remove_passage(self, passage_id: str) -&gt; None</h3>
<p>The function `remove_passage` removes a passage from the internal storage of the `RetrievalIndex` class using the specified `passage_id`. If the `passage_id` does not exist in the storage, the operation has no effect. The function does not return any value.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">remove_passage</span>(<span style="color: #008000">self</span>, passage_id: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_passages<span style="color: #666666">.</span>pop(passage_id, <span style="color: #008000; font-weight: bold">None</span>)
</code></pre>
<h3 id="clear">Method: clear(self) -&gt; None</h3>
<p>The `clear` method clears all passages stored in the `self._passages` collection, removing all indexed content from the retrieval index.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">clear</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_passages<span style="color: #666666">.</span>clear()
</code></pre>
<h3 id="search">Method: search(self, query_embedding: Sequence[float], *, top_k: int=5, diversity: float=0.3, scope: RetrievalScope | None=None) -&gt; list[dict[str, Any]]</h3>
<p>The `search` method retrieves the top-k most relevant passages based on a query embedding, applying optional scope constraints and diversity filtering. It normalizes the query vector, filters passages according to the provided scope, scores the filtered passages, and applies a diversity filter to the top results. Conflicts among selected passages are detected, and the final results are formatted into dictionaries containing passage details, scores, previews, citations, and conflict information. If no passages match the scope or scoring yields no results, an empty list is returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">search</span>(
        <span style="color: #008000">self</span>,
        query_embedding: Sequence[<span style="color: #008000">float</span>],
        <span style="color: #666666">*</span>,
        top_k: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">5</span>,
        diversity: <span style="color: #008000">float</span> <span style="color: #666666">=</span> <span style="color: #666666">0.3</span>,
        scope: RetrievalScope <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return the top ``k`` passages respecting ``scope`` constraints.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">if</span> top_k <span style="color: #666666">&lt;=</span> <span style="color: #666666">0</span>:
            <span style="color: #008000; font-weight: bold">return</span> []
        normalized_query <span style="color: #666666">=</span> _normalize_vector(query_embedding)
        scope <span style="color: #666666">=</span> scope <span style="color: #AA22FF; font-weight: bold">or</span> RetrievalScope()
        filtered <span style="color: #666666">=</span> [
            passage
            <span style="color: #008000; font-weight: bold">for</span> passage <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_passages<span style="color: #666666">.</span>values()
            <span style="color: #008000; font-weight: bold">if</span> scope<span style="color: #666666">.</span>matches(passage)
        ]
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> filtered:
            <span style="color: #008000; font-weight: bold">return</span> []

        scored <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_score_passages(normalized_query, filtered)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> scored:
            <span style="color: #008000; font-weight: bold">return</span> []

        candidates <span style="color: #666666">=</span> <span style="color: #008000">sorted</span>(scored, key<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">lambda</span> item: item<span style="color: #666666">.</span>score, reverse<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        selected <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_diversity_filter(candidates, top_k, diversity)
        conflicts <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_detect_conflicts([item<span style="color: #666666">.</span>passage <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> selected])
        results <span style="color: #666666">=</span> [
            RetrievedPassage(
                passage<span style="color: #666666">=</span>item<span style="color: #666666">.</span>passage,
                score<span style="color: #666666">=</span>item<span style="color: #666666">.</span>score,
                preview<span style="color: #666666">=</span>item<span style="color: #666666">.</span>preview,
                citation<span style="color: #666666">=</span>Citation(
                    document_id<span style="color: #666666">=</span>item<span style="color: #666666">.</span>passage<span style="color: #666666">.</span>document_id,
                    page<span style="color: #666666">=</span>item<span style="color: #666666">.</span>passage<span style="color: #666666">.</span>page,
                    section<span style="color: #666666">=</span>item<span style="color: #666666">.</span>passage<span style="color: #666666">.</span>section,
                ),
                conflicts<span style="color: #666666">=</span>conflicts<span style="color: #666666">.</span>get(item<span style="color: #666666">.</span>passage<span style="color: #666666">.</span>passage_id, []),
            )<span style="color: #666666">.</span>to_dict()
            <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> selected
        ]
        <span style="color: #008000; font-weight: bold">return</span> results
</code></pre>
<h3 id="_score_passages">Method: _score_passages(self, normalized_query: Sequence[float], passages: Iterable[Passage]) -&gt; list[_ScoredPassage]</h3>
<p>The function `_score_passages` computes similarity scores between a normalized query and a collection of passages using cosine similarity. It deduplicates passages based on their deduplication keys, retaining only the passage with the highest score for each unique key. For each passage, it also generates a preview of the text. The result is a list of `_ScoredPassage` objects, each containing the original passage, its computed score, and its preview.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_score_passages</span>(
        <span style="color: #008000">self</span>,
        normalized_query: Sequence[<span style="color: #008000">float</span>],
        passages: Iterable[Passage],
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[_ScoredPassage]:
        deduplicated: <span style="color: #008000">dict</span>[<span style="color: #008000">tuple</span>[<span style="color: #008000">int</span>, <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, <span style="color: #008000">str</span>], _ScoredPassage] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> passage <span style="color: #AA22FF; font-weight: bold">in</span> passages:
            score <span style="color: #666666">=</span> _cosine_similarity(normalized_query, passage<span style="color: #666666">.</span>normalized_embedding)
            preview <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_preview(passage<span style="color: #666666">.</span>text)
            key <span style="color: #666666">=</span> passage<span style="color: #666666">.</span>deduplication_key
            current <span style="color: #666666">=</span> deduplicated<span style="color: #666666">.</span>get(key)
            candidate <span style="color: #666666">=</span> _ScoredPassage(passage<span style="color: #666666">=</span>passage, score<span style="color: #666666">=</span>score, preview<span style="color: #666666">=</span>preview)
            <span style="color: #008000; font-weight: bold">if</span> current <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">or</span> candidate<span style="color: #666666">.</span>score <span style="color: #666666">&gt;</span> current<span style="color: #666666">.</span>score:
                deduplicated[key] <span style="color: #666666">=</span> candidate
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">list</span>(deduplicated<span style="color: #666666">.</span>values())
</code></pre>
<h3 id="_apply_diversity_filter">Method: _apply_diversity_filter(self, candidates: list[_ScoredPassage], top_k: int, diversity: float) -&gt; list[_ScoredPassage]</h3>
<p>The function `_apply_diversity_filter` filters a list of scored passages to ensure diversity among the top-k results. It takes a list of candidates, a number of top results to return (`top_k`), and a diversity parameter between 0 and 1. If diversity is zero or less, it returns the top-k candidates without modification. Otherwise, it iteratively selects passages that balance high score with low similarity to already selected passages, using a weighted value combining score and inverse similarity. The result is a list of up to `top_k` passages that are both highly scored and diverse.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_diversity_filter</span>(
        <span style="color: #008000">self</span>,
        candidates: <span style="color: #008000">list</span>[_ScoredPassage],
        top_k: <span style="color: #008000">int</span>,
        diversity: <span style="color: #008000">float</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[_ScoredPassage]:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> candidates:
            <span style="color: #008000; font-weight: bold">return</span> []
        <span style="color: #008000; font-weight: bold">if</span> diversity <span style="color: #666666">&lt;=</span> <span style="color: #666666">0</span>:
            <span style="color: #008000; font-weight: bold">return</span> candidates[:top_k]
        diversity <span style="color: #666666">=</span> <span style="color: #008000">min</span>(<span style="color: #008000">max</span>(diversity, <span style="color: #666666">0.0</span>), <span style="color: #666666">1.0</span>)
        selected: <span style="color: #008000">list</span>[_ScoredPassage] <span style="color: #666666">=</span> []
        pool <span style="color: #666666">=</span> candidates<span style="color: #666666">.</span>copy()
        <span style="color: #008000; font-weight: bold">while</span> pool <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">len</span>(selected) <span style="color: #666666">&lt;</span> top_k:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> selected:
                selected<span style="color: #666666">.</span>append(pool<span style="color: #666666">.</span>pop(<span style="color: #666666">0</span>))
                <span style="color: #008000; font-weight: bold">continue</span>
            best_index <span style="color: #666666">=</span> <span style="color: #666666">0</span>
            best_value <span style="color: #666666">=</span> <span style="color: #008000">float</span>(<span style="color: #BA2121">&quot;-inf&quot;</span>)
            <span style="color: #008000; font-weight: bold">for</span> index, candidate <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(pool):
                similarity <span style="color: #666666">=</span> <span style="color: #008000">max</span>(
                    _cosine_similarity(
                        candidate<span style="color: #666666">.</span>passage<span style="color: #666666">.</span>normalized_embedding,
                        chosen<span style="color: #666666">.</span>passage<span style="color: #666666">.</span>normalized_embedding,
                    )
                    <span style="color: #008000; font-weight: bold">for</span> chosen <span style="color: #AA22FF; font-weight: bold">in</span> selected
                )
                value <span style="color: #666666">=</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> diversity) <span style="color: #666666">*</span> candidate<span style="color: #666666">.</span>score <span style="color: #666666">-</span> diversity <span style="color: #666666">*</span> similarity
                <span style="color: #008000; font-weight: bold">if</span> value <span style="color: #666666">&gt;</span> best_value:
                    best_value <span style="color: #666666">=</span> value
                    best_index <span style="color: #666666">=</span> index
            selected<span style="color: #666666">.</span>append(pool<span style="color: #666666">.</span>pop(best_index))
        <span style="color: #008000; font-weight: bold">return</span> selected
</code></pre>
<h3 id="_detect_conflicts">Method: _detect_conflicts(self, passages: Iterable[Passage]) -&gt; dict[str, list[dict[str, Any]]]</h3>
<p>The function `_detect_conflicts` identifies conflicting passages within an iterable of `Passage` objects based on matching &quot;statement&quot; and differing &quot;stance&quot; metadata values. It groups passages by statement and stance, then for each statement with multiple stances, it records opposing stances as conflicts. Each conflict entry includes the passage ID, stance, and document ID of opposing passages. The result is a dictionary mapping passage IDs to lists of conflicting passage details.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_detect_conflicts</span>(
        <span style="color: #008000">self</span>, passages: Iterable[Passage]
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]]:
        buckets: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">list</span>[Passage]]] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> passage <span style="color: #AA22FF; font-weight: bold">in</span> passages:
            metadata <span style="color: #666666">=</span> passage<span style="color: #666666">.</span>metadata <span style="color: #AA22FF; font-weight: bold">or</span> {}
            statement <span style="color: #666666">=</span> <span style="color: #008000">str</span>(metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;statement&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))<span style="color: #666666">.</span>strip()<span style="color: #666666">.</span>lower()
            stance <span style="color: #666666">=</span> <span style="color: #008000">str</span>(metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;stance&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>))<span style="color: #666666">.</span>strip()<span style="color: #666666">.</span>lower()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> statement <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #AA22FF; font-weight: bold">not</span> stance:
                <span style="color: #008000; font-weight: bold">continue</span>
            stances <span style="color: #666666">=</span> buckets<span style="color: #666666">.</span>setdefault(statement, {})
            stances<span style="color: #666666">.</span>setdefault(stance, [])<span style="color: #666666">.</span>append(passage)

        conflicts: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> stances <span style="color: #AA22FF; font-weight: bold">in</span> buckets<span style="color: #666666">.</span>values():
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(stances) <span style="color: #666666">&lt;=</span> <span style="color: #666666">1</span>:
                <span style="color: #008000; font-weight: bold">continue</span>
            <span style="color: #008000; font-weight: bold">for</span> stance, passages_for_stance <span style="color: #AA22FF; font-weight: bold">in</span> stances<span style="color: #666666">.</span>items():
                opposing <span style="color: #666666">=</span> [
                    {
                        <span style="color: #BA2121">&quot;passage_id&quot;</span>: other<span style="color: #666666">.</span>passage_id,
                        <span style="color: #BA2121">&quot;stance&quot;</span>: other<span style="color: #666666">.</span>metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;stance&quot;</span>),
                        <span style="color: #BA2121">&quot;document_id&quot;</span>: other<span style="color: #666666">.</span>document_id,
                    }
                    <span style="color: #008000; font-weight: bold">for</span> other_stance, others <span style="color: #AA22FF; font-weight: bold">in</span> stances<span style="color: #666666">.</span>items()
                    <span style="color: #008000; font-weight: bold">if</span> other_stance <span style="color: #666666">!=</span> stance
                    <span style="color: #008000; font-weight: bold">for</span> other <span style="color: #AA22FF; font-weight: bold">in</span> others
                ]
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> opposing:
                    <span style="color: #008000; font-weight: bold">continue</span>
                <span style="color: #008000; font-weight: bold">for</span> passage <span style="color: #AA22FF; font-weight: bold">in</span> passages_for_stance:
                    conflicts<span style="color: #666666">.</span>setdefault(passage<span style="color: #666666">.</span>passage_id, [])<span style="color: #666666">.</span>extend(opposing)
        <span style="color: #008000; font-weight: bold">return</span> conflicts
</code></pre>
<h3 id="_build_preview">Method: _build_preview(text: str, *, limit: int=280) -&gt; str</h3>
<p>The function `_build_preview` generates a truncated preview of a given text string, ensuring that the output does not exceed a specified character limit. It first removes extra whitespace from the input text by splitting and rejoining it. If the cleaned text is already within the limit, it returns the text as-is. Otherwise, it finds the last space before the limit to avoid breaking words, truncates the text at that point, and appends an ellipsis (&quot;‚Ä¶&quot;) to indicate truncation. The default limit is 280 characters.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_preview</span>(text: <span style="color: #008000">str</span>, <span style="color: #666666">*</span>, limit: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">280</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        cleaned <span style="color: #666666">=</span> <span style="color: #BA2121">&quot; &quot;</span><span style="color: #666666">.</span>join(text<span style="color: #666666">.</span>split())
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(cleaned) <span style="color: #666666">&lt;=</span> limit:
            <span style="color: #008000; font-weight: bold">return</span> cleaned
        cutoff <span style="color: #666666">=</span> cleaned<span style="color: #666666">.</span>rfind(<span style="color: #BA2121">&quot; &quot;</span>, <span style="color: #666666">0</span>, limit)
        <span style="color: #008000; font-weight: bold">if</span> cutoff <span style="color: #666666">==</span> <span style="color: #666666">-1</span>:
            cutoff <span style="color: #666666">=</span> limit
        <span style="color: #008000; font-weight: bold">return</span> cleaned[:cutoff]<span style="color: #666666">.</span>rstrip() <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;‚Ä¶&quot;</span>
</code></pre>
<h2 id="_ScoredPassage">Class: _ScoredPassage</h2>
<p>The `_ScoredPassage` class represents a passage of text that has been scored for relevance, likely as part of a retrieval-augmented generation (RAG) system for document processing and question-answering. It is designed to store and manage passages of content retrieved from a corpus based on query relevance scores, supporting offline AI interactions and local data storage. The class is part of a larger system that handles document ingestion, indexing, and retrieval using local AI models and SQLite-based storage.</p>
<h2>Functions</h2>
<h3 id="_normalize_vector">_normalize_vector(values: Sequence[float]) -&gt; tuple[float, ...]</h3>
<p>The function `_normalize_vector` computes a unit-length vector from a sequence of numerical values. It first validates that the input sequence is non-empty and converts all elements to floats. It then calculates the Euclidean norm (magnitude) of the vector. If the magnitude is zero, it raises a `ValueError`, as normalization is not possible. Otherwise, it returns a tuple of components divided by the magnitude, resulting in a unit vector.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalize_vector</span>(values: Sequence[<span style="color: #008000">float</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">float</span>, <span style="color: #666666">...</span>]:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a unit-length vector derived from ``values``.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> values:
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>(<span style="color: #BA2121">&quot;Embedding vectors must contain at least one value&quot;</span>)
    floats <span style="color: #666666">=</span> <span style="color: #008000">tuple</span>(<span style="color: #008000">float</span>(value) <span style="color: #008000; font-weight: bold">for</span> value <span style="color: #AA22FF; font-weight: bold">in</span> values)
    length <span style="color: #666666">=</span> math<span style="color: #666666">.</span>sqrt(<span style="color: #008000">sum</span>(component <span style="color: #666666">*</span> component <span style="color: #008000; font-weight: bold">for</span> component <span style="color: #AA22FF; font-weight: bold">in</span> floats))
    <span style="color: #008000; font-weight: bold">if</span> length <span style="color: #666666">==</span> <span style="color: #666666">0</span>:
        <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>(<span style="color: #BA2121">&quot;Embedding vectors must have non-zero magnitude&quot;</span>)
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">tuple</span>(component <span style="color: #666666">/</span> length <span style="color: #008000; font-weight: bold">for</span> component <span style="color: #AA22FF; font-weight: bold">in</span> floats)
</code></pre>
<h3 id="_cosine_similarity">_cosine_similarity(left: Sequence[float], right: Sequence[float]) -&gt; float</h3>
<p>Computes the cosine similarity between two pre-normalized vectors represented as sequences of floats. The similarity is calculated as the dot product of the vectors.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_cosine_similarity</span>(left: Sequence[<span style="color: #008000">float</span>], right: Sequence[<span style="color: #008000">float</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">float</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Compute cosine similarity for pre-normalised vectors.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">float</span>(<span style="color: #008000">sum</span>(a <span style="color: #666666">*</span> b <span style="color: #008000; font-weight: bold">for</span> a, b <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">zip</span>(left, right)))
</code></pre>
<h3 id="_normalise_folder">_normalise_folder(folder: str | Path | None) -&gt; str | None</h3>
<p>Normalizes a folder path by resolving it to an absolute path or returning None if the input is None or empty.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalise_folder</span>(folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
    <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #008000; font-weight: bold">None</span>, <span style="color: #BA2121">&quot;&quot;</span>):
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(Path(folder)<span style="color: #666666">.</span>resolve())
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
