<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>document_hierarchy</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>document_hierarchy</h1>
        <p>The module defines a `DocumentHierarchyService` class that provides functionality for organizing documents into hierarchical folder structures and retrieving enriched document metadata. It includes methods to build nested folder trees with attached documents, list documents based on scope criteria such as tags or folder path, retrieve detailed metadata views for individual documents, and refresh tag counts. The service uses a `DocumentRepository` for data access and implements helper methods for path manipulation, node creation, sorting, and tag enrichment.</p>
<h2 id="DocumentHierarchyService">Class: DocumentHierarchyService</h2>
<p>The `DocumentHierarchyService` class provides methods to construct nested folder trees from document collections and retrieve documents with associated tag metadata. It includes functionality to normalize folder paths, determine base paths for hierarchies, and sort nodes and documents within the tree structure. The service interacts with a `DocumentRepository` to fetch and update document data, including tag counts and metadata.</p>
<h3 id="__init__">Method: __init__(self, documents: DocumentRepository) -&gt; None</h3>
<p>Initializes the `DocumentHierarchyService` class with a `DocumentRepository` instance. The service stores the provided document repository for use in managing document hierarchies.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, documents: DocumentRepository) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>documents <span style="color: #666666">=</span> documents
</code></pre>
<h3 id="build_folder_tree">Method: build_folder_tree(self, project_id: int) -&gt; dict[str, Any]</h3>
<p>The function `build_folder_tree` constructs a nested dictionary representation of a folder structure for a given project, attaching documents to their respective folders. It begins by retrieving all documents associated with the specified project ID and determines a base path shared by these documents. A root node is created to represent the top level of the tree. The function iterates through each document, normalizes its folder path, and calculates its relative position from the base path. For each ancestor folder in the path, it ensures that a corresponding node exists in the tree, creating parent-child relationships as needed. Each document is then appended to the appropriate folder node&#x27;s &quot;documents&quot; list. Finally, the tree is sorted recursively before being returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">build_folder_tree</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a nested folder tree with documents attached at each node.&quot;&quot;&quot;</span>

        documents <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>list_for_project(project_id)
        base_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_determine_base_path(documents)
        root <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_node(name<span style="color: #666666">=</span><span style="color: #BA2121">&quot;&quot;</span>, path<span style="color: #666666">=</span><span style="color: #008000">str</span>(base_path) <span style="color: #008000; font-weight: bold">if</span> base_path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>)
        index: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> {<span style="color: #008000; font-weight: bold">None</span>: root}
        <span style="color: #008000; font-weight: bold">for</span> document <span style="color: #AA22FF; font-weight: bold">in</span> documents:
            folder <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_normalize_folder(document<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;folder_path&quot;</span>))
            relative <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_relative_folder(folder, base_path)
            <span style="color: #008000; font-weight: bold">for</span> ancestor <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_iter_folder_paths(relative):
                <span style="color: #008000; font-weight: bold">if</span> ancestor <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> index:
                    parent <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_parent_folder_key(ancestor)
                    parent_node <span style="color: #666666">=</span> index[parent]
                    absolute_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_absolute_path(base_path, ancestor)
                    node <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_node(name<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_node_name(ancestor), path<span style="color: #666666">=</span>absolute_path)
                    parent_node[<span style="color: #BA2121">&quot;children&quot;</span>]<span style="color: #666666">.</span>append(node)
                    index[ancestor] <span style="color: #666666">=</span> node
            index[relative][<span style="color: #BA2121">&quot;documents&quot;</span>]<span style="color: #666666">.</span>append(document)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sort_tree(root)
        <span style="color: #008000; font-weight: bold">return</span> root
</code></pre>
<h3 id="list_documents_for_scope">Method: list_documents_for_scope(self, project_id: int, *, tags: Iterable[int] | None=None, folder: str | Path | None=None, recursive: bool=True) -&gt; list[dict[str, Any]]</h3>
<p>Returns a list of documents matching specified tags or folder scope, enriched with tag metadata. The function retrieves documents using the `list_for_scope` method from the `documents` service and augments each document with additional tag information by calling `_with_tags`. It accepts parameters for project ID, optional tags, optional folder path, and recursive search flag.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">list_documents_for_scope</span>(
        <span style="color: #008000">self</span>,
        project_id: <span style="color: #008000">int</span>,
        <span style="color: #666666">*</span>,
        tags: Iterable[<span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        recursive: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return documents matching ``tags``/``folder`` enriched with tag metadata.&quot;&quot;&quot;</span>

        documents <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>list_for_scope(
            project_id,
            tags<span style="color: #666666">=</span>tags,
            folder<span style="color: #666666">=</span>folder,
            recursive<span style="color: #666666">=</span>recursive,
        )
        <span style="color: #008000; font-weight: bold">return</span> [<span style="color: #008000">self</span><span style="color: #666666">.</span>_with_tags(document) <span style="color: #008000; font-weight: bold">for</span> document <span style="color: #AA22FF; font-weight: bold">in</span> documents]
</code></pre>
<h3 id="get_document_view">Method: get_document_view(self, document_id: int) -&gt; dict[str, Any] | None</h3>
<p>Returns a metadata view for a specified document ID, including its associated tags. If the document ID is not found, returns None.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_document_view</span>(<span style="color: #008000">self</span>, document_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a metadata view for ``document_id`` including its tags.&quot;&quot;&quot;</span>

        document <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>get(document_id)
        <span style="color: #008000; font-weight: bold">if</span> document <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_with_tags(document)
</code></pre>
<h3 id="refresh_tag_counts">Method: refresh_tag_counts(self, project_id: int | None=None) -&gt; None</h3>
<p>The function `refresh_tag_counts` recalculates tag counts for documents within a specified project by invoking the `refresh_tag_counts` method of the `documents` attribute, passing along an optional project ID. This updates the tag count information stored in the repository helper.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">refresh_tag_counts</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Recalculate tag counts via the repository helper.&quot;&quot;&quot;</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>refresh_tag_counts(project_id)
</code></pre>
<h3 id="_normalize_folder">Method: _normalize_folder(folder: Any) -&gt; str | None</h3>
<p>The function `_normalize_folder` takes a single argument `folder` of type `Any` and returns either a string or `None`. If the input `folder` is `None` or an empty string, the function returns `None`. Otherwise, it converts the input to a string representation of a `Path` object and returns that string. This utility function ensures consistent handling of folder paths by normalizing them into a standard string format or returning `None` for invalid inputs.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalize_folder</span>(folder: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #008000; font-weight: bold">None</span>, <span style="color: #BA2121">&quot;&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(Path(folder))
</code></pre>
<h3 id="_relative_folder">Method: _relative_folder(folder: str | None, base_path: Path | None) -&gt; str | None</h3>
<p>The function `_relative_folder` computes the relative path of a given folder with respect to a base path. If the folder is `None`, it returns `None`. If the base path is `None`, it returns the absolute path of the folder. Otherwise, it attempts to calculate the relative path using `Path.relative_to()`. If the calculation fails (e.g., due to paths being on different drives), it falls back to returning the absolute path of the folder. If the resulting relative path is an empty string or a dot (`.`), indicating the folder is the same as the base, it returns `None`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_relative_folder</span>(folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, base_path: Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> base_path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(Path(folder))
        folder_path <span style="color: #666666">=</span> Path(folder)
        <span style="color: #008000; font-weight: bold">try</span>:
            relative <span style="color: #666666">=</span> folder_path<span style="color: #666666">.</span>relative_to(base_path)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(folder_path)
        relative_str <span style="color: #666666">=</span> <span style="color: #008000">str</span>(relative)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">if</span> relative_str <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;.&quot;</span>) <span style="color: #008000; font-weight: bold">else</span> relative_str
</code></pre>
<h3 id="_absolute_path">Method: _absolute_path(base_path: Path | None, relative: str | None) -&gt; str | None</h3>
<p>The function `_absolute_path` computes and returns the absolute path constructed from a base path and a relative path component. If the relative path is `None` or an empty string, it returns the string representation of the base path, or `None` if the base path is also `None`. If the base path is `None` but the relative path is provided, it returns the string representation of the relative path as a `Path` object. Otherwise, it combines the base path and the relative path using the `/` operator to form a new `Path` object, returning its string representation.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_absolute_path</span>(base_path: Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, relative: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> relative <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #008000; font-weight: bold">None</span>, <span style="color: #BA2121">&quot;&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(base_path) <span style="color: #008000; font-weight: bold">if</span> base_path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> base_path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(Path(relative))
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>((base_path <span style="color: #666666">/</span> relative))
</code></pre>
<h3 id="_node_name">Method: _node_name(path: str | None) -&gt; str</h3>
<p>The function `_node_name` takes a file path as input and returns the name of the file or directory at that path. If the input is `None`, it returns an empty string. It uses `Path(path).name` to extract the name component of the path, and if that results in an empty string (which can happen with certain paths like root directories), it falls back to converting the entire path to a string.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_node_name</span>(path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">if</span> path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span>
        name <span style="color: #666666">=</span> Path(path)<span style="color: #666666">.</span>name
        <span style="color: #008000; font-weight: bold">return</span> name <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000">str</span>(Path(path))
</code></pre>
<h3 id="_create_node">Method: _create_node(*, name: str, path: str | None) -&gt; dict[str, Any]</h3>
<p>Creates a dictionary representation of a node for use in a document hierarchy. The node contains a name, an optional path, and empty lists for documents and children.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_node</span>(<span style="color: #666666">*</span>, name: <span style="color: #008000">str</span>, path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;name&quot;</span>: name, <span style="color: #BA2121">&quot;path&quot;</span>: path, <span style="color: #BA2121">&quot;documents&quot;</span>: [], <span style="color: #BA2121">&quot;children&quot;</span>: []}
</code></pre>
<h3 id="_parent_folder_key">Method: _parent_folder_key(path: str | None) -&gt; str | None</h3>
<p>The function `_parent_folder_key` computes the parent folder path of a given file system path. It returns `None` if the input path is `None`, empty, or represents the current directory (`.`). For valid paths, it determines the parent directory using `Path.parent` and returns the parent path as a string. If the parent directory is the same as the input path or is empty/invalid, it returns `None`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_parent_folder_key</span>(path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> path <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #008000; font-weight: bold">None</span>, <span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;.&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        current <span style="color: #666666">=</span> Path(path)
        parent <span style="color: #666666">=</span> current<span style="color: #666666">.</span>parent
        parent_str <span style="color: #666666">=</span> <span style="color: #008000">str</span>(parent)
        <span style="color: #008000; font-weight: bold">if</span> parent <span style="color: #666666">==</span> current <span style="color: #AA22FF; font-weight: bold">or</span> parent_str <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;.&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> parent_str
</code></pre>
<h3 id="_iter_folder_paths">Method: _iter_folder_paths(folder: str | None) -&gt; Iterable[str | None]</h3>
<p>The function `_iter_folder_paths` generates an iterable sequence of folder paths starting with `None`, followed by a sequence of ancestor paths leading up to the root, inclusive of the input folder itself. If the input folder is `None`, empty string, or current directory (`.`), it returns immediately without yielding any ancestor paths. The function uses `Path` from the `pathlib` module to traverse up the directory tree and yields each ancestor path in reverse order, ensuring that the deepest ancestor is yielded first.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_iter_folder_paths</span>(folder: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> Iterable[<span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>]:
        <span style="color: #008000; font-weight: bold">yield</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> folder <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #008000; font-weight: bold">None</span>, <span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;.&quot;</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        path <span style="color: #666666">=</span> Path(folder)
        ancestors: <span style="color: #008000">list</span>[Path] <span style="color: #666666">=</span> []
        current <span style="color: #666666">=</span> path
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000; font-weight: bold">True</span>:
            ancestors<span style="color: #666666">.</span>append(current)
            parent <span style="color: #666666">=</span> current<span style="color: #666666">.</span>parent
            parent_str <span style="color: #666666">=</span> <span style="color: #008000">str</span>(parent)
            <span style="color: #008000; font-weight: bold">if</span> parent <span style="color: #666666">==</span> current <span style="color: #AA22FF; font-weight: bold">or</span> parent_str <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;&quot;</span>, <span style="color: #BA2121">&quot;.&quot;</span>):
                <span style="color: #008000; font-weight: bold">break</span>
            current <span style="color: #666666">=</span> parent
        <span style="color: #008000; font-weight: bold">for</span> ancestor <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">reversed</span>(ancestors):
            <span style="color: #008000; font-weight: bold">yield</span> <span style="color: #008000">str</span>(ancestor)
</code></pre>
<h3 id="_determine_base_path">Method: _determine_base_path(documents: Iterable[dict[str, Any]]) -&gt; Path | None</h3>
<p>The function `_determine_base_path` takes an iterable of document dictionaries and extracts the folder paths from them. It then determines the deepest common parent directory (base path) shared by all the provided folder paths. If no folder paths are present, it returns `None`. The function iteratively adjusts the base path upward through the directory tree until it finds a common ancestor that contains all specified folders.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_determine_base_path</span>(documents: Iterable[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]) <span style="color: #666666">-&gt;</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        folders <span style="color: #666666">=</span> [Path(doc[<span style="color: #BA2121">&quot;folder_path&quot;</span>]) <span style="color: #008000; font-weight: bold">for</span> doc <span style="color: #AA22FF; font-weight: bold">in</span> documents <span style="color: #008000; font-weight: bold">if</span> doc<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;folder_path&quot;</span>)]
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> folders:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        base <span style="color: #666666">=</span> folders[<span style="color: #666666">0</span>]
        <span style="color: #008000; font-weight: bold">for</span> folder <span style="color: #AA22FF; font-weight: bold">in</span> folders[<span style="color: #666666">1</span>:]:
            <span style="color: #008000; font-weight: bold">while</span> <span style="color: #AA22FF; font-weight: bold">not</span> folder<span style="color: #666666">.</span>is_relative_to(base):
                base <span style="color: #666666">=</span> base<span style="color: #666666">.</span>parent
                <span style="color: #008000; font-weight: bold">if</span> base<span style="color: #666666">.</span>parent <span style="color: #666666">==</span> base:
                    <span style="color: #008000; font-weight: bold">break</span>
        <span style="color: #008000; font-weight: bold">return</span> base
</code></pre>
<h3 id="_with_tags">Method: _with_tags(self, document: dict[str, Any]) -&gt; dict[str, Any]</h3>
<p>The function `_with_tags` takes a document dictionary as input and returns a new dictionary that includes the original document data along with an additional &quot;tags&quot; key. The value of the &quot;tags&quot; key is obtained by calling `self.documents.list_tags_for_document()` with the document&#x27;s ID. This enriches the document with its associated tags.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_with_tags</span>(<span style="color: #008000">self</span>, document: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        enriched <span style="color: #666666">=</span> <span style="color: #008000">dict</span>(document)
        enriched[<span style="color: #BA2121">&quot;tags&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>documents<span style="color: #666666">.</span>list_tags_for_document(document[<span style="color: #BA2121">&quot;id&quot;</span>])
        <span style="color: #008000; font-weight: bold">return</span> enriched
</code></pre>
<h3 id="_sort_tree">Method: _sort_tree(self, node: dict[str, Any]) -&gt; None</h3>
<p>The function `_sort_tree` recursively sorts the documents and children of a given node within a document hierarchy. It sorts the documents by their title (case-insensitive) and the children by their name (case-insensitive). The sorting is performed in-place, modifying the structure of the node and its descendants.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_sort_tree</span>(<span style="color: #008000">self</span>, node: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        node[<span style="color: #BA2121">&quot;documents&quot;</span>]<span style="color: #666666">.</span>sort(key<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">lambda</span> item: (item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)<span style="color: #666666">.</span>lower())
        children <span style="color: #666666">=</span> node[<span style="color: #BA2121">&quot;children&quot;</span>]
        children<span style="color: #666666">.</span>sort(key<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">lambda</span> item: item[<span style="color: #BA2121">&quot;name&quot;</span>]<span style="color: #666666">.</span>lower())
        <span style="color: #008000; font-weight: bold">for</span> child <span style="color: #AA22FF; font-weight: bold">in</span> children:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_sort_tree(child)
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
