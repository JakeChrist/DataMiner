<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>conversation_manager</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>conversation_manager</h1>
        <p>This module provides stateful helpers for managing conversations with LMStudio, defining data structures for conversation turns, reasoning artifacts, and response modes while supporting both single-shot and dynamic planning approaches. It includes enums for specifying response behavior and reasoning verbosity, along with classes representing plan items, self-check results, assumption decisions, and structured reasoning data extracted from LMStudio metadata. The implementation offers methods for managing conversation turns, building request options, merging step configurations, constructing prompts, handling citations, composing final answers, parsing reasoning artifacts, and managing connection states. Key functionality encompasses deduplicating citations, aggregating citation data, collecting citation indexes, and formatting messages for API requests, with support for various response modes, reasoning verbosity levels, and structured data extraction from reasoning outputs including summaries, plans, assumptions, and self-check results. The module also manages system prompts, context windows, and emits connection state changes to listeners.</p>
<h2 id="ResponseMode">Class: ResponseMode</h2>
<p>The code defines an enumeration class `ResponseMode` with two possible values: `GENERATIVE` and `SOURCES_ONLY`. This enum is used to specify the desired format or structure of assistant responses. The documentation indicates that these modes control how the assistant should shape its output, with `GENERATIVE` likely producing synthesized content and `SOURCES_ONLY` restricting responses to referenced sources.</p>
<h2 id="ReasoningVerbosity">Class: ReasoningVerbosity</h2>
<p>The `ReasoningVerbosity` class defines an enumeration of verbosity levels for structured reasoning output, with values `MINIMAL`, `BRIEF`, and `EXTENDED`. It includes a method `to_request_options` that converts each verbosity level into a dictionary of LMStudio request options, configuring settings such as verbosity, summary inclusion, assumption inclusion, self-check inclusion, plan inclusion, and limits on bullets and plan items. The configuration varies based on the verbosity level, adjusting the amount of reasoning detail and structure included in the output.</p>
<h3 id="to_request_options">Method: to_request_options(self) -&gt; dict[str, Any]</h3>
<p>The function `to_request_options` translates the verbosity preset of the `ReasoningVerbosity` class into a dictionary of LMStudio request options. It sets default values for reasoning parameters such as `verbosity`, `include_summary`, `include_assumptions`, and `include_self_check`. Depending on the specific verbosity level (MINIMAL, BRIEF, or EXTENDED), it updates the payload with additional settings including `include_plan`, `max_bullets`, and `max_plan_items`. The function returns the constructed payload dictionary.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">to_request_options</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Translate the verbosity preset into LMStudio request options.&quot;&quot;&quot;</span>

        payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;reasoning&quot;</span>: {
                <span style="color: #BA2121">&quot;verbosity&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>value,
                <span style="color: #BA2121">&quot;include_summary&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
                <span style="color: #BA2121">&quot;include_assumptions&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
                <span style="color: #BA2121">&quot;include_self_check&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
            }
        }
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span> <span style="color: #AA22FF; font-weight: bold">is</span> ReasoningVerbosity<span style="color: #666666">.</span>MINIMAL:
            payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>]<span style="color: #666666">.</span>update({
                <span style="color: #BA2121">&quot;include_plan&quot;</span>: <span style="color: #008000; font-weight: bold">False</span>,
                <span style="color: #BA2121">&quot;max_bullets&quot;</span>: <span style="color: #666666">2</span>,
            })
        <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">self</span> <span style="color: #AA22FF; font-weight: bold">is</span> ReasoningVerbosity<span style="color: #666666">.</span>BRIEF:
            payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>]<span style="color: #666666">.</span>update({
                <span style="color: #BA2121">&quot;include_plan&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
                <span style="color: #BA2121">&quot;max_bullets&quot;</span>: <span style="color: #666666">4</span>,
                <span style="color: #BA2121">&quot;max_plan_items&quot;</span>: <span style="color: #666666">3</span>,
            })
        <span style="color: #008000; font-weight: bold">else</span>:  <span style="color: #3D7B7B; font-style: italic"># EXTENDED</span>
            payload[<span style="color: #BA2121">&quot;reasoning&quot;</span>]<span style="color: #666666">.</span>update({
                <span style="color: #BA2121">&quot;include_plan&quot;</span>: <span style="color: #008000; font-weight: bold">True</span>,
                <span style="color: #BA2121">&quot;max_bullets&quot;</span>: <span style="color: #666666">8</span>,
                <span style="color: #BA2121">&quot;max_plan_items&quot;</span>: <span style="color: #666666">6</span>,
            })
        <span style="color: #008000; font-weight: bold">return</span> payload
</code></pre>
<h2 id="PlanItem">Class: PlanItem</h2>
<p>The `PlanItem` class represents a single entry in a plan, containing a description and status field with a default value of &quot;pending&quot;. The class includes a property `is_complete` that returns a boolean indicating whether the item&#x27;s status indicates completion. The status check considers multiple possible completion states: &quot;complete&quot;, &quot;completed&quot;, and &quot;done&quot;.</p>
<h3 id="is_complete">Method: is_complete(self) -&gt; bool</h3>
<p>The function `is_complete` checks whether the status of a `PlanItem` instance indicates completion. It returns `True` if the lowercase version of the `status` attribute is one of the strings &quot;complete&quot;, &quot;completed&quot;, or &quot;done&quot;, and `False` otherwise.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">is_complete</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>status<span style="color: #666666">.</span>lower() <span style="color: #AA22FF; font-weight: bold">in</span> {<span style="color: #BA2121">&quot;complete&quot;</span>, <span style="color: #BA2121">&quot;completed&quot;</span>, <span style="color: #BA2121">&quot;done&quot;</span>}
</code></pre>
<h2 id="SelfCheckResult">Class: SelfCheckResult</h2>
<p>The `SelfCheckResult` class represents the outcome of a model&#x27;s self-check routine, containing a boolean indicating whether the check passed, a list of flags, and optional notes. The class defines a `passed` attribute to store the result status, a `flags` attribute initialized as an empty list to track issues, and a `notes` attribute for additional information. The implementation uses a dataclass field with a default factory for the flags list to ensure proper initialization.</p>
<h2 id="AssumptionDecision">Class: AssumptionDecision</h2>
<p>The `AssumptionDecision` class records how ambiguity in a turn was resolved, with a mode indicating whether clarification occurred, an assumption was made, or the handling was unspecified. It includes optional fields for documenting the rationale behind the decision and any clarifying question that was asked. The class is designed to capture the decision-making process around ambiguous input during conversation turns.</p>
<h2 id="ReasoningArtifacts">Class: ReasoningArtifacts</h2>
<p>The `ReasoningArtifacts` class defines a structured data model for organizing reasoning components extracted from LMStudio metadata. It includes fields for summary bullet points, plan items, assumptions, and optional self-check and assumption decision results. The class uses field definitions with default factory functions to initialize empty lists and None values for optional fields.</p>
<h2 id="ConversationTurn">Class: ConversationTurn</h2>
<p>The `ConversationTurn` class represents a single exchange between a user and an assistant, capturing the question, answer, and associated metadata such as citations, reasoning artifacts, response mode, and timing information. It includes properties to access structured reasoning components like bullets, plan items, assumptions, assumption decisions, and self-check results from the reasoning artifacts. The class is designed to store and expose detailed information about each turn in a conversation, including token usage, latency, and raw response data.</p>
<h3 id="reasoning_bullets">Method: reasoning_bullets(self) -&gt; list[str]</h3>
<p>The function `reasoning_bullets` returns a list of strings representing summary bullets from the `reasoning_artifacts` attribute of the `ConversationTurn` instance. If `reasoning_artifacts` is `None`, it returns an empty list. Otherwise, it extracts and returns the `summary_bullets` from `reasoning_artifacts`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">reasoning_bullets</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> []
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts<span style="color: #666666">.</span>summary_bullets)
</code></pre>
<h3 id="plan">Method: plan(self) -&gt; list[PlanItem]</h3>
<p>The function `plan` returns a list of `PlanItem` objects from the `reasoning_artifacts` attribute of the `ConversationTurn` instance. If `reasoning_artifacts` is `None`, it returns an empty list. Otherwise, it converts the `plan_items` attribute of `reasoning_artifacts` into a list and returns it.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plan</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[PlanItem]:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> []
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts<span style="color: #666666">.</span>plan_items)
</code></pre>
<h3 id="assumptions">Method: assumptions(self) -&gt; list[str]</h3>
<p>The function `assumptions` returns a list of strings representing the assumptions extracted from the `reasoning_artifacts` attribute of the `ConversationTurn` instance. If `reasoning_artifacts` is `None`, it returns an empty list.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">assumptions</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> []
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts<span style="color: #666666">.</span>assumptions)
</code></pre>
<h3 id="assumption_decision">Method: assumption_decision(self) -&gt; AssumptionDecision | None</h3>
<p>The function `assumption_decision` retrieves the `AssumptionDecision` object from the `reasoning_artifacts` attribute of the `ConversationTurn` instance. If `reasoning_artifacts` is `None`, it returns `None`. Otherwise, it returns the value of `assumption_decision` from `reasoning_artifacts`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">assumption_decision</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> AssumptionDecision <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts<span style="color: #666666">.</span>assumption_decision
</code></pre>
<h3 id="self_check">Method: self_check(self) -&gt; SelfCheckResult | None</h3>
<p>The function `self_check` retrieves the `SelfCheckResult` from the `reasoning_artifacts` attribute of the `ConversationTurn` instance. If `reasoning_artifacts` is `None`, it returns `None`. Otherwise, it returns the `self_check` property of `reasoning_artifacts`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">self_check</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> SelfCheckResult <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_artifacts<span style="color: #666666">.</span>self_check
</code></pre>
<h2 id="ConnectionState">Class: ConnectionState</h2>
<p>The `ConnectionState` class defines a data structure for representing connection status events, containing a boolean field `connected` and an optional string field `message`. The class is implemented as a simple data container with type hints indicating that `message` can be either a string or None. This structure serves to encapsulate the payload for connection status notifications.</p>
<h2 id="StepContextBatch">Class: StepContextBatch</h2>
<p>The `StepContextBatch` class defines a context payload used for a single execution pass of a plan item, containing a list of string snippets and an optional list of document dictionaries. The documents field is initialized as an empty list by default. The class serves as a data structure to hold execution context information during plan item processing.</p>
<h2 id="StepResult">Class: StepResult</h2>
<p>The `StepResult` class defines a data structure that aggregates the output of a single step in a planning process. It includes fields for tracking the step&#x27;s index, description, and answer, along with optional supporting elements like citations, contextual information, and citation indexes. The class uses default factory functions for initializing mutable fields such as lists.</p>
<h2 id="DynamicPlanningError">Class: DynamicPlanningError</h2>
<p>This code defines a custom exception class called `DynamicPlanningError` that inherits from Python&#x27;s built-in `RuntimeError`. The exception is specifically designed to be raised when dynamic planning processes fail to complete successfully. The class serves as a specialized error type to handle planning-related runtime failures in a structured way.</p>
<h2 id="ConversationManager">Class: ConversationManager</h2>
<p>The code defines a `ConversationManager` class that manages conversation history and orchestrates requests to an LMStudio client, maintaining internal state for conversation turns, connection status, and system prompts. It handles the construction of messages, tracks conversation history through `ConversationTurn` objects, and supports both simple and complex query processing with context snippets, reasoning verbosity, and custom request options. The class provides methods for checking connectivity, asking questions, managing connection listeners, and processing structured reasoning data from model outputs, including extracting bullet points, plan items, assumption decisions, and self-check results. Additionally, it implements a categorical data management system that supports missing values, custom formatting, and proper serialization/deserialization of categorical information with methods for adding, retrieving, and manipulating categorical entries while maintaining internal consistency across different data types.</p>
<h3 id="__init__">Method: __init__(self, client: LMStudioClient, *, system_prompt: str | None=None, context_window: int=4) -&gt; None</h3>
<p>Initializes a `ConversationManager` instance with the specified LMStudio client, system prompt, and context window size. Sets up the conversation turns list, connection state tracking, and listener callbacks for connection status updates. The context window is normalized to a minimum value of zero.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(
        <span style="color: #008000">self</span>,
        client: LMStudioClient,
        <span style="color: #666666">*</span>,
        system_prompt: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        context_window: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">4</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>client <span style="color: #666666">=</span> client
        <span style="color: #008000">self</span><span style="color: #666666">.</span>system_prompt <span style="color: #666666">=</span> system_prompt
        <span style="color: #008000">self</span><span style="color: #666666">.</span>context_window <span style="color: #666666">=</span> <span style="color: #008000">max</span>(<span style="color: #666666">0</span>, context_window)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>turns: <span style="color: #008000">list</span>[ConversationTurn] <span style="color: #666666">=</span> []
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_connected <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_connection_error: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_listeners: <span style="color: #008000">list</span>[Callable[[ConnectionState], <span style="color: #008000; font-weight: bold">None</span>]] <span style="color: #666666">=</span> []
</code></pre>
<h3 id="add_connection_listener">Method: add_connection_listener(self, listener: Callable[[ConnectionState], None]) -&gt; Callable[[], None]</h3>
<p>The function `add_connection_listener` subscribes a provided callback function to listen for connection state changes. It appends the listener to an internal list of listeners and returns an unsubscribe function that removes the listener from the list when called. This enables dynamic management of connection state notifications within the `ConversationManager` class.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">add_connection_listener</span>(
        <span style="color: #008000">self</span>, listener: Callable[[ConnectionState], <span style="color: #008000; font-weight: bold">None</span>]
    ) <span style="color: #666666">-&gt;</span> Callable[[], <span style="color: #008000; font-weight: bold">None</span>]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Subscribe to connection changes and return an unsubscribe callable.&quot;&quot;&quot;</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_listeners<span style="color: #666666">.</span>append(listener)

        <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">unsubscribe</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">if</span> listener <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_listeners:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_listeners<span style="color: #666666">.</span>remove(listener)

        <span style="color: #008000; font-weight: bold">return</span> unsubscribe
</code></pre>
<details>
<summary>Subfunction: unsubscribe() -&gt; None</summary>
<h4 id="unsubscribe">unsubscribe() -&gt; None</h4>
<p>The function `unsubscribe` removes a specified listener from the `_listeners` collection if it exists. It performs a membership check to ensure the listener is present before attempting removal. This function is part of the `ConversationManager` class and manages the list of active listeners for event handling.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">unsubscribe</span>() <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">if</span> listener <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_listeners:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_listeners<span style="color: #666666">.</span>remove(listener)
</code></pre>
</details>
<h3 id="connection_state">Method: connection_state(self) -&gt; ConnectionState</h3>
<p>The function `connection_state` is a property method within the `ConversationManager` class that returns a `ConnectionState` object. This object is initialized with two attributes: `self._connected`, which indicates the connection status, and `self._connection_error`, which holds any error message related to the connection. The method provides access to the current connection state of the conversation manager.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">connection_state</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> ConnectionState:
        <span style="color: #008000; font-weight: bold">return</span> ConnectionState(<span style="color: #008000">self</span><span style="color: #666666">.</span>_connected, <span style="color: #008000">self</span><span style="color: #666666">.</span>_connection_error)
</code></pre>
<h3 id="check_connection">Method: check_connection(self) -&gt; ConnectionState</h3>
<p>The function `check_connection` probes the LMStudio client to determine its connectivity status. It performs a health check via `self.client.health_check()`. If the check succeeds, it updates the connection state to healthy with no error message. If the check fails, it updates the connection state to unhealthy with an error message indicating that LMStudio is unreachable. The function returns the current connection state.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">check_connection</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> ConnectionState:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Probe LMStudio and update connection state.&quot;&quot;&quot;</span>

        healthy <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>client<span style="color: #666666">.</span>health_check()
        <span style="color: #008000; font-weight: bold">if</span> healthy:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_connection(<span style="color: #008000; font-weight: bold">True</span>, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_connection(<span style="color: #008000; font-weight: bold">False</span>, <span style="color: #BA2121">&quot;LMStudio is unreachable. Check the base URL.&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>connection_state
</code></pre>
<h3 id="can_ask">Method: can_ask(self) -&gt; bool</h3>
<p>The `can_ask` method returns a boolean value indicating whether it is safe to issue a new query. It returns `True` if the `_connected` attribute is set to `True`, otherwise it returns `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">can_ask</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return ``True`` when it is safe to issue a new query.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_connected
</code></pre>
<h3 id="ask">Method: ask(self, question: str, *, context_snippets: Sequence[str] | None=None, preset: AnswerLength=AnswerLength.NORMAL, reasoning_verbosity: ReasoningVerbosity | None=ReasoningVerbosity.BRIEF, response_mode: ResponseMode=ResponseMode.GENERATIVE, extra_options: dict[str, Any] | None=None, context_provider: Callable[[PlanItem, int, int], Iterable[StepContextBatch]] | None=None) -&gt; ConversationTurn</h3>
<p>The `ask` method sends a user question to an LMStudio connection and returns the resulting conversation turn. It first checks for a valid connection, raising an error if disconnected. Depending on whether a `context_provider` is supplied, it either attempts dynamic planning or uses a single-shot approach to generate a response. The method supports various parameters such as answer length, reasoning verbosity, response mode, and additional options, and delegates to internal methods `_ask_with_plan` or `_ask_single_shot` based on the presence of a context provider.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">ask</span>(
        <span style="color: #008000">self</span>,
        question: <span style="color: #008000">str</span>,
        <span style="color: #666666">*</span>,
        context_snippets: Sequence[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        preset: AnswerLength <span style="color: #666666">=</span> AnswerLength<span style="color: #666666">.</span>NORMAL,
        reasoning_verbosity: ReasoningVerbosity <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> ReasoningVerbosity<span style="color: #666666">.</span>BRIEF,
        response_mode: ResponseMode <span style="color: #666666">=</span> ResponseMode<span style="color: #666666">.</span>GENERATIVE,
        extra_options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        context_provider: Callable[[PlanItem, <span style="color: #008000">int</span>, <span style="color: #008000">int</span>], Iterable[StepContextBatch]] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> ConversationTurn:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Send ``question`` to LMStudio and append the resulting turn.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_connected:
            message <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_connection_error <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;LMStudio is disconnected.&quot;</span>
            <span style="color: #008000; font-weight: bold">raise</span> LMStudioConnectionError(message)

        <span style="color: #008000; font-weight: bold">if</span> context_provider <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">try</span>:
                turn <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ask_with_plan(
                    question,
                    context_snippets<span style="color: #666666">=</span>context_snippets,
                    preset<span style="color: #666666">=</span>preset,
                    reasoning_verbosity<span style="color: #666666">=</span>reasoning_verbosity,
                    response_mode<span style="color: #666666">=</span>response_mode,
                    extra_options<span style="color: #666666">=</span>extra_options,
                    context_provider<span style="color: #666666">=</span>context_provider,
                )
            <span style="color: #008000; font-weight: bold">except</span> DynamicPlanningError:
                turn <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ask_single_shot(
                    question,
                    context_snippets<span style="color: #666666">=</span>context_snippets,
                    preset<span style="color: #666666">=</span>preset,
                    reasoning_verbosity<span style="color: #666666">=</span>reasoning_verbosity,
                    response_mode<span style="color: #666666">=</span>response_mode,
                    extra_options<span style="color: #666666">=</span>extra_options,
                )
        <span style="color: #008000; font-weight: bold">else</span>:
            turn <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ask_single_shot(
                question,
                context_snippets<span style="color: #666666">=</span>context_snippets,
                preset<span style="color: #666666">=</span>preset,
                reasoning_verbosity<span style="color: #666666">=</span>reasoning_verbosity,
                response_mode<span style="color: #666666">=</span>response_mode,
                extra_options<span style="color: #666666">=</span>extra_options,
            )
        <span style="color: #008000; font-weight: bold">return</span> turn
</code></pre>
<h3 id="_ask_single_shot">Method: _ask_single_shot(self, question: str, *, context_snippets: Sequence[str] | None, preset: AnswerLength, reasoning_verbosity: ReasoningVerbosity | None, response_mode: ResponseMode, extra_options: dict[str, Any] | None) -&gt; ConversationTurn</h3>
<p>The function `_ask_single_shot` performs a single AI query using the configured language model client. It constructs a message list from the input question and optional context snippets, builds request options based on specified parameters such as reasoning verbosity and response mode, and sends the request to the LMStudio client. If the client raises an `LMStudioError`, it updates the connection status and re-raises the exception. On successful response, it updates the connection status, registers the conversation turn with the question, response, and specified modes, and returns the resulting `ConversationTurn` object.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_ask_single_shot</span>(
        <span style="color: #008000">self</span>,
        question: <span style="color: #008000">str</span>,
        <span style="color: #666666">*</span>,
        context_snippets: Sequence[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        preset: AnswerLength,
        reasoning_verbosity: ReasoningVerbosity <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        response_mode: ResponseMode,
        extra_options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> ConversationTurn:
        messages <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_messages(question, context_snippets)
        request_options <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_request_options(
            question,
            reasoning_verbosity,
            response_mode,
            extra_options,
        )
        <span style="color: #008000; font-weight: bold">try</span>:
            response <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>client<span style="color: #666666">.</span>chat(
                messages,
                preset<span style="color: #666666">=</span>preset,
                extra_options<span style="color: #666666">=</span>request_options <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000; font-weight: bold">None</span>,
            )
        <span style="color: #008000; font-weight: bold">except</span> LMStudioError <span style="color: #008000; font-weight: bold">as</span> exc:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_connection(<span style="color: #008000; font-weight: bold">False</span>, <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to reach LMStudio.&quot;</span>)
            <span style="color: #008000; font-weight: bold">raise</span>

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_connection(<span style="color: #008000; font-weight: bold">True</span>, <span style="color: #008000; font-weight: bold">None</span>)
        turn <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_register_turn(question, response, response_mode, preset)
        <span style="color: #008000; font-weight: bold">return</span> turn
</code></pre>
<h3 id="_ask_with_plan">Method: _ask_with_plan(self, question: str, *, context_snippets: Sequence[str] | None, preset: AnswerLength, reasoning_verbosity: ReasoningVerbosity | None, response_mode: ResponseMode, extra_options: dict[str, Any] | None, context_provider: Callable[[PlanItem, int, int], Iterable[StepContextBatch]]) -&gt; ConversationTurn</h3>
<p>The function `_ask_with_plan` executes a dynamic planning approach to answer a user&#x27;s question by breaking it into a sequence of plan items, retrieving relevant context for each step, and generating responses using an LMStudio client. It iterates through each plan item, retrieves contextual batches via a provided `context_provider`, constructs prompts, and sends messages to the language model. The function aggregates results from each step, deduplicates citations, and compiles a final answer along with reasoning artifacts such as assumptions and a summary of executed steps. It raises a `DynamicPlanningError` if no plan items are generated or if the context provider fails. The resulting `ConversationTurn` object is appended to the conversation history and returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_ask_with_plan</span>(
        <span style="color: #008000">self</span>,
        question: <span style="color: #008000">str</span>,
        <span style="color: #666666">*</span>,
        context_snippets: Sequence[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        preset: AnswerLength,
        reasoning_verbosity: ReasoningVerbosity <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        response_mode: ResponseMode,
        extra_options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        context_provider: Callable[[PlanItem, <span style="color: #008000">int</span>, <span style="color: #008000">int</span>], Iterable[StepContextBatch]],
    ) <span style="color: #666666">-&gt;</span> ConversationTurn:
        plan_items <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_generate_plan(question)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> plan_items:
            <span style="color: #008000; font-weight: bold">raise</span> DynamicPlanningError(<span style="color: #BA2121">&quot;No plan items generated&quot;</span>)

        total_steps <span style="color: #666666">=</span> <span style="color: #008000">len</span>(plan_items)
        shared_context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(context_snippets <span style="color: #AA22FF; font-weight: bold">or</span> [])
        base_options <span style="color: #666666">=</span> copy<span style="color: #666666">.</span>deepcopy(extra_options) <span style="color: #008000; font-weight: bold">if</span> extra_options <span style="color: #008000; font-weight: bold">else</span> {}
        executed_plan: <span style="color: #008000">list</span>[PlanItem] <span style="color: #666666">=</span> [
            PlanItem(description<span style="color: #666666">=</span>item<span style="color: #666666">.</span>description, status<span style="color: #666666">=</span><span style="color: #BA2121">&quot;not_started&quot;</span>)
            <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> plan_items
        ]
        step_results: <span style="color: #008000">list</span>[StepResult] <span style="color: #666666">=</span> []
        assumptions: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []

        <span style="color: #008000; font-weight: bold">for</span> index, plan_item <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(executed_plan, start<span style="color: #666666">=1</span>):
            plan_item<span style="color: #666666">.</span>status <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;running&quot;</span>
            <span style="color: #008000; font-weight: bold">try</span>:
                batches <span style="color: #666666">=</span> <span style="color: #008000">list</span>(context_provider(plan_item, index, total_steps))
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - fallback to single shot</span>
                <span style="color: #008000; font-weight: bold">raise</span> DynamicPlanningError(<span style="color: #BA2121">&quot;Context provider failed&quot;</span>) <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">exc</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> batches:
                batches <span style="color: #666666">=</span> [StepContextBatch(snippets<span style="color: #666666">=</span>[], documents<span style="color: #666666">=</span>[])]

            answer_parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
            citations: <span style="color: #008000">list</span>[Any] <span style="color: #666666">=</span> []
            used_contexts: <span style="color: #008000">list</span>[StepContextBatch] <span style="color: #666666">=</span> []

            <span style="color: #008000; font-weight: bold">for</span> pass_index, batch <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(batches, start<span style="color: #666666">=1</span>):
                used_contexts<span style="color: #666666">.</span>append(batch)
                combined_snippets: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
                <span style="color: #008000; font-weight: bold">if</span> shared_context:
                    combined_snippets<span style="color: #666666">.</span>append(shared_context)
                combined_snippets<span style="color: #666666">.</span>extend(batch<span style="color: #666666">.</span>snippets)
                prompt <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_step_prompt(
                    question,
                    plan_item<span style="color: #666666">.</span>description,
                    index,
                    total_steps,
                    pass_index,
                )
                messages <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_messages(
                    prompt,
                    combined_snippets <span style="color: #008000; font-weight: bold">if</span> combined_snippets <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>,
                )
                merged_options <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_merge_step_options(
                    base_options,
                    batch<span style="color: #666666">.</span>documents,
                    plan_item<span style="color: #666666">.</span>description,
                    reasoning_verbosity,
                    response_mode,
                )
                <span style="color: #008000; font-weight: bold">try</span>:
                    response <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>client<span style="color: #666666">.</span>chat(
                        messages,
                        preset<span style="color: #666666">=</span>preset,
                        extra_options<span style="color: #666666">=</span>merged_options <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000; font-weight: bold">None</span>,
                    )
                <span style="color: #008000; font-weight: bold">except</span> LMStudioError <span style="color: #008000; font-weight: bold">as</span> exc:
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_connection(<span style="color: #008000; font-weight: bold">False</span>, <span style="color: #008000">str</span>(exc) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;Unable to reach LMStudio.&quot;</span>)
                    <span style="color: #008000; font-weight: bold">raise</span>

                <span style="color: #008000">self</span><span style="color: #666666">.</span>_update_connection(<span style="color: #008000; font-weight: bold">True</span>, <span style="color: #008000; font-weight: bold">None</span>)
                text <span style="color: #666666">=</span> response<span style="color: #666666">.</span>content<span style="color: #666666">.</span>strip()
                <span style="color: #008000; font-weight: bold">if</span> text:
                    answer_parts<span style="color: #666666">.</span>append(text)
                <span style="color: #008000; font-weight: bold">if</span> response<span style="color: #666666">.</span>citations:
                    citations<span style="color: #666666">.</span>extend(copy<span style="color: #666666">.</span>deepcopy(response<span style="color: #666666">.</span>citations))

            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> answer_parts:
                message <span style="color: #666666">=</span> (
                    <span style="color: #BA2121">f&quot;No direct evidence located for step </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>plan_item<span style="color: #666666">.</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
                )
                answer_parts<span style="color: #666666">.</span>append(message)
                assumptions<span style="color: #666666">.</span>append(message)
            plan_item<span style="color: #666666">.</span>status <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;done&quot;</span>
            result <span style="color: #666666">=</span> StepResult(
                index<span style="color: #666666">=</span>index,
                description<span style="color: #666666">=</span>plan_item<span style="color: #666666">.</span>description,
                answer<span style="color: #666666">=</span><span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(answer_parts)<span style="color: #666666">.</span>strip(),
                citations<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_deduplicate_citations(citations),
                contexts<span style="color: #666666">=</span>used_contexts,
            )
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> result<span style="color: #666666">.</span>citations:
                assumptions<span style="color: #666666">.</span>append(
                    <span style="color: #BA2121">f&quot;No citations available for step </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>plan_item<span style="color: #666666">.</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
                )
            step_results<span style="color: #666666">.</span>append(result)

        aggregated, citation_index_map <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_aggregate_citations(step_results)
        <span style="color: #008000; font-weight: bold">for</span> result <span style="color: #AA22FF; font-weight: bold">in</span> step_results:
            indexes <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_collect_citation_indexes(result<span style="color: #666666">.</span>citations, citation_index_map)
            result<span style="color: #666666">.</span>citation_indexes <span style="color: #666666">=</span> indexes

        answer <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_compose_final_answer(step_results)
        summary <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Executed </span><span style="color: #A45A77; font-weight: bold">{</span>total_steps<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> dynamic step</span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #BA2121">&#39;s&#39;</span><span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">if</span><span style="color: #bbbbbb"> </span>total_steps<span style="color: #bbbbbb"> </span><span style="color: #666666">!=</span><span style="color: #bbbbbb"> </span><span style="color: #666666">1</span><span style="color: #bbbbbb"> </span><span style="color: #008000; font-weight: bold">else</span><span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;&#39;</span><span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.&quot;</span>
        artifacts <span style="color: #666666">=</span> ReasoningArtifacts(
            summary_bullets<span style="color: #666666">=</span>[summary],
            plan_items<span style="color: #666666">=</span>executed_plan,
            assumptions<span style="color: #666666">=</span>assumptions,
        )
        reasoning_payload <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;plan&quot;</span>: [
                {<span style="color: #BA2121">&quot;description&quot;</span>: item<span style="color: #666666">.</span>description, <span style="color: #BA2121">&quot;status&quot;</span>: item<span style="color: #666666">.</span>status}
                <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> executed_plan
            ],
            <span style="color: #BA2121">&quot;assumptions&quot;</span>: assumptions,
            <span style="color: #BA2121">&quot;steps&quot;</span>: [
                {
                    <span style="color: #BA2121">&quot;index&quot;</span>: result<span style="color: #666666">.</span>index,
                    <span style="color: #BA2121">&quot;description&quot;</span>: result<span style="color: #666666">.</span>description,
                    <span style="color: #BA2121">&quot;answer&quot;</span>: result<span style="color: #666666">.</span>answer,
                    <span style="color: #BA2121">&quot;citations&quot;</span>: result<span style="color: #666666">.</span>citation_indexes,
                }
                <span style="color: #008000; font-weight: bold">for</span> result <span style="color: #AA22FF; font-weight: bold">in</span> step_results
            ],
        }
        raw_response <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;dynamic_plan&quot;</span>: {
                <span style="color: #BA2121">&quot;steps&quot;</span>: reasoning_payload[<span style="color: #BA2121">&quot;steps&quot;</span>],
                <span style="color: #BA2121">&quot;citations&quot;</span>: aggregated,
            }
        }
        turn <span style="color: #666666">=</span> ConversationTurn(
            question<span style="color: #666666">=</span>question,
            answer<span style="color: #666666">=</span>answer,
            citations<span style="color: #666666">=</span>aggregated,
            reasoning<span style="color: #666666">=</span>reasoning_payload,
            reasoning_artifacts<span style="color: #666666">=</span>artifacts,
            response_mode<span style="color: #666666">=</span>response_mode,
            answer_length<span style="color: #666666">=</span>preset,
            model_name<span style="color: #666666">=</span><span style="color: #008000">getattr</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>client, <span style="color: #BA2121">&quot;model&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>),
            raw_response<span style="color: #666666">=</span>raw_response,
            step_results<span style="color: #666666">=</span>step_results,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>turns<span style="color: #666666">.</span>append(turn)
        <span style="color: #008000; font-weight: bold">return</span> turn
</code></pre>
<h3 id="_generate_plan">Method: _generate_plan(self, question: str) -&gt; list[PlanItem]</h3>
<p>The function `_generate_plan` takes a string `question`, normalizes it by stripping whitespace, and splits it into segments using punctuation marks (`\n`, `.`, `!`, `?`). It iterates through the segments, filtering out those with fewer than four characters, and creates a list of `PlanItem` objects with each valid segment as the description and an initial status of `&quot;not_started&quot;`. If no valid segments are found, it defaults to creating a single `PlanItem` from the full normalized question. The resulting plan is limited to six items and returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_generate_plan</span>(<span style="color: #008000">self</span>, question: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[PlanItem]:
        normalized <span style="color: #666666">=</span> question<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> normalized:
            <span style="color: #008000; font-weight: bold">return</span> []
        segments <span style="color: #666666">=</span> re<span style="color: #666666">.</span>split(<span style="color: #BA2121">r&quot;[\n\.!?]+&quot;</span>, normalized)
        plan: <span style="color: #008000">list</span>[PlanItem] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> segment <span style="color: #AA22FF; font-weight: bold">in</span> segments:
            text <span style="color: #666666">=</span> segment<span style="color: #666666">.</span>strip()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">len</span>(text) <span style="color: #666666">&lt;</span> <span style="color: #666666">4</span>:
                <span style="color: #008000; font-weight: bold">continue</span>
            plan<span style="color: #666666">.</span>append(PlanItem(description<span style="color: #666666">=</span>text, status<span style="color: #666666">=</span><span style="color: #BA2121">&quot;not_started&quot;</span>))
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> plan:
            plan <span style="color: #666666">=</span> [PlanItem(description<span style="color: #666666">=</span>normalized, status<span style="color: #666666">=</span><span style="color: #BA2121">&quot;not_started&quot;</span>)]
        <span style="color: #008000; font-weight: bold">return</span> plan[:<span style="color: #666666">6</span>]
</code></pre>
<h3 id="_register_turn">Method: _register_turn(self, question: str, response: ChatMessage, response_mode: ResponseMode, preset: AnswerLength) -&gt; ConversationTurn</h3>
<p>The function `_register_turn` creates and appends a new `ConversationTurn` object to the `turns` list of the `ConversationManager`. It constructs the `ConversationTurn` using the provided question, response details, response mode, and answer length. The response&#x27;s reasoning is parsed into artifacts, and the model name from the client is included. The newly created turn is then returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_register_turn</span>(
        <span style="color: #008000">self</span>,
        question: <span style="color: #008000">str</span>,
        response: ChatMessage,
        response_mode: ResponseMode,
        preset: AnswerLength,
    ) <span style="color: #666666">-&gt;</span> ConversationTurn:
        artifacts <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_parse_reasoning_artifacts(response<span style="color: #666666">.</span>reasoning)
        turn <span style="color: #666666">=</span> ConversationTurn(
            question<span style="color: #666666">=</span>question,
            answer<span style="color: #666666">=</span>response<span style="color: #666666">.</span>content,
            citations<span style="color: #666666">=</span>response<span style="color: #666666">.</span>citations,
            reasoning<span style="color: #666666">=</span>response<span style="color: #666666">.</span>reasoning,
            reasoning_artifacts<span style="color: #666666">=</span>artifacts,
            response_mode<span style="color: #666666">=</span>response_mode,
            answer_length<span style="color: #666666">=</span>preset,
            model_name<span style="color: #666666">=</span><span style="color: #008000">getattr</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>client, <span style="color: #BA2121">&quot;model&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>),
            raw_response<span style="color: #666666">=</span>response<span style="color: #666666">.</span>raw_response,
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>turns<span style="color: #666666">.</span>append(turn)
        <span style="color: #008000; font-weight: bold">return</span> turn
</code></pre>
<h3 id="_build_request_options">Method: _build_request_options(question: str, reasoning_verbosity: ReasoningVerbosity | None, response_mode: ResponseMode, extra_options: dict[str, Any] | None) -&gt; dict[str, Any]</h3>
<p>The function `_build_request_options` constructs a dictionary of request options based on input parameters including a question, reasoning verbosity, response mode, and additional options. It updates the options dictionary with settings derived from `reasoning_verbosity` and `response_mode`. If `extra_options` are provided, they are merged into the options dictionary, with special handling for nested &quot;reasoning&quot; dictionaries. The function also ensures that a normalized version of the question is used as the query in the retrieval configuration if applicable. The resulting dictionary contains all configured options for processing a request.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_request_options</span>(
        question: <span style="color: #008000">str</span>,
        reasoning_verbosity: ReasoningVerbosity <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        response_mode: ResponseMode,
        extra_options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">if</span> reasoning_verbosity <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            options<span style="color: #666666">.</span>update(reasoning_verbosity<span style="color: #666666">.</span>to_request_options())
        <span style="color: #008000; font-weight: bold">if</span> response_mode <span style="color: #AA22FF; font-weight: bold">is</span> ResponseMode<span style="color: #666666">.</span>SOURCES_ONLY:
            options[<span style="color: #BA2121">&quot;response_mode&quot;</span>] <span style="color: #666666">=</span> response_mode<span style="color: #666666">.</span>value
        <span style="color: #008000; font-weight: bold">if</span> extra_options:
            <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> extra_options<span style="color: #666666">.</span>items():
                <span style="color: #008000; font-weight: bold">if</span> (
                    key <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;reasoning&quot;</span>
                    <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">isinstance</span>(value, <span style="color: #008000">dict</span>)
                    <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">isinstance</span>(options<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;reasoning&quot;</span>), <span style="color: #008000">dict</span>)
                ):
                    options[<span style="color: #BA2121">&quot;reasoning&quot;</span>]<span style="color: #666666">.</span>update(value)
                <span style="color: #008000; font-weight: bold">else</span>:
                    options[key] <span style="color: #666666">=</span> copy<span style="color: #666666">.</span>deepcopy(value)
        retrieval <span style="color: #666666">=</span> options<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;retrieval&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(retrieval, <span style="color: #008000">dict</span>):
            normalized_question <span style="color: #666666">=</span> question<span style="color: #666666">.</span>strip()
            query <span style="color: #666666">=</span> retrieval<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;query&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> normalized_question <span style="color: #AA22FF; font-weight: bold">and</span> (query <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">str</span>(query)<span style="color: #666666">.</span>strip()):
                retrieval[<span style="color: #BA2121">&quot;query&quot;</span>] <span style="color: #666666">=</span> normalized_question
        <span style="color: #008000; font-weight: bold">return</span> options
</code></pre>
<h3 id="_merge_step_options">Method: _merge_step_options(self, base_options: dict[str, Any], documents: Sequence[dict[str, Any]], question: str, reasoning_verbosity: ReasoningVerbosity | None, response_mode: ResponseMode) -&gt; dict[str, Any]</h3>
<p>The function `_merge_step_options` merges base configuration options with document-specific retrieval settings and builds a complete set of request options for processing a question. It takes a dictionary of base options, a sequence of document dictionaries, a question string, an optional reasoning verbosity level, and a response mode. The documents are deep-copied and added to the retrieval section of the options under the key &quot;documents&quot;. Then, it calls `_build_request_options` with the question, reasoning verbosity, response mode, and the modified options to produce and return the final merged configuration.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_merge_step_options</span>(
        <span style="color: #008000">self</span>,
        base_options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any],
        documents: Sequence[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]],
        question: <span style="color: #008000">str</span>,
        reasoning_verbosity: ReasoningVerbosity <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
        response_mode: ResponseMode,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        extra: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> copy<span style="color: #666666">.</span>deepcopy(base_options) <span style="color: #008000; font-weight: bold">if</span> base_options <span style="color: #008000; font-weight: bold">else</span> {}
        <span style="color: #008000; font-weight: bold">if</span> documents:
            retrieval <span style="color: #666666">=</span> extra<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;retrieval&quot;</span>, {})
            payload_docs <span style="color: #666666">=</span> retrieval<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;documents&quot;</span>, [])
            payload_docs<span style="color: #666666">.</span>extend(copy<span style="color: #666666">.</span>deepcopy(<span style="color: #008000">list</span>(documents)))
        merged <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_build_request_options(
            question,
            reasoning_verbosity,
            response_mode,
            extra,
        )
        <span style="color: #008000; font-weight: bold">return</span> merged
</code></pre>
<h3 id="_build_step_prompt">Method: _build_step_prompt(self, question: str, step_description: str, index: int, total_steps: int, pass_index: int) -&gt; str</h3>
<p>The function `_build_step_prompt` constructs a prompt string for a specific step in a multi-step process. It takes parameters including the original question, a description of the current step, the step index, total number of steps, and the pass index. The resulting prompt includes the step details, the original question, and instructions to provide a concise factual finding without citation markers.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_step_prompt</span>(
        <span style="color: #008000">self</span>,
        question: <span style="color: #008000">str</span>,
        step_description: <span style="color: #008000">str</span>,
        index: <span style="color: #008000">int</span>,
        total_steps: <span style="color: #008000">int</span>,
        pass_index: <span style="color: #008000">int</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        prefix <span style="color: #666666">=</span> (
            <span style="color: #BA2121">f&quot;Step </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> of </span><span style="color: #A45A77; font-weight: bold">{</span>total_steps<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> (pass </span><span style="color: #A45A77; font-weight: bold">{</span>pass_index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">): </span><span style="color: #A45A77; font-weight: bold">{</span>step_description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">.&quot;</span>
        )
        instructions <span style="color: #666666">=</span> (
            <span style="color: #BA2121">&quot;Respond with a concise factual finding for this step. &quot;</span>
            <span style="color: #BA2121">&quot;Do not include bracketed citation markers; they will be added later.&quot;</span>
        )
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>prefix<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">Original question: </span><span style="color: #A45A77; font-weight: bold">{</span>question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>instructions<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
</code></pre>
<h3 id="_deduplicate_citations">Method: _deduplicate_citations(citations: Sequence[Any]) -&gt; list[Any]</h3>
<p>The function `_deduplicate_citations` removes duplicate citations from a sequence, preserving the first occurrence of each unique citation. It uses a set to track seen citation keys generated by `ConversationManager._citation_key`, ensuring that only the first instance of each citation is included in the returned list. The function performs a deep copy of each unique citation before adding it to the result list to avoid modifying the original objects.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_deduplicate_citations</span>(citations: Sequence[Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[Any]:
        unique: <span style="color: #008000">list</span>[Any] <span style="color: #666666">=</span> []
        seen: <span style="color: #008000">set</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        <span style="color: #008000; font-weight: bold">for</span> citation <span style="color: #AA22FF; font-weight: bold">in</span> citations:
            key <span style="color: #666666">=</span> ConversationManager<span style="color: #666666">.</span>_citation_key(citation)
            <span style="color: #008000; font-weight: bold">if</span> key <span style="color: #AA22FF; font-weight: bold">in</span> seen:
                <span style="color: #008000; font-weight: bold">continue</span>
            seen<span style="color: #666666">.</span>add(key)
            unique<span style="color: #666666">.</span>append(copy<span style="color: #666666">.</span>deepcopy(citation))
        <span style="color: #008000; font-weight: bold">return</span> unique
</code></pre>
<h3 id="_citation_key">Method: _citation_key(citation: Any) -&gt; str</h3>
<p>The function `_citation_key` generates a stable string key for a given citation object. It attempts to serialize the citation using `json.dumps` with sorted keys and a default string conversion for non-serializable objects. If serialization fails due to a `TypeError`, it falls back to converting the citation directly to a string. The resulting string serves as a unique identifier for the citation, ensuring consistent hashing or indexing behavior.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_citation_key</span>(citation: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> json<span style="color: #666666">.</span>dumps(citation, sort_keys<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, default<span style="color: #666666">=</span><span style="color: #008000">str</span>)
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">TypeError</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">str</span>(citation)
</code></pre>
<h3 id="_aggregate_citations">Method: _aggregate_citations(self, step_results: Sequence[StepResult]) -&gt; tuple[list[Any], dict[str, int]]</h3>
<p>The function `_aggregate_citations` processes a sequence of `StepResult` objects to collect and merge unique citations across the results. It returns a tuple containing a list of aggregated citation entries and a dictionary mapping citation keys to their indices in the list. For each citation in the input results, it checks for uniqueness using a key generated by `_citation_key`, and if unique, adds a deep copy of the citation to the aggregated list. It then updates each citation with a sorted list of step indices from which it originated, ensuring no duplicate steps are included. The function handles potential `TypeError` during sorting gracefully.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_aggregate_citations</span>(
        <span style="color: #008000">self</span>, step_results: Sequence[StepResult]
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">tuple</span>[<span style="color: #008000">list</span>[Any], <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">int</span>]]:
        aggregated: <span style="color: #008000">list</span>[Any] <span style="color: #666666">=</span> []
        index_map: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">int</span>] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> result <span style="color: #AA22FF; font-weight: bold">in</span> step_results:
            <span style="color: #008000; font-weight: bold">for</span> citation <span style="color: #AA22FF; font-weight: bold">in</span> result<span style="color: #666666">.</span>citations:
                key <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_citation_key(citation)
                <span style="color: #008000; font-weight: bold">if</span> key <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> index_map:
                    entry <span style="color: #666666">=</span> copy<span style="color: #666666">.</span>deepcopy(citation)
                    aggregated<span style="color: #666666">.</span>append(entry)
                    index_map[key] <span style="color: #666666">=</span> <span style="color: #008000">len</span>(aggregated)
        <span style="color: #008000; font-weight: bold">for</span> citation <span style="color: #AA22FF; font-weight: bold">in</span> aggregated:
            key <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_citation_key(citation)
            steps <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">for</span> result <span style="color: #AA22FF; font-weight: bold">in</span> step_results:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">any</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_citation_key(item) <span style="color: #666666">==</span> key <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> result<span style="color: #666666">.</span>citations):
                    steps<span style="color: #666666">.</span>append(result<span style="color: #666666">.</span>index)
            <span style="color: #008000; font-weight: bold">if</span> steps:
                <span style="color: #008000; font-weight: bold">try</span>:
                    citation[<span style="color: #BA2121">&quot;steps&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">sorted</span>(<span style="color: #008000">set</span>(steps))  <span style="color: #3D7B7B; font-style: italic"># type: ignore[index]</span>
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">TypeError</span>:
                    <span style="color: #008000; font-weight: bold">pass</span>
        <span style="color: #008000; font-weight: bold">return</span> aggregated, index_map
</code></pre>
<h3 id="_collect_citation_indexes">Method: _collect_citation_indexes(citations: Sequence[Any], index_map: dict[str, int]) -&gt; list[int]</h3>
<p>The function `_collect_citation_indexes` takes a sequence of citations and a dictionary mapping citation keys to indexes. It processes each citation by generating its key using `ConversationManager._citation_key`, checks if the key exists in the provided `index_map`, and collects the corresponding index. The resulting set of indexes is converted to a sorted list and returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_collect_citation_indexes</span>(
        citations: Sequence[Any], index_map: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">int</span>]
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">int</span>]:
        indexes <span style="color: #666666">=</span> {
            index_map[key]
            <span style="color: #008000; font-weight: bold">for</span> key <span style="color: #AA22FF; font-weight: bold">in</span> (ConversationManager<span style="color: #666666">.</span>_citation_key(citation) <span style="color: #008000; font-weight: bold">for</span> citation <span style="color: #AA22FF; font-weight: bold">in</span> citations)
            <span style="color: #008000; font-weight: bold">if</span> key <span style="color: #AA22FF; font-weight: bold">in</span> index_map
        }
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">sorted</span>(indexes)
</code></pre>
<h3 id="_compose_final_answer">Method: _compose_final_answer(step_results: Sequence[StepResult]) -&gt; str</h3>
<p>The function `_compose_final_answer` takes a sequence of `StepResult` objects and constructs a final answer string by processing each result. For each `StepResult`, it uses the `answer` field if available, otherwise falling back to the `description` field. It then appends citation markers, formatted as indexed references (e.g., &quot;[1][2]&quot;), to the text if citation indexes are present. Each processed line is joined with double newlines to form the final concatenated string output.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_compose_final_answer</span>(step_results: Sequence[StepResult]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        lines: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> result <span style="color: #AA22FF; font-weight: bold">in</span> step_results:
            text <span style="color: #666666">=</span> result<span style="color: #666666">.</span>answer<span style="color: #666666">.</span>strip() <span style="color: #AA22FF; font-weight: bold">or</span> result<span style="color: #666666">.</span>description
            markers <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">]&quot;</span> <span style="color: #008000; font-weight: bold">for</span> index <span style="color: #AA22FF; font-weight: bold">in</span> result<span style="color: #666666">.</span>citation_indexes)
            <span style="color: #008000; font-weight: bold">if</span> markers:
                text <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>text<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> </span><span style="color: #A45A77; font-weight: bold">{</span>markers<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>strip()
            lines<span style="color: #666666">.</span>append(text)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(lines)
</code></pre>
<h3 id="_parse_reasoning_artifacts">Method: _parse_reasoning_artifacts(reasoning: dict[str, Any] | None) -&gt; ReasoningArtifacts | None</h3>
<p>The function `_parse_reasoning_artifacts` processes a dictionary containing reasoning data and converts it into a structured `ReasoningArtifacts` object. It extracts and normalizes summary bullet points, plan items, assumptions, and self-check results from the input dictionary. Summary candidates are collected from multiple potential keys and deduplicated while preserving order. Plan items are parsed from sequences, with support for both dictionary and string formats. Assumptions are handled as either a dictionary or sequence, with associated decision metadata derived from the input. Self-check data is extracted to form a `SelfCheckResult`. If no meaningful reasoning data is present, the function returns `None`. Otherwise, it constructs and returns a `ReasoningArtifacts` object populated with the parsed components.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_parse_reasoning_artifacts</span>(
        reasoning: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> ReasoningArtifacts <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> reasoning:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>

        summary_candidates: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> key <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;summary_bullets&quot;</span>, <span style="color: #BA2121">&quot;bullets&quot;</span>, <span style="color: #BA2121">&quot;summary&quot;</span>, <span style="color: #BA2121">&quot;points&quot;</span>):
            summary_candidates<span style="color: #666666">.</span>extend(
                ConversationManager<span style="color: #666666">.</span>_coerce_str_list(reasoning<span style="color: #666666">.</span>get(key))
            )
        summary_bullets <span style="color: #666666">=</span> ConversationManager<span style="color: #666666">.</span>_deduplicate_preserve_order(summary_candidates)

        plan_items: <span style="color: #008000">list</span>[PlanItem] <span style="color: #666666">=</span> []
        plan_raw <span style="color: #666666">=</span> reasoning<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;plan&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> reasoning<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;plan_items&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(plan_raw, Sequence) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(plan_raw, (<span style="color: #008000">str</span>, <span style="color: #008000">bytes</span>, <span style="color: #008000">dict</span>)):
            <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> plan_raw:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(entry, <span style="color: #008000">dict</span>):
                    description <span style="color: #666666">=</span> <span style="color: #008000">str</span>(
                        entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;description&quot;</span>)
                        <span style="color: #AA22FF; font-weight: bold">or</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;step&quot;</span>)
                        <span style="color: #AA22FF; font-weight: bold">or</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>)
                        <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
                    )<span style="color: #666666">.</span>strip()
                    status_raw <span style="color: #666666">=</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;status&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;state&quot;</span>)
                    status <span style="color: #666666">=</span> (
                        <span style="color: #008000">str</span>(status_raw)<span style="color: #666666">.</span>strip()<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">if</span> status_raw <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>
                    )
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> status:
                        status <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;pending&quot;</span>
                <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(entry, <span style="color: #008000">str</span>):
                    description <span style="color: #666666">=</span> entry<span style="color: #666666">.</span>strip()
                    status <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;pending&quot;</span>
                <span style="color: #008000; font-weight: bold">else</span>:
                    <span style="color: #008000; font-weight: bold">continue</span>
                <span style="color: #008000; font-weight: bold">if</span> description:
                    plan_items<span style="color: #666666">.</span>append(PlanItem(description<span style="color: #666666">=</span>description, status<span style="color: #666666">=</span>status))

        assumptions_list: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        decision: AssumptionDecision <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        assumptions_raw <span style="color: #666666">=</span> reasoning<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;assumptions&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(assumptions_raw, <span style="color: #008000">dict</span>):
            assumptions_list <span style="color: #666666">=</span> ConversationManager<span style="color: #666666">.</span>_coerce_str_list(
                assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;used&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;list&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;items&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;assumptions&quot;</span>)
            )
            question_raw <span style="color: #666666">=</span> (
                assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;clarifying_question&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;question&quot;</span>)
            )
            clarifying_question <span style="color: #666666">=</span> (
                <span style="color: #008000">str</span>(question_raw)<span style="color: #666666">.</span>strip() <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(question_raw, <span style="color: #008000">str</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            )
            rationale_raw <span style="color: #666666">=</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;rationale&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;reason&quot;</span>)
            rationale <span style="color: #666666">=</span> (
                <span style="color: #008000">str</span>(rationale_raw)<span style="color: #666666">.</span>strip() <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(rationale_raw, <span style="color: #008000">str</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            )
            decision_raw <span style="color: #666666">=</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;decision&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(decision_raw, <span style="color: #008000">str</span>):
                mode <span style="color: #666666">=</span> decision_raw<span style="color: #666666">.</span>strip()<span style="color: #666666">.</span>lower() <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;unspecified&quot;</span>
            <span style="color: #008000; font-weight: bold">else</span>:
                mode <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;unspecified&quot;</span>
            should_ask <span style="color: #666666">=</span> assumptions_raw<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;should_ask&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(should_ask, <span style="color: #008000">bool</span>) <span style="color: #AA22FF; font-weight: bold">and</span> should_ask:
                mode <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;clarify&quot;</span>
            <span style="color: #008000; font-weight: bold">if</span> mode <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> {<span style="color: #BA2121">&quot;clarify&quot;</span>, <span style="color: #BA2121">&quot;assume&quot;</span>}:
                <span style="color: #008000; font-weight: bold">if</span> assumptions_list:
                    mode <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;assume&quot;</span>
                <span style="color: #008000; font-weight: bold">elif</span> clarifying_question:
                    mode <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;clarify&quot;</span>
                <span style="color: #008000; font-weight: bold">else</span>:
                    mode <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;unspecified&quot;</span>
            decision <span style="color: #666666">=</span> AssumptionDecision(
                mode<span style="color: #666666">=</span>mode <span style="color: #008000; font-weight: bold">if</span> mode <span style="color: #AA22FF; font-weight: bold">in</span> {<span style="color: #BA2121">&quot;clarify&quot;</span>, <span style="color: #BA2121">&quot;assume&quot;</span>, <span style="color: #BA2121">&quot;unspecified&quot;</span>} <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;unspecified&quot;</span>,
                rationale<span style="color: #666666">=</span>rationale,
                clarifying_question<span style="color: #666666">=</span>clarifying_question,
            )
        <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(assumptions_raw, Sequence) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(
            assumptions_raw, (<span style="color: #008000">str</span>, <span style="color: #008000">bytes</span>)
        ):
            assumptions_list <span style="color: #666666">=</span> ConversationManager<span style="color: #666666">.</span>_coerce_str_list(assumptions_raw)
            mode <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;assume&quot;</span> <span style="color: #008000; font-weight: bold">if</span> assumptions_list <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;unspecified&quot;</span>
            decision <span style="color: #666666">=</span> AssumptionDecision(mode<span style="color: #666666">=</span>mode, rationale<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>, clarifying_question<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>)

        self_check_data <span style="color: #666666">=</span> reasoning<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;self_check&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> reasoning<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;selfCheck&quot;</span>)
        self_check: SelfCheckResult <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(self_check_data, <span style="color: #008000">dict</span>):
            passed <span style="color: #666666">=</span> <span style="color: #008000">bool</span>(self_check_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;passed&quot;</span>))
            flags <span style="color: #666666">=</span> ConversationManager<span style="color: #666666">.</span>_coerce_str_list(
                self_check_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;flags&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> self_check_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;issues&quot;</span>)
                <span style="color: #AA22FF; font-weight: bold">or</span> self_check_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;notes&quot;</span>)
            )
            notes_raw <span style="color: #666666">=</span> self_check_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;notes&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> self_check_data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;explanation&quot;</span>)
            notes <span style="color: #666666">=</span> <span style="color: #008000">str</span>(notes_raw)<span style="color: #666666">.</span>strip() <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(notes_raw, <span style="color: #008000">str</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
            self_check <span style="color: #666666">=</span> SelfCheckResult(passed<span style="color: #666666">=</span>passed, flags<span style="color: #666666">=</span>flags, notes<span style="color: #666666">=</span>notes)

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">any</span>([summary_bullets, plan_items, assumptions_list, self_check, decision]):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>

        <span style="color: #008000; font-weight: bold">return</span> ReasoningArtifacts(
            summary_bullets<span style="color: #666666">=</span>summary_bullets,
            plan_items<span style="color: #666666">=</span>plan_items,
            assumptions<span style="color: #666666">=</span>assumptions_list,
            assumption_decision<span style="color: #666666">=</span>decision,
            self_check<span style="color: #666666">=</span>self_check,
        )
</code></pre>
<h3 id="_coerce_str_list">Method: _coerce_str_list(value: Any) -&gt; list[str]</h3>
<p>The function `_coerce_str_list` converts a given input value into a list of strings. If the input is a string, it strips whitespace and returns a single-element list if the string is non-empty; otherwise, it returns an empty list. If the input is a sequence (but not a string, bytes, or dict), it iterates through the elements, strips whitespace from each string element, and appends non-empty stripped strings to the result list. For all other inputs, it returns an empty list.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_coerce_str_list</span>(value: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(value, <span style="color: #008000">str</span>):
            text <span style="color: #666666">=</span> value<span style="color: #666666">.</span>strip()
            <span style="color: #008000; font-weight: bold">return</span> [text] <span style="color: #008000; font-weight: bold">if</span> text <span style="color: #008000; font-weight: bold">else</span> []
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(value, Sequence) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(value, (<span style="color: #008000">str</span>, <span style="color: #008000">bytes</span>, <span style="color: #008000">dict</span>)):
            results: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> value:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(item, <span style="color: #008000">str</span>):
                    text <span style="color: #666666">=</span> item<span style="color: #666666">.</span>strip()
                    <span style="color: #008000; font-weight: bold">if</span> text:
                        results<span style="color: #666666">.</span>append(text)
            <span style="color: #008000; font-weight: bold">return</span> results
        <span style="color: #008000; font-weight: bold">return</span> []
</code></pre>
<h3 id="_deduplicate_preserve_order">Method: _deduplicate_preserve_order(values: Sequence[str]) -&gt; list[str]</h3>
<p>The function `_deduplicate_preserve_order` takes a sequence of strings and returns a list of strings with duplicates removed while preserving the original order of elements. It uses a set to track seen values and a list to maintain the order of first occurrences.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_deduplicate_preserve_order</span>(values: Sequence[<span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
        seen: <span style="color: #008000">set</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> <span style="color: #008000">set</span>()
        ordered: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> value <span style="color: #AA22FF; font-weight: bold">in</span> values:
            <span style="color: #008000; font-weight: bold">if</span> value <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> seen:
                seen<span style="color: #666666">.</span>add(value)
                ordered<span style="color: #666666">.</span>append(value)
        <span style="color: #008000; font-weight: bold">return</span> ordered
</code></pre>
<h3 id="_build_messages">Method: _build_messages(self, question: str, context_snippets: Sequence[str] | None) -&gt; list[dict[str, Any]]</h3>
<p>The function `_build_messages` constructs a list of message dictionaries suitable for use in an AI conversation, based on the current conversation context. It begins by adding a system prompt if one is defined. It then appends recent turns from the conversation history, alternating between user questions and assistant answers, up to the specified context window size. Finally, it adds the current user question, optionally including provided context snippets in the message content. The resulting list of messages encapsulates the full conversational context for generating a response.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_build_messages</span>(
        <span style="color: #008000">self</span>, question: <span style="color: #008000">str</span>, context_snippets: Sequence[<span style="color: #008000">str</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]]:
        messages: <span style="color: #008000">list</span>[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>system_prompt:
            messages<span style="color: #666666">.</span>append({<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;system&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>system_prompt})
        history <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>turns[<span style="color: #666666">-</span><span style="color: #008000">self</span><span style="color: #666666">.</span>context_window :] <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>context_window <span style="color: #008000; font-weight: bold">else</span> []
        <span style="color: #008000; font-weight: bold">for</span> turn <span style="color: #AA22FF; font-weight: bold">in</span> history:
            messages<span style="color: #666666">.</span>append({<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;user&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: turn<span style="color: #666666">.</span>question})
            messages<span style="color: #666666">.</span>append({<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;assistant&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: turn<span style="color: #666666">.</span>answer})

        user_content <span style="color: #666666">=</span> question
        <span style="color: #008000; font-weight: bold">if</span> context_snippets:
            formatted_context <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(context_snippets)
            user_content <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">Context:</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>formatted_context<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
        messages<span style="color: #666666">.</span>append({<span style="color: #BA2121">&quot;role&quot;</span>: <span style="color: #BA2121">&quot;user&quot;</span>, <span style="color: #BA2121">&quot;content&quot;</span>: user_content})
        <span style="color: #008000; font-weight: bold">return</span> messages
</code></pre>
<h3 id="_update_connection">Method: _update_connection(self, connected: bool, message: str | None) -&gt; None</h3>
<p>Updates the connection state of the `ConversationManager` instance, storing whether it is connected and any associated error message. If the connection state or error message has changed, it emits a signal indicating the connection state has updated.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_update_connection</span>(<span style="color: #008000">self</span>, connected: <span style="color: #008000">bool</span>, message: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        state_changed <span style="color: #666666">=</span> connected <span style="color: #666666">!=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_connected <span style="color: #AA22FF; font-weight: bold">or</span> message <span style="color: #666666">!=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_connection_error
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_connected <span style="color: #666666">=</span> connected
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_connection_error <span style="color: #666666">=</span> message
        <span style="color: #008000; font-weight: bold">if</span> state_changed:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_connection_state()
</code></pre>
<h3 id="_emit_connection_state">Method: _emit_connection_state(self) -&gt; None</h3>
<p>The function `_emit_connection_state` notifies all registered listeners of the current connection state. It retrieves the connection state from `self.connection_state` and iterates through a copy of `self._listeners`, calling each listener with the current state. If an exception occurs while invoking a listener, it is caught and ignored, ensuring other listeners are not affected.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_emit_connection_state</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        state <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>connection_state
        <span style="color: #008000; font-weight: bold">for</span> listener <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_listeners):
            <span style="color: #008000; font-weight: bold">try</span>:
                listener(state)
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">Exception</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive guard</span>
                <span style="color: #008000; font-weight: bold">continue</span>
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
