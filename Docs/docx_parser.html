<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>docx_parser</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>docx_parser</h1>
        <p>Module implements a DOCX document parser that extracts text content, headings, and metadata from Microsoft Word files. It processes paragraphs to identify heading styles and organizes content into sections with hierarchical levels. The parser retrieves core document properties including title, author, creation date, and modification timestamps. Extracted metadata is formatted with UTC timezone information for dates. Content is structured into document sections based on heading styles, with body text grouped under appropriate section titles. The parser returns a parsed document object containing combined text, metadata, structured sections, and page content. It handles missing python-docx dependency with a specific error message. Paragraphs are processed to build both flat body text and hierarchical section structure while filtering out empty sections.</p>
<h2>Functions</h2>
<h3 id="_extract_core_properties">_extract_core_properties(doc: Any) -&gt; dict[str, Any]</h3>
<p>The function `_extract_core_properties` extracts core metadata properties from a document object. It retrieves standard metadata attributes such as title, subject, author, category, comments, keywords, and last modified by. Additionally, it processes datetime fields including created, modified, and last printed, ensuring they are timezone-aware and formatted in ISO format before adding them to the metadata dictionary. The function returns a dictionary containing all successfully extracted metadata properties.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_extract_core_properties</span>(doc: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
    properties <span style="color: #666666">=</span> doc<span style="color: #666666">.</span>core_properties
    metadata: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
    <span style="color: #008000; font-weight: bold">for</span> attr <span style="color: #AA22FF; font-weight: bold">in</span> (
        <span style="color: #BA2121">&quot;title&quot;</span>,
        <span style="color: #BA2121">&quot;subject&quot;</span>,
        <span style="color: #BA2121">&quot;author&quot;</span>,
        <span style="color: #BA2121">&quot;category&quot;</span>,
        <span style="color: #BA2121">&quot;comments&quot;</span>,
        <span style="color: #BA2121">&quot;keywords&quot;</span>,
        <span style="color: #BA2121">&quot;last_modified_by&quot;</span>,
    ):
        value <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(properties, attr, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> value:
            metadata[attr] <span style="color: #666666">=</span> value

    <span style="color: #008000; font-weight: bold">for</span> attr <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;created&quot;</span>, <span style="color: #BA2121">&quot;modified&quot;</span>, <span style="color: #BA2121">&quot;last_printed&quot;</span>):
        value <span style="color: #666666">=</span> <span style="color: #008000">getattr</span>(properties, attr, <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(value, _dt<span style="color: #666666">.</span>datetime):
            <span style="color: #008000; font-weight: bold">if</span> value<span style="color: #666666">.</span>tzinfo <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                value <span style="color: #666666">=</span> value<span style="color: #666666">.</span>replace(tzinfo<span style="color: #666666">=</span>_dt<span style="color: #666666">.</span>timezone<span style="color: #666666">.</span>utc)
            metadata[attr] <span style="color: #666666">=</span> value<span style="color: #666666">.</span>astimezone(_dt<span style="color: #666666">.</span>timezone<span style="color: #666666">.</span>utc)<span style="color: #666666">.</span>isoformat()
    <span style="color: #008000; font-weight: bold">return</span> metadata
</code></pre>
<h3 id="parse_docx">parse_docx(path: Path) -&gt; ParsedDocument</h3>
<p>The function `parse_docx` extracts content from a Microsoft Word (.docx) document, returning a `ParsedDocument` object that includes the document&#x27;s text, metadata, sections (with titles and levels derived from heading styles), and page content. It uses the `python-docx` library to read the document, processes paragraphs to identify headings and body text, organizes content into sections based on heading levels, and collects all text into a combined string. Empty sections are removed, and paragraph count is added to metadata. The function raises a `ParserError` if `python-docx` is not installed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">parse_docx</span>(path: Path) <span style="color: #666666">-&gt;</span> ParsedDocument:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Parse a Microsoft Word document and extract headings and body content.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">docx</span> <span style="color: #008000; font-weight: bold">import</span> Document  <span style="color: #3D7B7B; font-style: italic"># type: ignore[import-untyped]</span>
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ImportError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
        <span style="color: #008000; font-weight: bold">raise</span> ParserError(<span style="color: #BA2121">&quot;python-docx is required to parse DOCX files&quot;</span>) <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">exc</span>

    document <span style="color: #666666">=</span> Document(path)
    metadata <span style="color: #666666">=</span> _extract_core_properties(document)

    sections: <span style="color: #008000">list</span>[DocumentSection] <span style="color: #666666">=</span> []
    current_section: DocumentSection <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
    body_parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []

    <span style="color: #008000; font-weight: bold">for</span> paragraph <span style="color: #AA22FF; font-weight: bold">in</span> document<span style="color: #666666">.</span>paragraphs:
        text <span style="color: #666666">=</span> paragraph<span style="color: #666666">.</span>text<span style="color: #666666">.</span>strip()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> text:
            <span style="color: #008000; font-weight: bold">continue</span>
        body_parts<span style="color: #666666">.</span>append(text)
        style_name <span style="color: #666666">=</span> paragraph<span style="color: #666666">.</span>style<span style="color: #666666">.</span>name <span style="color: #008000; font-weight: bold">if</span> paragraph<span style="color: #666666">.</span>style <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> style_name<span style="color: #666666">.</span>lower()<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;heading&quot;</span>):
            <span style="color: #008000; font-weight: bold">try</span>:
                level <span style="color: #666666">=</span> <span style="color: #008000">int</span>(<span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(<span style="color: #008000">filter</span>(<span style="color: #008000">str</span><span style="color: #666666">.</span>isdigit, style_name)))
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
                level <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
            current_section <span style="color: #666666">=</span> DocumentSection(title<span style="color: #666666">=</span>text, content<span style="color: #666666">=</span><span style="color: #BA2121">&quot;&quot;</span>, level<span style="color: #666666">=</span>level)
            sections<span style="color: #666666">.</span>append(current_section)
            <span style="color: #008000; font-weight: bold">continue</span>
        <span style="color: #008000; font-weight: bold">if</span> current_section <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            current_section <span style="color: #666666">=</span> DocumentSection(title<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">None</span>, content<span style="color: #666666">=</span><span style="color: #BA2121">&quot;&quot;</span>)
            sections<span style="color: #666666">.</span>append(current_section)
        <span style="color: #008000; font-weight: bold">if</span> current_section<span style="color: #666666">.</span>content:
            current_section<span style="color: #666666">.</span>content <span style="color: #666666">+=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>
        current_section<span style="color: #666666">.</span>content <span style="color: #666666">+=</span> text

    <span style="color: #3D7B7B; font-style: italic"># Remove empty trailing sections to keep output compact.</span>
    sections <span style="color: #666666">=</span> [section <span style="color: #008000; font-weight: bold">for</span> section <span style="color: #AA22FF; font-weight: bold">in</span> sections <span style="color: #008000; font-weight: bold">if</span> section<span style="color: #666666">.</span>content <span style="color: #AA22FF; font-weight: bold">or</span> section<span style="color: #666666">.</span>title]
    pages <span style="color: #666666">=</span> [PageContent(number<span style="color: #666666">=1</span>, text<span style="color: #666666">=</span><span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(body_parts))]
    combined <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(body_parts)
    metadata<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;paragraph_count&quot;</span>, <span style="color: #008000">len</span>(document<span style="color: #666666">.</span>paragraphs))
    <span style="color: #008000; font-weight: bold">return</span> ParsedDocument(text<span style="color: #666666">=</span>combined, metadata<span style="color: #666666">=</span>metadata, sections<span style="color: #666666">=</span>sections, pages<span style="color: #666666">=</span>pages)
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
