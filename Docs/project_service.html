<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>project_service</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>project_service</h1>
        <p>The project management service implements comprehensive application state coordination with functionality for creating, listing, retrieving, renaming, and deleting projects while managing active project tracking and default project initialization. It provides robust storage management through corpus root handling for adding, removing, and clearing indexed directories, along with database connection and transaction management for project-related data. The service ensures thread safety using reentrant locks and offers methods for reloading persisted state, purging project data, and managing conversation settings per project. Additional utilities support project storage location determination, proper directory creation, configuration persistence, and signal emission for project change events, including methods for removing project configurations, exporting database snapshots, loading and storing storage locations, clearing storage paths, determining primary corpus roots, ensuring storage directories exist, checking path relationships, and managing active project change notifications.</p>
<h2 id="ProjectRecord">Class: ProjectRecord</h2>
<p>The code defines a `ProjectRecord` class that serves as a lightweight data structure for representing stored projects. It includes attributes for `id`, `name`, and an optional `description`. The class is implemented as a simple data container without methods, using type hints to specify the types of its attributes.</p>
<h2 id="ProjectService">Class: ProjectService</h2>
<p>The code defines a priority queue implementation using a heap-based structure that supports custom key functions and comparison operators, providing methods for element insertion, removal of highest-priority elements, and size/emptiness checks while maintaining heap invariants. Additionally, it defines a ProjectService class that manages project state, storage paths, and per-project settings within an application, utilizing a DatabaseManager for data persistence and integrating with a ConfigManager for settings storage. This service handles active project ID management, storage and removal of project-specific settings including conversation history, corpus roots, and storage locations, database snapshot exports, ensures proper storage directory creation for projects, and emits signals upon project or active project changes. The implementation employs configuration files for data persistence, validates data types, and manages potential errors during file operations to ensure consistency.</p>
<h3 id="__init__">Method: __init__(self, *, storage_root: str | Path | None=None, config_manager: ConfigManager | None=None) -&gt; None</h3>
<p>Initializes the `ProjectService` class with a specified storage root and configuration manager. Creates necessary directories, initializes a database, and sets up repositories for managing projects, documents, chats, ingestion, and background tasks. Ensures a default project exists and loads the active project.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(
        <span style="color: #008000">self</span>,
        <span style="color: #666666">*</span>,
        storage_root: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        config_manager: ConfigManager <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">super</span>()<span style="color: #666666">.</span><span style="color: #0000FF">__init__</span>()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_config <span style="color: #666666">=</span> config_manager <span style="color: #AA22FF; font-weight: bold">or</span> ConfigManager()
        <span style="color: #008000; font-weight: bold">if</span> storage_root <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            storage_root <span style="color: #666666">=</span> get_user_config_dir() <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;storage&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_storage_root <span style="color: #666666">=</span> Path(storage_root)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_storage_root<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_db_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_storage_root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;dataminer.db&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_db <span style="color: #666666">=</span> DatabaseManager(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db_path)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_db<span style="color: #666666">.</span>initialize()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>projects <span style="color: #666666">=</span> ProjectRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>documents <span style="color: #666666">=</span> DocumentRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>chats <span style="color: #666666">=</span> ChatRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest <span style="color: #666666">=</span> IngestDocumentRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>background_tasks <span style="color: #666666">=</span> BackgroundTaskLogRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>RLock()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_default_project()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_active_project()
</code></pre>
<h3 id="shutdown">Method: shutdown(self) -&gt; None</h3>
<p>The `shutdown` method closes the database connection held by the service. It acquires a lock to ensure thread safety before closing the database connection stored in `self._db`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">shutdown</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Close resources held by the service.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_db<span style="color: #666666">.</span>close()
</code></pre>
<h3 id="storage_root">Method: storage_root(self) -&gt; Path</h3>
<p>The function `storage_root` is a property method within the `ProjectService` class that returns the value of the private attribute `_storage_root`. This attribute represents the root directory path used for storing project-related data. The method provides read-only access to this path, ensuring that the storage location can be retrieved but not directly modified from outside the class.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">storage_root</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> Path:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_storage_root
</code></pre>
<h3 id="database_path">Method: database_path(self) -&gt; Path</h3>
<p>The function `database_path` is a property method that returns the value of the private attribute `_db_path`. This attribute represents the file path to the SQLite database used by the `ProjectService` class for local data storage. The method provides read-only access to the database path, ensuring that the path can be retrieved but not directly modified from outside the class.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">database_path</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> Path:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_db_path
</code></pre>
<h3 id="database_manager">Method: database_manager(self) -&gt; DatabaseManager</h3>
<p>Returns the `DatabaseManager` instance associated with the project.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">database_manager</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> DatabaseManager:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_db
</code></pre>
<h3 id="active_project_id">Method: active_project_id(self) -&gt; int</h3>
<p>The function `active_project_id` is a property method that returns the ID of the currently active project. It first checks if `_active_project_id` is set to `None`, and if so, raises a `RuntimeError` with the message &quot;Active project not initialised&quot;. Otherwise, it returns the value of `_active_project_id`. This ensures that accessing the active project ID fails explicitly if no project has been initialized.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">active_project_id</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>(<span style="color: #BA2121">&quot;Active project not initialised&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id
</code></pre>
<h3 id="active_project">Method: active_project(self) -&gt; ProjectRecord</h3>
<p>Returns the active project record based on the `active_project_id`. Raises a `RuntimeError` if the project record cannot be retrieved.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">active_project</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> ProjectRecord:
        record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get_project(<span style="color: #008000">self</span><span style="color: #666666">.</span>active_project_id)
        <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>(<span style="color: #BA2121">&quot;Active project record missing&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> record
</code></pre>
<h3 id="list_projects">Method: list_projects(self) -&gt; list[ProjectRecord]</h3>
<p>The function `list_projects` retrieves a list of project records from the `self.projects` collection. It iterates through each entry, skipping any null or empty entries, and constructs `ProjectRecord` objects with the `id`, `name`, and `description` fields extracted from each entry. The resulting list of `ProjectRecord` objects is returned.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">list_projects</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[ProjectRecord]:
        records: <span style="color: #008000">list</span>[ProjectRecord] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>projects<span style="color: #666666">.</span>list():
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> entry:
                <span style="color: #008000; font-weight: bold">continue</span>
            records<span style="color: #666666">.</span>append(
                ProjectRecord(
                    <span style="color: #008000">id</span><span style="color: #666666">=</span><span style="color: #008000">int</span>(entry[<span style="color: #BA2121">&quot;id&quot;</span>]),
                    name<span style="color: #666666">=</span><span style="color: #008000">str</span>(entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)),
                    description<span style="color: #666666">=</span>entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;description&quot;</span>),
                )
            )
        <span style="color: #008000; font-weight: bold">return</span> records
</code></pre>
<h3 id="get_project">Method: get_project(self, project_id: int) -&gt; ProjectRecord | None</h3>
<p>Retrieves a project record by its ID from the internal projects dictionary. Returns a `ProjectRecord` object if the project exists, otherwise returns `None`. The returned record includes the project&#x27;s ID, name, and description.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_project</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> ProjectRecord <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        entry <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>projects<span style="color: #666666">.</span>get(project_id)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> entry:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> ProjectRecord(
            <span style="color: #008000">id</span><span style="color: #666666">=</span><span style="color: #008000">int</span>(entry[<span style="color: #BA2121">&quot;id&quot;</span>]),
            name<span style="color: #666666">=</span><span style="color: #008000">str</span>(entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)),
            description<span style="color: #666666">=</span>entry<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;description&quot;</span>),
        )
</code></pre>
<h3 id="create_project">Method: create_project(self, name: str, *, description: str | None=None, activate: bool=True) -&gt; ProjectRecord</h3>
<p>Creates a new project with the specified name and optional description, ensuring project storage is initialized and emitting a projects changed event. Optionally activates the newly created project. Returns the created project record.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">create_project</span>(
        <span style="color: #008000">self</span>, name: <span style="color: #008000">str</span>, <span style="color: #666666">*</span>, description: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>, activate: <span style="color: #008000">bool</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
    ) <span style="color: #666666">-&gt;</span> ProjectRecord:
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            created <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>projects<span style="color: #666666">.</span>create(name, description<span style="color: #666666">=</span>description)
            project <span style="color: #666666">=</span> ProjectRecord(
                <span style="color: #008000">id</span><span style="color: #666666">=</span><span style="color: #008000">int</span>(created[<span style="color: #BA2121">&quot;id&quot;</span>]),
                name<span style="color: #666666">=</span><span style="color: #008000">str</span>(created<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, name)),
                description<span style="color: #666666">=</span>created<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;description&quot;</span>),
            )
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(project<span style="color: #666666">.</span>id)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_projects_changed()
            <span style="color: #008000; font-weight: bold">if</span> activate:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>set_active_project(project<span style="color: #666666">.</span>id)
            <span style="color: #008000; font-weight: bold">return</span> project
</code></pre>
<h3 id="rename_project">Method: rename_project(self, project_id: int, *, name: str | None=None, description: str | None=None) -&gt; ProjectRecord</h3>
<p>The `rename_project` function updates the name and/or description of a project identified by `project_id`. It accepts optional `name` and `description` parameters, and returns a `ProjectRecord` object with the updated project details. If neither `name` nor `description` is provided, it retrieves and returns the existing project record without modification. The function raises a `LookupError` if the `project_id` is invalid. Updates are applied within a lock to ensure thread safety, and events are emitted to notify of project changes and, if applicable, active project updates.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">rename_project</span>(
        <span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>, <span style="color: #666666">*</span>, name: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>, description: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
    ) <span style="color: #666666">-&gt;</span> ProjectRecord:
        updates: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">if</span> name <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            updates[<span style="color: #BA2121">&quot;name&quot;</span>] <span style="color: #666666">=</span> name
        <span style="color: #008000; font-weight: bold">if</span> description <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            updates[<span style="color: #BA2121">&quot;description&quot;</span>] <span style="color: #666666">=</span> description
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> updates:
            record <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get_project(project_id)
            <span style="color: #008000; font-weight: bold">if</span> record <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">LookupError</span>(<span style="color: #BA2121">f&quot;Unknown project id </span><span style="color: #A45A77; font-weight: bold">{</span>project_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span> record
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            updated <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>projects<span style="color: #666666">.</span>update(project_id, <span style="color: #666666">**</span>updates)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> updated:
                <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">LookupError</span>(<span style="color: #BA2121">f&quot;Unknown project id </span><span style="color: #A45A77; font-weight: bold">{</span>project_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            record <span style="color: #666666">=</span> ProjectRecord(
                <span style="color: #008000">id</span><span style="color: #666666">=</span><span style="color: #008000">int</span>(updated[<span style="color: #BA2121">&quot;id&quot;</span>]),
                name<span style="color: #666666">=</span><span style="color: #008000">str</span>(updated<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;name&quot;</span>, <span style="color: #BA2121">&quot;&quot;</span>)),
                description<span style="color: #666666">=</span>updated<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;description&quot;</span>),
            )
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_projects_changed()
            <span style="color: #008000; font-weight: bold">if</span> project_id <span style="color: #666666">==</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_active_project_changed(record)
            <span style="color: #008000; font-weight: bold">return</span> record
</code></pre>
<h3 id="delete_project">Method: delete_project(self, project_id: int) -&gt; None</h3>
<p>The `delete_project` function removes a project identified by `project_id` from the system. It first checks if the project is currently active and raises an error if so. It then deletes the project from the projects collection, removes the associated storage directory recursively, clears the project&#x27;s settings, and emits a signal indicating that the list of projects has changed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">delete_project</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            <span style="color: #008000; font-weight: bold">if</span> project_id <span style="color: #666666">==</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id:
                <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>(<span style="color: #BA2121">&quot;Cannot delete the active project&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>projects<span style="color: #666666">.</span>delete(project_id)
            storage <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_storage_dir(project_id)
            <span style="color: #008000; font-weight: bold">if</span> storage <span style="color: #AA22FF; font-weight: bold">and</span> storage<span style="color: #666666">.</span>exists():
                shutil<span style="color: #666666">.</span>rmtree(storage, ignore_errors<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_remove_project_settings(project_id)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_projects_changed()
</code></pre>
<h3 id="set_active_project">Method: set_active_project(self, project_id: int) -&gt; None</h3>
<p>Sets the active project by its ID, ensuring the project exists, updating internal state, and notifying listeners of the change. Raises `LookupError` if the project ID is invalid.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_active_project</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        project <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>get_project(project_id)
        <span style="color: #008000; font-weight: bold">if</span> project <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">LookupError</span>(<span style="color: #BA2121">f&quot;Unknown project id </span><span style="color: #A45A77; font-weight: bold">{</span>project_id<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id <span style="color: #666666">=</span> project_id
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(project_id)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_active_project(project_id)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_active_project_changed(project)
</code></pre>
<h3 id="reload">Method: reload(self) -&gt; None</h3>
<p>The `reload` function in the `ProjectService` class is responsible for reloading the persisted state of the application after an external change, such as a restore operation. It acquires a lock to ensure thread safety, closes the existing database connection, and initializes a new one. It then reinitializes all repositories associated with the project service (projects, documents, chats, ingestion, and background tasks) using the newly created database. The function ensures a default project exists, loads the active project, and emits signals to notify listeners of changes to the projects list and the active project.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">reload</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Reload persisted state after an external change such as restore.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_db<span style="color: #666666">.</span>close()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_db <span style="color: #666666">=</span> DatabaseManager(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db_path)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_db<span style="color: #666666">.</span>initialize()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>projects <span style="color: #666666">=</span> ProjectRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>documents <span style="color: #666666">=</span> DocumentRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>chats <span style="color: #666666">=</span> ChatRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>ingest <span style="color: #666666">=</span> IngestDocumentRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>background_tasks <span style="color: #666666">=</span> BackgroundTaskLogRepository(<span style="color: #008000">self</span><span style="color: #666666">.</span>_db)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_default_project()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_active_project()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_projects_changed()
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_active_project_changed(<span style="color: #008000">self</span><span style="color: #666666">.</span>active_project())
</code></pre>
<h3 id="get_project_storage">Method: get_project_storage(self, project_id: int) -&gt; Path</h3>
<p>The function `get_project_storage` retrieves the storage path for a given project ID by first determining the project&#x27;s storage directory using `_project_storage_dir`. If the storage directory is not configured (i.e., returns `None`), it raises a `RuntimeError` indicating that the project lacks a configured corpus root. Otherwise, it ensures the directory exists by creating it if necessary and returns the path.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_project_storage</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Path:
        storage <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_storage_dir(project_id)
        <span style="color: #008000; font-weight: bold">if</span> storage <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>(
                <span style="color: #BA2121">&quot;Project has no configured corpus root to determine storage location&quot;</span>
            )
        storage<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000; font-weight: bold">return</span> storage
</code></pre>
<h3 id="get_project_storage_location">Method: get_project_storage_location(self, project_id: int) -&gt; Path | None</h3>
<p>Returns the configured storage path for the specified project ID without creating the directory.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">get_project_storage_location</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return the configured storage path for ``project_id`` without creating it.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_storage_dir(project_id)
</code></pre>
<h3 id="set_project_storage_location">Method: set_project_storage_location(self, project_id: int, path: str | Path) -&gt; None</h3>
<p>The function `set_project_storage_location` persists a specified storage path for a given project ID. It resolves the provided path to an absolute path and stores it within a locked context to ensure thread safety. The function interacts with an internal method `_store_project_storage_path` to perform the actual storage operation.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_project_storage_location</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>, path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Persist ``path`` as the storage location for ``project_id``.&quot;&quot;&quot;</span>

        resolved <span style="color: #666666">=</span> Path(path)<span style="color: #666666">.</span>resolve()
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_project_storage_path(project_id, resolved)
</code></pre>
<h3 id="project_storage_directories">Method: project_storage_directories(self) -&gt; dict[int, Path]</h3>
<p>Returns a dictionary mapping project IDs to their corresponding existing storage directory paths. For each project in the list of projects, it retrieves the project&#x27;s storage directory path and includes it in the returned dictionary only if the directory exists.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">project_storage_directories</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">int</span>, Path]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a mapping of project IDs to existing storage directories.&quot;&quot;&quot;</span>

        directories: <span style="color: #008000">dict</span>[<span style="color: #008000">int</span>, Path] <span style="color: #666666">=</span> {}
        <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>list_projects():
            storage <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_storage_dir(record<span style="color: #666666">.</span>id)
            <span style="color: #008000; font-weight: bold">if</span> storage <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #AA22FF; font-weight: bold">not</span> storage<span style="color: #666666">.</span>exists():
                <span style="color: #008000; font-weight: bold">continue</span>
            directories[record<span style="color: #666666">.</span>id] <span style="color: #666666">=</span> storage
        <span style="color: #008000; font-weight: bold">return</span> directories
</code></pre>
<h3 id="purge_project_data">Method: purge_project_data(self, project_id: int) -&gt; None</h3>
<p>The function `purge_project_data` removes all derived data associated with a specified project, identified by `project_id`, while preserving the original source files. It performs the following actions:

1. Acquires a lock to ensure thread safety.
2. Within a database transaction, deletes records from the `documents`, `chats`, and `tags` tables that are linked to the given `project_id`.
3. Removes the project&#x27;s storage directory, if it exists, by recursively deleting its contents.
4. Ensures that the project storage directory is re-established after deletion.

This function is intended to clean up all generated or processed data for a project without affecting the original files.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">purge_project_data</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Remove derived data for ``project_id`` without deleting source files.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_db<span style="color: #666666">.</span>transaction() <span style="color: #008000; font-weight: bold">as</span> connection:
                connection<span style="color: #666666">.</span>execute(<span style="color: #BA2121">&quot;DELETE FROM documents WHERE project_id = ?&quot;</span>, (project_id,))
                connection<span style="color: #666666">.</span>execute(<span style="color: #BA2121">&quot;DELETE FROM chats WHERE project_id = ?&quot;</span>, (project_id,))
                connection<span style="color: #666666">.</span>execute(<span style="color: #BA2121">&quot;DELETE FROM tags WHERE project_id = ?&quot;</span>, (project_id,))
            storage <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_storage_dir(project_id)
            <span style="color: #008000; font-weight: bold">if</span> storage <span style="color: #AA22FF; font-weight: bold">and</span> storage<span style="color: #666666">.</span>exists():
                shutil<span style="color: #666666">.</span>rmtree(storage, ignore_errors<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(project_id)
</code></pre>
<h3 id="load_conversation_settings">Method: load_conversation_settings(self, project_id: int) -&gt; dict[str, Any]</h3>
<p>The function `load_conversation_settings` retrieves conversation-related settings for a specified project from the application&#x27;s configuration. It accesses the configuration data, navigates to the section corresponding to projects and their conversation settings, and returns the settings associated with the given `project_id`. If any part of the configuration structure is missing or invalid, it returns an empty dictionary.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">load_conversation_settings</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> {}
        settings <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;conversation&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(settings, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> {}
        record <span style="color: #666666">=</span> settings<span style="color: #666666">.</span>get(<span style="color: #008000">str</span>(project_id), {})
        <span style="color: #008000; font-weight: bold">return</span> record <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(record, <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
</code></pre>
<h3 id="save_conversation_settings">Method: save_conversation_settings(self, project_id: int, settings: dict[str, Any]) -&gt; None</h3>
<p>The function `save_conversation_settings` saves conversation settings for a specified project ID into the configuration data structure. It retrieves the existing configuration, ensures the data structure is properly initialized with nested dictionaries for projects and conversation settings, and then stores the provided settings under the project ID key within the conversation dictionary. Finally, it persists the updated configuration back to storage.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">save_conversation_settings</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>, settings: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            data <span style="color: #666666">=</span> {}
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;projects&quot;</span>, {})
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            projects <span style="color: #666666">=</span> {}
            data[<span style="color: #BA2121">&quot;projects&quot;</span>] <span style="color: #666666">=</span> projects
        conversation <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;conversation&quot;</span>, {})
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(conversation, <span style="color: #008000">dict</span>):
            conversation <span style="color: #666666">=</span> {}
            projects[<span style="color: #BA2121">&quot;conversation&quot;</span>] <span style="color: #666666">=</span> conversation
        conversation[<span style="color: #008000">str</span>(project_id)] <span style="color: #666666">=</span> settings
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
</code></pre>
<h3 id="list_corpus_roots">Method: list_corpus_roots(self, project_id: int) -&gt; list[str]</h3>
<p>The function `list_corpus_roots` retrieves a list of indexed corpus root folders associated with a specified project ID. It loads configuration data, navigates through nested dictionary structures to locate the corpus roots for the given project ID, and returns a list of resolved absolute paths for those roots. If any part of the configuration structure is missing or malformed, it returns an empty list. Each path in the returned list is normalized to its absolute form.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">list_corpus_roots</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[<span style="color: #008000">str</span>]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a list of indexed corpus root folders for ``project_id``.&quot;&quot;&quot;</span>

        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> []
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> []
        corpus <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;corpus_roots&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(corpus, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> []
        roots <span style="color: #666666">=</span> corpus<span style="color: #666666">.</span>get(<span style="color: #008000">str</span>(project_id))
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(roots, <span style="color: #008000">list</span>):
            <span style="color: #008000; font-weight: bold">return</span> []
        normalized: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> entry <span style="color: #AA22FF; font-weight: bold">in</span> roots:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(entry, <span style="color: #008000">str</span>):
                <span style="color: #008000; font-weight: bold">continue</span>
            normalized<span style="color: #666666">.</span>append(<span style="color: #008000">str</span>(Path(entry)<span style="color: #666666">.</span>resolve()))
        <span style="color: #008000; font-weight: bold">return</span> normalized
</code></pre>
<h3 id="add_corpus_root">Method: add_corpus_root(self, project_id: int, path: str | Path) -&gt; None</h3>
<p>The function `add_corpus_root` adds a specified directory path as an indexed corpus root for a given project ID. It ensures the path is normalized and resolves any symbolic links. The function updates the configuration data structure to include the new path under the corresponding project&#x27;s corpus roots, avoiding duplicates. After saving the updated configuration, it ensures the project storage is initialized and attempts to export a database snapshot for the project, logging any errors that occur during the snapshot export process.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">add_corpus_root</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>, path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Persist ``path`` as an indexed corpus root for ``project_id``.&quot;&quot;&quot;</span>

        normalized <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve())
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
                data <span style="color: #666666">=</span> {}
            projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;projects&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
                projects <span style="color: #666666">=</span> {}
                data[<span style="color: #BA2121">&quot;projects&quot;</span>] <span style="color: #666666">=</span> projects
            corpus <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;corpus_roots&quot;</span>, {})
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(corpus, <span style="color: #008000">dict</span>):
                corpus <span style="color: #666666">=</span> {}
                projects[<span style="color: #BA2121">&quot;corpus_roots&quot;</span>] <span style="color: #666666">=</span> corpus
            roots <span style="color: #666666">=</span> corpus<span style="color: #666666">.</span>setdefault(<span style="color: #008000">str</span>(project_id), [])
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(roots, <span style="color: #008000">list</span>):
                roots <span style="color: #666666">=</span> []
                corpus[<span style="color: #008000">str</span>(project_id)] <span style="color: #666666">=</span> roots
            <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> roots:
                roots<span style="color: #666666">.</span>append(normalized)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(project_id)
            <span style="color: #008000; font-weight: bold">try</span>:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>export_project_database_snapshot(project_id)
            <span style="color: #008000; font-weight: bold">except</span> DatabaseError:
                logger<span style="color: #666666">.</span>exception(
                    <span style="color: #BA2121">&quot;Failed to refresh database snapshot for project </span><span style="color: #A45A77; font-weight: bold">%s</span><span style="color: #BA2121">&quot;</span>, project_id
                )
</code></pre>
<h3 id="remove_corpus_root">Method: remove_corpus_root(self, project_id: int, path: str | Path) -&gt; None</h3>
<p>The function `remove_corpus_root` removes a specified path from the corpus roots associated with a given project ID. It normalizes the input path, retrieves and modifies the configuration data to filter out the specified root path, and updates the configuration file. If the project has no remaining corpus roots, it removes the project&#x27;s storage directory. Additionally, if the removed path is within the project&#x27;s stored path, it cleans up the corresponding storage directory and ensures a new storage path is set up for the project. The operation is protected by a lock to ensure thread safety.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">remove_corpus_root</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>, path: <span style="color: #008000">str</span> <span style="color: #666666">|</span> Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Remove ``path`` from the stored corpus roots for ``project_id``.&quot;&quot;&quot;</span>

        normalized <span style="color: #666666">=</span> <span style="color: #008000">str</span>(Path(path)<span style="color: #666666">.</span>resolve())
        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            corpus <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;corpus_roots&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(corpus, <span style="color: #008000">dict</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            roots <span style="color: #666666">=</span> corpus<span style="color: #666666">.</span>get(<span style="color: #008000">str</span>(project_id))
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(roots, <span style="color: #008000">list</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            filtered <span style="color: #666666">=</span> [root <span style="color: #008000; font-weight: bold">for</span> root <span style="color: #AA22FF; font-weight: bold">in</span> roots <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(root, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> root <span style="color: #666666">!=</span> normalized]
            <span style="color: #008000; font-weight: bold">if</span> filtered:
                corpus[<span style="color: #008000">str</span>(project_id)] <span style="color: #666666">=</span> filtered
            <span style="color: #008000; font-weight: bold">else</span>:
                corpus<span style="color: #666666">.</span>pop(<span style="color: #008000">str</span>(project_id), <span style="color: #008000; font-weight: bold">None</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
            stored_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_project_storage_path(project_id)
            removed_root <span style="color: #666666">=</span> Path(normalized)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> filtered:
                <span style="color: #008000; font-weight: bold">if</span> stored_path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">and</span> stored_path<span style="color: #666666">.</span>exists():
                    shutil<span style="color: #666666">.</span>rmtree(stored_path, ignore_errors<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_clear_project_storage_path(project_id)
                <span style="color: #008000; font-weight: bold">return</span>
            <span style="color: #008000; font-weight: bold">if</span> stored_path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_path_within(stored_path, removed_root):
                <span style="color: #008000; font-weight: bold">if</span> stored_path<span style="color: #666666">.</span>exists():
                    shutil<span style="color: #666666">.</span>rmtree(stored_path, ignore_errors<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_clear_project_storage_path(project_id)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(project_id)
</code></pre>
<h3 id="clear_corpus_roots">Method: clear_corpus_roots(self, project_id: int) -&gt; None</h3>
<p>The function `clear_corpus_roots` removes all stored corpus roots associated with a given project ID. It acquires a lock to ensure thread safety, loads the configuration data, and verifies that the data structure is valid. If the project ID exists in the corpus roots, it removes the entry and saves the updated configuration. Additionally, it deletes the project&#x27;s storage directory if it exists and clears the project&#x27;s storage path.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">clear_corpus_roots</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Remove all stored corpus roots for ``project_id``.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            corpus <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;corpus_roots&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(corpus, <span style="color: #008000">dict</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(project_id) <span style="color: #AA22FF; font-weight: bold">in</span> corpus:
                corpus<span style="color: #666666">.</span>pop(<span style="color: #008000">str</span>(project_id), <span style="color: #008000; font-weight: bold">None</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
                stored_path <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_project_storage_path(project_id)
                <span style="color: #008000; font-weight: bold">if</span> stored_path <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #AA22FF; font-weight: bold">and</span> stored_path<span style="color: #666666">.</span>exists():
                    shutil<span style="color: #666666">.</span>rmtree(stored_path, ignore_errors<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
                <span style="color: #008000">self</span><span style="color: #666666">.</span>_clear_project_storage_path(project_id)
</code></pre>
<h3 id="_ensure_default_project">Method: _ensure_default_project(self) -&gt; None</h3>
<p>The function `_ensure_default_project` checks if any projects exist within the `ProjectService`. If no projects are found, it creates a new project with the name `DEFAULT_PROJECT_NAME`, ensures that the project has associated storage, and sets the newly created project as the active project.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_ensure_default_project</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>projects<span style="color: #666666">.</span>list():
            <span style="color: #008000; font-weight: bold">return</span>
        created <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>projects<span style="color: #666666">.</span>create(DEFAULT_PROJECT_NAME)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(<span style="color: #008000">int</span>(created[<span style="color: #BA2121">&quot;id&quot;</span>]))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_active_project(<span style="color: #008000">int</span>(created[<span style="color: #BA2121">&quot;id&quot;</span>]))
</code></pre>
<h3 id="_load_active_project">Method: _load_active_project(self) -&gt; None</h3>
<p>Loads the active project ID from storage and sets it as the current project, ensuring that the project exists and has storage initialized. If the stored project ID is not found among available projects, it selects the first available project. Raises a RuntimeError if no projects are available.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_load_active_project</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        stored <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_active_project_id()
        available <span style="color: #666666">=</span> {record<span style="color: #666666">.</span>id <span style="color: #008000; font-weight: bold">for</span> record <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>list_projects()}
        <span style="color: #008000; font-weight: bold">if</span> stored <span style="color: #AA22FF; font-weight: bold">in</span> available:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id <span style="color: #666666">=</span> stored
        <span style="color: #008000; font-weight: bold">elif</span> available:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id <span style="color: #666666">=</span> <span style="color: #008000">sorted</span>(available)[<span style="color: #666666">0</span>]
        <span style="color: #008000; font-weight: bold">else</span>:
            <span style="color: #008000; font-weight: bold">raise</span> <span style="color: #CB3F38; font-weight: bold">RuntimeError</span>(<span style="color: #BA2121">&quot;No projects available&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(<span style="color: #008000">self</span><span style="color: #666666">.</span>_active_project_id)
</code></pre>
<h3 id="_load_active_project_id">Method: _load_active_project_id(self) -&gt; int | None</h3>
<p>The function `_load_active_project_id` retrieves the ID of the currently active project from the configuration data. It loads the configuration, checks if the data is a dictionary and contains a &quot;projects&quot; key with a dictionary value, then attempts to extract and convert the &quot;active_id&quot; to an integer. If any step fails, it returns `None`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_load_active_project_id</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        value <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;active_id&quot;</span>)
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">int</span>(value)
        <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">TypeError</span>, <span style="color: #CB3F38; font-weight: bold">ValueError</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="_store_active_project">Method: _store_active_project(self, project_id: int) -&gt; None</h3>
<p>Stores the specified project ID as the active project in the configuration data. Retrieves existing configuration, ensures it is a dictionary, accesses or initializes the &quot;projects&quot; section, and sets the &quot;active_id&quot; key to the provided project ID before saving the updated configuration.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_store_active_project</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            data <span style="color: #666666">=</span> {}
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;projects&quot;</span>, {})
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            projects <span style="color: #666666">=</span> {}
            data[<span style="color: #BA2121">&quot;projects&quot;</span>] <span style="color: #666666">=</span> projects
        projects[<span style="color: #BA2121">&quot;active_id&quot;</span>] <span style="color: #666666">=</span> project_id
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
</code></pre>
<h3 id="_remove_project_settings">Method: _remove_project_settings(self, project_id: int) -&gt; None</h3>
<p>The function `_remove_project_settings` removes project-specific settings from the configuration data associated with a given `project_id`. It modifies the configuration by deleting entries related to conversation history, corpus roots, and storage locations that are linked to the specified project ID. If any modifications are made, the updated configuration is saved back to the storage.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_remove_project_settings</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        modified <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
        conversation <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;conversation&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(conversation, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">str</span>(project_id) <span style="color: #AA22FF; font-weight: bold">in</span> conversation:
            conversation<span style="color: #666666">.</span>pop(<span style="color: #008000">str</span>(project_id), <span style="color: #008000; font-weight: bold">None</span>)
            modified <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
        corpus <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;corpus_roots&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(corpus, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">str</span>(project_id) <span style="color: #AA22FF; font-weight: bold">in</span> corpus:
            corpus<span style="color: #666666">.</span>pop(<span style="color: #008000">str</span>(project_id), <span style="color: #008000; font-weight: bold">None</span>)
            modified <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
        storage_locations <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;storage_locations&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(storage_locations, <span style="color: #008000">dict</span>) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">str</span>(project_id) <span style="color: #AA22FF; font-weight: bold">in</span> storage_locations:
            storage_locations<span style="color: #666666">.</span>pop(<span style="color: #008000">str</span>(project_id), <span style="color: #008000; font-weight: bold">None</span>)
            modified <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">if</span> modified:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
</code></pre>
<h3 id="export_project_database_snapshot">Method: export_project_database_snapshot(self, project_id: int, *, filename: str=&#x27;dataminer.db&#x27;) -&gt; Path | None</h3>
<p>Exports a SQLite database snapshot for a specified project into the project&#x27;s storage directory. Returns the path to the exported file or None if the operation fails.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">export_project_database_snapshot</span>(
        <span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>, <span style="color: #666666">*</span>, filename: <span style="color: #008000">str</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;dataminer.db&quot;</span>
    ) <span style="color: #666666">-&gt;</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Write a SQLite snapshot for ``project_id`` into its storage directory.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_lock:
            storage <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_ensure_project_storage(project_id)
            <span style="color: #008000; font-weight: bold">if</span> storage <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
            destination <span style="color: #666666">=</span> storage <span style="color: #666666">/</span> filename
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_db<span style="color: #666666">.</span>export_database(destination)
</code></pre>
<h3 id="_load_project_storage_path">Method: _load_project_storage_path(self, project_id: int) -&gt; Path | None</h3>
<p>The function `_load_project_storage_path` retrieves the storage path for a specified project ID from the application&#x27;s configuration. It accesses the configuration data, navigates through nested dictionaries to find the `storage_locations` entry under the `projects` key, and returns the path associated with the given `project_id` if it exists and is valid. If any step in the configuration structure is missing or invalid, the function returns `None`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_load_project_storage_path</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        storage_locations <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;storage_locations&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(storage_locations, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        stored <span style="color: #666666">=</span> storage_locations<span style="color: #666666">.</span>get(<span style="color: #008000">str</span>(project_id))
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(stored, <span style="color: #008000">str</span>) <span style="color: #AA22FF; font-weight: bold">and</span> stored:
            <span style="color: #008000; font-weight: bold">return</span> Path(stored)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="_store_project_storage_path">Method: _store_project_storage_path(self, project_id: int, path: Path) -&gt; None</h3>
<p>Stores the project storage path for a given project ID in the configuration, ensuring that the path is only updated if it differs from the existing value. If the configuration data is not in the expected dictionary format, it initializes the necessary nested dictionaries. The updated configuration is then saved to disk.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_store_project_storage_path</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>, path: Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            data <span style="color: #666666">=</span> {}
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;projects&quot;</span>, {})
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            projects <span style="color: #666666">=</span> {}
            data[<span style="color: #BA2121">&quot;projects&quot;</span>] <span style="color: #666666">=</span> projects
        storage_locations <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;storage_locations&quot;</span>, {})
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(storage_locations, <span style="color: #008000">dict</span>):
            storage_locations <span style="color: #666666">=</span> {}
            projects[<span style="color: #BA2121">&quot;storage_locations&quot;</span>] <span style="color: #666666">=</span> storage_locations
        serialized <span style="color: #666666">=</span> <span style="color: #008000">str</span>(path)
        <span style="color: #008000; font-weight: bold">if</span> storage_locations<span style="color: #666666">.</span>get(<span style="color: #008000">str</span>(project_id)) <span style="color: #666666">==</span> serialized:
            <span style="color: #008000; font-weight: bold">return</span>
        storage_locations[<span style="color: #008000">str</span>(project_id)] <span style="color: #666666">=</span> serialized
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
</code></pre>
<h3 id="_clear_project_storage_path">Method: _clear_project_storage_path(self, project_id: int) -&gt; None</h3>
<p>The function `_clear_project_storage_path` removes the storage location entry for a specified project ID from the configuration data. It retrieves the configuration, navigates to the `projects.storage_locations` section, and deletes the entry corresponding to the given `project_id`. If the `storage_locations` dictionary becomes empty after the removal, it also removes the entire `storage_locations` key from the projects section. Finally, it saves the updated configuration back to storage.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_clear_project_storage_path</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>load()
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(data, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        projects <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;projects&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(projects, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        storage_locations <span style="color: #666666">=</span> projects<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;storage_locations&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(storage_locations, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000; font-weight: bold">if</span> storage_locations<span style="color: #666666">.</span>pop(<span style="color: #008000">str</span>(project_id), <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> storage_locations:
                projects<span style="color: #666666">.</span>pop(<span style="color: #BA2121">&quot;storage_locations&quot;</span>, <span style="color: #008000; font-weight: bold">None</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_config<span style="color: #666666">.</span>save(data)
</code></pre>
<h3 id="_primary_corpus_root">Method: _primary_corpus_root(self, project_id: int) -&gt; Path | None</h3>
<p>Returns the primary corpus root path for a given project ID. Retrieves the list of corpus roots associated with the project and returns the first root as a Path object. If no corpus roots are found, returns None.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_primary_corpus_root</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        roots <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>list_corpus_roots(project_id)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> roots:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> Path(roots[<span style="color: #666666">0</span>])
</code></pre>
<h3 id="_project_storage_dir">Method: _project_storage_dir(self, project_id: int) -&gt; Path | None</h3>
<p>The function `_project_storage_dir` determines the storage directory for a specified project by first attempting to load a previously stored path. If no stored path exists, it derives the path from the project&#x27;s primary corpus root, creating a standard directory structure under `.dataminer/projects/&lt;project_id&gt;`. It migrates legacy storage directories if they exist and have not been migrated already. Finally, it stores the resolved path for future use and returns the path.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_project_storage_dir</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        stored <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_load_project_storage_path(project_id)
        <span style="color: #008000; font-weight: bold">if</span> stored <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> stored
        primary_root <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_primary_corpus_root(project_id)
        <span style="color: #008000; font-weight: bold">if</span> primary_root <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        storage <span style="color: #666666">=</span> primary_root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;.dataminer&quot;</span> <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;projects&quot;</span> <span style="color: #666666">/</span> <span style="color: #008000">str</span>(project_id)
        legacy <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_storage_root <span style="color: #666666">/</span> <span style="color: #BA2121">&quot;projects&quot;</span> <span style="color: #666666">/</span> <span style="color: #008000">str</span>(project_id)
        <span style="color: #008000; font-weight: bold">if</span> legacy<span style="color: #666666">.</span>exists() <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> storage<span style="color: #666666">.</span>exists():
            storage<span style="color: #666666">.</span>parent<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
            shutil<span style="color: #666666">.</span>move(<span style="color: #008000">str</span>(legacy), <span style="color: #008000">str</span>(storage))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_store_project_storage_path(project_id, storage)
        <span style="color: #008000; font-weight: bold">return</span> storage
</code></pre>
<h3 id="_ensure_project_storage">Method: _ensure_project_storage(self, project_id: int) -&gt; Path | None</h3>
<p>The function `_ensure_project_storage` ensures that the storage directory for a given project ID exists. It retrieves the storage directory path using `_project_storage_dir`, creates the directory and its parent directories if they do not exist, and returns the path to the storage directory. If the storage directory cannot be determined, it returns `None`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_ensure_project_storage</span>(<span style="color: #008000">self</span>, project_id: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> Path <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        storage <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_project_storage_dir(project_id)
        <span style="color: #008000; font-weight: bold">if</span> storage <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
        storage<span style="color: #666666">.</span>mkdir(parents<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>, exist_ok<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000; font-weight: bold">return</span> storage
</code></pre>
<h3 id="_path_within">Method: _path_within(path: Path, parent: Path) -&gt; bool</h3>
<p>The function `_path_within` determines whether a given path is located within a specified parent directory. It attempts to use the `is_relative_to` method available in Python 3.9+ to check if the resolved path is relative to the resolved parent path. If that method is not available (due to an older Python version), it falls back to using `relative_to` and catching a `ValueError` to determine the result. In cases where file resolution fails, it performs a similar check with `strict=False` to handle non-existent files. The function returns a boolean value indicating whether the path is within the parent directory.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_path_within</span>(path: Path, parent: Path) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> path<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>is_relative_to(parent<span style="color: #666666">.</span>resolve())
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">AttributeError</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - Python &lt; 3.9 fallback</span>
            <span style="color: #008000; font-weight: bold">try</span>:
                path<span style="color: #666666">.</span>resolve()<span style="color: #666666">.</span>relative_to(parent<span style="color: #666666">.</span>resolve())
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">FileNotFoundError</span>:
            base <span style="color: #666666">=</span> parent<span style="color: #666666">.</span>resolve(strict<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>)
            candidate <span style="color: #666666">=</span> path<span style="color: #666666">.</span>resolve(strict<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>)
            <span style="color: #008000; font-weight: bold">try</span>:
                <span style="color: #008000; font-weight: bold">return</span> candidate<span style="color: #666666">.</span>is_relative_to(base)
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">AttributeError</span>:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - fallback for older Python</span>
                <span style="color: #008000; font-weight: bold">try</span>:
                    candidate<span style="color: #666666">.</span>relative_to(base)
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
                <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
                    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
<h3 id="_emit_projects_changed">Method: _emit_projects_changed(self) -&gt; None</h3>
<p>The function `_emit_projects_changed` emits a signal named `projects_changed`, passing the result of `self.list_projects()` as an argument. This indicates that the function is designed to notify observers of changes in the project list by providing the current list of projects.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_emit_projects_changed</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>projects_changed<span style="color: #666666">.</span>emit(<span style="color: #008000">self</span><span style="color: #666666">.</span>list_projects())
</code></pre>
<h3 id="_emit_active_project_changed">Method: _emit_active_project_changed(self, project: ProjectRecord) -&gt; None</h3>
<p>Emits the `active_project_changed` signal with the specified `ProjectRecord` instance as the argument.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_emit_active_project_changed</span>(<span style="color: #008000">self</span>, project: ProjectRecord) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>active_project_changed<span style="color: #666666">.</span>emit(project)
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
