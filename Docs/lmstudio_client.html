<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lmstudio_client</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>lmstudio_client</h1>
        <p>Defines a client for interacting with a local LMStudio HTTP server that provides chat completion functionality. Includes error handling for connection and response issues, support for different answer length presets, and methods for health checks and sending messages. The client handles retries with exponential backoff and parses structured responses into data classes. Provides utilities for configuring connection settings and normalizing message content from responses.</p>
<h2 id="LMStudioError">Class: LMStudioError</h2>
<p>The code defines a custom exception class named `LMStudioError` that inherits from Python&#x27;s built-in `RuntimeError`. This exception is intended to serve as the base class for handling various error conditions specific to an LMStudio client implementation. The class is documented with a docstring explaining its purpose as a base exception for LMStudio client failures.</p>
<h2 id="LMStudioConnectionError">Class: LMStudioConnectionError</h2>
<p>This code defines a custom exception class `LMStudioConnectionError` that inherits from `LMStudioError`. The exception is specifically designed to be raised when there is a failure to connect to the LMStudio server. The class includes a docstring that describes its purpose in handling connection-related errors.</p>
<h2 id="LMStudioResponseError">Class: LMStudioResponseError</h2>
<p>This code defines a custom exception class named `LMStudioResponseError` that inherits from a base exception class `LMStudioError`. The exception is specifically designed to be raised when the LMStudio server provides an invalid response. The class serves as an error handling mechanism for detecting and managing server response anomalies within the LMStudio framework.</p>
<h2 id="ChatMessage">Class: ChatMessage</h2>
<p>The `ChatMessage` class defines a structured data model for representing chat completion responses. It includes fields for message content, citations, reasoning metadata, and the raw API response. The class serves as a container for organizing and storing information from chat interactions.</p>
<h2 id="AnswerLength">Class: AnswerLength</h2>
<p>The `AnswerLength` class defines an enumeration with three verbosity presets: BRIEF, NORMAL, and DETAILED, each associated with a string value. Each preset maps to specific request parameters including `max_tokens` and `temperature` values. The `to_request_params` method returns a dictionary of these parameter overrides based on the selected preset.</p>
<h3 id="to_request_params">Method: to_request_params(self) -&gt; dict[str, Any]</h3>
<p>The function `to_request_params` returns a dictionary of request parameter overrides based on the enum value of `AnswerLength`. For `BRIEF`, it sets `max_tokens` to 256 and `temperature` to 0.2. For `DETAILED`, it sets `max_tokens` to 1024 and `temperature` to 0.4. For the default case, it sets `max_tokens` to 512 and `temperature` to 0.3.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">to_request_params</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return request parameter overrides for the preset.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span> <span style="color: #AA22FF; font-weight: bold">is</span> AnswerLength<span style="color: #666666">.</span>BRIEF:
            <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;max_tokens&quot;</span>: <span style="color: #666666">256</span>, <span style="color: #BA2121">&quot;temperature&quot;</span>: <span style="color: #666666">0.2</span>}
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span> <span style="color: #AA22FF; font-weight: bold">is</span> AnswerLength<span style="color: #666666">.</span>DETAILED:
            <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;max_tokens&quot;</span>: <span style="color: #666666">1024</span>, <span style="color: #BA2121">&quot;temperature&quot;</span>: <span style="color: #666666">0.4</span>}
        <span style="color: #008000; font-weight: bold">return</span> {<span style="color: #BA2121">&quot;max_tokens&quot;</span>: <span style="color: #666666">512</span>, <span style="color: #BA2121">&quot;temperature&quot;</span>: <span style="color: #666666">0.3</span>}
</code></pre>
<h2 id="LMStudioClient">Class: LMStudioClient</h2>
<p>The `LMStudioClient` class provides a simple HTTP client for interacting with LMStudio&#x27;s OpenAI-compatible API, supporting chat completions and health checks. It includes methods for configuring connection settings, sending chat messages with optional parameters, and handling HTTP requests with retry logic and error management. The client parses JSON responses into structured `ChatMessage` objects and supports customizable base URLs, models, and retry behavior.</p>
<h3 id="__init__">Method: __init__(self, *, base_url: str=DEFAULT_BASE_URL, model: str=&#x27;lmstudio&#x27;, max_retries: int=2, retry_backoff: float=0.5) -&gt; None</h3>
<p>Initializes an `LMStudioClient` instance with specified configuration parameters. Sets the base URL, model identifier, maximum number of retries, and retry backoff interval. The base URL is normalized to remove trailing slashes, defaulting to a predefined value if empty. The maximum retries is ensured to be non-negative.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(
        <span style="color: #008000">self</span>,
        <span style="color: #666666">*</span>,
        base_url: <span style="color: #008000">str</span> <span style="color: #666666">=</span> DEFAULT_BASE_URL,
        model: <span style="color: #008000">str</span> <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;lmstudio&quot;</span>,
        max_retries: <span style="color: #008000">int</span> <span style="color: #666666">=</span> <span style="color: #666666">2</span>,
        retry_backoff: <span style="color: #008000">float</span> <span style="color: #666666">=</span> <span style="color: #666666">0.5</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_base_url <span style="color: #666666">=</span> base_url<span style="color: #666666">.</span>rstrip(<span style="color: #BA2121">&quot;/&quot;</span>) <span style="color: #AA22FF; font-weight: bold">or</span> DEFAULT_BASE_URL
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_model <span style="color: #666666">=</span> model
        <span style="color: #008000">self</span><span style="color: #666666">.</span>max_retries <span style="color: #666666">=</span> <span style="color: #008000">max</span>(max_retries, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>retry_backoff <span style="color: #666666">=</span> retry_backoff
</code></pre>
<h3 id="base_url">Method: base_url(self) -&gt; str</h3>
<p>The function `base_url` is a property method that returns the value of the private attribute `_base_url`. It provides read-only access to the base URL stored within the `LMStudioClient` instance.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">base_url</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_base_url
</code></pre>
<h3 id="model">Method: model(self) -&gt; str</h3>
<p>The function `model` is a property getter that returns the value of the private attribute `_model`. This attribute likely stores the identifier or name of a language model used by the `LMStudioClient` class. The method provides read-only access to the model configuration.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">model</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_model
</code></pre>
<h3 id="configure">Method: configure(self, *, base_url: str | None=None, model: str | None=None) -&gt; None</h3>
<p>The `configure` method updates the connection settings for the `LMStudioClient` instance. It accepts optional arguments for `base_url` and `model`, allowing the client&#x27;s base URL and model to be modified without requiring a full client recreation. The `base_url` is normalized by removing any trailing slashes, and if the resulting string is empty, it defaults to `DEFAULT_BASE_URL`. The `model` parameter directly updates the client&#x27;s assigned model.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">configure</span>(
        <span style="color: #008000">self</span>,
        <span style="color: #666666">*</span>,
        base_url: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
        model: <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Update connection settings without recreating the client.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">if</span> base_url <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            normalized <span style="color: #666666">=</span> base_url<span style="color: #666666">.</span>rstrip(<span style="color: #BA2121">&quot;/&quot;</span>)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_base_url <span style="color: #666666">=</span> normalized <span style="color: #AA22FF; font-weight: bold">or</span> DEFAULT_BASE_URL
        <span style="color: #008000; font-weight: bold">if</span> model <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_model <span style="color: #666666">=</span> model
</code></pre>
<h3 id="health_check">Method: health_check(self) -&gt; bool</h3>
<p>The `health_check` method performs a health probe against the LMStudio server by sending a GET request to a predefined health endpoint. It returns `True` if the server responds successfully, and `False` if an `LMStudioError` is raised during the request, indicating the server is not responsive.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">health_check</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return ``True`` if the LMStudio server responds to a health probe.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_request(<span style="color: #BA2121">&quot;GET&quot;</span>, HEALTH_PATH)
        <span style="color: #008000; font-weight: bold">except</span> LMStudioError:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
</code></pre>
<h3 id="chat">Method: chat(self, messages: Sequence[dict[str, Any]], *, preset: AnswerLength=AnswerLength.NORMAL, extra_options: dict[str, Any] | None=None) -&gt; ChatMessage</h3>
<p>The `chat` method sends a sequence of messages to the LMStudio client for processing and returns the first completion as a `ChatMessage`. It constructs a request payload containing the model, messages, preset parameters derived from the `AnswerLength` enum, and optional extra options. The method disables streaming by default, sends the payload to the LMStudio API endpoint for chat completions, and parses the response into a `ChatMessage` object.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">chat</span>(
        <span style="color: #008000">self</span>,
        messages: Sequence[<span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]],
        <span style="color: #666666">*</span>,
        preset: AnswerLength <span style="color: #666666">=</span> AnswerLength<span style="color: #666666">.</span>NORMAL,
        extra_options: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> ChatMessage:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Send chat ``messages`` to LMStudio and return the first completion.&quot;&quot;&quot;</span>

        payload <span style="color: #666666">=</span> {
            <span style="color: #BA2121">&quot;model&quot;</span>: <span style="color: #008000">self</span><span style="color: #666666">.</span>_model,
            <span style="color: #BA2121">&quot;messages&quot;</span>: <span style="color: #008000">list</span>(messages),
        }
        payload<span style="color: #666666">.</span>update(preset<span style="color: #666666">.</span>to_request_params())
        payload<span style="color: #666666">.</span>setdefault(<span style="color: #BA2121">&quot;stream&quot;</span>, <span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000; font-weight: bold">if</span> extra_options:
            payload<span style="color: #666666">.</span>update(extra_options)
        data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_request_json(<span style="color: #BA2121">&quot;POST&quot;</span>, CHAT_COMPLETIONS_PATH, payload)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_parse_chat_response(data)
</code></pre>
<h3 id="_request">Method: _request(self, method: str, path: str, payload: dict[str, Any] | None=None) -&gt; bytes</h3>
<p>The function `_request` performs an HTTP request to the LMStudio API with support for retries and error handling. It constructs a URL from a base URL and path, encodes a JSON payload if provided, and sends the request using `urllib.request`. The function handles various HTTP errors, timeouts, and connection issues, raising appropriate custom exceptions based on the type of failure. It implements exponential backoff for retry attempts and returns the response body as bytes upon success. If all retry attempts are exhausted or an unrecoverable error occurs, it raises a `LMStudioError` with details about the failure.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_request</span>(
        <span style="color: #008000">self</span>,
        method: <span style="color: #008000">str</span>,
        path: <span style="color: #008000">str</span>,
        payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bytes</span>:
        url <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_base_url<span style="color: #A45A77; font-weight: bold">}{</span>path<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
        data: <span style="color: #008000">bytes</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        headers <span style="color: #666666">=</span> {<span style="color: #BA2121">&quot;Accept&quot;</span>: <span style="color: #BA2121">&quot;application/json&quot;</span>}
        <span style="color: #008000; font-weight: bold">if</span> payload <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            data <span style="color: #666666">=</span> json<span style="color: #666666">.</span>dumps(payload)<span style="color: #666666">.</span>encode(<span style="color: #BA2121">&quot;utf-8&quot;</span>)
            headers[<span style="color: #BA2121">&quot;Content-Type&quot;</span>] <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;application/json&quot;</span>
        request_obj <span style="color: #666666">=</span> request<span style="color: #666666">.</span>Request(url, data<span style="color: #666666">=</span>data, headers<span style="color: #666666">=</span>headers, method<span style="color: #666666">=</span>method)
        last_error: <span style="color: #CB3F38; font-weight: bold">Exception</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">for</span> attempt <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>max_retries <span style="color: #666666">+</span> <span style="color: #666666">1</span>):
            <span style="color: #008000; font-weight: bold">try</span>:
                <span style="color: #008000; font-weight: bold">with</span> request<span style="color: #666666">.</span>urlopen(request_obj) <span style="color: #008000; font-weight: bold">as</span> response:
                    status <span style="color: #666666">=</span> response<span style="color: #666666">.</span>getcode()
                    body <span style="color: #666666">=</span> response<span style="color: #666666">.</span>read()
                <span style="color: #008000; font-weight: bold">if</span> status <span style="color: #666666">&gt;=</span> <span style="color: #666666">400</span>:
                    message <span style="color: #666666">=</span> body<span style="color: #666666">.</span>decode(<span style="color: #BA2121">&quot;utf-8&quot;</span>, errors<span style="color: #666666">=</span><span style="color: #BA2121">&quot;replace&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> body <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;&quot;</span>
                    <span style="color: #008000; font-weight: bold">raise</span> LMStudioResponseError(
                        <span style="color: #BA2121">f&quot;LMStudio returned HTTP </span><span style="color: #A45A77; font-weight: bold">{</span>status<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>message<span style="color: #666666">.</span>strip()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
                    )
                <span style="color: #008000; font-weight: bold">return</span> body
            <span style="color: #008000; font-weight: bold">except</span> error<span style="color: #666666">.</span>HTTPError <span style="color: #008000; font-weight: bold">as</span> exc:
                body <span style="color: #666666">=</span> exc<span style="color: #666666">.</span>read() <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">hasattr</span>(exc, <span style="color: #BA2121">&quot;read&quot;</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">b&quot;&quot;</span>
                message <span style="color: #666666">=</span> body<span style="color: #666666">.</span>decode(<span style="color: #BA2121">&quot;utf-8&quot;</span>, errors<span style="color: #666666">=</span><span style="color: #BA2121">&quot;replace&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> body <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000">str</span>(exc)
                last_error <span style="color: #666666">=</span> LMStudioResponseError(message)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_should_retry(exc<span style="color: #666666">.</span>code):
                    <span style="color: #008000; font-weight: bold">break</span>
            <span style="color: #008000; font-weight: bold">except</span> error<span style="color: #666666">.</span>URLError <span style="color: #008000; font-weight: bold">as</span> exc:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(exc<span style="color: #666666">.</span>reason, (<span style="color: #CB3F38; font-weight: bold">TimeoutError</span>, socket<span style="color: #666666">.</span>timeout)):
                    last_error <span style="color: #666666">=</span> LMStudioConnectionError(<span style="color: #BA2121">&quot;LMStudio request timed out&quot;</span>)
                <span style="color: #008000; font-weight: bold">else</span>:
                    last_error <span style="color: #666666">=</span> LMStudioConnectionError(<span style="color: #008000">str</span>(exc<span style="color: #666666">.</span>reason))
            <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">TimeoutError</span>:
                last_error <span style="color: #666666">=</span> LMStudioConnectionError(<span style="color: #BA2121">&quot;LMStudio request timed out&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> attempt <span style="color: #666666">&lt;</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>max_retries:
                time<span style="color: #666666">.</span>sleep(<span style="color: #008000">self</span><span style="color: #666666">.</span>retry_backoff <span style="color: #666666">*</span> (<span style="color: #666666">2**</span>attempt))
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(last_error, LMStudioError):
            <span style="color: #008000; font-weight: bold">raise</span> last_error
        <span style="color: #008000; font-weight: bold">if</span> last_error <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">raise</span> LMStudioError(<span style="color: #008000">str</span>(last_error))
        <span style="color: #008000; font-weight: bold">raise</span> LMStudioError(<span style="color: #BA2121">&quot;Unexpected LMStudio request failure&quot;</span>)
</code></pre>
<h3 id="_request_json">Method: _request_json(self, method: str, path: str, payload: dict[str, Any] | None=None) -&gt; dict[str, Any]</h3>
<p>The function `_request_json` sends an HTTP request to the LMStudio API using the specified method and path, with an optional payload. It retrieves the response body, checks for empty responses, and attempts to decode the body as UTF-8 JSON. If the response is empty, it raises an `LMStudioResponseError`. If the JSON decoding fails, it also raises an `LMStudioResponseError` with the original exception as the cause. The function returns the parsed JSON data as a dictionary.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_request_json</span>(
        <span style="color: #008000">self</span>, method: <span style="color: #008000">str</span>, path: <span style="color: #008000">str</span>, payload: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]:
        body <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_request(method, path, payload)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> body:
            <span style="color: #008000; font-weight: bold">raise</span> LMStudioResponseError(<span style="color: #BA2121">&quot;Empty response from LMStudio&quot;</span>)
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">return</span> json<span style="color: #666666">.</span>loads(body<span style="color: #666666">.</span>decode(<span style="color: #BA2121">&quot;utf-8&quot;</span>))
        <span style="color: #008000; font-weight: bold">except</span> json<span style="color: #666666">.</span>JSONDecodeError <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
            <span style="color: #008000; font-weight: bold">raise</span> LMStudioResponseError(<span style="color: #BA2121">&quot;Invalid JSON from LMStudio&quot;</span>) <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">exc</span>
</code></pre>
<h3 id="_should_retry">Method: _should_retry(status: int | None) -&gt; bool</h3>
<p>The function `_should_retry` determines whether a request should be retried based on the HTTP status code provided. It returns `True` if the status is `None` or if the status code is one of the retryable errors: 408 (Request Timeout), 409 (Conflict), 429 (Too Many Requests), 500 (Internal Server Error), 502 (Bad Gateway), 503 (Service Unavailable), or 504 (Gateway Timeout). Otherwise, it returns `False`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_should_retry</span>(status: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">bool</span>:
        <span style="color: #008000; font-weight: bold">if</span> status <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">if</span> status <span style="color: #AA22FF; font-weight: bold">in</span> {<span style="color: #666666">408</span>, <span style="color: #666666">409</span>, <span style="color: #666666">429</span>, <span style="color: #666666">500</span>, <span style="color: #666666">502</span>, <span style="color: #666666">503</span>, <span style="color: #666666">504</span>}:
            <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">True</span>
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">False</span>
</code></pre>
<h3 id="_parse_chat_response">Method: _parse_chat_response(data: dict[str, Any]) -&gt; ChatMessage</h3>
<p>The function `_parse_chat_response` processes a dictionary response from the LMStudio API and extracts structured chat message information. It retrieves the content, citations, and reasoning from the response, normalizes the content, and constructs a `ChatMessage` object with these components along with the raw response data. The function includes error handling to ensure the response contains expected fields and data types.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_parse_chat_response</span>(data: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, Any]) <span style="color: #666666">-&gt;</span> ChatMessage:
        choices <span style="color: #666666">=</span> data<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;choices&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(choices, Iterable):
            <span style="color: #008000; font-weight: bold">raise</span> LMStudioResponseError(<span style="color: #BA2121">&quot;LMStudio response missing choices&quot;</span>)
        first <span style="color: #666666">=</span> <span style="color: #008000">next</span>(<span style="color: #008000">iter</span>(choices), <span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(first, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">raise</span> LMStudioResponseError(<span style="color: #BA2121">&quot;LMStudio response missing first choice&quot;</span>)
        message <span style="color: #666666">=</span> first<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;message&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(message, <span style="color: #008000">dict</span>):
            <span style="color: #008000; font-weight: bold">raise</span> LMStudioResponseError(<span style="color: #BA2121">&quot;LMStudio response missing message&quot;</span>)
        content_raw <span style="color: #666666">=</span> message<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;content&quot;</span>)
        content <span style="color: #666666">=</span> LMStudioClient<span style="color: #666666">.</span>_normalize_message_content(content_raw)
        metadata <span style="color: #666666">=</span> message<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;metadata&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(message<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;metadata&quot;</span>), <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> {}
        citations <span style="color: #666666">=</span> metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;citations&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(citations, <span style="color: #008000">list</span>):
            citations <span style="color: #666666">=</span> []
        reasoning <span style="color: #666666">=</span> metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;reasoning&quot;</span>) <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(metadata<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;reasoning&quot;</span>), <span style="color: #008000">dict</span>) <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000; font-weight: bold">return</span> ChatMessage(
            content<span style="color: #666666">=</span>content,
            citations<span style="color: #666666">=</span>citations,
            reasoning<span style="color: #666666">=</span>reasoning,
            raw_response<span style="color: #666666">=</span>data,
        )
</code></pre>
<h3 id="_normalize_message_content">Method: _normalize_message_content(content: Any) -&gt; str</h3>
<p>The function `_normalize_message_content` takes a value of any type and attempts to extract or construct a string from it. If the input is already a string, it returns the string directly. If the input is an iterable, it processes each item, collecting strings and extracting text from dictionaries with a &quot;text&quot; key. If successful in collecting parts, it joins them into a single string. If no valid content is found, it raises an `LMStudioResponseError` indicating that the message content is missing.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_normalize_message_content</span>(content: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
<span style="color: #bbbbbb">        </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return a usable string from ``content`` or raise an error.&quot;&quot;&quot;</span>

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(content, <span style="color: #008000">str</span>):
            <span style="color: #008000; font-weight: bold">return</span> content
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(content, Iterable):
            parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">for</span> item <span style="color: #AA22FF; font-weight: bold">in</span> content:
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(item, <span style="color: #008000">str</span>):
                    parts<span style="color: #666666">.</span>append(item)
                <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(item, <span style="color: #008000">dict</span>):
                    text <span style="color: #666666">=</span> item<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;text&quot;</span>)
                    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(text, <span style="color: #008000">str</span>):
                        parts<span style="color: #666666">.</span>append(text)
            <span style="color: #008000; font-weight: bold">if</span> parts:
                <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(parts)
        <span style="color: #008000; font-weight: bold">raise</span> LMStudioResponseError(<span style="color: #BA2121">&quot;LMStudio message missing content&quot;</span>)
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
