<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>pdf_parser</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>pdf_parser</h1>
        <p>Module provides utilities for extracting text and metadata from PDF files using PyMuPDF. Defines a function to parse PDF documents and return structured content including textual data, document sections, page information, and normalized metadata. Includes helper logic to convert date formats into ISO standard and detect when OCR might be needed due to lack of extractable text. Handles import errors and file reading exceptions during parsing.</p>
<h2>Functions</h2>
<h3 id="_to_datetime">_to_datetime(value: Any) -&gt; str | None</h3>
<p>The function `_to_datetime` converts a PyMuPDF metadata value into ISO format. It handles datetime objects by ensuring they have timezone information and converting them to UTC, and it processes string representations of dates formatted as `D:YYYYMMDDHHmmSS` into ISO format datetime strings. If the input is not a recognized date format, it returns the original value or None.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_to_datetime</span>(value: Any) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Normalize a PyMuPDF metadata value into ISO format when possible.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(value, _dt<span style="color: #666666">.</span>datetime):
        <span style="color: #008000; font-weight: bold">if</span> value<span style="color: #666666">.</span>tzinfo <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            value <span style="color: #666666">=</span> value<span style="color: #666666">.</span>replace(tzinfo<span style="color: #666666">=</span>_dt<span style="color: #666666">.</span>timezone<span style="color: #666666">.</span>utc)
        <span style="color: #008000; font-weight: bold">return</span> value<span style="color: #666666">.</span>astimezone(_dt<span style="color: #666666">.</span>timezone<span style="color: #666666">.</span>utc)<span style="color: #666666">.</span>isoformat()
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(value, <span style="color: #008000">str</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #3D7B7B; font-style: italic"># PyMuPDF encodes dates as D:YYYYMMDDHHmmSS</span>
            cleaned <span style="color: #666666">=</span> value<span style="color: #666666">.</span>strip()<span style="color: #666666">.</span>lstrip(<span style="color: #BA2121">&quot;D:&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> cleaned:
                parsed <span style="color: #666666">=</span> _dt<span style="color: #666666">.</span>datetime<span style="color: #666666">.</span>strptime(cleaned[:<span style="color: #666666">14</span>], <span style="color: #BA2121">&quot;%Y%m</span><span style="color: #A45A77; font-weight: bold">%d</span><span style="color: #BA2121">%H%M%S&quot;</span>)
                <span style="color: #008000; font-weight: bold">return</span> parsed<span style="color: #666666">.</span>replace(tzinfo<span style="color: #666666">=</span>_dt<span style="color: #666666">.</span>timezone<span style="color: #666666">.</span>utc)<span style="color: #666666">.</span>isoformat()
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ValueError</span>:
            <span style="color: #008000; font-weight: bold">return</span> value
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000; font-weight: bold">None</span>
</code></pre>
<h3 id="parse_pdf">parse_pdf(path: Path) -&gt; ParsedDocument</h3>
<p>The function `parse_pdf` extracts textual content from a PDF file located at the specified path using PyMuPDF. It returns a `ParsedDocument` object containing the combined text, metadata, document sections, page content, and indicators of whether OCR is needed. The function handles potential import and file reading errors by raising a `ParserError`. Each page&#x27;s text is collected, and metadata from the PDF is processed, with datetime fields normalized for consistency. If no text is found on any page, an OCR hint is included in the result. The PDF document is closed after processing, regardless of success or failure.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">parse_pdf</span>(path: Path) <span style="color: #666666">-&gt;</span> ParsedDocument:
<span style="color: #bbbbbb">    </span><span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Parse ``path`` and extract textual content using PyMuPDF.&quot;&quot;&quot;</span>

    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">fitz</span>  <span style="color: #3D7B7B; font-style: italic"># type: ignore[import-untyped]</span>
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #CB3F38; font-weight: bold">ImportError</span> <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
        <span style="color: #008000; font-weight: bold">raise</span> ParserError(<span style="color: #BA2121">&quot;PyMuPDF is required to parse PDF documents&quot;</span>) <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">exc</span>

    <span style="color: #008000; font-weight: bold">try</span>:
        document <span style="color: #666666">=</span> fitz<span style="color: #666666">.</span>open(path)  <span style="color: #3D7B7B; font-style: italic"># type: ignore[arg-type]</span>
    <span style="color: #008000; font-weight: bold">except</span> fitz<span style="color: #666666">.</span>FileDataError <span style="color: #008000; font-weight: bold">as</span> exc:  <span style="color: #3D7B7B; font-style: italic"># pragma: no cover - defensive</span>
        <span style="color: #008000; font-weight: bold">raise</span> ParserError(<span style="color: #008000">str</span>(exc)) <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">exc</span>

    <span style="color: #008000; font-weight: bold">try</span>:
        texts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        sections: <span style="color: #008000">list</span>[DocumentSection] <span style="color: #666666">=</span> []
        pages: <span style="color: #008000">list</span>[PageContent] <span style="color: #666666">=</span> []
        needs_ocr <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">True</span>

        <span style="color: #008000; font-weight: bold">for</span> index, page <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(document, start<span style="color: #666666">=1</span>):
            text <span style="color: #666666">=</span> page<span style="color: #666666">.</span>get_text(<span style="color: #BA2121">&quot;text&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> text<span style="color: #666666">.</span>strip():
                needs_ocr <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">False</span>
            texts<span style="color: #666666">.</span>append(text<span style="color: #666666">.</span>strip())
            sections<span style="color: #666666">.</span>append(
                DocumentSection(
                    title<span style="color: #666666">=</span><span style="color: #BA2121">f&quot;Page </span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>,
                    content<span style="color: #666666">=</span>text<span style="color: #666666">.</span>strip(),
                    level<span style="color: #666666">=1</span>,
                    page_number<span style="color: #666666">=</span>index,
                )
            )
            pages<span style="color: #666666">.</span>append(PageContent(number<span style="color: #666666">=</span>index, text<span style="color: #666666">=</span>text))

        metadata <span style="color: #666666">=</span> {key: value <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> (document<span style="color: #666666">.</span>metadata <span style="color: #AA22FF; font-weight: bold">or</span> {})<span style="color: #666666">.</span>items() <span style="color: #008000; font-weight: bold">if</span> value}
        <span style="color: #008000; font-weight: bold">if</span> document<span style="color: #666666">.</span>page_count <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            metadata[<span style="color: #BA2121">&quot;page_count&quot;</span>] <span style="color: #666666">=</span> <span style="color: #008000">int</span>(document<span style="color: #666666">.</span>page_count)

        <span style="color: #3D7B7B; font-style: italic"># Normalize datetime fields for consistency.</span>
        <span style="color: #008000; font-weight: bold">for</span> key <span style="color: #AA22FF; font-weight: bold">in</span> (<span style="color: #BA2121">&quot;creationDate&quot;</span>, <span style="color: #BA2121">&quot;modDate&quot;</span>, <span style="color: #BA2121">&quot;CreationDate&quot;</span>, <span style="color: #BA2121">&quot;ModDate&quot;</span>):
            <span style="color: #008000; font-weight: bold">if</span> key <span style="color: #AA22FF; font-weight: bold">in</span> metadata:
                normalized <span style="color: #666666">=</span> _to_datetime(metadata[key])
                <span style="color: #008000; font-weight: bold">if</span> normalized:
                    metadata[key] <span style="color: #666666">=</span> normalized

        ocr_hint <span style="color: #666666">=</span> (
            <span style="color: #BA2121">&quot;No extractable text detected. Consider running OCR before re-ingesting this PDF.&quot;</span>
            <span style="color: #008000; font-weight: bold">if</span> needs_ocr
            <span style="color: #008000; font-weight: bold">else</span> <span style="color: #008000; font-weight: bold">None</span>
        )

        combined_text <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(<span style="color: #008000">filter</span>(<span style="color: #008000; font-weight: bold">None</span>, texts))
        <span style="color: #008000; font-weight: bold">return</span> ParsedDocument(
            text<span style="color: #666666">=</span>combined_text,
            metadata<span style="color: #666666">=</span>metadata,
            sections<span style="color: #666666">=</span>sections,
            pages<span style="color: #666666">=</span>pages,
            needs_ocr<span style="color: #666666">=</span>needs_ocr,
            ocr_hint<span style="color: #666666">=</span>ocr_hint,
        )
    <span style="color: #008000; font-weight: bold">finally</span>:
        document<span style="color: #666666">.</span>close()
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
