<!-- Generated by DocGen-LM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>answer_view</title>
    <link rel="stylesheet" href="static/style.css">
</head>
<body>
    <button id="sidebar-toggle">Menu</button>
    <div class="sidebar">
        <h2>Navigation</h2>
        <ul><li><a href="index.html"><strong>üè† Project Overview</strong></a></li><li><details><summary>app</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="__main__.html">__main__</a></li><li><a href="config.html">config</a></li><li><a href="logging.html">logging</a></li><li><details><summary>ingest</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="preview.html">preview</a></li><li><a href="service.html">service</a></li><li><details><summary>parsers</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="docx_parser.html">docx_parser</a></li><li><a href="markdown_parser.html">markdown_parser</a></li><li><a href="pdf_parser.html">pdf_parser</a></li><li><a href="text_parser.html">text_parser</a></li></ul></details></li></ul></details></li><li><details><summary>retrieval</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="index.html">index</a></li><li><a href="search.html">search</a></li></ul></details></li><li><details><summary>services</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="backup_service.html">backup_service</a></li><li><a href="conversation_manager.html">conversation_manager</a></li><li><a href="conversation_settings.html">conversation_settings</a></li><li><a href="document_hierarchy.html">document_hierarchy</a></li><li><a href="export_service.html">export_service</a></li><li><a href="lmstudio_client.html">lmstudio_client</a></li><li><a href="progress_service.html">progress_service</a></li><li><a href="project_service.html">project_service</a></li><li><a href="settings_service.html">settings_service</a></li></ul></details></li><li><details><summary>storage</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="database.html">database</a></li></ul></details></li><li><details><summary>ui</summary><ul><li><a href="__init__.html">__init__</a></li><li><a href="answer_view.html">answer_view</a></li><li><a href="evidence_panel.html">evidence_panel</a></li><li><a href="main_window.html">main_window</a></li><li><a href="question_input_widget.html">question_input_widget</a></li></ul></details></li></ul></details></li><li><details><summary>tests</summary><ul><li><a href="test_dynamic_planning.html">test_dynamic_planning</a></li><li><a href="test_export_and_backup.html">test_export_and_backup</a></li><li><a href="test_ingest_service.html">test_ingest_service</a></li><li><a href="test_lmstudio_integration.html">test_lmstudio_integration</a></li><li><a href="test_parser_file_types.html">test_parser_file_types</a></li><li><a href="test_preview_service.html">test_preview_service</a></li><li><a href="test_project_service.html">test_project_service</a></li><li><a href="test_retrieval_index.html">test_retrieval_index</a></li><li><a href="test_search_service.html">test_search_service</a></li><li><a href="test_storage.html">test_storage</a></li><li><a href="test_ui_main_window.html">test_ui_main_window</a></li></ul></details></li></ul>
    </div>
    <div class="content">
        <h1>answer_view</h1>
        <p>Defines widgets for displaying conversation turns with metadata and interactive elements. Includes a `TurnCardWidget` to render individual turns with question, answer, metadata, citations, and optional sections like reasoning and plan. Provides functionality for copying text, selecting citations, and adjusting layout density. An `AnswerView` widget manages a scrollable list of turn cards, supporting rendering multiple turns and highlighting citations across the view.</p>
<h2 id="TurnCardWidget">Class: TurnCardWidget</h2>
<p>The `TurnCardWidget` class defines a Qt-based UI component that displays the details of a single conversation turn, including the question, answer, metadata, and structured elements like reasoning, plan, step results, assumptions, and self-check information. It supports interactive citation highlighting, copying answer or citation text to the clipboard, and adjustable layout density. The widget updates its content based on a `ConversationTurn` object and applies settings to control visibility of various sections.</p>
<h3 id="__init__">Method: __init__(self, turn: ConversationTurn, settings: ConversationSettings, progress_service: ProgressService, parent: QWidget | None=None) -&gt; None</h3>
<p>Initializes a `TurnCardWidget` instance for displaying conversation turn data. The widget includes components for showing the question, answer, metadata, and citations, along with sections for reasoning, plan, step results, assumptions, and self-check. It sets up layouts, connects signals, and applies initial data and settings. The widget is styled as a panel and supports copying answer and citation text.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(
        <span style="color: #008000">self</span>,
        turn: ConversationTurn,
        settings: ConversationSettings,
        progress_service: ProgressService,
        parent: QWidget <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">super</span>()<span style="color: #666666">.</span><span style="color: #0000FF">__init__</span>(parent)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>turn <span style="color: #666666">=</span> turn
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_settings <span style="color: #666666">=</span> settings
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress <span style="color: #666666">=</span> progress_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setFrameShape(QFrame<span style="color: #666666">.</span>Shape<span style="color: #666666">.</span>StyledPanel)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;turnCard&quot;</span>)

        layout <span style="color: #666666">=</span> QVBoxLayout(<span style="color: #008000">self</span>)
        layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">6</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout <span style="color: #666666">=</span> layout

        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_label <span style="color: #666666">=</span> QLabel(<span style="color: #BA2121">f&quot;Q: </span><span style="color: #A45A77; font-weight: bold">{</span>turn<span style="color: #666666">.</span>question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_label<span style="color: #666666">.</span>setWordWrap(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>question_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;turnQuestion&quot;</span>)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>question_label)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser <span style="color: #666666">=</span> QTextBrowser(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>setReadOnly(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>setOpenExternalLinks(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>setOpenLinks(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;turnAnswer&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>anchorClicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_anchor_clicked)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>setSizePolicy(QSizePolicy<span style="color: #666666">.</span>Policy<span style="color: #666666">.</span>Expanding, QSizePolicy<span style="color: #666666">.</span>Policy<span style="color: #666666">.</span>MinimumExpanding)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label <span style="color: #666666">=</span> QLabel(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;turnMetadata&quot;</span>)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser <span style="color: #666666">=</span> QTextBrowser(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;turnCitations&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>setReadOnly(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>setOpenExternalLinks(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>setOpenLinks(<span style="color: #008000; font-weight: bold">False</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>anchorClicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_on_anchor_clicked)
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_section <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_section(<span style="color: #BA2121">&quot;Reasoning summary&quot;</span>, [])
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_section)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>plan_section <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_section(<span style="color: #BA2121">&quot;Plan&quot;</span>, [])
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>plan_section)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>step_results_section <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_section(<span style="color: #BA2121">&quot;Step results&quot;</span>, [])
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>step_results_section)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>assumptions_section <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_section(<span style="color: #BA2121">&quot;Assumptions&quot;</span>, [])
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>assumptions_section)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>self_check_section <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_create_section(<span style="color: #BA2121">&quot;Self-check&quot;</span>, [])
        layout<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>self_check_section)

        actions_row <span style="color: #666666">=</span> QHBoxLayout()
        actions_row<span style="color: #666666">.</span>addStretch(<span style="color: #666666">1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_answer_button <span style="color: #666666">=</span> QPushButton(<span style="color: #BA2121">&quot;Copy answer&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_answer_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_copy_answer)
        actions_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>copy_answer_button)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_citations_button <span style="color: #666666">=</span> QPushButton(<span style="color: #BA2121">&quot;Copy citations&quot;</span>, <span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>copy_citations_button<span style="color: #666666">.</span>clicked<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_copy_citations)
        actions_row<span style="color: #666666">.</span>addWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>copy_citations_button)
        layout<span style="color: #666666">.</span>addLayout(actions_row)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row <span style="color: #666666">=</span> actions_row

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_turn_data()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>apply_settings(settings)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>set_density(<span style="color: #BA2121">&quot;comfortable&quot;</span>)
</code></pre>
<h3 id="_apply_turn_data">Method: _apply_turn_data(self) -&gt; None</h3>
<p>The function `_apply_turn_data` updates the UI of a `TurnCardWidget` with data from a `turn` object. It formats and displays metadata such as timestamps, latency, and token usage. It renders the answer and citations, populates sections for reasoning, plan, step results, assumptions, assumption decisions, and self-check results, applying appropriate formatting and structure to each section&#x27;s content. The function handles optional fields and constructs multi-line text content for display in various UI labels and sections.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_turn_data</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        turn <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>turn
        asked <span style="color: #666666">=</span> _format_timestamp(turn<span style="color: #666666">.</span>asked_at)
        answered <span style="color: #666666">=</span> _format_timestamp(turn<span style="color: #666666">.</span>answered_at)
        latency <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Latency: </span><span style="color: #A45A77; font-weight: bold">{</span>turn<span style="color: #666666">.</span>latency_ms<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> ms&quot;</span> <span style="color: #008000; font-weight: bold">if</span> turn<span style="color: #666666">.</span>latency_ms <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;Latency: ‚Äî&quot;</span>
        tokens <span style="color: #666666">=</span> _format_token_usage(turn<span style="color: #666666">.</span>token_usage)
        metadata_text <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Asked: </span><span style="color: #A45A77; font-weight: bold">{</span>asked<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> | Answered: </span><span style="color: #A45A77; font-weight: bold">{</span>answered<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> | </span><span style="color: #A45A77; font-weight: bold">{</span>latency<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> | </span><span style="color: #A45A77; font-weight: bold">{</span>tokens<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label<span style="color: #666666">.</span>setText(metadata_text)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_render_answer()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_render_citations()

        reasoning_bullets <span style="color: #666666">=</span> <span style="color: #008000">list</span>(turn<span style="color: #666666">.</span>reasoning_bullets)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_section_content(<span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_section, reasoning_bullets)

        plan_rows: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> index, item <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(turn<span style="color: #666666">.</span>plan, start<span style="color: #666666">=1</span>):
            status <span style="color: #666666">=</span> item<span style="color: #666666">.</span>status<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;_&quot;</span>, <span style="color: #BA2121">&quot; &quot;</span>) <span style="color: #008000; font-weight: bold">if</span> item<span style="color: #666666">.</span>status <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;pending&quot;</span>
            plan_rows<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">. </span><span style="color: #A45A77; font-weight: bold">{</span>item<span style="color: #666666">.</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> [</span><span style="color: #A45A77; font-weight: bold">{</span>status<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">]&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_section_content(<span style="color: #008000">self</span><span style="color: #666666">.</span>plan_section, plan_rows)

        step_lines: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">for</span> result <span style="color: #AA22FF; font-weight: bold">in</span> turn<span style="color: #666666">.</span>step_results:
            description <span style="color: #666666">=</span> result<span style="color: #666666">.</span>description<span style="color: #666666">.</span>strip() <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">f&quot;Step </span><span style="color: #A45A77; font-weight: bold">{</span>result<span style="color: #666666">.</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
            step_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>result<span style="color: #666666">.</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">. </span><span style="color: #A45A77; font-weight: bold">{</span>description<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            answer_text <span style="color: #666666">=</span> result<span style="color: #666666">.</span>answer<span style="color: #666666">.</span>strip()
            markers <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(<span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">]&quot;</span> <span style="color: #008000; font-weight: bold">for</span> idx <span style="color: #AA22FF; font-weight: bold">in</span> result<span style="color: #666666">.</span>citation_indexes)
            <span style="color: #008000; font-weight: bold">if</span> answer_text <span style="color: #AA22FF; font-weight: bold">or</span> markers:
                summary <span style="color: #666666">=</span> answer_text <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;No evidence recorded&quot;</span>
                <span style="color: #008000; font-weight: bold">if</span> markers:
                    summary <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> </span><span style="color: #A45A77; font-weight: bold">{</span>markers<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>strip()
                step_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;    </span><span style="color: #A45A77; font-weight: bold">{</span>summary<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_section_content(<span style="color: #008000">self</span><span style="color: #666666">.</span>step_results_section, step_lines)

        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_section_content(<span style="color: #008000">self</span><span style="color: #666666">.</span>assumptions_section, <span style="color: #008000">list</span>(turn<span style="color: #666666">.</span>assumptions))

        decision <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>assumption_decision
        assumptions_extra: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">if</span> decision:
            mode <span style="color: #666666">=</span> decision<span style="color: #666666">.</span>mode<span style="color: #666666">.</span>title()
            rationale <span style="color: #666666">=</span> decision<span style="color: #666666">.</span>rationale <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
            question <span style="color: #666666">=</span> decision<span style="color: #666666">.</span>clarifying_question <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>
            parts <span style="color: #666666">=</span> [<span style="color: #BA2121">f&quot;Decision: </span><span style="color: #A45A77; font-weight: bold">{</span>mode<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>]
            <span style="color: #008000; font-weight: bold">if</span> rationale:
                parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Rationale: </span><span style="color: #A45A77; font-weight: bold">{</span>rationale<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> question:
                parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Follow-up: </span><span style="color: #A45A77; font-weight: bold">{</span>question<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            assumptions_extra<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot; | &quot;</span><span style="color: #666666">.</span>join(parts))
        <span style="color: #008000; font-weight: bold">if</span> assumptions_extra:
            current <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>assumptions_section<span style="color: #666666">.</span>findChild(QLabel, <span style="color: #BA2121">&quot;contentLabel&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> current <span style="color: #AA22FF; font-weight: bold">and</span> current<span style="color: #666666">.</span>text():
                current<span style="color: #666666">.</span>setText(current<span style="color: #666666">.</span>text() <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span> <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(assumptions_extra))

        self_check <span style="color: #666666">=</span> turn<span style="color: #666666">.</span>self_check
        self_check_lines: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
        <span style="color: #008000; font-weight: bold">if</span> self_check <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            status <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;Passed&quot;</span> <span style="color: #008000; font-weight: bold">if</span> self_check<span style="color: #666666">.</span>passed <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;Flagged&quot;</span>
            self_check_lines<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;Status: </span><span style="color: #A45A77; font-weight: bold">{</span>status<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> self_check<span style="color: #666666">.</span>flags:
                self_check_lines<span style="color: #666666">.</span>extend(<span style="color: #BA2121">f&quot;‚Ä¢ </span><span style="color: #A45A77; font-weight: bold">{</span>flag<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">for</span> flag <span style="color: #AA22FF; font-weight: bold">in</span> self_check<span style="color: #666666">.</span>flags)
            <span style="color: #008000; font-weight: bold">if</span> self_check<span style="color: #666666">.</span>notes:
                self_check_lines<span style="color: #666666">.</span>append(self_check<span style="color: #666666">.</span>notes)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_section_content(<span style="color: #008000">self</span><span style="color: #666666">.</span>self_check_section, self_check_lines)
</code></pre>
<h3 id="apply_settings">Method: apply_settings(self, settings: ConversationSettings) -&gt; None</h3>
<p>The function `apply_settings` updates the widget&#x27;s visibility based on the provided `ConversationSettings`. It adjusts the visibility of the plan section, step results section, and assumptions section according to the settings and the presence of associated data in the turn. Specifically, it shows or hides these sections depending on whether the corresponding settings are enabled and whether relevant content exists.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">apply_settings</span>(<span style="color: #008000">self</span>, settings: ConversationSettings) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_settings <span style="color: #666666">=</span> settings
        <span style="color: #008000">self</span><span style="color: #666666">.</span>plan_section<span style="color: #666666">.</span>setVisible(settings<span style="color: #666666">.</span>show_plan <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #008000">bool</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>plan))
        <span style="color: #008000">self</span><span style="color: #666666">.</span>step_results_section<span style="color: #666666">.</span>setVisible(<span style="color: #008000">bool</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>step_results))
        assumptions_visible <span style="color: #666666">=</span> settings<span style="color: #666666">.</span>show_assumptions <span style="color: #AA22FF; font-weight: bold">and</span> (
            <span style="color: #008000">bool</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>assumptions) <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>assumption_decision <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>
        )
        <span style="color: #008000">self</span><span style="color: #666666">.</span>assumptions_section<span style="color: #666666">.</span>setVisible(assumptions_visible)
</code></pre>
<h3 id="to_plain_text">Method: to_plain_text(self) -&gt; str</h3>
<p>The function `to_plain_text` extracts and combines the text content from various UI elements within the `TurnCardWidget`. It collects text from labels, browsers, and sections, filtering out empty entries. The returned string consists of the question, answer, metadata, citations, and optional reasoning-related content, each separated by newlines.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">to_plain_text</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        parts <span style="color: #666666">=</span> [
            <span style="color: #008000">self</span><span style="color: #666666">.</span>question_label<span style="color: #666666">.</span>text(),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>toPlainText(),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>metadata_label<span style="color: #666666">.</span>text(),
            <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>toPlainText(),
        ]
        <span style="color: #008000; font-weight: bold">for</span> section <span style="color: #AA22FF; font-weight: bold">in</span> (
            <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>plan_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>step_results_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assumptions_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>self_check_section,
        ):
            label <span style="color: #666666">=</span> section<span style="color: #666666">.</span>findChild(QLabel, <span style="color: #BA2121">&quot;titleLabel&quot;</span>)
            content <span style="color: #666666">=</span> section<span style="color: #666666">.</span>findChild(QLabel, <span style="color: #BA2121">&quot;contentLabel&quot;</span>)
            <span style="color: #008000; font-weight: bold">if</span> label <span style="color: #AA22FF; font-weight: bold">and</span> content <span style="color: #AA22FF; font-weight: bold">and</span> section<span style="color: #666666">.</span>isVisible() <span style="color: #AA22FF; font-weight: bold">and</span> content<span style="color: #666666">.</span>text():
                parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>label<span style="color: #666666">.</span>text()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">:</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #A45A77; font-weight: bold">{</span>content<span style="color: #666666">.</span>text()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(<span style="color: #008000">filter</span>(<span style="color: #008000; font-weight: bold">None</span>, parts))
</code></pre>
<h3 id="_copy_answer">Method: _copy_answer(self) -&gt; None</h3>
<p>The function `_copy_answer` copies the text content of the `answer_browser` widget to the system clipboard and displays a notification indicating that the answer has been copied.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_copy_answer</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        QApplication<span style="color: #666666">.</span>clipboard()<span style="color: #666666">.</span>setText(<span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>toPlainText())
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress<span style="color: #666666">.</span>notify(<span style="color: #BA2121">&quot;Answer copied to clipboard&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=1500</span>)
</code></pre>
<h3 id="_copy_citations">Method: _copy_citations(self) -&gt; None</h3>
<p>The function `_copy_citations` copies the plain text content of `self.citations_browser` to the system clipboard using `QApplication.clipboard()`. It then displays a notification with the message &quot;Citations copied&quot; and an info level for 1500 milliseconds using `self._progress.notify()`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_copy_citations</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        QApplication<span style="color: #666666">.</span>clipboard()<span style="color: #666666">.</span>setText(<span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>toPlainText())
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress<span style="color: #666666">.</span>notify(<span style="color: #BA2121">&quot;Citations copied&quot;</span>, level<span style="color: #666666">=</span><span style="color: #BA2121">&quot;info&quot;</span>, duration_ms<span style="color: #666666">=1500</span>)
</code></pre>
<h3 id="set_selected_citation">Method: set_selected_citation(self, index: int | None) -&gt; None</h3>
<p>The function `set_selected_citation` updates the selected citation index in the `TurnCardWidget`. If the new index differs from the currently selected citation, it updates the internal `_selected_citation` attribute and triggers re-rendering of both the answer and citations through calls to `_render_answer()` and `_render_citations()`.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_selected_citation</span>(<span style="color: #008000">self</span>, index: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> index <span style="color: #666666">==</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation <span style="color: #666666">=</span> index
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_render_answer()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_render_citations()
</code></pre>
<h3 id="selected_citation">Method: selected_citation(self) -&gt; int | None</h3>
<p>The function `selected_citation` is a property method within the `TurnCardWidget` class that returns the value of the private attribute `_selected_citation`. This attribute likely holds an integer identifier or index related to a currently selected citation, or it may return `None` if no citation is selected. The method provides read-only access to the internal state of the widget regarding citation selection.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">selected_citation</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation
</code></pre>
<h3 id="set_density">Method: set_density(self, density: str) -&gt; None</h3>
<p>The `set_density` function configures the visual density of the `TurnCardWidget` by adjusting margins, spacing, and layout properties based on a specified density setting. It accepts a string input representing the desired density (&quot;compact&quot; or &quot;comfortable&quot;) and normalizes it. If the density has changed, it updates internal layout parameters accordingly. For compact density, it applies smaller margins and spacing values; for comfortable density, larger values are used. The function modifies the widget&#x27;s main layout, action row layout, and several section layouts to reflect the new density setting.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_density</span>(<span style="color: #008000">self</span>, density: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        normalized <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(density)<span style="color: #666666">.</span>lower() <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;comfortable&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #666666">==</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_density:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> normalized
        margin <span style="color: #666666">=</span> <span style="color: #666666">12</span> <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">16</span>
        spacing <span style="color: #666666">=</span> <span style="color: #666666">4</span> <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">8</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_layout, QVBoxLayout):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setContentsMargins(margin, margin, margin, margin)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setSpacing(spacing)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row, QHBoxLayout):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_actions_row<span style="color: #666666">.</span>setSpacing(spacing)
        <span style="color: #008000; font-weight: bold">for</span> section <span style="color: #AA22FF; font-weight: bold">in</span> (
            <span style="color: #008000">self</span><span style="color: #666666">.</span>reasoning_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>plan_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>step_results_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>assumptions_section,
            <span style="color: #008000">self</span><span style="color: #666666">.</span>self_check_section,
        ):
            layout <span style="color: #666666">=</span> section<span style="color: #666666">.</span>layout()
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(layout, QVBoxLayout):
                layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">1</span> <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">2</span>)
</code></pre>
<h3 id="_create_section">Method: _create_section(self, title: str, lines: Iterable[str]) -&gt; QFrame</h3>
<p>Creates a styled section frame with a title and content area. The section includes a title label with bold styling and a content label that wraps text. The content is populated by calling `_set_section_content` with the provided lines. Returns the constructed `QFrame` object.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_create_section</span>(<span style="color: #008000">self</span>, title: <span style="color: #008000">str</span>, lines: Iterable[<span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> QFrame:
        frame <span style="color: #666666">=</span> QFrame(<span style="color: #008000">self</span>)
        frame<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">f&quot;section_</span><span style="color: #A45A77; font-weight: bold">{</span>title<span style="color: #666666">.</span>lower()<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&#39; &#39;</span>,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39;_&#39;</span>)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
        layout <span style="color: #666666">=</span> QVBoxLayout(frame)
        layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>)
        layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">2</span>)
        title_label <span style="color: #666666">=</span> QLabel(title, frame)
        title_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;titleLabel&quot;</span>)
        title_label<span style="color: #666666">.</span>setStyleSheet(<span style="color: #BA2121">&quot;font-weight: 600;&quot;</span>)
        layout<span style="color: #666666">.</span>addWidget(title_label)
        content_label <span style="color: #666666">=</span> QLabel(<span style="color: #BA2121">&quot;&quot;</span>, frame)
        content_label<span style="color: #666666">.</span>setObjectName(<span style="color: #BA2121">&quot;contentLabel&quot;</span>)
        content_label<span style="color: #666666">.</span>setWordWrap(<span style="color: #008000; font-weight: bold">True</span>)
        layout<span style="color: #666666">.</span>addWidget(content_label)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_set_section_content(frame, <span style="color: #008000">list</span>(lines))
        <span style="color: #008000; font-weight: bold">return</span> frame
</code></pre>
<h3 id="_set_section_content">Method: _set_section_content(self, section: QFrame, lines: Iterable[str]) -&gt; None</h3>
<p>Sets the content of a QLabel within a QFrame section based on provided lines of text. If the section contains a QLabel with the object name &quot;contentLabel&quot;, it updates the label&#x27;s text with the non-empty lines joined by newlines. The section is made visible if there are non-empty lines, otherwise it is hidden and the label is cleared.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_set_section_content</span>(<span style="color: #008000">self</span>, section: QFrame, lines: Iterable[<span style="color: #008000">str</span>]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        label <span style="color: #666666">=</span> section<span style="color: #666666">.</span>findChild(QLabel, <span style="color: #BA2121">&quot;contentLabel&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> label <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
            <span style="color: #008000; font-weight: bold">return</span>
        filtered <span style="color: #666666">=</span> [line <span style="color: #008000; font-weight: bold">for</span> line <span style="color: #AA22FF; font-weight: bold">in</span> lines <span style="color: #008000; font-weight: bold">if</span> line]
        <span style="color: #008000; font-weight: bold">if</span> filtered:
            label<span style="color: #666666">.</span>setText(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(filtered))
            section<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000; font-weight: bold">else</span>:
            label<span style="color: #666666">.</span>clear()
            section<span style="color: #666666">.</span>setVisible(<span style="color: #008000; font-weight: bold">False</span>)
</code></pre>
<h3 id="_render_answer">Method: _render_answer(self) -&gt; None</h3>
<p>The function `_render_answer` processes and displays the answer content within the `TurnCardWidget`. It escapes HTML characters in the answer text and replaces newlines with `&lt;br/&gt;` tags. It then iterates through the citations associated with the turn, replacing citation placeholders (e.g., &quot;[1]&quot;) with clickable HTML anchors. Selected citations are highlighted with a CSS class. Finally, it applies optional styling for selected citations and sets the processed HTML content to an answer browser component.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_render_answer</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        answer <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(<span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>answer <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;&quot;</span>)
        answer <span style="color: #666666">=</span> answer<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n</span><span style="color: #BA2121">&quot;</span>, <span style="color: #BA2121">&quot;&lt;br/&gt;&quot;</span>)
        total_citations <span style="color: #666666">=</span> <span style="color: #008000">len</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>citations)
        <span style="color: #008000; font-weight: bold">for</span> index <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>, total_citations <span style="color: #666666">+</span> <span style="color: #666666">1</span>):
            placeholder <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;[</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">]&quot;</span>
            highlighted <span style="color: #666666">=</span> placeholder
            classes <span style="color: #666666">=</span> []
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation <span style="color: #666666">==</span> index:
                classes<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;selected-citation&quot;</span>)
                highlighted <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;&lt;span class=&#39;selected-citation&#39;&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>placeholder<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/span&gt;&quot;</span>
            anchor <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;&lt;a href=&#39;cite-</span><span style="color: #A45A77; font-weight: bold">{</span>index<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&#39;&gt;</span><span style="color: #A45A77; font-weight: bold">{</span>highlighted<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/a&gt;&quot;</span>
            answer <span style="color: #666666">=</span> answer<span style="color: #666666">.</span>replace(placeholder, anchor)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            style <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&lt;style&gt;.selected-citation{background-color:rgba(255,230,128,0.6);}&lt;/style&gt;&quot;</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            style <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>answer_browser<span style="color: #666666">.</span>setHtml(style <span style="color: #666666">+</span> answer)
</code></pre>
<h3 id="_render_citations">Method: _render_citations(self) -&gt; None</h3>
<p>Renders citations for a turn in an HTML format within a browser widget. If no citations are present, displays a placeholder message. Otherwise, it iterates through the citations, formats each one based on its type (string or dictionary), and applies styling to the selected citation. The formatted HTML is then set in the `citations_browser` widget.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_render_citations</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>citations:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>setHtml(<span style="color: #BA2121">&quot;&lt;p&gt;Citations: ‚Äî&lt;/p&gt;&quot;</span>)
            <span style="color: #008000; font-weight: bold">return</span>
        rows: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;&lt;p&gt;Citations:&lt;/p&gt;&lt;ul&gt;&quot;</span>]
        <span style="color: #008000; font-weight: bold">for</span> idx, citation <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">enumerate</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>turn<span style="color: #666666">.</span>citations, start<span style="color: #666666">=1</span>):
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">str</span>):
                label <span style="color: #666666">=</span> citation
            <span style="color: #008000; font-weight: bold">elif</span> <span style="color: #008000">isinstance</span>(citation, <span style="color: #008000">dict</span>):
                base_label <span style="color: #666666">=</span> <span style="color: #008000">str</span>(
                    citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;source&quot;</span>)
                    <span style="color: #AA22FF; font-weight: bold">or</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;title&quot;</span>)
                    <span style="color: #AA22FF; font-weight: bold">or</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;document&quot;</span>)
                    <span style="color: #AA22FF; font-weight: bold">or</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;path&quot;</span>)
                    <span style="color: #AA22FF; font-weight: bold">or</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;snippet&quot;</span>)
                    <span style="color: #AA22FF; font-weight: bold">or</span> citation
                )
                steps <span style="color: #666666">=</span> citation<span style="color: #666666">.</span>get(<span style="color: #BA2121">&quot;steps&quot;</span>)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(steps, Iterable) <span style="color: #AA22FF; font-weight: bold">and</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000">isinstance</span>(steps, (<span style="color: #008000">str</span>, <span style="color: #008000">bytes</span>, <span style="color: #008000">dict</span>)):
                    step_ids <span style="color: #666666">=</span> <span style="color: #008000">sorted</span>({<span style="color: #008000">str</span>(step) <span style="color: #008000; font-weight: bold">for</span> step <span style="color: #AA22FF; font-weight: bold">in</span> steps <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(step)<span style="color: #666666">.</span>strip()})
                    <span style="color: #008000; font-weight: bold">if</span> step_ids:
                        label <span style="color: #666666">=</span> <span style="color: #BA2121">f&quot;Steps </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #BA2121">&#39;, &#39;</span><span style="color: #666666">.</span>join(step_ids)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121"> ‚Äì </span><span style="color: #A45A77; font-weight: bold">{</span>base_label<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span> <span style="color: #008000; font-weight: bold">if</span> base_label <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">f&quot;Steps </span><span style="color: #A45A77; font-weight: bold">{</span><span style="color: #BA2121">&#39;, &#39;</span><span style="color: #666666">.</span>join(step_ids)<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>
                    <span style="color: #008000; font-weight: bold">else</span>:
                        label <span style="color: #666666">=</span> base_label
                <span style="color: #008000; font-weight: bold">else</span>:
                    label <span style="color: #666666">=</span> base_label
            <span style="color: #008000; font-weight: bold">else</span>:
                label <span style="color: #666666">=</span> <span style="color: #008000">str</span>(citation)
            safe_label <span style="color: #666666">=</span> html<span style="color: #666666">.</span>escape(label)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation <span style="color: #666666">==</span> idx:
                safe_label <span style="color: #666666">=</span> (
                    <span style="color: #BA2121">&quot;&lt;span class=&#39;selected-citation&#39;&gt;&quot;</span>
                    <span style="color: #666666">+</span> safe_label
                    <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&lt;/span&gt;&quot;</span>
                )
            rows<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;&lt;li&gt;&lt;a href=&#39;cite-</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&#39;&gt;[</span><span style="color: #A45A77; font-weight: bold">{</span>idx<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">]&lt;/a&gt; </span><span style="color: #A45A77; font-weight: bold">{</span>safe_label<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&lt;/li&gt;&quot;</span>)
        rows<span style="color: #666666">.</span>append(<span style="color: #BA2121">&quot;&lt;/ul&gt;&quot;</span>)
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_selected_citation <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            style <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&lt;style&gt;.selected-citation{background-color:rgba(255,230,128,0.6);}&lt;/style&gt;&quot;</span>
        <span style="color: #008000; font-weight: bold">else</span>:
            style <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>citations_browser<span style="color: #666666">.</span>setHtml(style <span style="color: #666666">+</span> <span style="color: #BA2121">&quot;&quot;</span><span style="color: #666666">.</span>join(rows))
</code></pre>
<h3 id="_on_anchor_clicked">Method: _on_anchor_clicked(self, url: QUrl) -&gt; None</h3>
<p>Handles clicks on citation anchors in the widget. Extracts the citation index from the URL, validates it, and emits signals to update the selected citation and notify of activation.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_on_anchor_clicked</span>(<span style="color: #008000">self</span>, url: QUrl) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        target <span style="color: #666666">=</span> url<span style="color: #666666">.</span>toString()
        <span style="color: #008000; font-weight: bold">if</span> target<span style="color: #666666">.</span>startswith(<span style="color: #BA2121">&quot;cite-&quot;</span>):
            <span style="color: #008000; font-weight: bold">try</span>:
                index <span style="color: #666666">=</span> <span style="color: #008000">int</span>(target<span style="color: #666666">.</span>split(<span style="color: #BA2121">&quot;-&quot;</span>, <span style="color: #666666">1</span>)[<span style="color: #666666">1</span>])
            <span style="color: #008000; font-weight: bold">except</span> (<span style="color: #CB3F38; font-weight: bold">ValueError</span>, <span style="color: #CB3F38; font-weight: bold">IndexError</span>):
                <span style="color: #008000; font-weight: bold">return</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>set_selected_citation(index)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>citation_activated<span style="color: #666666">.</span>emit(index)
</code></pre>
<h2 id="AnswerView">Class: AnswerView</h2>
<p>The `AnswerView` class implements a scrollable container for displaying a list of `ConversationTurn` cards using a vertical layout. It manages the addition, removal, and rendering of turn cards, and supports dynamic updates based on conversation settings such as showing plans or assumptions. The class also handles citation highlighting and adjusts spacing between cards based on density settings.</p>
<h3 id="__init__">Method: __init__(self, settings: ConversationSettings, progress_service: ProgressService, parent: QWidget | None=None) -&gt; None</h3>
<p>Initializes the `AnswerView` widget with provided conversation settings and progress service. Sets up a scrollable container with a vertical layout to hold turn cards, configures spacing and margins, and connects setting change signals to update displayed cards. The view is initialized with a &quot;comfortable&quot; density setting.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(
        <span style="color: #008000">self</span>,
        settings: ConversationSettings,
        progress_service: ProgressService,
        parent: QWidget <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span> <span style="color: #666666">=</span> <span style="color: #008000; font-weight: bold">None</span>,
    ) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">super</span>()<span style="color: #666666">.</span><span style="color: #0000FF">__init__</span>(parent)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_settings <span style="color: #666666">=</span> settings
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress <span style="color: #666666">=</span> progress_service
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards: <span style="color: #008000">list</span>[TurnCardWidget] <span style="color: #666666">=</span> []
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;&quot;</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setWidgetResizable(<span style="color: #008000; font-weight: bold">True</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setFrameShape(QFrame<span style="color: #666666">.</span>Shape<span style="color: #666666">.</span>NoFrame)

        container <span style="color: #666666">=</span> QWidget(<span style="color: #008000">self</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout <span style="color: #666666">=</span> QVBoxLayout(container)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setContentsMargins(<span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>, <span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setSpacing(<span style="color: #666666">8</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>addStretch(<span style="color: #666666">1</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>setWidget(container)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>set_density(<span style="color: #BA2121">&quot;comfortable&quot;</span>)

        settings<span style="color: #666666">.</span>show_plan_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_settings_to_cards)
        settings<span style="color: #666666">.</span>show_assumptions_changed<span style="color: #666666">.</span>connect(<span style="color: #008000">self</span><span style="color: #666666">.</span>_apply_settings_to_cards)
</code></pre>
<h3 id="cards">Method: cards(self) -&gt; list[TurnCardWidget]</h3>
<p>Returns a list of `TurnCardWidget` objects stored in the internal `_cards` collection.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">cards</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">list</span>[TurnCardWidget]:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">list</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_cards)
</code></pre>
<h3 id="clear">Method: clear(self) -&gt; None</h3>
<p>The `clear` method removes all cards from the `AnswerView` by setting their parent to `None` and then clears the internal list of cards.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">clear</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">for</span> card <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards:
            card<span style="color: #666666">.</span>setParent(<span style="color: #008000; font-weight: bold">None</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards<span style="color: #666666">.</span>clear()
</code></pre>
<h3 id="render_turns">Method: render_turns(self, turns: Iterable[ConversationTurn]) -&gt; None</h3>
<p>The function `render_turns` clears the current content of the `AnswerView` and iterates through a collection of `ConversationTurn` objects, adding each turn to the view. It serves to update the display with a sequence of conversation turns.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">render_turns</span>(<span style="color: #008000">self</span>, turns: Iterable[ConversationTurn]) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>clear()
        <span style="color: #008000; font-weight: bold">for</span> turn <span style="color: #AA22FF; font-weight: bold">in</span> turns:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>add_turn(turn)
</code></pre>
<h3 id="add_turn">Method: add_turn(self, turn: ConversationTurn) -&gt; TurnCardWidget</h3>
<p>The function `add_turn` creates a new `TurnCardWidget` instance using a provided `ConversationTurn`, settings, and progress tracker. It appends the created widget to an internal list of cards and inserts it into a layout just before the last element. The function connects the widget&#x27;s `citation_activated` signal to a lambda that emits a citation event, sets the selected citation to `None`, configures the card&#x27;s density based on a stored density setting or defaults to &quot;comfortable&quot;, scrolls the view to the bottom, and returns the created card.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">add_turn</span>(<span style="color: #008000">self</span>, turn: ConversationTurn) <span style="color: #666666">-&gt;</span> TurnCardWidget:
        card <span style="color: #666666">=</span> TurnCardWidget(turn, <span style="color: #008000">self</span><span style="color: #666666">.</span>_settings, <span style="color: #008000">self</span><span style="color: #666666">.</span>_progress, parent<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>widget())
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards<span style="color: #666666">.</span>append(card)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>insertWidget(<span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>count() <span style="color: #666666">-</span> <span style="color: #666666">1</span>, card)
        card<span style="color: #666666">.</span>citation_activated<span style="color: #666666">.</span>connect(<span style="color: #008000; font-weight: bold">lambda</span> index, card<span style="color: #666666">=</span>card: <span style="color: #008000">self</span><span style="color: #666666">.</span>_emit_citation(card, index))
        card<span style="color: #666666">.</span>set_selected_citation(<span style="color: #008000; font-weight: bold">None</span>)
        card<span style="color: #666666">.</span>set_density(<span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #AA22FF; font-weight: bold">or</span> <span style="color: #BA2121">&quot;comfortable&quot;</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_scroll_to_bottom()
        <span style="color: #008000; font-weight: bold">return</span> card
</code></pre>
<h3 id="to_plain_text">Method: to_plain_text(self) -&gt; str</h3>
<p>The function `to_plain_text` returns a string that concatenates the plain text representations of all cards contained within `self._cards`, separating each with double newlines. Each card&#x27;s `to_plain_text()` method is called to retrieve its text content.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">to_plain_text</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;</span><span style="color: #AA5D1F; font-weight: bold">\n\n</span><span style="color: #BA2121">&quot;</span><span style="color: #666666">.</span>join(card<span style="color: #666666">.</span>to_plain_text() <span style="color: #008000; font-weight: bold">for</span> card <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards)
</code></pre>
<h3 id="highlight_citation">Method: highlight_citation(self, card: TurnCardWidget | None, index: int | None) -&gt; None</h3>
<p>The function `highlight_citation` updates the citation highlighting state for a set of `TurnCardWidget` objects. It iterates through all cards in `self._cards`, and if a card matches the provided `card` parameter, it sets the citation at the specified `index` as selected. For all other cards, it clears the selected citation index. The function does not return any value.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">highlight_citation</span>(<span style="color: #008000">self</span>, card: TurnCardWidget <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>, index: <span style="color: #008000">int</span> <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">for</span> current <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards:
            <span style="color: #008000; font-weight: bold">if</span> current <span style="color: #AA22FF; font-weight: bold">is</span> card:
                current<span style="color: #666666">.</span>set_selected_citation(index)
            <span style="color: #008000; font-weight: bold">else</span>:
                current<span style="color: #666666">.</span>set_selected_citation(<span style="color: #008000; font-weight: bold">None</span>)
</code></pre>
<h3 id="_apply_settings_to_cards">Method: _apply_settings_to_cards(self) -&gt; None</h3>
<p>The function `_apply_settings_to_cards` iterates through all cards stored in `self._cards` and applies the current settings from `self._settings` to each card by calling the `apply_settings` method on the card. This ensures that each card reflects the latest configuration specified in the settings.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_apply_settings_to_cards</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">for</span> card <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards:
            card<span style="color: #666666">.</span>apply_settings(<span style="color: #008000">self</span><span style="color: #666666">.</span>_settings)
</code></pre>
<h3 id="_scroll_to_bottom">Method: _scroll_to_bottom(self) -&gt; None</h3>
<p>The function `_scroll_to_bottom` adjusts the vertical scroll bar of the `AnswerView` class to position the view at the bottommost visible content. It retrieves the vertical scroll bar instance and sets its value to the maximum possible position, ensuring that the latest content is displayed.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_scroll_to_bottom</span>(<span style="color: #008000">self</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        bar <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>verticalScrollBar()
        <span style="color: #008000; font-weight: bold">if</span> bar <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #008000; font-weight: bold">None</span>:
            bar<span style="color: #666666">.</span>setValue(bar<span style="color: #666666">.</span>maximum())
</code></pre>
<h3 id="_emit_citation">Method: _emit_citation(self, card: TurnCardWidget, index: int) -&gt; None</h3>
<p>Emits a signal indicating that a citation has been activated, passing the associated `TurnCardWidget` and the citation index as arguments.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_emit_citation</span>(<span style="color: #008000">self</span>, card: TurnCardWidget, index: <span style="color: #008000">int</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000">self</span><span style="color: #666666">.</span>citation_activated<span style="color: #666666">.</span>emit(card, index)
</code></pre>
<h3 id="set_density">Method: set_density(self, density: str) -&gt; None</h3>
<p>The `set_density` function configures the spacing and layout density of the `AnswerView` class. It accepts a string input representing the desired density (&quot;compact&quot; or &quot;comfortable&quot;), normalizes it to one of these two values, and updates the layout spacing accordingly. If the density changes, it adjusts the vertical spacing of the layout and propagates the density setting to all cards within the view.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">set_density</span>(<span style="color: #008000">self</span>, density: <span style="color: #008000">str</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000; font-weight: bold">None</span>:
        normalized <span style="color: #666666">=</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">str</span>(density)<span style="color: #666666">.</span>lower() <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;comfortable&quot;</span>
        <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #666666">==</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_density:
            <span style="color: #008000; font-weight: bold">return</span>
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_density <span style="color: #666666">=</span> normalized
        spacing <span style="color: #666666">=</span> <span style="color: #666666">8</span> <span style="color: #008000; font-weight: bold">if</span> normalized <span style="color: #666666">==</span> <span style="color: #BA2121">&quot;compact&quot;</span> <span style="color: #008000; font-weight: bold">else</span> <span style="color: #666666">12</span>
        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">isinstance</span>(<span style="color: #008000">self</span><span style="color: #666666">.</span>_layout, QVBoxLayout):
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_layout<span style="color: #666666">.</span>setSpacing(spacing)
        <span style="color: #008000; font-weight: bold">for</span> card <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_cards:
            card<span style="color: #666666">.</span>set_density(normalized)
</code></pre>
<h2>Functions</h2>
<h3 id="_format_timestamp">_format_timestamp(value: datetime | None) -&gt; str</h3>
<p>The function `_format_timestamp` takes a datetime object or None as input and returns a formatted string representation of the timestamp. If the input is None, it returns &quot;‚Äî&quot;. Otherwise, it formats the datetime object into a string with the pattern &quot;%Y-%m-%d %H:%M:%S&quot;.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_format_timestamp</span>(value: datetime <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
    <span style="color: #008000; font-weight: bold">if</span> value <span style="color: #AA22FF; font-weight: bold">is</span> <span style="color: #008000; font-weight: bold">None</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;‚Äî&quot;</span>
    <span style="color: #008000; font-weight: bold">return</span> value<span style="color: #666666">.</span>strftime(<span style="color: #BA2121">&quot;%Y-%m-</span><span style="color: #A45A77; font-weight: bold">%d</span><span style="color: #BA2121"> %H:%M:%S&quot;</span>)
</code></pre>
<h3 id="_format_token_usage">_format_token_usage(token_usage: dict[str, int] | None) -&gt; str</h3>
<p>The function `_format_token_usage` takes a dictionary of token usage data and formats it into a human-readable string. If the input is empty or None, it returns &quot;Tokens: ‚Äî&quot;. Otherwise, it processes the dictionary to order specific keys (`prompt_tokens`, `completion_tokens`, `total_tokens`) first, then appends any additional keys in arbitrary order. Each key-value pair is formatted with spaces instead of underscores and title-cased for readability. The resulting parts are joined by commas.</p>
<pre><code><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">_format_token_usage</span>(token_usage: <span style="color: #008000">dict</span>[<span style="color: #008000">str</span>, <span style="color: #008000">int</span>] <span style="color: #666666">|</span> <span style="color: #008000; font-weight: bold">None</span>) <span style="color: #666666">-&gt;</span> <span style="color: #008000">str</span>:
    <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> token_usage:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;Tokens: ‚Äî&quot;</span>
    ordered_keys <span style="color: #666666">=</span> [<span style="color: #BA2121">&quot;prompt_tokens&quot;</span>, <span style="color: #BA2121">&quot;completion_tokens&quot;</span>, <span style="color: #BA2121">&quot;total_tokens&quot;</span>]
    parts: <span style="color: #008000">list</span>[<span style="color: #008000">str</span>] <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> key <span style="color: #AA22FF; font-weight: bold">in</span> ordered_keys:
        <span style="color: #008000; font-weight: bold">if</span> key <span style="color: #AA22FF; font-weight: bold">in</span> token_usage:
            parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&#39;_&#39;</span>,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39; &#39;</span>)<span style="color: #666666">.</span>title()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>token_usage[key]<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    <span style="color: #008000; font-weight: bold">for</span> key, value <span style="color: #AA22FF; font-weight: bold">in</span> token_usage<span style="color: #666666">.</span>items():
        <span style="color: #008000; font-weight: bold">if</span> key <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> ordered_keys:
            parts<span style="color: #666666">.</span>append(<span style="color: #BA2121">f&quot;</span><span style="color: #A45A77; font-weight: bold">{</span>key<span style="color: #666666">.</span>replace(<span style="color: #BA2121">&#39;_&#39;</span>,<span style="color: #bbbbbb"> </span><span style="color: #BA2121">&#39; &#39;</span>)<span style="color: #666666">.</span>title()<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">: </span><span style="color: #A45A77; font-weight: bold">{</span>value<span style="color: #A45A77; font-weight: bold">}</span><span style="color: #BA2121">&quot;</span>)
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&quot;, &quot;</span><span style="color: #666666">.</span>join(parts) <span style="color: #008000; font-weight: bold">if</span> parts <span style="color: #008000; font-weight: bold">else</span> <span style="color: #BA2121">&quot;Tokens: ‚Äî&quot;</span>
</code></pre>
    </div>
    <script src="static/toggle.js"></script>
</body>
</html>
